<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shadow802.gitee.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Shadow802">
<meta property="og:url" content="https://shadow802.gitee.io/index.html">
<meta property="og:site_name" content="Shadow802">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Shadow802">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://shadow802.gitee.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Shadow802</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Shadow802</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2024/10/22/Karmada-failover/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/22/Karmada-failover/" class="post-title-link" itemprop="url">Karmada failover</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-10-22 00:00:00" itemprop="dateCreated datePublished" datetime="2024-10-22T00:00:00+08:00">2024-10-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/" itemprop="url" rel="index"><span itemprop="name">运维实践</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>    我们使用了Karmada进行多集群的管理（主要是push模式），目前主要用于主备容灾的应用部署，来保证主、备集群应用镜像及配置版本的一致性。</p>
<p>    起因是某次网络变更影响了Karmada控制面与子集群的连通性，存在2次小于5分钟级别的访问中断。结果导致了Karmada托管的大部分集群所有Pod的重启（所有被Karmada托管的资源均发生了重建）。</p>
<p>    需找到导致资源重建，服务重启的原因，并采取规避措施。</p>
<h1 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h1><p>    通过对集群资源和Karmada controller manager的日志查看，发现资源对应的works资源有删除重建的痕迹，works删除重建，虽然能保证与删除的资源对象逻辑一致，但是会导致子集群的资源重新下发。</p>
<p>    那么为什么works会被删除重建？Karmada存在failover机制。代码整体脉络如下：</p>
<p><img src="failover-flow.png"></p>
<p>    从上图可以看出，works被删除有两种触发方式：</p>
<h2 id="cluster-failover"><a href="#cluster-failover" class="headerlink" title="cluster failover"></a>cluster failover</h2><ol>
<li><p>当无法连上子集群时，karmada的cluster controller会为cluster资源打上cluster.karmada.io/unreachable的污点。</p>
</li>
<li><p>NoExecuteTaintManager会将包含污点集群的所有ResourceBindings过滤出来，根据容忍时间和是否开启优雅驱逐（如果未开启优雅驱逐，直接从.spec.cluster中移除），决定是否将集群从ResourceBindings.spec.clusters中移除，并添加到ResourceBindings.spec.gracefulEvictionTasks中。</p>
</li>
<li><p>RBGracefulevictionController根据gracefulEvictionTasks中的容忍时间，将集群从gracefulEvictionTasks中删除。设置了suppressDeletion=true的任务，不会被删除。这里默认设置的是false。</p>
</li>
<li><p>ResourceBindingController，将不存在于.spec.cluster/.spec.gracefulEvictionTasks/.spec.requiredBy三者中的work过滤出来，认为是orphan works。</p>
</li>
</ol>
<h2 id="application-failover"><a href="#application-failover" class="headerlink" title="application failover"></a>application failover</h2><ol>
<li><p>当RBApplicationFailoverController通过ResourceBindings.status.aggregatedStatus中获取到资源不健康的状态后，会根据PropogationPolicy设置的优雅驱逐的策略，作出相应的处理：</p>
<p>（1）binding.Spec.Failover.Application.PurgeMode = Graciously：如果开启了优雅驱逐特性，将集群放置到ResourceBindings.spec.gracefulEvictionTasks中，并设置<strong>suppressDeletion=false</strong>，否则直接报错。</p>
<p>（2）binding.Spec.Failover.Application.PurgeMode = Never：如果开启了优雅驱逐特性，将集群放置到ResourceBindings.spec.gracefulEvictionTasks中，并设置<strong>suppressDeletion=true</strong>，否则直接报错。</p>
<p>（3）binding.Spec.Failover.Application.PurgeMode =Immediately，直接从spec.clusters中删除该集群。</p>
</li>
<li><p>与cluster failover后续流程相同。</p>
</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>    我们使用了karmada1.8.0的版本，通过对Karmada源码的分析，配合测试环境的验证，复现了上述问题，观察到断连集群的works的确被写了deleteTimestamp，最终被删除重建，导致了该集群所有资源被重建。因目前我们的PropagationPolicy和ClusterPropagationPolicy均未设置Failover字段，所以应用级别的failover不生效；Cluster的failover是导致该问题的主要原因，目前想到的应对措施：</p>
<ol>
<li><p>调大对集群污点的容忍时间，目前是300s，增大到600s，可缓解，如果断连时间超过该值，依然会引发该问题。</p>
</li>
<li><p>通过controller的启动参数–enable-taint-manager=false关闭NoExecuteTaintManager的执行，这样就不会因集群断连而产生资源的failover，当然也无法享受failover带来的故障转移能力。</p>
</li>
</ol>
<p>    </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2024/09/24/Apisix%E7%BD%91%E5%85%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/24/Apisix%E7%BD%91%E5%85%B3%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">Apisix网关方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-09-24 00:00:00" itemprop="dateCreated datePublished" datetime="2024-09-24T00:00:00+08:00">2024-09-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>    企业内部平台需搭建统一的网关服务，托管认证、鉴权等公共服务，并为各领域业务、不同集群内部的应用服务提供外部访问方式以及灵活的插件配置策略。</p>
<h1 id="架构概览"><a href="#架构概览" class="headerlink" title="架构概览"></a>架构概览</h1><p>    OpenResty是一个基于Nginx的Lua扩展的强大的Web应用服务平台。通过集成大量的Nginx模块、Lua库、LuaJIT，帮助开发者，通过使用Lua编写脚本，快速构建可扩展的高性能Web应用服务。</p>
<p>    Apisix构建在Ngnix、lua-nginx-module之上，并使用了OpenResty中大量的精心编写的优秀库，提供了强大的插件扩展能力（Lua、WASM、Go、Java、Python等）。</p>
<p><img src="apisix.jpg"></p>
<p>    Apisix由API7.ai（支流科技）开发和捐赠，同时提供企业版的服务api7ee3。主要包括:</p>
<ul>
<li><p>dashboard：可视化UI操作页面。</p>
</li>
<li><p>dp-manager：兼容网关对etcd api依赖，使用<a target="_blank" rel="noopener" href="https://github.com/k3s-io/kine">kine</a>转化为关系型数据的查询。</p>
</li>
<li><p>gateway：支持数据面和控制面分开部署。</p>
</li>
<li><p>关系型数据库（MySQL、PostgreSQL）：持久化数据，用以替换etcd。</p>
</li>
</ul>
<p><img src="api7ee3.jpg"></p>
<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="LuaJIT"><a href="#LuaJIT" class="headerlink" title="LuaJIT"></a>LuaJIT</h2><p>    在OpenResty中，每个Nginx的Worker中都运行着一个LuaVM，自从 OpenResty 1.5.8.1 版本之后，由于性能优势的原因，默认捆绑的 Lua 解释器就被替换成了 LuaJIT。</p>
<p>    LuaJIT的解释器在执行字节码的同时，会记录运行时的统计信息，当认为某些代码足够热便会触发JIT编译器开始工作，JIT 编译器会从热函数的入口或者热循环的某个位置开始，尝试编译对应 Lua 代码路径。 编译的过程是把 LuaJIT 字节码先转化成 LuaJIT 自定义的中间码（IR），然后再生成目标机器的机器码。</p>
<p>    其次，LuJIT 还紧密结合了 FFI（Foreign Function Interface），可以直接在 Lua 代码中调用外部的 C 函数或者 C 数据结构。</p>
<p>    LuaJIT 的测评报告表明，在数值运算、循环与函数调用、协程切换、字符串操作等许多方面它的加速效果都很显著。凭借着 FFI 特性，LuaJIT 在那些需要频繁地调用外部 C/C++ 代码的场景，也要比标准 Lua 解释器快很多。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Lua调用C语言</span></span><br><span class="line"><span class="keyword">local</span> ffi = <span class="built_in">require</span>(ffi)</span><br><span class="line">ffi.cdef <span class="string">[[</span></span><br><span class="line"><span class="string">    int printf(const char *fmt, ...);</span></span><br><span class="line"><span class="string">]]</span></span><br><span class="line">ffi.C.prinf(<span class="string">&quot;hello %s&quot;</span>, <span class="string">&quot;world&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Cosocket"><a href="#Cosocket" class="headerlink" title="Cosocket"></a>Cosocket</h2><blockquote>
<p>    cosocket = coroutine +  socket</p>
</blockquote>
<p>    OpenResty的cosocket将lua的协程和Nginx的socket事件机制联系到了一起，使得用户在Lua脚本中的每一个网络操作，都可以充分利用Nginx的非阻塞网络IO。</p>
<p><img src="lua-cosocket.png"></p>
<p>    OpenResty以此为基础，提供了大量在Lua中使用网络操作的<a target="_blank" rel="noopener" href="https://github.com/openresty/lua-nginx-module?tab=readme-ov-file#description">cosocket api</a>。</p>
<p><img src="cosoket-api.jpg"></p>
<h2 id="Apisix"><a href="#Apisix" class="headerlink" title="Apisix"></a>Apisix</h2><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>    因此前对OpenResty和Lua知之甚少，为能更好地理解Apisix与OpenResty、Nginx、Lua几者之间的关联，梳理了Apisix的总体启动代码，便于深入理解和后续运维查证问题。</p>
<p><img src="apisix-code-start.jpg"></p>
<p>    总体上看，Apisix的启动，最终转换成了OpenResty的启动，并通过模版维护了nginx.conf的配置文件，在nginx.conf的配置文件中，通过Nginx的Lua扩展能力，在整个Nginx和用户请求的生命周期的不同位置分别进行插桩，并调用了Apisix的相关的Lua代码实现，这一点结合apisix生成的nginx.conf的配置文件（只截取了部分）来看更明显。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat nginx.conf | grep -C1 &quot;by_lua_block&quot;</span><br></pre></td></tr></table></figure>

<p><img src="apisix-nginx-conf.jpg"></p>
<h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><p>    Apisix支持Lua、Wasm、外部服务三种插件方案。</p>
<ul>
<li><p>Lua，方案成熟，生产可用。</p>
</li>
<li><p>Wasm，目前只实现了少量API，<a target="_blank" rel="noopener" href="https://github.com/api7/wasm-nginx-module">wasm-nginx-module</a>。</p>
</li>
<li><p>外部服务，只可以配置一个外部服务，通过UDS通信。</p>
<p>本文重点关注落地方案所使用的lua插件。</p>
</li>
</ul>
<p>  在Apisix中，插件可以附着的位置包括Route、Service、Consumer或者是在Plugin Config中引用。</p>
<p>（1）<a target="_blank" rel="noopener" href="https://apisix.apache.org/zh/docs/apisix/terminology/plugin/#%E6%8F%92%E4%BB%B6%E6%89%A7%E8%A1%8C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">生命周期</a></p>
<p>    根据OpenResty的<a target="_blank" rel="noopener" href="https://openresty-reference.readthedocs.io/en/latest/Directives/">指令设计</a></p>
<p><img src="openresty-directives.png"></p>
<p>插件可以在如下的阶段发挥作用，每个阶段分别对应插件代码中相应的实现方法：</p>
<p><img src="apisix-plugin-phase.jpg"></p>
<p>（2）<a target="_blank" rel="noopener" href="https://apisix.apache.org/zh/docs/apisix/terminology/plugin/#%E6%8F%92%E4%BB%B6%E6%89%A7%E8%A1%8C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">执行顺序</a></p>
<p>（3）<a target="_blank" rel="noopener" href="https://apisix.apache.org/zh/docs/apisix/terminology/plugin/#%E6%8F%92%E4%BB%B6%E5%90%88%E5%B9%B6%E4%BC%98%E5%85%88%E9%A1%BA%E5%BA%8F">插件合并优先顺序</a></p>
<p>（4）<a target="_blank" rel="noopener" href="https://apisix.apache.org/zh/docs/apisix/terminology/plugin/#%E6%8F%92%E4%BB%B6%E5%90%88%E5%B9%B6%E4%BC%98%E5%85%88%E9%A1%BA%E5%BA%8F">插件优先级</a></p>
<p>（5）配置</p>
<p>    插件从使用上，分为如下三种配置方式：</p>
<ul>
<li><p>metadata</p>
<p>使用API维护插件的公共配置。</p>
</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在插件中通过如下代码获取metadata的公共配置</span></span><br><span class="line"><span class="keyword">local</span> plugin = <span class="built_in">require</span>(<span class="string">&quot;apisix.plugin&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> metadata = plugin.plugin_metadata(plugin_name)</span><br><span class="line"><span class="keyword">if</span> metadata <span class="keyword">and</span> metadata.value <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        redis_host = metadata.value.redis_host,</span><br><span class="line">        redis_port = metadata.value.redis_port,</span><br><span class="line">        redis_password = metadata.value.redis_password,</span><br><span class="line">        redis_database = metadata.value.redis_database</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li>attribute<br>使用配置文件维护插件的公共配置。</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在插件中通过如下代码获取attribute的公共配置</span></span><br><span class="line"><span class="keyword">local</span> plugin = <span class="built_in">require</span>(<span class="string">&quot;apisix.plugin&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> attr = plugin.plugin_attr(plugin_name)</span><br><span class="line"><span class="keyword">if</span> attr <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        redis_host = attr.redis_host,</span><br><span class="line">        redis_port = attr.redis_port,</span><br><span class="line">        redis_password = attr.redis_password,</span><br><span class="line">        redis_database = attr.redis_database</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>config</p>
<p>插件配置在具体对象上的个性化配置，通过启用时的配置字段配置。</p>
</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在插件中通过如下代码获取个性化配置</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.access</span><span class="params">(conf, ctx)</span></span></span><br><span class="line">    env = conf.env</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p>    Apisix通过Lua代码在内存中构建radixtree来支持路由匹配，相较于传统ingress controller路由维护在nginx.conf文件中，每次路由更新都需要执行nginx的reload，显著减少了reload的次数，对长连接更加友好。</p>
<p>    目前支持三种路由匹配方式：</p>
<ul>
<li><p>radixtree_uri：只使用uri作为主索引，支持精确和前缀匹配。优先精确匹配。</p>
</li>
<li><p>radixtree_uri_with_parameter：同radixtree_uri，支持可变参数匹配。</p>
</li>
<li><p>radixtree_host_uri：默认使用host+uri作为主索引，支持精确和前缀匹配。优先精确匹配。</p>
</li>
</ul>
<h3 id="服务"><a href="#服务" class="headerlink" title="服务"></a>服务</h3><p>    服务是Apisix中的概念，区别于K8s中的服务，服务与Apisix的上游是一一对应的，与Apisix中的路由是一对N的关系，可以理解为：一个服务对应一个上游服务的一组路由。</p>
<p><img src="apisix-service.jpg"></p>
<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><p>    Apisix除支持在上游服务直接填写域名或者是IP的后端之外，还支持与多种注册中心（consul、nacos、eureka、DNS、K8s、ZK等）对接，可自动发现注册中的后端地址，并填写到Apisix的上游服务中的Node中。</p>
<p>    这里重点关注K8s服务。主要分为如下步骤：</p>
<p>（1）在Apisix配置文件的注册中心中填写K8s的连接信息（注意授权service、endpoints等必要的资源）。</p>
<p>（2）在填写上游服务时，按照如下格式填写：[id]/[namespace]/[name]:[portName]。</p>
<h1 id="落地方案"><a href="#落地方案" class="headerlink" title="落地方案"></a>落地方案</h1><p>    之前业务采用了一个集中式的Apisix的网关，将所有流量收归到这个单点的网关，然后分发给各个集群的外部流量入口，存在明显缺点：</p>
<ul>
<li><p>单点故障，网关压力大，一旦出现问题，整个平台所承载的系统将无法使用。</p>
</li>
<li><p>链路长，延时高，跨集群的调用，需要经过网关-&gt;集群X的负载均衡-&gt;应用服务。</p>
</li>
</ul>
<p>    经过考虑后，将网关拆分到各个集群中，每个平台业务根据自身所在的集群，使用当前集群的网关，同时各个网关互为主备，可提供一定的主备容灾能力。</p>
<p><img src="api7ee3-impl.jpg"></p>
<blockquote>
<p>目前网关认证鉴权等插件依赖的Redis，只做了主备，没有进行异地拆分，跨地域调用的架构有优化的空间。 </p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>    网关的建设过程中，调研了许多的技术方案，一直着眼在WASM、Envoy等比较热的技术点，因为认识不足，一直对OpenResty+Lua这组网关方案不太感冒，后续公司采购了API7的产品，通过学习和使用，原有的成见都被一一解答，才认识到这组网关方案的强大-Apisix只依靠Nginx的内核及扩展，使用Lua脚本语言和关系型数据库，构建了一组完整的Restful API（admin API）来管理网关的控制面，并通过Lua脚本在Nginx处理请求的各个阶段插桩执行自定义的代码，扩展Nginx的能力，这使得Apisix在网关方案和API管理领域日渐风靡，炙手可热，敢与一众基于envoy的云原生网关掰手腕。由此可见，无知是原罪，想要选出的技术方案，就必须首先有广阔的技术视野和认知，当下最热的不一定就是最合适的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2024/08/13/%E8%BF%90%E7%BB%B4%E6%9D%82%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/13/%E8%BF%90%E7%BB%B4%E6%9D%82%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/" class="post-title-link" itemprop="url">运维杂记（一）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-13 00:00:00" itemprop="dateCreated datePublished" datetime="2024-08-13T00:00:00+08:00">2024-08-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/" itemprop="url" rel="index"><span itemprop="name">运维实践</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>    最近在排查用户问题时，遇到一些棘手的问题，因本身知识&amp;技能不足，特此记录备忘。</p>
<h1 id="运维记录"><a href="#运维记录" class="headerlink" title="运维记录"></a>运维记录</h1><h2 id="漏洞扫描显示某个端口加密算法不安全"><a href="#漏洞扫描显示某个端口加密算法不安全" class="headerlink" title="漏洞扫描显示某个端口加密算法不安全"></a>漏洞扫描显示某个端口加密算法不安全</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>    开通DMZ服务器公网访问时，安全部门扫描显示服务器8443端口存在安全漏洞（CVE-2016-2183,CVE-2016-6329），这几台服务器部署着我们的ingress controller（版本：ingress-nginx-controller:v1.1.3），而这个端口是webhook的调用端口。</p>
<p>    扫描工具显示的问题如下：<strong>支持</strong> <strong>SSL</strong> <strong>中等强度密码组</strong> <strong>(SWEET32)</strong></p>
<blockquote>
<p>远程主机支持在一个或多个密码套件中使用 64 位块的块密码。由于使用弱 64 位块密码，因而会受到一个称为 SWEET32 的漏洞影响。具有足够资源的中间人攻击者可利用此漏洞，通过“birthday”攻击检测会在固定密码与已知纯文本之间泄露 XOR 的冲突，进而泄露密码文本（例如安全 HTTPS Cookie），并可能导致劫持经认证的会话。概念验证表明，攻击者仅需 30 个小时就可以从 HTTPS 会话中恢复身份验证 cookie。请注意，在客户端和服务器之间通过相同的 TLS 连接发送大量请求的能力，是发动此攻击的重要条件。如果单个链接允许的请求数量有限，则会减轻该漏洞的严重性。该插件需要报告偏差，因为 Nessus 尚未检查该缓解措施。</p>
<p>Plugin Output: </p>
<p>  Medium Strength Ciphers (&gt; 64-bit and &lt; 112-bit key, or 3DES)</p>
<p>    Name                          Code             KEX           Auth     Encryption             MAC</p>
<p>    ———————-        ———-       —           —-     ———————  —</p>
<p>    ECDHE-RSA-DES-CBC3-SHA        0xC0, 0x12       ECDH          RSA      3DES-CBC(168)          SHA1</p>
<p>    DES-CBC3-SHA                  0x00, 0x0A       RSA           RSA      3DES-CBC(168)          SHA1</p>
</blockquote>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>    从安全扫描工具可以看出，问题在于暴露的端口支持在一个或多个密码套件中使用 64 位块的块密码。通过sslscan可以探测端口，并列出目前支持的密码套件。</p>
<p>   目前sslscan可以通过github上的指导文档在linux服务期上编译。扫描命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sslscan 10.xxx.xx.xx:8443</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者使用nmap --script ssl-enum-ciphers -p 8443 10.xxx.xx.xx</span></span><br></pre></td></tr></table></figure>

<p>扫描的结果如下：</p>
<p><img src="sslscan.jpeg"></p>
<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><ul>
<li><p>临时规避方案</p>
<p>因考虑到目前webhook的调用，只有在提交资源对象给apiServer后，apiServer才会发起对webhook的调用，目前临时的解决方案是在节点上通过iptables禁用了非来自apiServer的连接请求。</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -m tcp -p tcp --dport 8443 -j DROP</span><br><span class="line">iptables -I INPUT -m tcp -p tcp --dport 8443 -s 10.xx.xx.0/24 -j ACCEPT</span><br></pre></td></tr></table></figure>

<ul>
<li><p>最终解决方案</p>
<p>在ingress controller的源码中，禁用TLSv1.2的加密套件。</p>
</li>
</ul>
<p><img src="ingress-controller-TLSv1.3.jpeg"></p>
<h2 id="Https请求服务器解密查看"><a href="#Https请求服务器解密查看" class="headerlink" title="Https请求服务器解密查看"></a>Https请求服务器解密查看</h2><h3 id="背景-1"><a href="#背景-1" class="headerlink" title="背景"></a>背景</h3><p>    用户前端页面使用了类似于/xxxx <strong>%3A</strong>xxx来请求图片，请求流经集群的ingress nginx后，通过http转发给业务的apisix，apisix通过<strong>https协议</strong>转发给业务的上游服务。</p>
<p>    通过在nginx的pod中抓包显示：发送给apisix的服务并未进行decode。这点与Nginx的说明一致：<strong>没有定义URI和rewrite的path不会被decode</strong>。<img src="nginx-uri-passed.jpeg"></p>
<p>    目前排查到了apisix，需要判断apisix是否对转发的路径进行了decode，但是apisix使用了https协议，传统的抓包无法获取http协议的内容。</p>
<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>    数据包经应用的openssl包加密发送到内核后，在内核中是无法知道具体的数据内容的。需要在加密之前，读取到apisix发送的内容。目前大多数加密使用的都是openssl。可使用bpf工具在uprobe中附加调试程序打印加密之前的数据。</p>
<h3 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h3><p><a target="_blank" rel="noopener" href="https://blog.px.dev/ebpf-openssl-tracing/">Debugging with eBPF Part 3: Tracing SSL/TLS connections</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看进程的动态链接库</span></span><br><span class="line">ldd /proc/3648492/exe</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据进程ID查询OpenSSL的write 方法。</span></span><br><span class="line">bpftrace -l &#x27;u:/proc/3648492/root/usr/local/openresty/openssl111/lib/libssl.so.1.1:*&#x27;|grep -i write</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出, argN代表程序的参数</span></span><br><span class="line">BPFTRACE_STRLEN=200 bpftrace -e &#x27;u:/proc/3648492/root/usr/local/openresty/openssl111/lib/libssl.so.1.1:SSL_write &#123;printf(&quot;%s\n&quot;, str(arg1, arg2))&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>     apisix使用的openssl的动态库的地/usr/local/openresty/openssl111/lib。</p>
<p>    抓取到的结果，显示apisix确实对path进行了decode。<a target="_blank" rel="noopener" href="https://github.com/apache/apisix/issues/5654">apisix issue</a>    </p>
<p><img src="apisix-ssl.jpeg">    </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入容器内查看二进制文件的动态链接</span></span><br><span class="line">ldd /usr/local/openresty/bin/openresty</span><br><span class="line">nm --dynamic /usr/local/openresty/bin/openresty</span><br></pre></td></tr></table></figure>

<p><img src="ldd.jpeg"></p>
<h2 id="K8s短域名无法解析"><a href="#K8s短域名无法解析" class="headerlink" title="K8s短域名无法解析"></a>K8s短域名无法解析</h2><h3 id="背景-2"><a href="#背景-2" class="headerlink" title="背景"></a>背景</h3><p>    偶然的机会发现在pod中无法解析serviceName.namespace的域名，检查了dns设置和cordns的运行情况，百思不得其解。</p>
<h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>    比对了正常的和不正常Pod的dns配置发现如下差异，不正常的Pod没有设置ndots。</p>
<p><img src="dns-ndot.jpeg"></p>
<p>    ndot的说明：与search配合使用，如果查询的域名中包含的点数大于等于ndot，则会首先使用该域名进行解析。默认值是1，上限是15。</p>
<blockquote>
<p>ndots: n<br>                     Sets a threshold for the number of dots which must<br>                     appear in a name given to <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man3/res_query.3.html">res_query(3)</a> (see<br>                     <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man3/resolver.3.html">resolver(3)</a>) before an <em>initial absolute query</em> will<br>                     be made.  The default for <em>n</em> is 1, meaning that if<br>                     there are any dots in a name, the name will be<br>                     tried first as an absolute name before any <em>search</em><br>                     <em>list</em> elements are appended to it.  The value for<br>                     this option is silently capped to 。</p>
</blockquote>
<p>    有问题的Pod使用了alpine的镜像，使用了<a target="_blank" rel="noopener" href="https://wiki.musl-libc.org/functional-differences-from-glibc.html">musl</a>的dns解析库。其中有这样的说明。</p>
<p><img src="musl-resolve.jpeg"></p>
<p>    也就是说一旦域名大于等于ndot后（有问题的pod默认ndots=1），musl不会再使用search搜索。</p>
<h3 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h3><p>    需要注入ndots。目前都是公有云的local dns给注入的。</p>
<h2 id="MTU-amp-MSS-amp-DF"><a href="#MTU-amp-MSS-amp-DF" class="headerlink" title="MTU&amp;MSS&amp;DF"></a>MTU&amp;MSS&amp;DF</h2><h3 id="背景-3"><a href="#背景-3" class="headerlink" title="背景"></a>背景</h3><p>    正常部署的服务突然挂掉无法访问，经排查服务和网络都没有问题，后发现是MTU设置问题，借此来理解MTU、MSS（Maximum Segment Size）及IP数据报文中的DF。</p>
<h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wangquan1992/article/details/109028964">linux内核协议栈 TCP选项之MSS_linux查看mss-CSDN博客</a></p>
<p>   客户端和服务端在三次握手中的前两次，通过TCP首部的MSS选项来协商MSS的大小。</p>
<ol>
<li><p>客户端：发送syn的MSS的MSS选项，大小=MTU-40（IP头20+TCP头20）</p>
</li>
<li><p>服务端：接受到syn的MSS后，比较syn的MSS和用户通过套接字TCP_MAXSEG的最小值保存在mss_clamp中，该值会影响发送过程中MSS的选择。服务端发送syn+ack给客户端，此处对MSS的处理与客户端相同。</p>
</li>
<li><p>客户端：客户端收到sync+ack后，比较syn的MSS和用户通过套接字TCP_MAXSEG的最小值保存在mss_clamp中，该值会影响发送过程中MSS的选择。</p>
</li>
</ol>
<p>    TCP发送过程中会多次更新MSS的值，根据设备MTU或者当前最新的PMTU更新。</p>
<p><img src="mtu-mss.jpeg"></p>
<p>    在IP报文的有分片标志，一共三位，第1位保留，第2位代表DF：Don’t Fragment，如果设置为1代表不允许分片，第3位是MF：More Fragment，如果为1，代表后面还有分片，0代表最后一个分片。</p>
<p>    IP分片和重组发生在网络层，数据传输过程中，每个路由器的MTU可能不同，如果不允许分片，将会触发ICMP协议，将当前数据包丢弃，并把当前路由的MTU回传给源主机。</p>
<p>    TCP分段和重组发生在传输层。使用TCP协议一般会通过MSS协商数据包大小，所以很少会导致IP分片（UDP协议不会自己分段，或导致IP分片）。</p>
<h2 id="PromQL-remote-read不支持"><a href="#PromQL-remote-read不支持" class="headerlink" title="PromQL remote read不支持|"></a>PromQL remote read不支持|</h2><h3 id="背景-4"><a href="#背景-4" class="headerlink" title="背景"></a>背景</h3><p>    在总prometheus（使用remote read级联查询下级prometheus）中统计多个实例的数据，发现使用labelName =~’xxx|sss’并不生效。</p>
<h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><p>    所使用的labelName是通过external label添加上去的，原始的prometheus的指标中并不存在这个label。</p>
<h3 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h3><p>    拆开按每个指标查询，然后+。</p>
<h2 id="otel-processors-无法读取HostNetwork的Pod标签"><a href="#otel-processors-无法读取HostNetwork的Pod标签" class="headerlink" title="otel processors 无法读取HostNetwork的Pod标签"></a>otel processors 无法读取HostNetwork的Pod标签</h2><h3 id="背景-5"><a href="#背景-5" class="headerlink" title="背景"></a>背景</h3><p>    otel collector中使用processor读取pod的label通过指定的规则附加到上报链路跟踪数据中，将Pod改成hostNetwork后，通过抓包发现上报的指标没有了pod的标签。</p>
<h3 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h3><p>    processor是通过pod的ip来识别具体的pod的，hostNetwork使用了宿主机的IP。无法查询是哪个pod的标签。</p>
<h3 id="解决-4"><a href="#解决-4" class="headerlink" title="解决"></a>解决</h3><p>    通过在otel 插件中自定义上报的属性数据来上报信息。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2023/12/25/%E5%88%9D%E8%AF%86%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/25/%E5%88%9D%E8%AF%86%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">初识机器学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-12-25 00:00:00" itemprop="dateCreated datePublished" datetime="2023-12-25T00:00:00+08:00">2023-12-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="人工智能"><a href="#人工智能" class="headerlink" title="人工智能"></a>人工智能</h2><p>    人工智能（全称 <em>A</em>rtificial <em>I</em>ntelligence）是一个构建能够推理、学习和行动的计算机和机器的科学领域，这种推理、学习和行动通常需要人类智力，或者涉及超出人类分析能力的数据规模。</p>
<p>    AI 是一个广博的领域，涵盖许多不同的学科，包括计算机科学、数据分析和统计、硬件和软件工程、语言学、神经学，甚至哲学和心理学。</p>
<h2 id="机器学习"><a href="#机器学习" class="headerlink" title="机器学习"></a>机器学习</h2><p>    机器学习（<em>M</em>achine <em>L</em>earning）是人工智能的一个子集，它使用算法训练数据来获取结果。主要分为如下学习模型:</p>
<ul>
<li><p>监督式（Supervised）</p>
<p>给定有标记的数据集，预测新输入的预期输出，例如分类、回归。</p>
</li>
<li><p>非监督式（Unsupervised）</p>
<p>从无标记的数据集中寻找隐藏的关系结构，例如聚类分析。</p>
</li>
<li><p>半监督学习</p>
<p>有些算法可以处理部分标记的训练数据，通常是大量未标记的数据和少量标记的数据；监督学习算法都是无监督和监督算法的结合。</p>
</li>
<li><p>强化学习（Reinforcement）</p>
<p>与环境交互得到反馈后，修正自己的行为。它模仿了人类为实现目标所采取的反复试验的学习过程</p>
</li>
</ul>
<blockquote>
<p>使用<strong>深层神经网络模型</strong>的被称为<strong>深度学习</strong>。</p>
</blockquote>
<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h2><h3 id="过拟合"><a href="#过拟合" class="headerlink" title="过拟合"></a>过拟合</h3><blockquote>
<p>Learning the parameters of a prediction function and testing it on the same data is a methodological mistake: a model that would just repeat the labels of the samples that it has just seen would have a perfect score but would fail to predict anything useful on yet-unseen data. This situation is called <strong>overfitting</strong> .</p>
</blockquote>
<p><img src="overfitting.jpg"></p>
<h3 id="超参数"><a href="#超参数" class="headerlink" title="超参数"></a>超参数</h3><p>    学习到的是参数；人为指定的是超参数，例如神经网络的层数、神经元的个数、SVM的C及核函数等。需要通过反复试验得到最佳的超参数组合，以使模型的准确性和性能达到最优。</p>
<p>    ​ 在超参数集中搜索以获得最佳<a target="_blank" rel="noopener" href="http://scikit-learn.org.cn/view/6.html">cross validation</a>交叉验证分数的方法是可实现并且推荐的。常用的方法有<strong>网格搜索</strong>、<strong>随机搜索</strong>等。</p>
<h3 id="损失函数"><a href="#损失函数" class="headerlink" title="损失函数"></a>损失函数</h3><p>    预测数据与真实数据存在误差，可以使用一个函数来表示损失值的大小，例如使用预测值和真实值的<strong>均方误差</strong>。</p>
<h3 id="正则化"><a href="#正则化" class="headerlink" title="正则化"></a>正则化</h3><p>    将输出的数据，进行处理，使起更具有代表意义，例如代表输出值，按照总和100%重新计算。</p>
<p>        $s_i =\frac{e_i} {\sum_{i=1}^{j} e_i}$</p>
<h3 id="标准化-归一化"><a href="#标准化-归一化" class="headerlink" title="标准化/归一化"></a>标准化/归一化</h3><p>    对训练数据进行处理，使其更好看和更易处理。</p>
<h2 id="数据集"><a href="#数据集" class="headerlink" title="数据集"></a>数据集</h2><p>    数据集一般需要换分成如下部分使用：</p>
<ul>
<li><p>训练数据集：训练模型。</p>
</li>
<li><p>验证数据集：如果使用交叉验证，例如K折交叉验证（k-fold CV），可以不划分。</p>
</li>
<li><p>测试数据集：始终用于模型的最后评估。</p>
</li>
</ul>
<p>   在训练数据上对模型进行训练，利用验证集对模型进行评估。当“实验”得到一个较好的成绩时，在测试集上完成模型的最终评估。</p>
<p><img src="cross-validation.jpg"></p>
<h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h3><p>    机器学习有很多算法，这里只选取几个，稍加分析，以了解整个机器学习的开发流程。</p>
<h4 id="线性回归-Linear-regression）"><a href="#线性回归-Linear-regression）" class="headerlink" title="线性回归(Linear regression）"></a>线性回归(Linear regression）</h4><p>    线性回归基于一个或多个自变量预测因变量的值，它之所以被称为“线性”，那是因为它假设因变量和自变量之间的关系是线性的。</p>
<p>    $y=a_1<em>x_1+a_2</em>x_2+a_n*x_n+b$</p>
<p>    使用线性回归预测糖尿病一年后疾病进展的定量测量指标。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://scikit-learn.org.cn/view/230.html#</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets, linear_model</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> mean_squared_error, r2_score</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line">X,y = datasets.load_diabetes(return_X_y=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">X = X[:, np.newaxis, <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lr = linear_model.LinearRegression()</span><br><span class="line">lr.fit(X_train, y_train)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make predictions using the testing set</span></span><br><span class="line">y_predict = lr.predict(X_test)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The coefficients</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Coefficients: \n&#x27;</span>, lr.coef_)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The mean squared error</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Mean squared error: %.2f&#x27;</span> % mean_squared_error(y_test, y_predict))</span><br><span class="line"></span><br><span class="line"><span class="comment"># The coefficient of determination: 1 is perfect prediction</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Coefficient of determination: %.2f&#x27;</span> % r2_score(y_test, y_predict))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Plot outputs</span></span><br><span class="line">plt.scatter(X_test, y_test,  color=<span class="string">&#x27;black&#x27;</span>)</span><br><span class="line">plt.plot(X_test, y_predict, color=<span class="string">&#x27;blue&#x27;</span>, linewidth=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">plt.xticks(())</span><br><span class="line">plt.yticks(())</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="linear-regression-plot.jpg"></p>
<h4 id="逻辑回归（Logistic-regression）"><a href="#逻辑回归（Logistic-regression）" class="headerlink" title="逻辑回归（Logistic regression）"></a>逻辑回归（Logistic regression）</h4><p>    逻辑回归是一个分类模型，通常是基于一个或多个自变量预测二元结果的概率。</p>
<p>    $y=1/(1+exp(b+a_1<em>x_1+a_2</em>x_2+…+a_n*x_n))$</p>
<p>        $exp(x) = e^x$</p>
<p>    MATLAB中sig函数指的是Sigmoid函数，其公式为:</p>
<p>    $y = 1 / (1 + e^{-x})$</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://scikit-learn.org.cn/view/378.html</span></span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_iris</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"></span><br><span class="line">X,y = load_iris(return_X_y=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">lr = LogisticRegression(max_iter=<span class="number">1000</span>, random_state = <span class="number">0</span>).fit(X, y)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;预测X中的前两个元素的标签类别: &quot;</span>,lr.predict(X[:<span class="number">2</span>,:]))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;概率估计: &quot;</span>,lr.predict_proba(X[:<span class="number">2</span>,:]))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;返回给定测试数据和标签上的平均准确度: &quot;</span>,lr.score(X,y))</span><br></pre></td></tr></table></figure>

<h4 id="决策树-Decision-trees"><a href="#决策树-Decision-trees" class="headerlink" title="决策树(Decision trees)"></a>决策树(Decision trees)</h4><p>    决策树之所以被称为“决策”树，顾名思义，能根据数据集的特征进行预测，它通过数据构建一个类似树状的决策模型来工作，每个分支代表不同的决策或结果。<strong>决策树</strong>(DTs)是一种用于分类和回归的非参数有监督学习方法。</p>
<h4 id="随机森林-Random-forests"><a href="#随机森林-Random-forests" class="headerlink" title="随机森林(Random forests)"></a>随机森林(Random forests)</h4><p>    它通过创建一组决策树，并使用每棵树所做预测的平均值来进行最终预测，就类似于现实当中咱一群人投票，然后少数服从多数那样。</p>
<p>    通过投票分类器VotingClassifier组合三种分类算法LogisticRegression、GaussianNB、 RandomForestClassifier，来计算分类的平均概率。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://scikit-learn.org.cn/view/171.html</span></span><br><span class="line"><span class="built_in">print</span>(__doc__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"><span class="keyword">from</span> sklearn.naive_bayes <span class="keyword">import</span> GaussianNB</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> VotingClassifier</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_wine</span><br><span class="line"></span><br><span class="line">lr = LogisticRegression(max_iter=<span class="number">10000</span>, random_state=<span class="number">100</span>)</span><br><span class="line">rf = RandomForestClassifier(n_estimators=<span class="number">100</span>, random_state=<span class="number">100</span>)</span><br><span class="line">gnb = GaussianNB()</span><br><span class="line"></span><br><span class="line"><span class="comment"># X,y = load_wine(return_X_y=True)</span></span><br><span class="line">X = np.array([[-<span class="number">1.0</span>, -<span class="number">1.0</span>], [-<span class="number">1.2</span>, -<span class="number">1.4</span>], [-<span class="number">3.4</span>, -<span class="number">2.2</span>], [<span class="number">1.1</span>, <span class="number">1.2</span>]])</span><br><span class="line">y = np.array([<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">vc = VotingClassifier(estimators=[(<span class="string">&#x27;lr&#x27;</span>, lr), (<span class="string">&#x27;rf&#x27;</span>, rf), (<span class="string">&#x27;gnb&#x27;</span>, gnb)], voting=<span class="string">&#x27;soft&#x27;</span>, weights=[<span class="number">1</span>,<span class="number">5</span>,<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">probas = [c.fit(X, y).predict_proba(X) <span class="keyword">for</span> c <span class="keyword">in</span> (lr, rf, gnb, vc)]</span><br><span class="line"></span><br><span class="line">c1 = [pr[<span class="number">0</span>, <span class="number">0</span>] <span class="keyword">for</span> pr <span class="keyword">in</span> probas]</span><br><span class="line">c2 = [pr[<span class="number">0</span>, <span class="number">1</span>] <span class="keyword">for</span> pr <span class="keyword">in</span> probas]</span><br><span class="line"><span class="comment"># c3 = [pr[0, 2] for pr in probas]</span></span><br><span class="line"></span><br><span class="line">N = <span class="number">4</span>  <span class="comment"># number of groups</span></span><br><span class="line">ind = np.arange(N)  <span class="comment"># group positions</span></span><br><span class="line">width = <span class="number">0.35</span>  <span class="comment"># bar width</span></span><br><span class="line"></span><br><span class="line">fig, ax = plt.subplots()</span><br><span class="line"></span><br><span class="line">p1 = ax.bar(ind, np.hstack(([c1[:-<span class="number">1</span>], [<span class="number">0</span>]])), width, color=<span class="string">&#x27;green&#x27;</span>, edgecolor=<span class="string">&#x27;k&#x27;</span>)</span><br><span class="line">p2 = ax.bar(ind + width, np.hstack(([c2[:-<span class="number">1</span>], [<span class="number">0</span>]])), width, color=<span class="string">&#x27;lightgreen&#x27;</span>, edgecolor=<span class="string">&#x27;k&#x27;</span>)</span><br><span class="line"><span class="comment"># p3 = ax.bar(ind + width, np.hstack(([c3[:-1], [0]])), width, color=&#x27;red&#x27;, edgecolor=&#x27;k&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bars for VotingClassifier</span></span><br><span class="line">p4 = ax.bar(ind, [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, c1[-<span class="number">1</span>]], width, color=<span class="string">&#x27;blue&#x27;</span>, edgecolor=<span class="string">&#x27;k&#x27;</span>)</span><br><span class="line">p5 = ax.bar(ind + width, [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, c2[-<span class="number">1</span>]], width, color=<span class="string">&#x27;steelblue&#x27;</span>, edgecolor=<span class="string">&#x27;k&#x27;</span>)</span><br><span class="line"><span class="comment"># p6 = ax.bar(ind + width, [0, 0, 0, c3[-1]], width, color=&#x27;steelblue&#x27;, edgecolor=&#x27;k&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># plot annotations</span></span><br><span class="line">plt.axvline(<span class="number">2.8</span>, color=<span class="string">&#x27;k&#x27;</span>, linestyle=<span class="string">&#x27;dashed&#x27;</span>)</span><br><span class="line">ax.set_xticks(ind + width)</span><br><span class="line">ax.set_xticklabels([<span class="string">&#x27;LogisticRegression\nweight 1&#x27;</span>, <span class="string">&#x27;RandomForestClassifier\nweight 5&#x27;</span>, <span class="string">&#x27;GaussianNB\nweight 1&#x27;</span>, <span class="string">&#x27;VotingClassifier\n(average probabilities)&#x27;</span>], rotation=<span class="number">40</span>, ha=<span class="string">&#x27;right&#x27;</span>)</span><br><span class="line">plt.ylim([<span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line">plt.title(<span class="string">&#x27;Class probabilities for sample 1 by different classifiers&#x27;</span>)</span><br><span class="line">plt.legend([p1[<span class="number">0</span>], p2[<span class="number">0</span>]], [<span class="string">&#x27;class 1&#x27;</span>, <span class="string">&#x27;class 2&#x27;</span>], loc=<span class="string">&#x27;upper left&#x27;</span>)</span><br><span class="line"><span class="comment"># plt.legend([p1[0], p2[0], p3[0]], [&#x27;class 1&#x27;, &#x27;class 2&#x27;, &#x27;class 3&#x27;], loc=&#x27;upper left&#x27;)</span></span><br><span class="line">plt.tight_layout()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="voting-classifier-plot.jpg"></p>
<h4 id="K最近邻（KNN）"><a href="#K最近邻（KNN）" class="headerlink" title="K最近邻（KNN）"></a>K最近邻（KNN）</h4><p>    它大概的原理是通过找到离给定数据点最近的K个数据点，并利用这些数据点的类别或数值来进行预测。</p>
<h4 id="K均值聚类算法-K-Means"><a href="#K均值聚类算法-K-Means" class="headerlink" title="K均值聚类算法(K-Means)"></a>K均值聚类算法(K-Means)</h4><p>    无监督学习算法。与KNN底层原理很像，但是是用来聚类的。</p>
<h4 id="支持向量机（SVM）"><a href="#支持向量机（SVM）" class="headerlink" title="支持向量机（SVM）"></a>支持向量机（SVM）</h4><p>    支持向量机（Support Vector Machines，SVM）最初的设计是用来解决二分类问题，后来扩展到多分类问题。</p>
<p>    使用Iris数据集的两个特征绘制投票分类器的决策边界。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://scikit-learn.org.cn/view/167.html</span></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">from</span> sklearn.tree <span class="keyword">import</span> DecisionTreeClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> VotingClassifier</span><br><span class="line"></span><br><span class="line">iris = datasets.load_iris()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取了所有行的第0列和第2列</span></span><br><span class="line">X = iris.data[:, [<span class="number">0</span>, <span class="number">2</span>]]</span><br><span class="line">y = iris.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dtc = DecisionTreeClassifier(max_depth=<span class="number">4</span>)</span><br><span class="line">knc = KNeighborsClassifier(n_neighbors=<span class="number">7</span>)</span><br><span class="line">svc = SVC(gamma=<span class="number">.1</span>, kernel=<span class="string">&#x27;rbf&#x27;</span>, probability=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">vc = VotingClassifier(estimators=[(<span class="string">&#x27;dtc&#x27;</span>, dtc), (<span class="string">&#x27;knc&#x27;</span>, knc), (<span class="string">&#x27;svc&#x27;</span>, svc)], voting=<span class="string">&#x27;soft&#x27;</span>, weights=[<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">dtc.fit(X, y)</span><br><span class="line">knc.fit(X, y)</span><br><span class="line">svc.fit(X, y)</span><br><span class="line">vc.fit(X, y)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Plotting decision regions</span></span><br><span class="line">x_min, x_max = X[:,<span class="number">0</span>].<span class="built_in">min</span>() - <span class="number">1</span>, X[:,<span class="number">0</span>].<span class="built_in">max</span>() + <span class="number">1</span></span><br><span class="line">y_min, y_max = X[:,<span class="number">1</span>].<span class="built_in">min</span>() - <span class="number">1</span>, X[:,<span class="number">1</span>].<span class="built_in">max</span>() + <span class="number">1</span></span><br><span class="line">xx, yy = np.meshgrid(np.arange(x_min, x_max, <span class="number">0.1</span>), np.arange(y_min, y_max, <span class="number">0.1</span>))</span><br><span class="line"></span><br><span class="line">f, axarr = plt.subplots(<span class="number">2</span>, <span class="number">2</span>, sharex = <span class="string">&#x27;col&#x27;</span>, sharey = <span class="string">&#x27;row&#x27;</span>, figsize=(<span class="number">19</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> idx, clf, tt <span class="keyword">in</span> <span class="built_in">zip</span>(product([<span class="number">0</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">1</span>]), [dtc, knc, svc, vc], [<span class="string">&#x27;Decision Tree (depth=4)&#x27;</span>, <span class="string">&#x27;KNN (k=7)&#x27;</span>, <span class="string">&#x27;Kernel SVM&#x27;</span>, <span class="string">&#x27;Soft Voting&#x27;</span>]):</span><br><span class="line">    Z = clf.predict(np.c_[xx.ravel(), yy.ravel()])</span><br><span class="line">    Z = Z.reshape(xx.shape)</span><br><span class="line"></span><br><span class="line">    axarr[idx[<span class="number">0</span>], idx[<span class="number">1</span>]].contourf(xx, yy, Z, alpha=<span class="number">0.4</span>)</span><br><span class="line">    axarr[idx[<span class="number">0</span>], idx[<span class="number">1</span>]].scatter(X[:, <span class="number">0</span>], X[:, <span class="number">1</span>], c=y, s=<span class="number">20</span>, edgecolor=<span class="string">&#x27;k&#x27;</span>)</span><br><span class="line">    axarr[idx[<span class="number">0</span>], idx[<span class="number">1</span>]].set_title(tt)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="voting-classifier-border.jpg"></p>
<h4 id="朴素贝叶斯-Naive-Bayes"><a href="#朴素贝叶斯-Naive-Bayes" class="headerlink" title="朴素贝叶斯(Naive Bayes)"></a>朴素贝叶斯(Naive Bayes)</h4><p>    朴素贝叶斯是一种基于贝叶斯定理进行预测的机器学习算法，它之所以被称为“朴素”是因为它假设数据集当中的所有特征都是相互独立的，而在现实世界的数据中当然肯定不是这样的。</p>
<h4 id="神经网络-Neural-networks"><a href="#神经网络-Neural-networks" class="headerlink" title="神经网络(Neural networks)"></a>神经网络(Neural networks)</h4><p>    神经网络是一种受到人脑结构和功能启发而研发出来的机器学习算法，模型结构由大量相互连接的节点(神经元)组成，模拟人脑的机制用于处理和传输信息。</p>
<p>    深度学习中的“深度”只是指神经网络中层的深度。 由三个以上的层组成的神经网络（包含输入和输出）即可视为深度学习算法。 只有两层或三层的神经网络只是基本神经网络。</p>
<h5 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h5><p>    （多层）感知机 MLP = 输入层 + 0个或多个隐藏层 + 输出层。</p>
<p><img src="MLP.jpg"></p>
<p>    根据数据的流转方向，分为：</p>
<ul>
<li><p>前馈神经网络</p>
<p>输入数据，从输入层依次流向各隐藏层和输出层，没有同层之前的数据传递，后面层的输出数据也不会传递给前面层作为输入。</p>
<blockquote>
<p>卷积神经网络（CNN）类似于前馈网络，但它们通常用于图像识别、模式识别和/或计算机视觉处理。 这些卷积神经网络利用线性代数中的原理（尤其是矩阵乘法）来识别图像中的模式。</p>
</blockquote>
</li>
<li><p>反馈神经网络</p>
<p>输出数据可以作为同层或者上层的输入数据，并且需要考虑输出和输入之间的之后效应。</p>
<blockquote>
<p>循环神经网络（RNN）由其反馈回路来识别。 利用时间序列数据预测未来结果时，主要使用这些学习算法，比如股市预测或销量预测。</p>
</blockquote>
</li>
</ul>
<p><img src="neural-networks.jpg"></p>
<h5 id="神经元"><a href="#神经元" class="headerlink" title="神经元"></a>神经元</h5><p>    网络层中处理信息的基本单元是M-P神经元模型。</p>
<p><img src="M-P.jpg"></p>
<ol>
<li><p>$x_1$ ~ $x_n$ 为输入，数量一般为特征（因变量）的数量。</p>
</li>
<li><p>$w_1$ ~ $w_n$ 为每个x对应的权重，可以理解为对计算结果的重要性。</p>
</li>
<li><p>激活函数（Activation），通过聚合因变量x*权重w，并辅以Bias阈值，来决定最终的计算结果$\widehat{y}$，常见的激活函数图形如下：</p>
</li>
</ol>
<p><img src="activation-function.jpg"></p>
<h5 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h5><p>    <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/377513272">机器学习初学：神经网络原理 + Python 简单实例</a></p>
<p>    <a target="_blank" rel="noopener" href="https://victorzhou.com/blog/intro-to-neural-networks/">Machine Learning for Beginners: An Introduction to Neural Networks</a></p>
<p><img src="neuron-network-demo.jpg"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://zhuanlan.zhihu.com/p/377513272</span></span><br><span class="line"><span class="comment"># https://victorzhou.com/blog/intro-to-neural-networks/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="comment"># Sigmoid 激活函数: f(x) = 1 / (1 + e^(-x))</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> / <span class="number">1</span> + np.exp(-x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deriv_sigmoid</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="comment"># Sigmoid 的导数: f&#x27;(x) = f(x) * (1 - f(x))</span></span><br><span class="line">    fx = sigmoid(x)</span><br><span class="line">    <span class="keyword">return</span> fx * (<span class="number">1</span> - fx)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mse_loss</span>(<span class="params">y_true, y_pred</span>):</span></span><br><span class="line">    <span class="comment"># y_true and y_pred 都是等长度的 numpy 数组.</span></span><br><span class="line">    <span class="keyword">return</span> ((y_true - y_pred)**<span class="number">2</span>).mean()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NeuralNetwork</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.w1 = np.random.normal()</span><br><span class="line">        self.w2 = np.random.normal()</span><br><span class="line">        self.w3 = np.random.normal()</span><br><span class="line">        self.w4 = np.random.normal()</span><br><span class="line">        self.w5 = np.random.normal()</span><br><span class="line">        self.w6 = np.random.normal()</span><br><span class="line"></span><br><span class="line">        self.b1 = np.random.normal()</span><br><span class="line">        self.b2 = np.random.normal()</span><br><span class="line">        self.b3 = np.random.normal()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">feedforward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        h1 = sigmoid(self.w1 * x[<span class="number">0</span>] + self.w2 * x[<span class="number">1</span>] + self.b1)</span><br><span class="line">        h2 = sigmoid(self.w3 * x[<span class="number">0</span>] + self.w4 * x[<span class="number">1</span>] + self.b2)</span><br><span class="line"></span><br><span class="line">        o1 = sigmoid(self.w5 * h1 + self.w6 * h2 + self.b3)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> o1</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">train</span>(<span class="params">self, data, all_y_trues</span>):</span></span><br><span class="line">        learn_rate = <span class="number">0.1</span></span><br><span class="line">        epochs = <span class="number">1000</span></span><br><span class="line">        lossdata = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(epochs):</span><br><span class="line">            <span class="keyword">for</span> x, y_true <span class="keyword">in</span> <span class="built_in">zip</span>(data, all_y_trues):</span><br><span class="line">                sum_h1 = self.w1 * x[<span class="number">0</span>] + self.w2 * x[<span class="number">1</span>] + self.b1</span><br><span class="line">                h1 = sigmoid(sum_h1)</span><br><span class="line"></span><br><span class="line">                sum_h2 = self.w3 * x[<span class="number">0</span>] + self.w4 * x[<span class="number">1</span>] + self.b2</span><br><span class="line">                h2 = sigmoid(sum_h2)</span><br><span class="line"></span><br><span class="line">                sum_o1 = self.w5 * h1 + self.w6 * h2 + self.b3</span><br><span class="line">                o1 = sigmoid(sum_o1)</span><br><span class="line">                y_pred = o1</span><br><span class="line"></span><br><span class="line">                <span class="comment"># --- 计算偏导数.</span></span><br><span class="line">                <span class="comment"># --- 命名方式：d_L_d_w1 代表 &quot;dL / dw1&quot;，即 L对 w1求偏导</span></span><br><span class="line">                d_L_d_ypred = -<span class="number">2</span> * (y_true - y_pred)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 神经元 o1</span></span><br><span class="line">                d_ypred_d_w5 = h1 * deriv_sigmoid(sum_o1)</span><br><span class="line">                d_ypred_d_w6 = h2 * deriv_sigmoid(sum_o1)</span><br><span class="line">                d_ypred_d_b3 = deriv_sigmoid(sum_o1)</span><br><span class="line"></span><br><span class="line">                d_ypred_d_h1 = self.w5 * deriv_sigmoid(sum_o1)</span><br><span class="line">                d_ypred_d_h2 = self.w6 * deriv_sigmoid(sum_o1)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 神经元 h1</span></span><br><span class="line">                d_h1_d_w1 = x[<span class="number">0</span>] * deriv_sigmoid(sum_h1)</span><br><span class="line">                d_h1_d_w2 = x[<span class="number">1</span>] * deriv_sigmoid(sum_h1)</span><br><span class="line">                d_h1_d_b1 = deriv_sigmoid(sum_h1)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 神经元 h2</span></span><br><span class="line">                d_h2_d_w3 = x[<span class="number">0</span>] * deriv_sigmoid(sum_h2)</span><br><span class="line">                d_h2_d_w4 = x[<span class="number">1</span>] * deriv_sigmoid(sum_h2)</span><br><span class="line">                d_h2_d_b2 = deriv_sigmoid(sum_h2)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># --- 更新权重（w）与偏移量（b）</span></span><br><span class="line">                <span class="comment"># 神经元 h1</span></span><br><span class="line">                self.w1 -= learn_rate * d_L_d_ypred * d_ypred_d_h1 * d_h1_d_w1</span><br><span class="line">                self.w2 -= learn_rate * d_L_d_ypred * d_ypred_d_h1 * d_h1_d_w2</span><br><span class="line">                self.b1 -= learn_rate * d_L_d_ypred * d_ypred_d_h1 * d_h1_d_b1</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 神经元 h2</span></span><br><span class="line">                self.w3 -= learn_rate * d_L_d_ypred * d_ypred_d_h2 * d_h2_d_w3</span><br><span class="line">                self.w4 -= learn_rate * d_L_d_ypred * d_ypred_d_h2 * d_h2_d_w4</span><br><span class="line">                self.b2 -= learn_rate * d_L_d_ypred * d_ypred_d_h2 * d_h2_d_b2</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 神经元 o1</span></span><br><span class="line">                self.w5 -= learn_rate * d_L_d_ypred * d_ypred_d_w5</span><br><span class="line">                self.w6 -= learn_rate * d_L_d_ypred * d_ypred_d_w6</span><br><span class="line">                self.b3 -= learn_rate * d_L_d_ypred * d_ypred_d_b3</span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- 在每10次迭代结束后计算总 loss并打印出来</span></span><br><span class="line">            <span class="keyword">if</span> epoch % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">                y_preds = np.apply_along_axis(self.feedforward, <span class="number">1</span>, data)</span><br><span class="line">                loss = mse_loss(all_y_trues, y_preds)</span><br><span class="line">                lossdata.append(loss)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Epoch %d loss: %.3f&quot;</span> % (epoch, loss))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> lossdata</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义数据集 data</span></span><br><span class="line">data = np.array([</span><br><span class="line">    [-<span class="number">2</span>, -<span class="number">1</span>],  <span class="comment"># Alice</span></span><br><span class="line">    [<span class="number">25</span>, <span class="number">6</span>],  <span class="comment"># Bob</span></span><br><span class="line">    [<span class="number">17</span>, <span class="number">4</span>],  <span class="comment"># Charlie</span></span><br><span class="line">    [-<span class="number">15</span>, -<span class="number">6</span>],  <span class="comment"># Diana</span></span><br><span class="line">])</span><br><span class="line">all_y_trues = np.array([</span><br><span class="line">    <span class="number">1</span>,  <span class="comment"># Alice</span></span><br><span class="line">    <span class="number">0</span>,  <span class="comment"># Bob</span></span><br><span class="line">    <span class="number">0</span>,  <span class="comment"># Charlie</span></span><br><span class="line">    <span class="number">1</span>,  <span class="comment"># Diana</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练我们的神经网络!</span></span><br><span class="line">network = NeuralNetwork()</span><br><span class="line">lossdata = network.train(data, all_y_trues)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 神经网络预测</span></span><br><span class="line">emily = np.array([-<span class="number">7</span>, -<span class="number">3</span>])  <span class="comment"># 128 磅, 63 英寸</span></span><br><span class="line">frank = np.array([<span class="number">20</span>, <span class="number">2</span>])   <span class="comment"># 155 磅, 68 英寸</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Emily: %.3f&quot;</span> % network.feedforward(emily))  <span class="comment"># 0.951 - 女性</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Frank: %.3f&quot;</span> % network.feedforward(frank))  <span class="comment"># 0.039 - 男性</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.add_subplot(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">ax.set_xlabel(<span class="string">&quot;epoch&quot;</span>)  <span class="comment"># 横坐标名</span></span><br><span class="line">ax.set_ylabel(<span class="string">&quot;loss&quot;</span>)   <span class="comment"># 纵坐标名</span></span><br><span class="line">ax.set_title(<span class="string">&quot;Neural Network Loss vs. Epochs&quot;</span>)</span><br><span class="line"></span><br><span class="line">epoch = <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">1000</span>, <span class="number">10</span>)  <span class="comment"># 100个点</span></span><br><span class="line">plt.plot(epoch, lossdata)  <span class="comment"># 绘图</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="neuron-network-demo-plot.jpg"></p>
<h3 id="评估"><a href="#评估" class="headerlink" title="评估"></a>评估</h3><h4 id="ROC-amp-AUC"><a href="#ROC-amp-AUC" class="headerlink" title="ROC &amp; AUC"></a>ROC &amp; AUC</h4><p>    纵坐标为 <strong>正例中被判断为正例的比率（TPR=TP/(TP+FN)</strong> ，**横坐标为负例中被判断为正例的比率（FPR=FP/(FP+TN)**，不断调整阈值就可以得到ROC曲线。</p>
<p>    ROC 曲线下方的那部分面积的大小。通常，AUC的值介于0.5到1.0之间，较大的AUC代表了较好的性能。AUC（Area Under roc Curve）是一种用来度量分类模型好坏的一个标准。</p>
<p><img src="roc-auc.jpg"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://scikit-learn.org/stable/visualizations.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_wine</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> RocCurveDisplay</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br><span class="line"></span><br><span class="line">X, y = load_wine(return_X_y=<span class="literal">True</span>)</span><br><span class="line">y = y == <span class="number">2</span></span><br><span class="line"></span><br><span class="line">X_train, X_test, y_train, y_test = train_test_split(X, y, random_state=<span class="number">42</span>)</span><br><span class="line">svc = SVC(random_state=<span class="number">42</span>)</span><br><span class="line">svc.fit(X_train, y_train)</span><br><span class="line"></span><br><span class="line"><span class="comment"># %%</span></span><br><span class="line"><span class="comment"># Plotting the ROC Curve</span></span><br><span class="line"><span class="comment"># ----------------------</span></span><br><span class="line"><span class="comment"># Next, we plot the ROC curve with a single call to</span></span><br><span class="line"><span class="comment"># :func:`sklearn.metrics.RocCurveDisplay.from_estimator`. The returned</span></span><br><span class="line"><span class="comment"># `svc_disp` object allows us to continue using the already computed ROC curve</span></span><br><span class="line"><span class="comment"># for the SVC in future plots.</span></span><br><span class="line">svc_disp = RocCurveDisplay.from_estimator(svc, X_test, y_test)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># %%</span></span><br><span class="line"><span class="comment"># Training a Random Forest and Plotting the ROC Curve</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------</span></span><br><span class="line"><span class="comment"># We train a random forest classifier and create a plot comparing it to the SVC</span></span><br><span class="line"><span class="comment"># ROC curve. Notice how `svc_disp` uses</span></span><br><span class="line"><span class="comment"># :func:`~sklearn.metrics.RocCurveDisplay.plot` to plot the SVC ROC curve</span></span><br><span class="line"><span class="comment"># without recomputing the values of the roc curve itself. Furthermore, we</span></span><br><span class="line"><span class="comment"># pass `alpha=0.8` to the plot functions to adjust the alpha values of the</span></span><br><span class="line"><span class="comment"># curves.</span></span><br><span class="line">rfc = RandomForestClassifier(n_estimators=<span class="number">10</span>, random_state=<span class="number">42</span>)</span><br><span class="line">rfc.fit(X_train, y_train)</span><br><span class="line">ax = plt.gca()</span><br><span class="line">rfc_disp = RocCurveDisplay.from_estimator(rfc, X_test, y_test, ax=ax, alpha=<span class="number">0.8</span>)</span><br><span class="line">svc_disp.plot(ax=ax, alpha=<span class="number">0.8</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="svm-roc-plot.jpg"></p>
<p><img src="svc-rf-roc-plot.jpg"></p>
<p>    从ROC曲线的AUC值来看，在这个测试用例中，随机森林的分类效果好于支持向量机。</p>
<h4 id="Cross-Validation"><a href="#Cross-Validation" class="headerlink" title="Cross-Validation"></a>Cross-Validation</h4><p>    为避免数据的划分影响模型的评估结果，可以不划分验证数据集。例如最基本的交叉验证方法是K折交叉验证（k-fold CV，将训练数据集划分为k个子集，以此充当验证数据集，循环执行。</p>
<p><img src="k-fold-CV.jpg"></p>
<h4 id="梯度下降"><a href="#梯度下降" class="headerlink" title="梯度下降"></a>梯度下降</h4><p>    通过数学中求导的方式，找到损失函数的最低点，以此来确定模型参数的最优解。</p>
<h4 id="反向传播（BP算法）"><a href="#反向传播（BP算法）" class="headerlink" title="反向传播（BP算法）"></a>反向传播（BP算法）</h4><p>    将损失值反向传播，重新运算，降低损失值，直到找到满意的参数组合。</p>
<h2 id="常用库"><a href="#常用库" class="headerlink" title="常用库"></a>常用库</h2><h3 id="numpy"><a href="#numpy" class="headerlink" title="numpy"></a>numpy</h3><h3 id="scikit-learn"><a href="#scikit-learn" class="headerlink" title="scikit-learn"></a>scikit-learn</h3><h3 id="pandas"><a href="#pandas" class="headerlink" title="pandas"></a>pandas</h3><h3 id="tensorflow"><a href="#tensorflow" class="headerlink" title="tensorflow"></a>tensorflow</h3><h3 id="pytorch"><a href="#pytorch" class="headerlink" title="pytorch"></a>pytorch</h3><h3 id="matplotlib"><a href="#matplotlib" class="headerlink" title="matplotlib"></a>matplotlib</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2023/10/30/%E4%BD%BF%E7%94%A8ProtoBuffers%E5%92%8CGolang%E7%BC%96%E5%86%99gRPC%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/30/%E4%BD%BF%E7%94%A8ProtoBuffers%E5%92%8CGolang%E7%BC%96%E5%86%99gRPC%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">使用ProtoBuffers和Golang编写gRPC服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-10-30 00:00:00" itemprop="dateCreated datePublished" datetime="2023-10-30T00:00:00+08:00">2023-10-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概要说明"><a href="#概要说明" class="headerlink" title="概要说明"></a>概要说明</h1><h2 id="Protocol-Buffers"><a href="#Protocol-Buffers" class="headerlink" title="Protocol Buffers"></a>Protocol Buffers</h2><p>    Protocol Buffers是用于序列化结构化数据的语言无关、平台无关的扩展机制，支持向前和向后兼容。</p>
<p>    Protocol Buffers有如下优点：</p>
<p>    （1）紧凑的数据存储</p>
<p>    （2）快速解析</p>
<p>    （3）跨语言的兼容性</p>
<p>    （4）自动生成的类优化功能</p>
<h2 id="gRPC"><a href="#gRPC" class="headerlink" title="gRPC"></a>gRPC</h2><p>    gRPC可以使用Protocol Buffers作为它的接口定义语言（<strong>I</strong>nterface <strong>D</strong>efinition <strong>L</strong>anguage）和底层数据交换格式。</p>
<p>    <img src="gRPC.jpg" alt="loading-ag-218"></p>
<h1 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h1><p>    示例参考地址 <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc-go/tree/master/examples/route_guide">grpc-go example route_guide</a></p>
<h2 id="Protocol-Buffers-amp-gRPC-Plugin"><a href="#Protocol-Buffers-amp-gRPC-Plugin" class="headerlink" title="Protocol Buffers &amp; gRPC Plugin"></a>Protocol Buffers &amp; gRPC Plugin</h2><p>（1）编写proto文件（route.pb），定义数据结构（message）、服务（service）、方法（rpc）。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;/route_guide/pb&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int32</span> latitude = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> Longitude = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">RouteGuide</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetFeature(Point) <span class="keyword">returns</span> (Feature) </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ListFeature(Rectangle) <span class="keyword">returns</span> (stream Feature) </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> RecordRoute(stream Point) <span class="keyword">returns</span> (RouteSummary) </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> RouteChat(stream RouteNote) <span class="keyword">returns</span> (stream RouteNote) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Feature</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">  Point location = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Rectangle</span> </span>&#123;</span><br><span class="line">  Point lo = <span class="number">1</span>;</span><br><span class="line">  Point hi = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">RouteSummary</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int32</span> point_count = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> feature_count = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">int32</span> distance = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">int32</span> elapsed_time = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">RouteNote</span> </span>&#123;</span><br><span class="line">  Point location = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">string</span> <span class="class"><span class="keyword">message</span> = 2;</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure>

<p>    常用字段说明</p>
<ul>
<li><p>syntax，一般放在第一行，表明使用的proto的版本，默认是proto2。</p>
</li>
<li><p>option，不会改变proto文件的定义，但会影响它在特定上下文的处理。go_package定义了生成go.pb文件时所放置的Go包。</p>
</li>
<li><p>message，自定义数据结构。</p>
</li>
<li><p>service，自定义服务。</p>
</li>
<li><p>rpc，自定义服务中的方法。</p>
</li>
</ul>
<p>（2）使用protoc+go插件，生成proto go 和grpc的代码文件，生成的文件，应用于客户端和服务器端。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> install</span></span><br><span class="line">go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28</span><br><span class="line">go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2</span><br><span class="line">export PATH=&quot;$PATH:$(go env GOPATH)/bin&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> generate</span></span><br><span class="line">protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative pb/route.proto</span><br></pre></td></tr></table></figure>

<p>    命令说明：</p>
<ul>
<li><p>–go_out，在该路径中生成pb.go文件。</p>
</li>
<li><p>–go_opt=paths=source_relative，输出的pb.go文件放置与输入文件相同的位置。</p>
</li>
<li><p>–go-grpc_out，在该路径中生成gprc.pb.go文件。</p>
</li>
<li><p>-go-grpc_opt=paths=source_relative，输出的grpc.pb.go文件放置与输入文件相同的位置。</p>
</li>
</ul>
<p>    protoc命令根据传递的参数会调用protoc-gen-go和protoc-gen-go-grpc插件，生成代码：</p>
<p>            <img src="protoc-generate-go-grpc.jpg"></p>
<p>    .pb.go包含定义的数据结构；grpc.pb.go包含接口定义和部分公共的grpc的实现代码。</p>
<h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><p>    编写gRPC的server代码，实现proto grpc文件中对应Server端interface中的方法。这里需要参照route_grpc.pb.go中的生成的接口定义，实现对应的方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RouteGuideServer is the server API for RouteGuide service.</span></span><br><span class="line"><span class="comment">// All implementations must embed UnimplementedRouteGuideServer</span></span><br><span class="line"><span class="comment">// for forward compatibility</span></span><br><span class="line"><span class="keyword">type</span> RouteGuideServer <span class="keyword">interface</span> &#123;</span><br><span class="line">    GetFeature(context.Context, *Point) (*Feature, error)</span><br><span class="line">    ListFeature(*Rectangle, RouteGuide_ListFeatureServer) error</span><br><span class="line">    RecordRoute(RouteGuide_RecordRouteServer) error</span><br><span class="line">    RouteChat(RouteGuide_RouteChatServer) error</span><br><span class="line">    mustEmbedUnimplementedRouteGuideServer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>    其中包含了一些流式数据的操作，具体可参照源码实现。</p>
<h3 id="Feature"><a href="#Feature" class="headerlink" title="Feature"></a>Feature</h3><p>    gRPC关于超时、负载均衡、保活、认证等特性的实现，可以参照示例代码。</p>
<p>    [gRPC Feature Examples](<a target="_blank" rel="noopener" href="https://github.com/grpc/grpc-go/tree/master/examples/features">grpc-go/examples/features at master · grpc/grpc-go · GitHub</a>)</p>
<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><p>    编写gRPC的client代码，使用proto grpc文件中定义的方法访问server端。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RouteGuideClient is the client API for RouteGuide service.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://pkg.go.dev/google.golang.org/grpc/?tab=doc#ClientConn.NewStream.</span></span><br><span class="line"><span class="keyword">type</span> RouteGuideClient <span class="keyword">interface</span> &#123;</span><br><span class="line">    GetFeature(ctx context.Context, in *Point, opts ...grpc.CallOption) (*Feature, error)</span><br><span class="line">    ListFeature(ctx context.Context, in *Rectangle, opts ...grpc.CallOption) (RouteGuide_ListFeatureClient, error)</span><br><span class="line">    RecordRoute(ctx context.Context, opts ...grpc.CallOption) (RouteGuide_RecordRouteClient, error)</span><br><span class="line">    RouteChat(ctx context.Context, opts ...grpc.CallOption) (RouteGuide_RouteChatClient, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>    其中包含了一些流式数据的操作，具体可参照源码实现。</p>
<h2 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> start gRPC server</span></span><br><span class="line">go run server/server.go</span><br><span class="line"><span class="meta">#</span><span class="bash"> start gRPC client</span></span><br><span class="line">go run client/client.go</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2023/01/28/ServiceMesh-Istio%E7%BD%91%E5%85%B3%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/28/ServiceMesh-Istio%E7%BD%91%E5%85%B3%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">ServiceMesh-Istio网关模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-28 00:00:00" itemprop="dateCreated datePublished" datetime="2023-01-28T00:00:00+08:00">2023-01-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ServiceMesh/" itemprop="url" rel="index"><span itemprop="name">ServiceMesh</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h1><p>    在K8s集群中，传统的Ingress Nginx充当集群南北向流量网关+Service充当集群的东西向代理的方案已经无法满足业务用户对于灰度发布、流量治理的要求，平台急需升级。</p>
<h1 id="技术调研"><a href="#技术调研" class="headerlink" title="技术调研"></a>技术调研</h1><p>    以Envoy为基础的Istio网格方案进入视野，在很大程度上解耦了业务应用与网络通信。分离了业务开发和基础架构的关注点。同时提供了完善的灰度发布、服务治理相关的配置。</p>
<p>    目前最新的ambient模式存在一些问题，尚无法应用到生产环境中。</p>
<p>    <a target="_blank" rel="noopener" href="https://github.com/istio/istio/tree/experimental-ambient#limitations">GitHub - istio/istio at experimental-ambient</a></p>
<p>    经典的sidecar模式也存在一些需考虑的问题：</p>
<p>（1）sidecar和应用生命周期强绑定</p>
<p>        sidecar的注入，需重启用户应用；sidecar和应用在同一个Pod中，应用和sidecar在启停上，需要遵循一定的顺序来保证服务通信；sidecar的升级需要重启应用（社区有一些热升级的方案，但是比较复杂），没有完全实现基础架构团队和业务团队的解耦。</p>
<p>（2）sidecar资源配额</p>
<p>        每一个应用的实例都需要绑定一个sidecar，而且一般需要按照应用实例的峰值进行资源配额的设置，造成集群中资源的浪费。</p>
<p>（3）通信延迟</p>
<p>        服务之间的通信，流量在客户端和服务端进出均需频繁地在用户态和内核态进行数据拷贝，通信延迟增加（可借助ebpf进行优化，但同时增加了复杂度）。</p>
<p>（4）规则下发</p>
<p>        xDS协议需要下发大量数据到sidecar代理上，虽然目前已经优化可以做到增量下发，减少网络的消耗，但在大规模集群中依然会有大量的规则在大量的sidecar的内存中，目前Istio可以做到Service Discovery和规则下发在namespace级别的控制，需要额外的配置。</p>
<p>（5）服务隔离</p>
<p>        在多租户场景下，需要对租户的服务进行隔离控制，拒绝没有授权的访问。</p>
<h1 id="架构方案"><a href="#架构方案" class="headerlink" title="架构方案"></a>架构方案</h1><p>    鉴于上述问题，结合ambient，决定使用内部网关的模式实现东西向流量的转发。 </p>
<p><img src="istio-gateway-mode.png"></p>
<p>      方案主要使用Istio，将东西向流量转发到内部网关上，以取代sidecar在东西向通信所起的作用。采取如下方式：</p>
<p>（1）让用户注册新的Service，使用新的Service，避免对现存Nginx Ingress的影响。</p>
<p>（2）使用控制器模式，生成东西向调用的Service（提供给用户调用）+Endpoint，并动态维护后端地址，转发流量到local-gateway。</p>
<p>（3）VS+DR所定义的流量功能，可以有选择的应用在东西向或南北向流量之上。</p>
<p>    方案的优点：</p>
<ul>
<li><p>对用户应用的侵入：需要重启用户应用；后续迁移ambient只需要修改Service的后端。</p>
</li>
<li><p>sidecar的资源问题：通过统一的内部网关和HPA解决资源不好设定和浪费的问题。</p>
</li>
<li><p>网络通信：Service的四层代理+Istio Gateway，相较sidecar模式，延迟低一些。</p>
</li>
<li><p>可以复用Istio的VS+DR，在东西向和南北向的网关上。</p>
</li>
</ul>
<p>    方案依然存在的问题:</p>
<ul>
<li><p>多租户的隔离问题。</p>
</li>
<li><p>Kiali的网络拓扑显示不完整。 </p>
</li>
</ul>
<h1 id="方案踩坑"><a href="#方案踩坑" class="headerlink" title="方案踩坑"></a>方案踩坑</h1><h2 id="HTTP-Traffic"><a href="#HTTP-Traffic" class="headerlink" title="HTTP Traffic"></a>HTTP Traffic</h2><p>    使用VS+DR通过网关或者是Sidecar控制HTTP流量的转发（未开启mTLS）。</p>
<h3 id="Sidecar"><a href="#Sidecar" class="headerlink" title="Sidecar"></a>Sidecar</h3><p>    参照Istio的<a target="_blank" rel="noopener" href="https://github.com/istio/istio/tree/master/samples/bookinfo">istio/samples/bookinfo</a>示例，有详细的yaml说明。</p>
<h3 id="LocalGateway"><a href="#LocalGateway" class="headerlink" title="LocalGateway"></a>LocalGateway</h3><p>    将bookinfo使用网关模式进行改造。</p>
<p>（1）修改服务的部署，定义服务发现和服务通信的两个Service。客户端访问端口一致。</p>
<p>（2）修改客户端访问方式：由Service名改成Service名.分区名。网关必须使用FQDN。</p>
<p>    以details为例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-discovery</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9080</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">reviews</span>    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9080</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span>               <span class="comment"># 内部网关端口</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">172.29</span><span class="number">.6</span><span class="number">.22</span>                <span class="comment"># 内部网关的Pod IP，测试写死</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">172.29</span><span class="number">.5</span><span class="number">.221</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span>                     <span class="comment"># 内部网关端口</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span>    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-reviews</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">account:</span> <span class="string">reviews</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-v1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">reviews</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">reviews-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">reviews-v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/version:</span> <span class="string">v1</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">reviews-v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">bookinfo-reviews</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/istio/examples-bookinfo-reviews-v1:1.16.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_DIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/tmp/logs&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVICES_DOMAIN</span>    <span class="comment"># 使用servie名称.分区名称作为域名访问</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">shadow</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9080</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wlp-output</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/opt/ibm/wlp/output</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wlp-output</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>    （3）通过内部网关进行流量控制</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">localgateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">cluster-local-gateway</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">localgateway</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;reviews.shadow&quot;</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews-discovery</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">30</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews-discovery</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">30</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews-discovery</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v3</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">40</span>      </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">reviews-discovery</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/version:</span> <span class="string">v2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v3</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/version:</span> <span class="string">v3</span></span><br></pre></td></tr></table></figure>

<h2 id="TCP-Traffic"><a href="#TCP-Traffic" class="headerlink" title="TCP Traffic"></a>TCP Traffic</h2><p>    使用VS+DR通过网关或者是Sidecar控制TCP流量的转发。</p>
<h3 id="Sidecar-1"><a href="#Sidecar-1" class="headerlink" title="Sidecar"></a>Sidecar</h3><p>    部署了sleep和tcp-echo的应用，测试VS的转发机制。</p>
<p><img src="sidecar-tcp-echo.png"></p>
<p>    定义如下转发规则，让流量都转发给v2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: tcp-echo</span><br><span class="line">    service: tcp-echo</span><br><span class="line">  name: tcp-echo</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: tcp</span><br><span class="line">    port: 8888</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 9000</span><br><span class="line">  - name: tcp-other</span><br><span class="line">    port: 9001</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 9001</span><br><span class="line">  selector:</span><br><span class="line">    app: tcp-echo</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.istio.io&#x2F;v1alpha3</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: tcp-echo-destination</span><br><span class="line">spec:</span><br><span class="line">  host: tcp-echo</span><br><span class="line">  subsets:</span><br><span class="line">  - name: v1</span><br><span class="line">    labels:</span><br><span class="line">      version: v1</span><br><span class="line">  - name: v2</span><br><span class="line">    labels:</span><br><span class="line">      version: v2</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.istio.io&#x2F;v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: tcp-echo</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - tcp-echo</span><br><span class="line">  gateways:</span><br><span class="line">  - mesh</span><br><span class="line">  tcp:</span><br><span class="line">  - match:</span><br><span class="line">    - port: 8888</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: tcp-echo</span><br><span class="line">        subset: v2</span><br></pre></td></tr></table></figure>

<p>     可以看到<strong>VS中所使用的port是客户端访问的Service的port</strong>，Istio中的Cluster、Listeners均使用这个字段进行监听，转发目标cluster、ServiceName。</p>
<p><img src="sidecar-tcp-echo-result.png"></p>
<p>    查看客户端sidecar的listeners、clusters。</p>
<p><img src="sidecar-tcp-echo-listeners-clusters.png"></p>
<blockquote>
<p>可以看到sidecar是根据所访问Service的clusterIP和port进行转发的。我们知道在Pod中会将所有对外的流量通过iptables的redirect –to-ports转发给envoy的监听端口，那么Envoy是如何获取到客户端访问的IP和端口呢？？</p>
</blockquote>
<h3 id="LocalGateway-1"><a href="#LocalGateway-1" class="headerlink" title="LocalGateway"></a>LocalGateway</h3><p>    在网关模型中，我们通过重写Service和EndPoint将客户端对Service的访问转发给集群内部LocalGateway（这个实际上是Istio的ingressGateway的网关实例），同样使用sleep和tcp-echo的应用进行测试。</p>
<p>    网关模式中Service+Endpoint的改写：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tcp-echo-discovery</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">tcp-echo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8800</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9000</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp-other</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line">  <span class="comment"># Port 9002 is omitted intentionally for testing the pass through filter chain.</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">tcp-echo</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tcp-echo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8800</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tcp</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8800</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tcp-echo</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">172.29</span><span class="number">.6</span><span class="number">.22</span>                <span class="comment"># 查询了网关实例的IP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">172.29</span><span class="number">.5</span><span class="number">.221</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8800</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>

<p>    定义流量分发的比例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tcp-localgateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">cluster-local-gateway</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">8800</span>     <span class="comment">## 监听端口</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tcp-echo-destination</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">tcp-echo-discovery</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/version:</span> <span class="string">v2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tcp-echo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tcp-echo.shadow</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tcp-localgateway</span></span><br><span class="line">  <span class="attr">tcp:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8800</span>    <span class="comment"># hosts/端口必须与gateway listeners端口一致，网关实例才会监听。H</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">tcp-echo-discovery</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">90</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">tcp-echo-discovery</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>    查看网关的listners和cluster信息：</p>
<p><img src="gateway-listeners-clusters.png"></p>
<p>    可以看到，流量基本按照比例分配，测试结果：</p>
<p><img src="gateway-tcp-echo-result.png"></p>
<blockquote>
<p>与sidecar不同的是，网关实际会起端口的监听，网关监听的端口必须与vs中match的端口一致（这样才会起监听），这样就导致客户端访问Service的port必须与网关监听的端口一致（否则vs match不上），这就限制了多租户场景下，不同Service使用相同的端口。从listeners上也可以看到，实际并未像sidecar那样按照Service的ClusterIP进行区分。</p>
</blockquote>
<h2 id="Security-Policy"><a href="#Security-Policy" class="headerlink" title="Security Policy"></a>Security Policy</h2><p>    Istio提供了认证和鉴权的机制。</p>
<h3 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h3><h4 id="PeerAuthentication"><a href="#PeerAuthentication" class="headerlink" title="PeerAuthentication"></a>PeerAuthentication</h4><p>    是否开启mTLS，支持一下三个模式：</p>
<ul>
<li><p>PERMISSIVE（默认），过度阶段同时支持mTLS和Plain Text。</p>
</li>
<li><p>STRICT</p>
</li>
<li><p>DISABLE</p>
</li>
</ul>
<h4 id="RequestAuthentication"><a href="#RequestAuthentication" class="headerlink" title="RequestAuthentication"></a>RequestAuthentication</h4><p>    验证JWT，包含以下内容：</p>
<ul>
<li><p>JWT Token在请求中的位置</p>
</li>
<li><p>颁发者或者请求</p>
</li>
<li><p>公共JSON Web密钥集(JWKS)</p>
</li>
</ul>
<h3 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h3><p>    基于以上的认证信息（source.principal/request.auth.principal），进行鉴权。其中一下几个字段，如要使用必须启用mtls：</p>
<ul>
<li><p>the <strong>principals</strong> and <strong>notPrincipals</strong> field under the source section</p>
</li>
<li><p>the <strong>namespaces</strong> and <strong>notNamespaces</strong> field under the source section</p>
</li>
<li><p>the <strong>source.principal</strong> custom condition</p>
</li>
<li><p>the <strong>source.namespace</strong> custom condition</p>
</li>
</ul>
<h4 id="AuthorizationPolicy"><a href="#AuthorizationPolicy" class="headerlink" title="AuthorizationPolicy"></a>AuthorizationPolicy</h4><p>    策略生效的优先级。</p>
<p><img src="authz-eval.png"></p>
<h2 id="VM-Architecture"><a href="#VM-Architecture" class="headerlink" title="VM Architecture"></a>VM Architecture</h2><p>    Istio支持虚拟机接入，虚拟机通过网关与Istiod进行通信（XDS下发和证书签发等），如果虚拟机不能与集群中的Pod直接通信，也可以借助网关进行通信。</p>
<h3 id="Service-Entry"><a href="#Service-Entry" class="headerlink" title="Service Entry"></a>Service Entry</h3><p>    将网格外的服务注册进网格。复用网格的流量管理（VS+DR）能力。</p>
<h3 id="Workload-Group"><a href="#Workload-Group" class="headerlink" title="Workload Group"></a>Workload Group</h3><p>    配置一组虚拟机的公共属性，类似于K8s集群中的Deployment。如果在虚拟机中部署了istio-proxy，可以实现自动创建Workload Entry。</p>
<h3 id="Workload-Entry"><a href="#Workload-Entry" class="headerlink" title="Workload Entry"></a>Workload Entry</h3><p>    某一个虚拟机的实例，类似于K8s集群中的Pod。自动创建时，从Workload Group集成metadata labels、健康检查、service account等。</p>
<blockquote>
<p> Workload Group + Workload Entry这两个资源对象代替虚拟机，向Istio提供服务网格需要的信息。</p>
</blockquote>
<h2 id="Hot-Plugin"><a href="#Hot-Plugin" class="headerlink" title="Hot Plugin"></a>Hot Plugin</h2><p>    支持自定义插件，并在路由级别实现热可拨插。</p>
<h3 id="Implement"><a href="#Implement" class="headerlink" title="Implement"></a>Implement</h3><p>    Istio使用Envoy作为数据面，envoy在插件实现上主要有Lua和wasm两种方式。其中lua支持路由级别的配置，而wasm目前都是全局的实现，可以通过Composite和Match的一些组合进行路由的过滤，但是逻辑比较复杂。</p>
<p>    envoy根据域名和路径执行wasm：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">static_resources:</span></span><br><span class="line">  <span class="attr">listeners:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">address:</span></span><br><span class="line">      <span class="attr">socket_address:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">        <span class="attr">port_value:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">filter_chains:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">filters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envoy.filters.network.http_connection_manager</span></span><br><span class="line">        <span class="attr">typed_config:</span></span><br><span class="line">          <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span></span><br><span class="line">          <span class="attr">codec_type:</span> <span class="string">AUTO</span></span><br><span class="line">          <span class="attr">stat_prefix:</span> <span class="string">ingress_http</span></span><br><span class="line">          <span class="attr">route_config:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">local_route_get</span></span><br><span class="line">            <span class="attr">virtual_hosts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">local_service</span></span><br><span class="line">              <span class="attr">domains:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">              <span class="attr">routes:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">                  <span class="attr">prefix:</span> <span class="string">&quot;/get&quot;</span></span><br><span class="line">                <span class="attr">route:</span></span><br><span class="line">                  <span class="attr">cluster:</span> <span class="string">httpbin</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">                  <span class="attr">prefix:</span> <span class="string">&quot;/headers&quot;</span></span><br><span class="line">                <span class="attr">route:</span></span><br><span class="line">                  <span class="attr">cluster:</span> <span class="string">httpbin</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">                  <span class="attr">prefix:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">                <span class="attr">route:</span></span><br><span class="line">                  <span class="attr">cluster:</span> <span class="string">httpbin</span></span><br><span class="line">          <span class="attr">http_filters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">composite</span></span><br><span class="line">            <span class="attr">typed_config:</span></span><br><span class="line">              <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.common.matching.v3.ExtensionWithMatcher</span></span><br><span class="line">              <span class="attr">extension_config:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">composite</span></span><br><span class="line">                <span class="attr">typed_config:</span></span><br><span class="line">                  <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.composite.v3.Composite</span></span><br><span class="line">              <span class="attr">xds_matcher:</span></span><br><span class="line">                <span class="attr">matcher_list:</span></span><br><span class="line">                  <span class="attr">matchers:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">predicate:</span></span><br><span class="line">                      <span class="attr">and_matcher:</span></span><br><span class="line">                        <span class="attr">predicate:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="attr">single_predicate:</span></span><br><span class="line">                            <span class="attr">input:</span></span><br><span class="line">                              <span class="attr">name:</span> <span class="string">request-domains</span></span><br><span class="line">                              <span class="attr">typed_config:</span></span><br><span class="line">                                <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.type.matcher.v3.HttpRequestHeaderMatchInput</span></span><br><span class="line">                                <span class="attr">header_name:</span> <span class="string">:authority</span></span><br><span class="line">                            <span class="attr">value_match:</span></span><br><span class="line">                              <span class="attr">exact:</span> <span class="string">&quot;shadow.xxx.xxx&quot;</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="attr">single_predicate:</span></span><br><span class="line">                            <span class="attr">input:</span></span><br><span class="line">                              <span class="attr">name:</span> <span class="string">request-path</span></span><br><span class="line">                              <span class="attr">typed_config:</span></span><br><span class="line">                                <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.type.matcher.v3.HttpRequestHeaderMatchInput</span></span><br><span class="line">                                <span class="attr">header_name:</span> <span class="string">:path</span></span><br><span class="line">                            <span class="attr">value_match:</span></span><br><span class="line">                              <span class="attr">exact:</span> <span class="string">&quot;/headers&quot;</span></span><br><span class="line">                    <span class="attr">on_match:</span></span><br><span class="line">                      <span class="attr">action:</span></span><br><span class="line">                        <span class="attr">name:</span> <span class="string">action</span></span><br><span class="line">                        <span class="attr">typed_config:</span></span><br><span class="line">                          <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.composite.v3.ExecuteFilterAction</span></span><br><span class="line">                          <span class="attr">typed_config:</span></span><br><span class="line">                            <span class="attr">name:</span> <span class="string">wasm</span></span><br><span class="line">                            <span class="attr">typed_config:</span></span><br><span class="line">                              <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm</span></span><br><span class="line">                              <span class="attr">config:</span></span><br><span class="line">                                <span class="attr">name:</span> <span class="string">&quot;my_plugin&quot;</span></span><br><span class="line">                                <span class="attr">root_id:</span> <span class="string">&quot;my_root_id&quot;</span></span><br><span class="line">                                <span class="attr">vm_config:</span></span><br><span class="line">                                  <span class="attr">runtime:</span> <span class="string">&quot;envoy.wasm.runtime.v8&quot;</span></span><br><span class="line">                                  <span class="attr">vm_id:</span> <span class="string">&quot;my_vm_id&quot;</span></span><br><span class="line">                                  <span class="attr">code:</span></span><br><span class="line">                                    <span class="attr">local:</span></span><br><span class="line">                                      <span class="attr">filename:</span> <span class="string">&quot;/etc/wasm_filter.wasm&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envoy.filters.http.router</span></span><br><span class="line">  <span class="attr">clusters:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">httpbin</span></span><br><span class="line">    <span class="attr">connect_timeout:</span> <span class="number">0.</span><span class="string">25s</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">STRICT_DNS</span></span><br><span class="line">    <span class="attr">lb_policy:</span> <span class="string">round_robin</span></span><br><span class="line">    <span class="attr">load_assignment:</span></span><br><span class="line">      <span class="attr">cluster_name:</span> <span class="string">httpbin</span></span><br><span class="line">      <span class="attr">endpoints:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">lb_endpoints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">endpoint:</span></span><br><span class="line">            <span class="attr">address:</span></span><br><span class="line">              <span class="attr">socket_address:</span></span><br><span class="line">                <span class="attr">address:</span> <span class="string">httpbin</span></span><br><span class="line">                <span class="attr">port_value:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">admin:</span></span><br><span class="line">  <span class="attr">access_log_path:</span> <span class="string">&quot;/dev/null&quot;</span></span><br><span class="line">  <span class="attr">address:</span></span><br><span class="line">    <span class="attr">socket_address:</span></span><br><span class="line">      <span class="attr">address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">      <span class="attr">port_value:</span> <span class="number">8001</span></span><br></pre></td></tr></table></figure>

<h3 id="inject"><a href="#inject" class="headerlink" title="inject"></a>inject</h3><p>    Istio支持对Envoy代理进行插件配置，但是暂不支持Composite规则的下发，按路由匹配的规则无法通过istio的crd下发到Envoy上。</p>
<h4 id="WasmPlug"><a href="#WasmPlug" class="headerlink" title="WasmPlug"></a>WasmPlug</h4><p>    wasm filter的注入方式，支持oci、http、file等方式。</p>
<h4 id="EnvoyFilter"><a href="#EnvoyFilter" class="headerlink" title="EnvoyFilter"></a>EnvoyFilter</h4><p>    通过Istio的pilot定制Envoy的配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EnvoyFilter</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lua-filter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">configPatches:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">applyTo:</span> <span class="string">HTTP_ROUTE</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">      <span class="attr">routeConfiguration:</span></span><br><span class="line">        <span class="attr">vhost:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">httpbin.xxx.xx:8080</span></span><br><span class="line">          <span class="attr">route:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">&quot;httpbin-match.get&quot;</span></span><br><span class="line">    <span class="attr">patch:</span></span><br><span class="line">      <span class="attr">operation:</span> <span class="string">MERGE</span></span><br><span class="line">      <span class="attr">value:</span></span><br><span class="line">        <span class="attr">typed_per_filter_config:</span></span><br><span class="line">          <span class="attr">envoy.filters.http.lua:</span></span><br><span class="line">            <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.lua.v3.LuaPerRoute</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">shadow.lua</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">applyTo:</span> <span class="string">HTTP_FILTER</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">GATEWAY</span></span><br><span class="line">      <span class="attr">listener:</span></span><br><span class="line">        <span class="attr">portNumber:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">filterChain:</span></span><br><span class="line">          <span class="attr">filter:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">envoy.filters.network.http_connection_manager</span></span><br><span class="line">            <span class="attr">subFilter:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">envoy.filters.http.router</span></span><br><span class="line">    <span class="attr">patch:</span></span><br><span class="line">      <span class="attr">operation:</span> <span class="string">INSERT_BEFORE</span></span><br><span class="line">      <span class="attr">value:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">envoy.filters.http.lua</span></span><br><span class="line">        <span class="attr">typed_config:</span></span><br><span class="line">          <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua</span></span><br><span class="line">          <span class="attr">inline_code:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">function</span> <span class="string">envoy_on_request(request_handle)</span></span><br><span class="line">              <span class="string">--</span> <span class="string">do</span> <span class="string">something</span></span><br><span class="line">            <span class="string">end</span></span><br><span class="line">          <span class="attr">source_codes:</span></span><br><span class="line">            <span class="attr">shadow.lua:</span></span><br><span class="line">              <span class="attr">inline_string:</span> <span class="string">|</span></span><br><span class="line">                <span class="string">function</span> <span class="string">envoy_on_request(request_handle)</span></span><br><span class="line">                  <span class="string">request_handle:headers():add(&quot;foo&quot;,</span> <span class="string">&quot;shadow&quot;</span><span class="string">)</span></span><br><span class="line">                <span class="string">end</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2022/10/27/Java%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E6%9D%82%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/27/Java%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E6%9D%82%E8%AE%B0/" class="post-title-link" itemprop="url">Java容器化部署杂记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-27 00:00:00" itemprop="dateCreated datePublished" datetime="2022-10-27T00:00:00+08:00">2022-10-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/" itemprop="url" rel="index"><span itemprop="name">运维实践</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>    Java是业务应用开发采用的主流语言，容器化部署K8s平台后，遇到用户反馈的许多模棱两可的问题，特此实验、记录，得出可信的结论。</p>
<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><p>    在一些场景中，需要在镜像的启动命令中使用一些环境变量，以便在镜像运行时传递这些变量改变启动命令中的一些参数，例如Java启动命令中的–spring.profiles.active来设置应用启动时使用的配置文件。</p>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>    先来看一下Dockerfile中容器启动命令定义的方式。</p>
<h4 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h4><p>    CMD是容器默认的启动命令，CMD的三种使用方式：</p>
<ul>
<li><p>CMD [“executable”,”param1”,”param2”] (<em>exec</em> form, this is the preferred form)</p>
</li>
<li><p>CMD [“param1”,”param2”] (as <em>default parameters to ENTRYPOINT</em>)</p>
</li>
<li><p>CMD command param1 param2 (<em>shell</em> form)</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/#cmd">Dockerfile reference | Docker Documentation</a></p>
</li>
</ul>
<h4 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h4><p>    ENTRYPOINT允许为容器定义可执行文件，会优于CMD的shell form和exec form执行。ENTRYPOINT的两种使用方式：</p>
<ul>
<li><p>ENTRYPOINT [“executable”, “param1”, “param2”] （<em>exec</em> form） </p>
</li>
<li><p>ENTRYPOINT command param1 param2 （<em>shell</em> form）</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/#entrypoint">Dockerfile reference | Docker Documentation</a></p>
</li>
</ul>
<blockquote>
<p>exec form不会引入shell进程，因此也不能进行环境变量的替换。</p>
<p>executable所起的进程会作为容器中Pid=1的进程。</p>
<p>shell form或者使用sh/bash -c的exec form可以通过使用exec将shell进程替换成启动的进程，使启动进程的Pid=1，接收docker stop发出的SIGTERM信号。 </p>
</blockquote>
<h3 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h3><h4 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h4><p>    docker run xxxx可直接覆盖CMD定义的执行命令，如果镜像中定义了ENTRYPOINT，run后面的执行指令会作为entrypoint的参数。</p>
<p>    docker run –entrypoint可覆盖ENTRYPOINT的执行命令。</p>
<p>    docker run -e/-env key=value可传递环境变量，在镜像启动命令中的如果使用环境变量，需要通过shell包装调起，进行环境变量的替换。其定义方式符合shell的语法规范: </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">var</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;var&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h4><p>    Kubernets的Pod的container定义中存在command和args的启动参数定义，其中环境变量的使用，可以参考kubectl explain中的说明。</p>
<p><img src="kubernetes-containers-args.png"></p>
<p><img src="kubernetes-containers-command.png"></p>
<h2 id="JVM内存"><a href="#JVM内存" class="headerlink" title="JVM内存"></a>JVM内存</h2><p>    首先来看一下JVM的内存模型：</p>
<p>    <img title="" src="jvm-memory-model.png" alt="" width="415"></p>
<p>    这里不做深入探讨，简单了解一下各个区域所存放的内容：</p>
<ul>
<li><p>堆内存：程序运行的主要内存分配区，是重点关注对象，其中又根据GC的方式划分为不同的区域：新生代、老年代等。</p>
</li>
<li><p>方法区：运行时常量池、类型数据。</p>
</li>
<li><p>虚拟机栈：局部变量表、操作数栈、动态链接、方法出口。</p>
</li>
<li><p>程序计数器。</p>
</li>
<li><p>本地方法栈。</p>
</li>
</ul>
<p>    从实际使用来看，又将JVM的内存分为堆内存和堆外内存。下面从一个容器的运行开始，看一下Java应用容器化后，内存信息的相关管理情况。</p>
<h3 id="申请"><a href="#申请" class="headerlink" title="申请"></a>申请</h3><p>    不论是通过docker通过命令行传递的，还是K8s的Pod的Resource资源配额，本质上都是通过CGroup的虚拟文件系统告诉操作系统，该进程的内存使用控制信息。</p>
<h4 id="CGroup"><a href="#CGroup" class="headerlink" title="CGroup"></a>CGroup</h4><p>    这里我们通过一个实例来主要看一下内存的设置情况。在K8s集群上部署测试Pod，分配如下资源。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">  <span class="attr">requests:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">256Mi</span></span><br></pre></td></tr></table></figure>

<p>    </p>
<blockquote>
<p>cgroup v2是cgroup的下一个版本，对内核和软件的版本有要求，本文还是在cgroup v1上进行测试</p>
</blockquote>
<p>    <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/architecture/cgroups/#check-cgroup-version">About cgroup v2 | Kubernetes</a></p>
<p>    随后查看宿主机上cgroup v1的虚拟文件系统的配置，如下图。</p>
<p><img src="pod-resource-cgroup.png"></p>
<p>    cpu、memory的按照如下规则设置：</p>
<ul>
<li><p>cpu request * 1024 /1000 = cpu.share。</p>
<p>cpu.share用来设置 cpu cgroup 子系统对于控制组之间的 cpu 分配比例。默认值是 1024。cpu.shares 以相对比例限制 cgroup 的 cpu。</p>
</li>
<li><p>cpu limit=500m：cpu是按照时间片进行划分的，因此cpu.cfs_period_us代表一个时钟周期是100000us，也就是100ms,对应1c，所以500m，cpu.cfs_quota_us=50000us。</p>
</li>
<li><p>memory request，没有体现在memory的cgroup中。</p>
</li>
<li><p>memory limit = 512Mi = memory.limit_in_bytes=536870912。</p>
</li>
</ul>
<blockquote>
<p>① 如果没有指定 limit 的话，那么 cfs_quota_us 将会被设置为 <code>-1</code>，即没有限制。</p>
<p>② 如果 limit 和 request 都没有指定的话，cpu.shares 将会被指定为 <code>2</code>，这个是 cpu.shares 允许指定的小数值了。</p>
<p>③ 如果没有 limit 的指定的话，memory.limit_in_bytes 将会被指定为一个非常大的值，一般是 2^64 ，可见含义就是不对内存做出限制</p>
</blockquote>
<p>    </p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>    上述对于容器内资源配额的设置，对于运行在其中的Java进程来说，实际相当于操作系统的资源，JVM在启动的过程中，会根据资源的上限进行内存的划分，这里主要关注堆大小的设置。</p>
<p>    这里需要说明的，是Java在容器内读取CGroup的内存限制，需要有JDK版本的支持。具体版本的支持方式不同：</p>
<ol>
<li><p>JDK 8u131+、JDK 9版本可以设置如下参数指定堆最大内存：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UnlockExperimentalVMOptions #开启实验性参数</span><br><span class="line">-XX:+UseCGroupMemoryLimitForHeap #指定JVM从主机读取cgroup限制</span><br><span class="line">-XX:MaxRAMFraction=int  #服务器内存/jvm最大内存，默认为4，占1/4</span><br></pre></td></tr></table></figure>
</li>
<li><p>JDK 8u191+、JDK 10及以上版本可以使用如下参数来动态指定jvm堆内存最大值：</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseContainerSupport #使用容器内存</span><br><span class="line">-XX:MaxRAMPercentage     #使用容器内存百分比</span><br></pre></td></tr></table></figure>

<blockquote>
<p>-Xmx/-Xms/这种设置堆大小的方式这里不推荐，如果容器的资源配额发生变化，需要手工修改这些值，非常不方便。</p>
</blockquote>
<p>    </p>
<p>    JDK版本对这些参数的支持情况，可通过如下命令查询：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -server -XX:+UnlockExperimentalVMOptions -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -version | grep UseContainerSupport </span><br></pre></td></tr></table></figure>

<h4 id="实验测试"><a href="#实验测试" class="headerlink" title="实验测试"></a>实验测试</h4><p>    下面选用JDK 8u242的版本进行实验验证，所使用Pod的资源配额如下，实际调度在一台内存为32G的节点上：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">850Mi</span></span><br><span class="line">  <span class="attr">requests:</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">500Mi</span></span><br></pre></td></tr></table></figure>

<p>    可以看到默认情况下，堆外内存的最大值为224395264=214Mi，大约为850Mi的1/4。使用-XX:MaxRAMPercentage=75.0，再次查看，堆外内存的最大值为668991488=638Mi，大约为850Mi的75%。</p>
<p><img src="jvm-heap-experiment.png"></p>
<h3 id="OOM"><a href="#OOM" class="headerlink" title="OOM"></a>OOM</h3><p>    默认情况下，JVM发生OOM后，不会退出，可以检查-XX:+CrashOnOutOfMemoryError和 -XX:ExitOnOutOfMemoryError两个参数的设置。如果需要进行Heap的导出，需要配置-XX:+HeapDumpOnOutOfMemoryError和-XX:HeapDumpPath=$(JVM_DUMP_PATH)两个参数。</p>
<p>    下面实例启动命令代表在发生JVM的OOM时导出Heap Dump。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=xxx.hprof xxx.jar</span><br></pre></td></tr></table></figure>

<blockquote>
<p>① 如果同时配置了OutOutOfMemoryError的Exit、Crash和HeapDump，则JVM不会退出，只会打印java.lang.OutOfMemoryError: Java heap spac的异常，并导出Heap Dump文件。</p>
<p>② 发生OutOutOfMemoryError的JVM依然可以正常提供api服务，但是属于不稳定的状态，可能会导致错误的结果，所以最好还是重启它。</p>
</blockquote>
<h4 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h4><p>    在K8s中是存在健康检查的，通常在实际中，我们使用http请求进行检查，JVM发生oom后，如果配置不退出，是可以正常提供服务的，因此不会发生Pod的重启，也不会将发生OOM的应用提出Service的Endpoint。</p>
<h3 id="内存查看"><a href="#内存查看" class="headerlink" title="内存查看"></a>内存查看</h3><p>    Kubernetes、Docker、Linux、Prometheus均存在一些指标和命令来查看一个应用的内存情况，这些指标和命令的结果存在差异，令人摸不着头脑，在Java应用中，因为JVM的中还有一层内存模型，所以更为复杂。下面选用一个简单的Java应用，获取这些方式的指标进行分析总结。</p>
<h4 id="监控指标"><a href="#监控指标" class="headerlink" title="监控指标"></a>监控指标</h4><h5 id="cadvisor"><a href="#cadvisor" class="headerlink" title="cadvisor"></a>cadvisor</h5><p>    Prometheus接入Kubernetes后，有一些代表应用的内存指标，其中最主要的两个指标是：container_memory_rss和container_memory_working_set_bytes。</p>
<ol>
<li><p>container_memory_rss = /sys/fs/cgroups/memory/memory.status的total_rss。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> rss常驻内存，不包括被交换出的内存</span></span><br><span class="line">total_rss = anonymous memory + swap cache</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 匿名内存</span></span><br><span class="line">anonymous memory = active_anon + inactive_anon</span><br></pre></td></tr></table></figure>
</li>
<li><p>container_memory_working_set_bytes= container_memory_usage_bytes - inactive file。</p>
<p>这个指标是OOM killer关注的指标。</p>
</li>
<li><p>container_memory_usage_bytes=memory.usage_in_bytes。包含文件缓存，在内存紧张时，可以被收回使用。</p>
<p>container_memory_usage_bytes= container_memory_rss + container_memory_cache + kernel memory</p>
</li>
</ol>
<p><img src="metric-prometheus.png"></p>
<p>    从上图可以看出container_memory_rss &lt; container_memory_working_set_bytes &lt; container_memory_usage_bytes。</p>
<p>    container_memory_rss不包含文件缓存所以最小。container_memory_usage_bytes包含所有内存所以最大。</p>
<h5 id="actuator"><a href="#actuator" class="headerlink" title="actuator"></a>actuator</h5><p>    Spring项目中引入spring-boot-starter-actuator和micrometer-registry-prometheus后，可通过/actuator/prometheus查看监控指标，这里只选取JVM内存的部分。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> HELP jvm_memory_max_bytes The maximum amount of memory <span class="keyword">in</span> bytes that can be used <span class="keyword">for</span> memory management</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE jvm_memory_max_bytes gauge</span></span><br><span class="line">jvm_memory_max_bytes&#123;application=&quot;shadow&quot;,area=&quot;nonheap&quot;,id=&quot;Code Cache&quot;,&#125; 2.5165824E8</span><br><span class="line">jvm_memory_max_bytes&#123;application=&quot;shadow&quot;,area=&quot;nonheap&quot;,id=&quot;Compressed Class Space&quot;,&#125; 1.073741824E9</span><br><span class="line">jvm_memory_max_bytes&#123;application=&quot;shadow&quot;,area=&quot;heap&quot;,id=&quot;PS Old Gen&quot;,&#125; 2.097152E8</span><br><span class="line">jvm_memory_max_bytes&#123;application=&quot;shadow&quot;,area=&quot;heap&quot;,id=&quot;PS Survivor Space&quot;,&#125; 524288.0</span><br><span class="line">jvm_memory_max_bytes&#123;application=&quot;shadow&quot;,area=&quot;nonheap&quot;,id=&quot;Metaspace&quot;,&#125; -1.0</span><br><span class="line">jvm_memory_max_bytes&#123;application=&quot;shadow&quot;,area=&quot;heap&quot;,id=&quot;PS Eden Space&quot;,&#125; 1.03809024E8</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP jvm_memory_used_bytes The amount of used memory</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE jvm_memory_used_bytes gauge</span></span><br><span class="line">jvm_memory_used_bytes&#123;application=&quot;shadow&quot;,area=&quot;nonheap&quot;,id=&quot;Code Cache&quot;,&#125; 1.6600448E7</span><br><span class="line">jvm_memory_used_bytes&#123;application=&quot;shadow&quot;,area=&quot;nonheap&quot;,id=&quot;Compressed Class Space&quot;,&#125; 4468432.0</span><br><span class="line">jvm_memory_used_bytes&#123;application=&quot;shadow&quot;,area=&quot;heap&quot;,id=&quot;PS Old Gen&quot;,&#125; 1.100248E7</span><br><span class="line">jvm_memory_used_bytes&#123;application=&quot;shadow&quot;,area=&quot;heap&quot;,id=&quot;PS Survivor Space&quot;,&#125; 32768.0</span><br><span class="line">jvm_memory_used_bytes&#123;application=&quot;shadow&quot;,area=&quot;nonheap&quot;,id=&quot;Metaspace&quot;,&#125; 3.768876E7</span><br><span class="line">jvm_memory_used_bytes&#123;application=&quot;shadow&quot;,area=&quot;heap&quot;,id=&quot;PS Eden Space&quot;,&#125; 3.720336E7</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP jvm_memory_committed_bytes The amount of memory <span class="keyword">in</span> bytes that is committed <span class="keyword">for</span> the Java virtual machine to use</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE jvm_memory_committed_bytes gauge</span></span><br><span class="line">jvm_memory_committed_bytes&#123;application=&quot;shadow&quot;,area=&quot;nonheap&quot;,id=&quot;Code Cache&quot;,&#125; 1.8481152E7</span><br><span class="line">jvm_memory_committed_bytes&#123;application=&quot;shadow&quot;,area=&quot;nonheap&quot;,id=&quot;Compressed Class Space&quot;,&#125; 5029888.0</span><br><span class="line">jvm_memory_committed_bytes&#123;application=&quot;shadow&quot;,area=&quot;heap&quot;,id=&quot;PS Old Gen&quot;,&#125; 2.097152E8</span><br><span class="line">jvm_memory_committed_bytes&#123;application=&quot;shadow&quot;,area=&quot;heap&quot;,id=&quot;PS Survivor Space&quot;,&#125; 524288.0</span><br><span class="line">jvm_memory_committed_bytes&#123;application=&quot;shadow&quot;,area=&quot;nonheap&quot;,id=&quot;Metaspace&quot;,&#125; 4.0411136E7</span><br><span class="line">jvm_memory_committed_bytes&#123;application=&quot;shadow&quot;,area=&quot;heap&quot;,id=&quot;PS Eden Space&quot;,&#125; 3.7224448E7</span><br></pre></td></tr></table></figure>

<blockquote>
<p>jvm_memory_committed_bytes是从操作系统层面预留给JVM的可用内存。</p>
</blockquote>
<p><img src="jvm_memory_committed_bytes.png"></p>
<h4 id="查询命令"><a href="#查询命令" class="headerlink" title="查询命令"></a>查询命令</h4><h5 id="kubectl-top"><a href="#kubectl-top" class="headerlink" title="kubectl top"></a>kubectl top</h5><p>    这里使用的是container_memory_working_set_bytes（不包含pause容器）， 是容器真实使用的内存量，也是 limit限制时的oom 判断依据。</p>
<h5 id="docker-stats"><a href="#docker-stats" class="headerlink" title="docker stats"></a>docker stats</h5><p>    这里的计算逻辑是container_memory_usage_bytes - container_memory_cache。</p>
<h5 id="free"><a href="#free" class="headerlink" title="free"></a>free</h5><p>    操作系统的内存使用情况，都记录在/proc/meminfo中，free命令的数据也来源于此。</p>
<p>    <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man5/proc.5.html">proc(5) - Linux manual page</a></p>
<p><img src="proc-meminfo.png"></p>
<h5 id="JVM内存分析"><a href="#JVM内存分析" class="headerlink" title="JVM内存分析"></a>JVM内存分析</h5><h6 id="MAT工具"><a href="#MAT工具" class="headerlink" title="MAT工具"></a>MAT工具</h6><p>    MAT（全名：Memory Analyzer Tool），是一款快速便捷且功能强大丰富的 JVM 堆内存离线分析工具。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jstack &lt;pid&gt;</span><br><span class="line">jmap dump:live,format=b,file=./map.pprof &lt;pid&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在容器中，如果Java进程的Pid=1，会报</p>
<p>1: Unable to get pid of LinuxThreads manager thread。</p>
</blockquote>
<h6 id="Arthas"><a href="#Arthas" class="headerlink" title="Arthas"></a>Arthas</h6><p>    <a target="_blank" rel="noopener" href="https://arthas.aliyun.com/">arthas</a>是 Alibaba 开源的 Java 诊断工具，深受开发者喜爱 。</p>
<h1 id="总结展望"><a href="#总结展望" class="headerlink" title="总结展望"></a>总结展望</h1><p>    因Java应用在容器化过程中，遇到很多棘手的问题：</p>
<ol>
<li><p>冷启动时间长</p>
</li>
<li><p>内存占用大</p>
</li>
<li><p>JVM+OS镜像文件大</p>
</li>
</ol>
<p>    但是Java作为最广泛使用的语言，已存的开发群体和社区资源庞大。 因此也有一些优化方案被提出，改善这些问题，其中Graalvm最为亮眼，Graalvm支持多个编程语言的运行时，并可以将Java代码编译为机器码。</p>
<p><a target="_blank" rel="noopener" href="https://www.graalvm.org/22.2/docs/getting-started/">GraalVM</a></p>
<blockquote>
<p>从GraalVM开始——这是一个高性能的JDK，旨在提高Java应用程序的性能，同时消耗更少的资源。 GraalVM提供了两种运行Java应用程序的方法:在HotSpot JVM上使用Graal即时(JIT)编译器，或者作为预先(AOT)编译的本机可执行文件。 除了Java，它还提供了JavaScript、Ruby、Python和其他一些流行语言的运行时。 GraalVM的多语言功能使得在一个应用程序中混合编程语言成为可能，同时消除了任何外语调用成本。<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/">https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/">Spring Native</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2022/09/19/Linux%20Kernel-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/19/Linux%20Kernel-%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E5%8C%85/" class="post-title-link" itemprop="url">Linux Kernel-网络收发包</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-19 00:00:00" itemprop="dateCreated datePublished" datetime="2022-09-19T00:00:00+08:00">2022-09-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux-Kernel/" itemprop="url" rel="index"><span itemprop="name">Linux Kernel</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>    随着互联网的兴起，分布式技术发展，越来越多的服务开始通过网络进行交互，Linux因其强大的网络功能，在服务器端作为底层操作系统长盛不衰，了解Linux Kernel级别的网络功能实现，有助于在Linux Kernel级别诊断应用网络问题，搭建更加牢固可靠的网络基础设施，为服务端应用更好的服务。</p>
<p>    因C语言能力浅薄，独自阅读Linux Kernel代码吃力，本文借鉴于张彦飞的《深入理解Linux网络》，让飞哥领路，一起看一下网络收发包是如何在Linux Kernel中实现的。</p>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>    Linux操作系统内核启动，为收发包功能做准备工作，这里只看网络收发包相关初始化。</p>
<h2 id="initcall"><a href="#initcall" class="headerlink" title="initcall"></a>initcall</h2><p><img src="initcall.png"></p>
<p>    按照从左到右的顺序，看一下相关初始化的代码实现。</p>
<h3 id="ksoftirq"><a href="#ksoftirq" class="headerlink" title="ksoftirq"></a>ksoftirq</h3><p><img src="ksoftirqd.png"></p>
<p>    ksoftirqd中的run_ksoftirqd是实际的软中断处理方法，当进行网络收发包时，会根据相应的中断类型，调用对应的处理函数。</p>
<h3 id="协议栈"><a href="#协议栈" class="headerlink" title="协议栈"></a>协议栈</h3><p><img src="network-stack-init.png"></p>
<p>    从上面流程中可以看出，协议栈的初始化，并未进行任何收发包的相关操作，只是分别初始化了一些数组：</p>
<ul>
<li>inet_protos，其中包含了传输层（本例只分析TCP）tcp_protocol的handler方法。</li>
<li>net_families，其中包含了socket创建时使用的inet_family_ops的create方法。</li>
<li>ptype_base，其中包含了网络层处理函数func。</li>
</ul>
<p>    这些数组的实现，能够很容易的根据协议、协议簇、类型，找到数组中的元素，从而调用不同的实现方法。</p>
<h3 id="网络子系统"><a href="#网络子系统" class="headerlink" title="网络子系统"></a>网络子系统</h3><p><img src="network-system-register.png"></p>
<p>    softnet_data的数据结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Incoming packets are placed on per-cpu queues</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">softnet_data</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span>        *<span class="title">output_queue</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span>        **<span class="title">output_queue_tailp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">poll_list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>        *<span class="title">completion_queue</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span>    <span class="title">process_queue</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* stats */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        processed;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        time_squeeze;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        cpu_collision;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        received_rps;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_RPS</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">softnet_data</span>    *<span class="title">rps_ipi_list</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Elements below can be accessed between CPUs for RPS */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">call_single_data</span>    <span class="title">csd</span> ____<span class="title">cacheline_aligned_in_smp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">softnet_data</span>    *<span class="title">rps_ipi_next</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        cpu;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        input_queue_head;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        input_queue_tail;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        dropped;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span>    <span class="title">input_pkt_queue</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">napi_struct</span>    <span class="title">backlog</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>    NET_TX_SOFTIRQ代表收包的软中断，对应net_tx_action的处理函数，NET_RX_SOFTIRQ代表发包的软中断，对应net_rx_action的处理函数。</p>
<h3 id="网卡驱动"><a href="#网卡驱动" class="headerlink" title="网卡驱动"></a>网卡驱动</h3><p>    以igb网卡为例，看一下驱动的注册过程。驱动在操作操作系统安装后，需要通过module_init向内核通报自己的信息（包括名称和操作方法）。</p>
<p><img src="igb-driver-register.png"></p>
<p>    igb_driver的信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pci_driver</span> <span class="title">igb_driver</span> =</span> &#123;</span><br><span class="line">    .name     = igb_driver_name,</span><br><span class="line">    .id_table = igb_pci_tbl,</span><br><span class="line">    .probe    = igb_probe,</span><br><span class="line">    .remove   = igb_remove,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PM</span></span><br><span class="line">    .driver.pm = &amp;igb_pm_ops,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    .shutdown = igb_shutdown,</span><br><span class="line">    .sriov_configure = igb_pci_sriov_configure,</span><br><span class="line">    .err_handler = &amp;igb_err_handler</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>    Linux系统启动时，扫描PCI，找到PCI设备（设备识别），如果该设备已经注册驱动，则调用驱动的probe函数，probe方法执行的目的是为了让设备处于ready的状态。</p>
<p>    网卡的驱动设备都必须实现probe方法。</p>
<p><img src="igb-driver-probe.png"></p>
<h2 id="网卡启动"><a href="#网卡启动" class="headerlink" title="网卡启动"></a>网卡启动</h2><p><img src="igb-open.png"></p>
<p>    网卡启动之后，主要通过igb_open的调用，实现了网卡多队列的硬中断处理函数的注册，同时，在回调函数igb_msix_ring中，明确了使用网卡驱动中的igb_poll函数进行数据的获取。</p>
<h1 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h1><p>    Linux Kernel完成准备工作后，下面通过一段简单的C语言服务器、客户端代码实例（暂不考虑性能因素）。沿着这一段基础的代码实现，看一下Kernel的TCP协议收发包是如何工作的。</p>
<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> listenfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);  </span><br><span class="line">    bind(listenfd, ...);</span><br><span class="line">    listen(listenfd, ...);</span><br><span class="line">    connfd=accept(listenfd, ....);</span><br><span class="line">    read(connfd);</span><br><span class="line">    write(connfd);</span><br><span class="line">    close(connfd);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> sk = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);  </span><br><span class="line">    connect(sk, ...);</span><br><span class="line">    write(sk, ...);</span><br><span class="line">    read(sk, ...);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="系统调用分析"><a href="#系统调用分析" class="headerlink" title="系统调用分析"></a>系统调用分析</h2><p>    按照如下流程来看一下简单的客户端和服务端系统调用分别都做了哪些工作。</p>
<ol>
<li>服务器端服务启动，监听端口，等待数据到达（涉及socket、bind、listen函数）。</li>
<li>客户端连接服务端发送数据，等待返回（涉及socket、connect、send函数）。</li>
<li>服务端接收连接，并读取客户端数据，然后返回数据到客户端（涉及accept、recv、send函数）。</li>
<li>客户端读取服务端返回的数据，关闭连接（涉及recv、close函数）。</li>
</ol>
<h3 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h3><p>    socker的创建过程，客户端和服务端想要完成通信，都必须创建自己的socket，然后使用返回的文件描述符完成后续的操作。</p>
<p><img src="socket.png"></p>
<p>    通过socket的创建，内核建立其如下数据结构：</p>
<p><img src="fd-socket.png"></p>
<h3 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h3><p>    这里主要进行端口检查，确定所使用的端口。</p>
<p><img src="bind.png"></p>
<h3 id="listen"><a href="#listen" class="headerlink" title="listen"></a>listen</h3><p>    listen的过程主要初始化连接队列，根据系统参数和用户参数，确定队列的长度。</p>
<p><img src="listen.png"></p>
<p>    在内核中，经常看到struct sock、tcp_sock、inet_connection_sock、inet_sock、sock之间的强制转化，他们之间的嵌套关系如下：</p>
<p><img src="tcp_sock.png"></p>
<h3 id="connect-send-recv"><a href="#connect-send-recv" class="headerlink" title="connect/send/recv"></a>connect/send/recv</h3><p>    在connect过程中，会进行TCP三次握手，建立连接，其中也会涉及到send和recv的系统调用处理流程。</p>
<p>    通过socket创建，bind绑定端口，listen开启监听，服务器端已经做好了接收连接的准备，客户端也通过socket创建得到了socket的文件描述符，下一步通过connect建立连接，然后进行数据发送。</p>
<h4 id="数据包发送"><a href="#数据包发送" class="headerlink" title="数据包发送"></a>数据包发送</h4><p><img src="connect.png" alt="loading-ag-324"></p>
<p>     上面构造了syn的包，并直接发送，当配额不足的时候，是需要走软中断发送的。在网络子系统初始化的时候，注册了NET_TX_SOFTIRQ中断的处理函数net_tx_action。</p>
<p><img src="connect-softirq.png"></p>
<p>    可以看到在软中断处理数据包发送中，会回调__qdisc_run最后都通过调用网卡驱动的发送方法完成发送，数据发送完成后，网卡会触发硬中断，产生NET_RX_SOFTIRQ的软中端，并通过该中断的函数中的igb_clean_tx_irq，清理数据。</p>
<p>    此时syn包离开了客户端，经由网络发送给服务器端，下面来看一下服务器端收包过程。</p>
<h4 id="数据包接收"><a href="#数据包接收" class="headerlink" title="数据包接收"></a>数据包接收</h4><p>    网卡启动一节中，注册了硬中断的处理函数igb_msix_ring，数据包到达网卡后，网卡会通过硬中断通知cpu，此时igb_msix_ring执行。</p>
<p><img src="hirq.png"></p>
<p>    ksoftirq进程通过ksoftirqd_should_run方法判断是否有软中断写入，当软中断写入时，执行run_ksoftirqd，h-&gt;action(h) 调用中断对应的处理函数，网络子系统中，提到过NET_RX_SOFTIRQ的中断处理函数是net_rx_action。</p>
<p><img src="recv-1.png"></p>
<p>    数据包经由网卡驱动、网络层的处理，即将进入传输层。传输层收到syn包后，需进行三次握手的过程，现在已经清楚了数据包的接收和发送，后续数据包的收发在网卡、网卡驱动、网络层的处理是一样的，重点看三次握手传输层的处理。</p>
<h4 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h4><p><img src="recv-2.png"></p>
<p>    服务端构建了syn+ack包后，发送给客户端，服务端的发送、客户端的接收不再赘述，客户端收到syn+ack，传输层也是从tcp_v4_rcv开始，只不过客户端的状态是TCP_SYN_SENT。</p>
<p><img src="recv-3.png" alt="loading-ag-502"></p>
<p>    客户端发送ack，给服务器端，服务器端传输层的处理流程。</p>
<p><img src="recv-4.png"></p>
<h3 id="close"><a href="#close" class="headerlink" title="close"></a>close</h3><p>    四次挥手的处理与三次握手整体流程基本一致，都是从tcp_v4_rcv进入到传输层，然后根据当前所处的状态以及接收到的数据包做分别的处理。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2022/07/05/Etcd%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/05/Etcd%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Etcd实战笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-05 00:00:00" itemprop="dateCreated datePublished" datetime="2022-07-05T00:00:00+08:00">2022-07-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>    Etcd作为分布式的强一致性的键值对配置库，广泛使用在元数据存储、配置存储、分布式锁等领域。其中最具代表性的有：K8s使用Etcd作为唯一的元数据后端存储，Apisix使用Etcd作为配置的后端存储。</p>
<p>    本文通过阅读学习极客时间唐聪老师的<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100069901">etcd实战课</a>，加深对Etcd的理解和使用。</p>
<h1 id="内容整理"><a href="#内容整理" class="headerlink" title="内容整理"></a>内容整理</h1><h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><p>    Etcd基于Raft算法实现，在Raft的论文中，将分布式系统一致性问题分解为三个子问题，分别为Leader选举、日志复制、安全性。以下是Raft论文的中文翻译地址：</p>
<p>    <a target="_blank" rel="noopener" href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md">中文翻译地址</a></p>
<h3 id="Leader选举"><a href="#Leader选举" class="headerlink" title="Leader选举"></a>Leader选举</h3><p>    集群角色主要分为：</p>
<ul>
<li><p>Leader，集群领导者，可以发起写操作，并同步日志给Follower，并且定时发送心跳维持自己的领导地位。</p>
</li>
<li><p>Follwer，同步从Leader接收的日志，可以处理读操作。</p>
</li>
<li><p>Candidate，竞选者，这是一个中间状态，可以发起Leader选举。</p>
</li>
<li><p>Learner，没有选举和被选举权，只能同步数据。   </p>
<p>Leader的任期号是单调递增的，可以作为逻辑时钟，可以比较数据的新旧。 节点拒绝给当前数据比自己任期号小的节点投票。     </p>
<p><img src="leader-election.webp"></p>
</li>
</ul>
<p>    这里有一个Precandidate的状态，是为了防止网络发生分区后，较少节点的分区，不断自增任期号，待网络恢复后，较少节点因自增任期号比较大，但数据远远落后而触发的无效节点选举，影响集群整体的稳定性。</p>
<h3 id="日志复制"><a href="#日志复制" class="headerlink" title="日志复制"></a>日志复制</h3><p>    Leader复制日志给Follower的核心流程：</p>
<p><img src="raft-log-sync.webp"></p>
<p>    ① 客户端发起请求，写入hello=world。</p>
<p>    ② Etcd首先向Raft模块，提交一个提案。消息类型为MsgProp。</p>
<p>    ③ Raft模块收到提案后，会生成日志条目，并附加到不稳定的Raft Log（内存）中。</p>
<p>    ④ Raft模块遍历Follower列表和进度信息，为每个Follower生成日志追加MsgApp消息，通过HTTP协议发送给Follower，并将日志条目<strong>持久化</strong>在WAL中。</p>
<blockquote>
<p>Leader通过两个核心字段来维护Follower的进度信息：</p>
<p>NextIndex：Leader发送给Follower的下一个日志索引</p>
<p>MatchIndex：Follower已同步的日志索引        </p>
</blockquote>
<p>    ⑤ 将日志条目追加到稳定的Raft Log（内存）中。</p>
<p>    ⑥ Follower收到的消息后，首先进行安全检查，然后<strong>持久化</strong>数据到WAL中，随后回复一个应答追加日志条目（MsgAppResp）的消息，告知Leader当前已经复制到日志的最大索引（MatchIndex）。Leader收到的Follower通告MatchIndex信息后，根据这个信息推算出，半数以上节点已经持久化这条日志后，代表这条日志已经被提交。Leader可以通过心跳信息（MsgHeartbeat）告知Follwer已提交的日志索引。</p>
<p>    ⑦ 各节点从Raft模块获取到已提交的日志条目。</p>
<p>    ⑧ 应用日志条目到存储状态机中，结果返回给client。</p>
<h3 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h3><p>    Etcd基于treeIndex、boltdb（B+tree）实现了存储状态机。支持多版本控制。</p>
<p><img src="mvcc.webp"></p>
<h4 id="TreeIndex"><a href="#TreeIndex" class="headerlink" title="TreeIndex"></a>TreeIndex</h4><p>    treeIndex是一颗B-tree，每个节点包含多个数据，支持范围查询。</p>
<p><img src="treeIndex-example.webp"></p>
<p>    每个节点的Key的数据结构如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> keyIndex <span class="keyword">struct</span> &#123;</span><br><span class="line">    key []<span class="keyword">byte</span>                        <span class="comment">//用户的key名称</span></span><br><span class="line">    modified revision                 <span class="comment">//最后一次修改key时的etcd版本号</span></span><br><span class="line">    generations []generation          <span class="comment">//generation保存了一个key若干代版本号信息，每代中包含对key的多次修改的版本号列表 （不断删除新增会生成多个代）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> generation <span class="keyword">struct</span> &#123;</span><br><span class="line">    ver <span class="keyword">int64</span>                          <span class="comment">//表示此key的修改次数</span></span><br><span class="line">    created revision                   <span class="comment">//表示generation结构创建时的版本号</span></span><br><span class="line">    revs []revision                    <span class="comment">//每次修改key时的revision追加到此数组</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> revision <span class="keyword">struct</span> &#123;</span><br><span class="line">    main <span class="keyword">int64</span><span class="comment">//一个全局递增的主版本号，随put/txn/delete事务递增，一个事务内的key main版本号是一致的</span></span><br><span class="line">    sub <span class="keyword">int64</span> <span class="comment">//一个事务内的子版本号，从0开始随事务内put/delete操作递增</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>     Etcd进行数据读入时，首先查询treeIndex的版本信息，这些信息在事务中发挥重要的作用，然后自增全局的版本号，生成revision{全局版本号，子版本号}，这是boltdb的key，然后填充mvccpb.KeyValue，这是boltdb的value。</p>
<p>    先将数据保存到boltdb的缓存中（这是文件系统的缓存，等待异步刷新到磁盘），然后更新数据到buffer（保证能查询到最新的数据）中，最后更新treeIndex的数据。</p>
<p><img src="mvcc-write.webp"></p>
<p>    数据读取与此类似，先查询的是buffer，如果未命中，才从boltdb中查询数据。</p>
<p>    数据删除采用的是延迟删除的方式，通过新增代表删除的标志或数据结构，代表数据已被删除。</p>
<p>    </p>
<p>    基于上述MVCC的原理，Etcd支持事务和Watch机制。</p>
<h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><p>    Etcd通过事务API来解决多key原子更新的问题，事务API如下格式使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client.Txn(ctx)</span><br><span class="line">.If(cmp1, cmp2, ...)</span><br><span class="line">.Then(op1, op2, ...,)</span><br><span class="line">.Else(op1, op2, …)</span><br></pre></td></tr></table></figure>

<h4 id="Watch机制"><a href="#Watch机制" class="headerlink" title="Watch机制"></a>Watch机制</h4><p>     当一个Watcher监听的版本号已经小于当前etcd Server压缩的版本号，变更的历史数据可能已丢失，etcd Server会返回ErrCompacted错误给客户端。客户端需要重新获取最新的版本好后重新watch。</p>
<ul>
<li><p>syncWatcher：最新数据已同步完毕，等待新的变更。</p>
</li>
<li><p>unsyncWathcer：努力追赶历史变更。</p>
</li>
<li><p>victimWathcer：channel buffer已满，同步缓慢的watccher。</p>
</li>
</ul>
<p>        三者之间随着数据同步的进行，可以转换。</p>
<p><img src="watch.webp"></p>
<h3 id="租约"><a href="#租约" class="headerlink" title="租约"></a>租约</h3><p>    Lease与key进行关联，相同TTL的Lease可以使用一个Lease。Leader按照过期时间维护了一个最小堆。主循环每次获取过期的lease，发起Revoke请求，通过Raft Log 传递给Follower节点，删除boltdb中已过期的key、删除Lease和Key的关联，删除Lease。</p>
<h3 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h3><p>    为防止Etcd的db不断增长，达到上限8G，需要进行压缩，清除历史数据。压缩分为：</p>
<ol>
<li><p>手动压缩，etcdctl compact。</p>
</li>
<li><p>自动压缩：</p>
<ul>
<li><p>周期压缩，保留时间周期    </p>
</li>
<li><p>版本号压缩</p>
</li>
</ul>
</li>
</ol>
<p>    压缩操作并不会直接释放磁盘，减小db的大小，而是会将释放的page，记录在空闲页中，等待新的写入请求，复用这个page。</p>
<h3 id="一次写请求"><a href="#一次写请求" class="headerlink" title="一次写请求"></a>一次写请求</h3><p><img src="etcd-write.webp"></p>
<p>（1）Client通过负载均衡算法选择一个节点，封装并发送gRPC请求。</p>
<p>（2）请求通过gRPC拦截器、Quota模块后，交给KV Server后，KV Server会生成一个提案（Propose）提交给Raft模块，随后会等待这个这个提案的返回。</p>
<p>          如果超时（5 秒磁盘 IO 延时 +2*1 秒竞选超时时间）未返回，会报etcdserver：request time out。</p>
<p>（3）Raft模块收到提案后，如果是Follower，它会转发给Leader节点。</p>
<p>          Leader节点收到提案后，Leader将提案消息广播给集群个节点，同时需要将集群Leader任期号、投票信息、已提交索引、提案内容持久化（fsync）到WAL日志文件中，并附建。</p>
<p>    WAL的记录类型：</p>
<ul>
<li><p>文件元数据记录</p>
</li>
<li><p>日志条目记录</p>
</li>
<li><p>状态信息记录</p>
</li>
<li><p>CRC记录</p>
</li>
<li><p>快照记录</p>
</li>
</ul>
<p>（4）当一半以上的节点持久化了日志条目后，Raft通过channel告知etcdserver模块，提案状态为已提交，可以异步进行Apply。</p>
<p>（5）Apply模块通过consistent index来实现日志条目执行的幂等性，Apply判定日志未执行后，交给MVCC进行持久化。</p>
<p>（6）MVCC通过维护treeindex和boltdb来实现提案的提交，注意这里的只是更新内存中的数据结构，并没有实现真正的事务提交。</p>
<p>          通过bucket buffer来保存暂未提交的事务数据，解决读不到最新数据的问题。</p>
<p>（7）事务的提交过程包括B+tree的平衡分裂、合并多个写操作等，通过异步定时批量地fsync刷新数据到磁盘。</p>
<h3 id="一次读请求"><a href="#一次读请求" class="headerlink" title="一次读请求"></a>一次读请求</h3><p><img src="etcd-read.webp"></p>
<p>（1）Client通过负载均衡算法选择一个节点，封装gRPC请求给KV Server。</p>
<p>（2）ETCD会通过拦截器提供metrics、日志、请求行为检查等机制。随后将请求交给KV Server来处理。</p>
<p>（3）如果是线性一致性（默认），则KV Server首先通过Raft模块到Leader中获取当前最新已提交的日志索引（committed index）。这里leader也需要向Follwer确认自己的Leader身份。</p>
<p>（4）查询的节点，需要等待直至自身状态机的applied index大于等于Leader的已提交索引（committed index），然后才去MVVC模块获取数据。</p>
<p>（5）MVVC模块获取数据时，首先查询treeIndex获取版本号，然后在未命中buffer的情况下， 才到boltdb中读取实际存储的数据。</p>
<p>    以上是线性读的处理流程，如果是序列化一致性，则不需要readIndex机制（上文中(3)(4)的步骤）来保证数据一致性。</p>
<h2 id="组件运维"><a href="#组件运维" class="headerlink" title="组件运维"></a>组件运维</h2><h3 id="集群发现"><a href="#集群发现" class="headerlink" title="集群发现"></a>集群发现</h3><p>    Etcd集群发现，可以采用如下两种方式：</p>
<p>    （1）static configuration</p>
<ul>
<li><p>initial-cluster-state=new，initial-cluster包含三个节点的信息。</p>
</li>
<li><p>initial-cluster-state=new，单个节点独立成集群，然后其它节点为existing，加入到集群中。</p>
</li>
</ul>
<p>（2）dynamic service discovery    </p>
<p>        通过公共服务来发现集群中的成员信息。</p>
<h3 id="集群成员变更"><a href="#集群成员变更" class="headerlink" title="集群成员变更"></a>集群成员变更</h3><p>    集群成员在线安全变更的方式为：每次变更一个节点，不要同时变更多个节点。</p>
<h3 id="监控告警"><a href="#监控告警" class="headerlink" title="监控告警"></a>监控告警</h3><p>    通过Etcd暴露的Metrics指标，监控磁盘、网络、MVCC事务、Etcd Server等信息。</p>
<h3 id="备份还原"><a href="#备份还原" class="headerlink" title="备份还原"></a>备份还原</h3><p>（1）etcdctl snapshot</p>
<p>（2）定时备份，etcd-backup-operator</p>
<p>（3）跨地域热备，learner节点</p>
<h3 id="巡检"><a href="#巡检" class="headerlink" title="巡检"></a>巡检</h3><h3 id="混沌工程"><a href="#混沌工程" class="headerlink" title="混沌工程"></a>混沌工程</h3><p>    快速复现故障实现问题定位。</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><h4 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h4><p>    Etcd的内存占用：</p>
<p>（1）raft log</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> raftLog <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// storage contains all stable entries since the last snapshot.</span></span><br><span class="line">    storage Storage</span><br><span class="line">    <span class="comment">// unstable contains all unstable entries and snapshot.</span></span><br><span class="line">    <span class="comment">// they will be saved into storage.</span></span><br><span class="line">    unstable unstable</span><br><span class="line">    <span class="comment">// committed is the highest log position that is known to be in</span></span><br><span class="line">    <span class="comment">// stable storage on a quorum of nodes.</span></span><br><span class="line">    committed <span class="keyword">uint64</span></span><br><span class="line">    <span class="comment">// applied is the highest log position that the application has</span></span><br><span class="line">    <span class="comment">// been instructed to apply to its state machine.</span></span><br><span class="line">    <span class="comment">// Invariant: applied &lt;= committed</span></span><br><span class="line">    applied <span class="keyword">uint64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）treeIndex  </p>
<p>（3）boltdb</p>
<p>    通过 mmap将db文件预读取到内存中。</p>
<p>（4）watcher</p>
<ul>
<li><p>连接</p>
</li>
<li><p>Stream</p>
</li>
<li><p>watcher。</p>
</li>
</ul>
<p>（5）expensive request</p>
<h4 id="延时"><a href="#延时" class="headerlink" title="延时"></a>延时</h4><p>    对于网络或者是磁盘的延时，可以通过接入监控，分析etcd暴露的指标来得出结论，也可以开启trace日志。</p>
<p>    expensive request、容量瓶颈、节点配置。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2022/06/21/Linux%E8%BF%90%E7%BB%B4%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/21/Linux%E8%BF%90%E7%BB%B4%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">Linux运维常用命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-21 00:00:00" itemprop="dateCreated datePublished" datetime="2022-06-21T00:00:00+08:00">2022-06-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/" itemprop="url" rel="index"><span itemprop="name">运维实践</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>    在Linux运维过程中，经常需要排查服务器的异常情况，当服务器因某些不明原因down机或者不响应，或者监控告警系统提示服务器某些指标出现异常，往往需要登录到这些服务器上进行异常原因排查，这时就需要一些常规的命令快速定位问题的所在，因此熟悉这些命令的使用，快速读懂它们的输出就非常重要。</p>
<h1 id="常用方式"><a href="#常用方式" class="headerlink" title="常用方式"></a>常用方式</h1><p>    服务器一般有几个核心的指标比较重要，下面根据具体的指标，展开分析如何进行排查分析。</p>
<h2 id="实时查看"><a href="#实时查看" class="headerlink" title="实时查看"></a>实时查看</h2><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">top</span><br><span class="line"><span class="meta">#</span><span class="bash"> 按数字1可以展开每个cpu的情况</span></span><br><span class="line">vmstat</span><br></pre></td></tr></table></figure>

<h3 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -lh</span><br></pre></td></tr></table></figure>

<h3 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h3><h4 id="流量情况"><a href="#流量情况" class="headerlink" title="流量情况"></a>流量情况</h4><ol>
<li><p>iftop</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">man iftop</span><br><span class="line">iftop -n -i enp0s3</span><br></pre></td></tr></table></figure>

<p><img src="iftop-remark.png"></p>
</li>
<li><p>ifconfig</p>
</li>
<li><p>netlog</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt install nethogs</span><br><span class="line">man nethogs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以在主机上查看哪些进程占用带宽较多</span></span><br><span class="line">nethogs </span><br></pre></td></tr></table></figure>

<h4 id="Socket情况"><a href="#Socket情况" class="headerlink" title="Socket情况"></a>Socket情况</h4><p>    netstat/ss</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">man ss</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看TCP的连接数量</span></span><br><span class="line">ss  -tan|awk &#x27;NR&gt;1&#123;++S[$1]&#125;END&#123;for (a in S) print a,S[a]&#125;&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有TCP Socket，不加-a不显示listenning的TCP socket</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -l可以只显示listenning的socket</span></span><br><span class="line">ss -t -a</span><br><span class="line"><span class="meta">#</span><span class="bash"> 过滤某状态的TCP连接</span></span><br><span class="line">ss -tn -o state established</span><br></pre></td></tr></table></figure>

<h4 id="容器情况"><a href="#容器情况" class="headerlink" title="容器情况"></a>容器情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stat</span><br></pre></td></tr></table></figure>

<p><img src="docker-stats-introduction.png"></p>
<h3 id="Disk-I-O"><a href="#Disk-I-O" class="headerlink" title="Disk I/O"></a>Disk I/O</h3><ol>
<li> iotop</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> iotop 默认按照Tid显示，可加参数-P按照Pid显示</span></span><br><span class="line">iotop -P</span><br></pre></td></tr></table></figure>

<p><img src="iotop-introduction.png"></p>
<ol start="2">
<li>raid</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 软raid的查看方式</span></span></span><br><span class="line">fdisk -l</span><br><span class="line">cat /proc/scsi/scsi</span><br><span class="line">或</span><br><span class="line">cat /proc/mdstat</span><br><span class="line">cat /etc/mdadm.conf</span><br></pre></td></tr></table></figure>

<h3 id="File-System"><a href="#File-System" class="headerlink" title="File System"></a>File System</h3><h4 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h4><h5 id="系统级别"><a href="#系统级别" class="headerlink" title="系统级别"></a>系统级别</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sysctl -h</span><br><span class="line"><span class="meta">#</span><span class="bash"> 统计每个进程打开文件数，第二行是Pid，第一行是数量</span></span><br><span class="line">lsof -n|awk &#x27;&#123;print $2&#125;&#x27;|sort|uniq -c|sort -nr|more</span><br></pre></td></tr></table></figure>

<p><img src="system-file-limit.png"></p>
<blockquote>
<p>这里用官方文档解释一下file-nr、open-nr、file-max分别代表的意思</p>
</blockquote>
<p><img src="file-introduction.png"></p>
<p>    <a target="_blank" rel="noopener" href="https://docs.kernel.org/admin-guide/sysctl/fs.html">官方说明</a></p>
<h5 id="用户级别"><a href="#用户级别" class="headerlink" title="用户级别"></a>用户级别</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ulimit -h</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询单个用户进程打开文件数，后面加上数字可临时修改，对当前shell有效</span></span><br><span class="line">ulimit -n</span><br><span class="line"><span class="meta">#</span><span class="bash"> 永久设置，设置的格式内容可以参照/etc/security/limits.conf前面的描述</span>            </span><br><span class="line">vim /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br></pre></td></tr></table></figure>

<h4 id="inode"><a href="#inode" class="headerlink" title="inode"></a>inode</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> inode在文件系统初始化的时候通过-N 指定数量</span></span><br><span class="line">df -i /</span><br></pre></td></tr></table></figure>

<h4 id="磁盘分区及挂载、用量"><a href="#磁盘分区及挂载、用量" class="headerlink" title="磁盘分区及挂载、用量"></a>磁盘分区及挂载、用量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看磁盘情况</span></span><br><span class="line">fdisk -l</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看分区、挂载</span></span><br><span class="line">df</span><br><span class="line">lsblk</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看文件夹下用量，进入该文件夹</span></span><br><span class="line">du -sh .</span><br></pre></td></tr></table></figure>

<h3 id="Process-Thread"><a href="#Process-Thread" class="headerlink" title="Process/Thread"></a>Process/Thread</h3><ol>
<li>Pid</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 系统对Pid限制</span></span><br><span class="line">sysctl -a | grep</span><br><span class="line">ulimit -u</span><br><span class="line">vim /etc/security/limits.con </span><br><span class="line">*        hard    nproc           5000</span><br><span class="line">*        soft    nproc           5000</span><br></pre></td></tr></table></figure>

<p><img src="pid-limit.png"></p>
<blockquote>
<p> 在Linux操作系统中，线程和进程的数据结构是一样的，只不过线程是通过clone的方式创建的共享父进程的内存，而进程是通过fork产生的，拥有自己独立的内存。</p>
<p>pid_max代表的是独立内存的进程的最大数量</p>
<p>thread_max是代表的是共享内存的进程的最大数量</p>
</blockquote>
<ol start="2">
<li>进程数/线程数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看进程</span></span><br><span class="line">ps -ef</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看线程  -T     Show threads, possibly with SPID column.</span></span><br><span class="line">ps -eT</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>僵尸进程</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看zombie</span></span><br><span class="line">top</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者查看状态为Z的</span></span><br><span class="line">ps -ef | grep defunct</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如何处理僵尸进程</p>
<p>可以kill僵尸进程的父进程，这样僵尸进程就成为孤儿进程，会托管给init进程，init进程会清理僵尸进程</p>
</blockquote>
<h2 id="历史记录"><a href="#历史记录" class="headerlink" title="历史记录"></a>历史记录</h2><h3 id="sysstat"><a href="#sysstat" class="headerlink" title="sysstat"></a>sysstat</h3><p>    sysstat服务启动以后，每十分钟收集一次系统系统状态信息（定时任务：cat /etc/cron.d/sysstat），数据记录在/var/log/sa目录下。配置文件在/etc/sysconfig/sysstat。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">man sar</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看/var/<span class="built_in">log</span>/sa下的历史某天记录</span></span><br><span class="line">cd /var/log/sa</span><br><span class="line">ll -al</span><br><span class="line"><span class="meta">#</span><span class="bash"> sadd是二进制文件，可通过如下命令查看；sardd是文本文件，可以直接查看</span></span><br><span class="line">sar -f sa   </span><br></pre></td></tr></table></figure>

<h3 id="系统日志"><a href="#系统日志" class="headerlink" title="系统日志"></a>系统日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">man journalctl</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内核日志</span></span><br><span class="line">journalctl -k</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看上一次的启动日志</span></span><br><span class="line">journalctl -b -1</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Shadow802</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">60</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shadow802</span>
</div>

<div class="powered-by">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <i class="fa fa-user-md"></i>
    <span id="busuanzi_container_site_uv">
        本站访客数:<span id="busuanzi_value_site_uv"></span>
    </span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_pv">
        本站访问量<span id="busuanzi_value_site_pv"></span>
    </span>
</div>
        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
