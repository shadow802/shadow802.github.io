<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shadow802.gitee.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Shadow802">
<meta property="og:url" content="https://shadow802.gitee.io/page/3/index.html">
<meta property="og:site_name" content="Shadow802">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Shadow802">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://shadow802.gitee.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Shadow802</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Shadow802</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2021/08/04/%E8%AE%B0%E4%B8%80%E6%AC%A1Golang%E7%8E%AF%E5%A2%83%E8%B0%83%E8%AF%95%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/04/%E8%AE%B0%E4%B8%80%E6%AC%A1Golang%E7%8E%AF%E5%A2%83%E8%B0%83%E8%AF%95%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">记一次Golang环境调试问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-04 00:00:00" itemprop="dateCreated datePublished" datetime="2021-08-04T00:00:00+08:00">2021-08-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h2><p>​    在Goland编写Rest API发布到测试环境中（kubernetes的pod）后，发现有一个API查询不到数据，而且无任何异常日志。与本地测试情况不符。</p>
<p>​    这批API承担的任务，都是根据前端请求的情况，通过httpclient调用harbor2.0的 API，然后将数据封装成已有的对象，返回给前端。因为本次做了Harbor的升级，为了减少前端的改动并同时兼容新旧版本Harbor的API，所以需要首先将数据反序列化成根据Harbor2.0 API返回值对应的数据结构，然后再转换成工程中为旧版本Harbor定义的数据结构。</p>
<h2 id="原因排查"><a href="#原因排查" class="headerlink" title="原因排查"></a>原因排查</h2><p>​    一开始排查的方向首先是自己的代码是否与测试环境不一致，经多次重新发布，核实，证明本地代码与测试环境完全一致。</p>
<p>​    后来不知到因为啥把焦点放在了harbor2.0的API上，是否在kubernetes容器化后，harbor2.0 api在windows和linux下返回的数据包的内容不相同或者是数据包内数据的key因为包含特殊字符，在不同操作系统下有差异。</p>
<p>​    于是就想用tcpdump抓包看一下kubernetes中数据包的情况，但是因为harbor2.0的API是采用https的方式，无法解密，因此在需要为TLS解密的时候放弃了这条路。</p>
<blockquote>
<p>这里因为对tcpdump + wireshark 抓包分析包的实操能力不足，浪费了很多时间，这里既然发现了在不同平台的差异，为什么不考虑运行环境的差异，例如Golang的编译、运行环境。这样就能少走一些弯路了。</p>
</blockquote>
<p>​    转而使用在代码中http调用返回的地方，追加日志，打印http的body。将byte[]转换成string的方式来打印显示。</p>
<p>​    意外发现，http body返回的数据格式与windows平台下的内容并无二致，证明与Harbor2.0 API并无关系，是代码中数据的反序列化出现了问题。</p>
<p>​    这里的代码使用了json.Unmarshal的反序列化方法。通过在测试环境中追加日志，发现问题就在这里。</p>
<p>​    后经在Goland中追踪json.Unmarshal的包，发现是Golang自带的包，才把问题定位在Golang的版本上，是否Golang的版本不同，测试环境上的Golang版本的反序列化方法存在bug？</p>
<p>​    后经排查，果然，测试环境编译、运行环境的Golang版本是1.10.1。而自己本地的Golang版本是1.16.4。</p>
<blockquote>
<p>之前看一个帖子，说是可以使用kubectl debug调试kubernetes中Pod的环境问题。因为测试环境的镜像都是alpine镜像，缺少 tcpdump、curl这样的工具。于是便想通过这样的方式来使用这些工具。但是没有找到有效的攻略~</p>
</blockquote>
<h2 id="实例验证"><a href="#实例验证" class="headerlink" title="实例验证"></a>实例验证</h2><p>​    将测试环境的版本升上来后，问题得以解决。看上去似乎是1.10.1的json.Unmarshal方法存在bug。下面通过demo做进一步验证：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> VulnerabilityItem <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID          <span class="keyword">string</span> <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">	Severity    <span class="keyword">string</span> <span class="string">`json:&quot;severity&quot;`</span></span><br><span class="line">	Pkg         <span class="keyword">string</span> <span class="string">`json:&quot;package&quot;`</span></span><br><span class="line">	Version     <span class="keyword">string</span> <span class="string">`json:&quot;version&quot;`</span></span><br><span class="line">	Description <span class="keyword">string</span> <span class="string">`json:&quot;description&quot;`</span></span><br><span class="line">	Link        <span class="keyword">string</span> <span class="string">`json:&quot;link&quot;`</span></span><br><span class="line">	Fixed       <span class="keyword">string</span> <span class="string">`json:&quot;fixedVersion,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	source :=</span><br><span class="line"><span class="string">`&#123;</span></span><br><span class="line"><span class="string">	&quot;application/vnd.scanner.adapter.vuln.report.harbor+json; version=1.0&quot;: &#123;</span></span><br><span class="line"><span class="string">		&quot;vulnerabilities&quot;: [&#123;</span></span><br><span class="line"><span class="string">			&quot;id&quot;: &quot;CVE-2017-8105&quot;,</span></span><br><span class="line"><span class="string">			&quot;package&quot;: &quot;freetype&quot;,</span></span><br><span class="line"><span class="string">			&quot;version&quot;: &quot;2.7-r1&quot;,</span></span><br><span class="line"><span class="string">			&quot;fix_version&quot;: &quot;2.7.1-r1&quot;,</span></span><br><span class="line"><span class="string">			&quot;severity&quot;: &quot;Critical&quot;,</span></span><br><span class="line"><span class="string">			&quot;description&quot;: &quot;FreeType 2 before 2017-03-24 has an out-of-bounds write caused by a heap-based buffer overflow related to the t1_decoder_parse_charstrings function in psaux/t1decode.c.&quot;,</span></span><br><span class="line"><span class="string">			&quot;links&quot;: [&quot;https://avd.aquasec.com/nvd/cve-2017-8105&quot;],</span></span><br><span class="line"><span class="string">			&quot;artifact_digests&quot;: [&quot;sha256:84ac8884cab3b1abbfce0e85d4c32dafd8deb41652a9d54696f17d274dfc8ad0&quot;],</span></span><br><span class="line"><span class="string">			&quot;preferred_cvss&quot;: &#123;</span></span><br><span class="line"><span class="string">				&quot;score_v3&quot;: 9.8,</span></span><br><span class="line"><span class="string">				&quot;score_v2&quot;: 7.5,</span></span><br><span class="line"><span class="string">				&quot;vector_v3&quot;: &quot;CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H&quot;,</span></span><br><span class="line"><span class="string">				&quot;vector_v2&quot;: &quot;AV:N/AC:L/Au:N/C:P/I:P/A:P&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;cwe_ids&quot;: [&quot;CWE-787&quot;],</span></span><br><span class="line"><span class="string">			&quot;vendor_attributes&quot;: &#123;</span></span><br><span class="line"><span class="string">				&quot;CVSS&quot;: &#123;</span></span><br><span class="line"><span class="string">					&quot;nvd&quot;: &#123;</span></span><br><span class="line"><span class="string">						&quot;V2Score&quot;: 7.5,</span></span><br><span class="line"><span class="string">						&quot;V2Vector&quot;: &quot;AV:N/AC:L/Au:N/C:P/I:P/A:P&quot;,</span></span><br><span class="line"><span class="string">						&quot;V3Score&quot;: 9.8,</span></span><br><span class="line"><span class="string">						&quot;V3Vector&quot;: &quot;CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H&quot;</span></span><br><span class="line"><span class="string">					&#125;,</span></span><br><span class="line"><span class="string">					&quot;redhat&quot;: &#123;</span></span><br><span class="line"><span class="string">						&quot;V3Score&quot;: 7,</span></span><br><span class="line"><span class="string">						&quot;V3Vector&quot;: &quot;CVSS:3.0/AV:L/AC:H/PR:N/UI:R/S:U/C:H/I:H/A:H&quot;</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;, &#123;</span></span><br><span class="line"><span class="string">			&quot;id&quot;: &quot;CVE-2017-8287&quot;,</span></span><br><span class="line"><span class="string">			&quot;package&quot;: &quot;freetype&quot;,</span></span><br><span class="line"><span class="string">			&quot;version&quot;: &quot;2.7-r1&quot;,</span></span><br><span class="line"><span class="string">			&quot;fix_version&quot;: &quot;2.7.1-r1&quot;,</span></span><br><span class="line"><span class="string">			&quot;severity&quot;: &quot;Critical&quot;,</span></span><br><span class="line"><span class="string">			&quot;description&quot;: &quot;FreeType 2 before 2017-03-26 has an out-of-bounds write caused by a heap-based buffer overflow related to the t1_builder_close_contour function in psaux/psobjs.c.&quot;,</span></span><br><span class="line"><span class="string">			&quot;links&quot;: [&quot;https://avd.aquasec.com/nvd/cve-2017-8287&quot;],</span></span><br><span class="line"><span class="string">			&quot;artifact_digests&quot;: [&quot;sha256:84ac8884cab3b1abbfce0e85d4c32dafd8deb41652a9d54696f17d274dfc8ad0&quot;],</span></span><br><span class="line"><span class="string">			&quot;preferred_cvss&quot;: &#123;</span></span><br><span class="line"><span class="string">				&quot;score_v3&quot;: 9.8,</span></span><br><span class="line"><span class="string">				&quot;score_v2&quot;: 7.5,</span></span><br><span class="line"><span class="string">				&quot;vector_v3&quot;: &quot;CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H&quot;,</span></span><br><span class="line"><span class="string">				&quot;vector_v2&quot;: &quot;AV:N/AC:L/Au:N/C:P/I:P/A:P&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;cwe_ids&quot;: [&quot;CWE-119&quot;],</span></span><br><span class="line"><span class="string">			&quot;vendor_attributes&quot;: &#123;</span></span><br><span class="line"><span class="string">				&quot;CVSS&quot;: &#123;</span></span><br><span class="line"><span class="string">					&quot;nvd&quot;: &#123;</span></span><br><span class="line"><span class="string">						&quot;V2Score&quot;: 7.5,</span></span><br><span class="line"><span class="string">						&quot;V2Vector&quot;: &quot;AV:N/AC:L/Au:N/C:P/I:P/A:P&quot;,</span></span><br><span class="line"><span class="string">						&quot;V3Score&quot;: 9.8,</span></span><br><span class="line"><span class="string">						&quot;V3Vector&quot;: &quot;CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H&quot;</span></span><br><span class="line"><span class="string">					&#125;,</span></span><br><span class="line"><span class="string">					&quot;redhat&quot;: &#123;</span></span><br><span class="line"><span class="string">						&quot;V3Score&quot;: 7,</span></span><br><span class="line"><span class="string">						&quot;V3Vector&quot;: &quot;CVSS:3.0/AV:L/AC:H/PR:N/UI:R/S:U/C:H/I:H/A:H&quot;</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;]</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;`</span></span><br><span class="line"></span><br><span class="line">	vulnerability := <span class="keyword">struct</span> &#123;</span><br><span class="line">		Mime <span class="keyword">struct</span>&#123;</span><br><span class="line">			Vulnerabilities []VulnerabilityItem <span class="string">`json:&quot;vulnerabilities&quot;`</span></span><br><span class="line">		&#125; <span class="string">`json:&quot;application/vnd.scanner.adapter.vuln.report.harbor+json; version=1.0&quot;`</span></span><br><span class="line">	&#125;&#123;&#125;</span><br><span class="line"></span><br><span class="line">	err := json.Unmarshal([]<span class="keyword">byte</span>(source), &amp;vulnerability)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;vulnerability: %s\n&quot;</span>, vulnerability)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	source = <span class="string">`&#123;&quot;nam/.+;=e&quot;:&quot;shadow&quot;&#125;`</span></span><br><span class="line"></span><br><span class="line">	shadow := <span class="keyword">struct</span> &#123;</span><br><span class="line">		Name <span class="keyword">string</span> <span class="string">`json:&quot;nam/.+;=e&quot;`</span></span><br><span class="line">	&#125;&#123;&#125;</span><br><span class="line"></span><br><span class="line">	err = json.Unmarshal([]<span class="keyword">byte</span>(source), &amp;shadow)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;shadow: %s\n&quot;</span>, shadow)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>​    首先使用了问题API中一段数据，进行测试情况还原，然后自己编写了demo数据，使用测试环境的镜像，直接执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将代码挂载进容器，执行，观察打印的反序列化方法</span></span><br><span class="line">docker run --name=shadow -v /root/windows/shadow/practice/basic:/basic  reg.xxxxx.net/library/golang:1.10.1-alpine3.7  go run /basic/unmarshal.go</span><br></pre></td></tr></table></figure>

<p>​    通过不断调整反序列化使用的key的特殊字符，最后发现，<strong>Golang 1.10.1 的json.Unmarshal方法，当key中含有”;”时，无法正确反序列化数据，而且不报错。最后反序列化的结果是空对象。</strong></p>
<blockquote>
<p>鉴于Golang 1.10.1的版本过低，加上本次发现的bug，目前将计划提出将相应工程的Golang版本升级到1.16.4。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2021/07/31/Kubernetes-Operator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/31/Kubernetes-Operator/" class="post-title-link" itemprop="url">Kubernetes-Operator</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-31 00:00:00" itemprop="dateCreated datePublished" datetime="2021-07-31T00:00:00+08:00">2021-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​    Kubernetes采用声明式的编程模式，为应用开发者屏蔽了底层实现细节，将实现细节下沉给平台的开发者，专业的事情交给专业的人来做，Operator将运维实施中有状态组件的部署经验按照K8S控制器模式封装起来，提供给上层用户使用。</p>
<p>​    Operator是K8S特性扩展中重要的一环。Operator=CRD+Controller。</p>
<h1 id="基础简介"><a href="#基础简介" class="headerlink" title="基础简介"></a>基础简介</h1><h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>​    Informer架构设计中的几个核心组件：<br>（1）Reflector：监控K8S中指定的资源，当资源发生变化时，触发相应的事件（Added、Updated、Deleted），并将<strong>资源对象</strong>存放到本地缓存Delta FIFO中。这是一个Informer的包，使用ListAndWatch完成监听。<br>（2）DeltaFIFO：一个保存资源对象的存储（可以保存操作类型）的先进先出队列，Delta是增量的意思。<br>（3）Indexer：是client-go用来存储操作对象并自带索引功能的本地存储。Reflector从DeltaFIFO中将消费出来的资源对象，存储至Indexer。</p>
<p><img src="informer.png" alt="informer"></p>
<p>下面以实际的场景来分析一下：<br>（1）首先我们将用户自定义的crd提交API Server。使K8S了解我们新增的资源对象的schema。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">networks.samplecrd.k8s.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">samplecrd.k8s.io</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Network</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">networks</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br></pre></td></tr></table></figure>

<p>（2）然后使用这个CRD，创建一个实际的资源对象。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">samplecrd.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Network</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-network</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">cidr:</span> <span class="string">&quot;192.168.0.0/16&quot;</span></span><br><span class="line">  <span class="attr">gateway:</span> <span class="string">&quot;192.168.0.1&quot;</span></span><br></pre></td></tr></table></figure>



<p>（3）资源对象（用户期望的状态）存放到ETCD后。Network的Controller是使用Informer始终ListAndWatch Network资源对象的变化。将监听到的资源对象和资源对象的操作类型放入到DeltaFIFO的队列中。</p>
<p>（4）然后Informer会源源不断地从DeltaFIFO中获取资源对象，并根据操作类型，更新本地Indexer缓存。另外每经过resyncPeriod指定的时间，Informer都会使用最近一次返回的列表数据，强制更新一次缓存（Resync）。这样始终保持缓存与ETCD保持一致。也减少了频繁访问API Server造成的服务器压力。</p>
<p>（5）另一方面 Informer会根据资源对象的操作类型触发对应的事件回调，将操作对象的key（namespace/name）添加到workqueue中。</p>
<p>（6）Controller的控制循环启动后，会首先判断是否完成一次Resync。然后并发启动多个Worker处理workqueue里的数据（根据key通过Lister取出对应的API对象）。</p>
<p><img src="client-go-controller-interaction.jpeg" alt="client-go-controller-interaction"></p>
<h2 id="脚手架工具"><a href="#脚手架工具" class="headerlink" title="脚手架工具"></a>脚手架工具</h2><p>​    手工编写Operator，门槛较高，需要对K8S的源码和设计架构有深刻的认识，为了让普通开发人员关注自身的实现逻辑，简化Operator的开发，目前业界提供了两个开发Operator的脚手架：Kubebuilder  VS Operator-SDK，核心均依赖于底层的controller-tools和controller-runtime。</p>
<p>​    Kubebuilder由K8S SIG负责开发维护，而Operator-SDK由CoreOS开发维护。两者目前正进行深度整合。鉴于”亲儿子”的天生优势，本文选择Kubebuilder进行实践。</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>​    目前Kubebuilder Github没有提供Windows的二进制文件，曾尝试过在windows平台下载源码打包，但因各种问题，无法进行下去，最终通过在虚拟机中安装Centos7.6操作系统，安装kuberbuilder，成功初始化测试项目。现将步骤整理如下。</p>
<h2 id="GVM-G"><a href="#GVM-G" class="headerlink" title="GVM/G"></a>GVM/G</h2><p>​    鉴于实际编码中对Go不同版本的切换需求，需要安装一个Go的版本管理器，实现不同版本的安装和切换。windows下采用<a target="_blank" rel="noopener" href="https://github.com/stefanmaric/g">g</a>。linux环境下使用<a target="_blank" rel="noopener" href="https://github.com/moovweb/gvm">gvm</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">##g安装（windows）</span><br><span class="line">1.github上下载g的二进制文件，将其放入环境变量PATH中。</span><br><span class="line">2.新增环境变量G_MIRROR&#x3D;https:&#x2F;&#x2F;golang.google.cn&#x2F;dl&#x2F;</span><br><span class="line">3.在PATH中追加GO的路径，%USERPROFILE%\.g\go\bin，指向g的连接目录。（清除掉其它的go的目录）</span><br><span class="line"></span><br><span class="line">4.常用命令：g ls-remot; g ls; g install gox.xx.x; g use x.xx.xx</span><br><span class="line">注意g use要使用管理员身份打开cmd。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##gvm安装（linux）</span><br><span class="line">1. bash &lt; &lt;(curl -s -S -L https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;moovweb&#x2F;gvm&#x2F;master&#x2F;binscripts&#x2F;gvm-installer)</span><br><span class="line"></span><br><span class="line">2. 常用命令：gvm listall; gvm list; gvm use gox.xx.xx --default; gvm install gx.xx.xx</span><br><span class="line">如果遇到网络问题无法安装，可以自行下载安装包放入&#x2F;root&#x2F;.gvm&#x2F;archive中，然后执行gvm install gox.xx.xx -B。本例使用root用户登录。</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="Kubebuilder"><a href="#Kubebuilder" class="headerlink" title="Kubebuilder"></a>Kubebuilder</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/$(go env GOOS)/$(go env GOARCH)</span><br><span class="line">chmod +x kubebuilder &amp;&amp; mv kubebuilder /usr/<span class="built_in">local</span>/bin/</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://master.book.kubebuilder.io/introduction.html">Kubebuilder</a></p>
<h2 id="Kustomize"><a href="#Kustomize" class="headerlink" title="Kustomize"></a>Kustomize</h2><p>​    Kubebuilder生成的项目模板中，使用Makefile进行打包、部署、运行，中间会自动下载使用kustomize的二进制文件，无需自行安装。</p>
<p>​    Kustomize类似于Helm，可以简单理解为一个yaml文件生成工具，可以基于基础yaml模板，配合kustomize的配置文件和语法，分发生成不同环境下的yaml部署文件，解决了K8S部署中，yaml部署文件的多环境配置、生成和版本管理。</p>
<h2 id="Code-Generator"><a href="#Code-Generator" class="headerlink" title="Code Generator"></a>Code Generator</h2><p>​    生成Kubernetes-style的代码。</p>
<p>​    生成器包括：</p>
<ul>
<li><p><strong>client-gen</strong></p>
</li>
<li><p><strong>conversion-gen</strong></p>
</li>
<li><p><strong>deepcopy-gen</strong></p>
</li>
<li><p>defaulter-gen</p>
</li>
<li><p>go-to-protobuf</p>
</li>
<li><p>import-boss</p>
</li>
<li><p><strong>informer-gen</strong></p>
</li>
<li><p><strong>lister-gen</strong></p>
</li>
<li><p>openapi-gen</p>
</li>
<li><p>register-gen</p>
</li>
<li><p>set-gen</p>
<p>可直接将项目clone到工程中，然后使用对应的脚本生成代码。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/code-generator">Code Generator Github</a></p>
<p><a target="_blank" rel="noopener" href="https://www.openshift.com/blog/kubernetes-deep-dive-code-generation-customresources">参考资料</a></p>
</li>
</ul>
<h2 id="Windows-Linux-Share-File"><a href="#Windows-Linux-Share-File" class="headerlink" title="Windows/Linux Share File"></a>Windows/Linux Share File</h2><p>​    因为kubebuilder目前不支持windows，因此需要在CentOS虚拟机中进行代码生成，而实际编写代码是在win10下使用Goland。为了避免在两个操作系统之间拷贝文件，直接将win10的目录设置为共享目录，并挂载进Centos的目录下。</p>
<p>​    1）设置win10的代码目录为共享目录</p>
<p>​    2）在Centos中使用mount挂载win10的共享目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t cifs -o username=&#123;win10登录用户名&#125;,password=&#123;win10登录密码&#125; //&#123;win10主机IP，例如10.190.181.204&#125;/go /root/windows</span><br></pre></td></tr></table></figure>

<p>​    这样就可以实现Linux和Windows共享同一份代码。</p>
<h1 id="项目实战"><a href="#项目实战" class="headerlink" title="项目实战"></a>项目实战</h1><p>​    使用上述脚手架工具，从头搭建一个项目，进行验证。</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">版本</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Golang</td>
<td align="left">1.16.5 linux/amd64</td>
</tr>
<tr>
<td align="left">Kubebuilder</td>
<td align="left">3.1.0</td>
</tr>
<tr>
<td align="left">Kubernetes</td>
<td align="left">v1.20.8</td>
</tr>
</tbody></table>
<h2 id="Initialize"><a href="#Initialize" class="headerlink" title="Initialize"></a>Initialize</h2><p>​    首先需要进行项目的初始化，包括go mod init 和 kubebuilder init两个步骤。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir operator</span><br><span class="line"><span class="built_in">cd</span> operator</span><br><span class="line">go mod init operator</span><br><span class="line">kubebuilder init --domain shadow.io</span><br></pre></td></tr></table></figure>

<p>​    执行后的项目目录如下</p>
<p><img src="project-init.png" alt="project-init"></p>
<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><p>​    创建一个CRD+Controller的模板项目，选择是否创建resource和api，这里均选y。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubebuilder create api --group shadow --version v1 --kind Example</span><br></pre></td></tr></table></figure>

<p>​    执行日志：</p>
<p><img src="api-create-log.png" alt="api-create-log"></p>
<p>​    项目目录（第二张图片第一行与第一张图片最后一行是同一个文件）：</p>
<p><img src="api-tree-1.png" alt="api-tree-1"></p>
<p><img src="api-tree-2.png" alt="api-tree-2"></p>
<p>​    项目根目录文件结构：</p>
<p>​    （1）api：</p>
<table>
<thead>
<tr>
<th>文件名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>example_types.go</td>
<td>这个是CRD的定义文件，编写自定义CRD的结构。</td>
</tr>
<tr>
<td>groupversion_info.go</td>
<td>注册CRD的schema、scheme，一般不需要修改。</td>
</tr>
<tr>
<td>zz_generated.deepcopy.go</td>
<td>controller-gen自动生成的deepcopy方法。不能修改。</td>
</tr>
</tbody></table>
<p>​    （2）bin</p>
<p>​            执行makefile、kubebuilder等命令，中使用的代码生成器，codegen。</p>
<p>​    （3）config</p>
<p>​            存放使用kustomize管理的yaml文件，用作环境部署。还有一些样例yaml，用作测试。</p>
<p>​    （4）controllers</p>
<p>​            主要存放controller的实现代码。</p>
<p>​    （5）hack</p>
<p>​            代码生成器所使用的文件，例如版权表头文件和一些代码生成的shell脚本。</p>
<p>​    （6）文件</p>
<table>
<thead>
<tr>
<th>文件名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>.dockerignore、.gitignore</td>
<td>ignore文件</td>
</tr>
<tr>
<td>Dockerfile</td>
<td>镜像打包文件</td>
</tr>
<tr>
<td>go.mod、go.sum</td>
<td>go module的依赖管理文件</td>
</tr>
<tr>
<td>main.go</td>
<td>项目入口</td>
</tr>
<tr>
<td>Makefile</td>
<td>编译打包工具，类似于maven</td>
</tr>
<tr>
<td>PROJECT</td>
<td>项目基本信息</td>
</tr>
</tbody></table>
<p>​    对于实现一个简单的Operator，一般只需要修改:</p>
<p>​    1）api目录中的CRD文件定义（example_type.go）</p>
<p>​    2）启动入口文件main.go（例如修改监听的资源类型，过滤掉不需要的事件等）</p>
<p>​    3）controller目录中的文件（example_controller.go）</p>
<p>​    其它文件可使用Makefile中的命令，自动更新生成。</p>
<p>​    使用代码来验证一下Operator是否工作，这里直接使用了最近写的一个demo（这里没有使用到CRD，watch的是核心资源namespace）。</p>
<p>​    主要需求是使用Spring-Cloud-Kubernetes框架后，在PaaS平台创建Namespace，并将应用部署到K8S后，需要为Namespace下的所有ServiceAccount（包括default）分配资源的API权限，具体可以参考 <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-kubernetes/1.1.0.M2/reference/html/#_security_configurations_inside_kubernetes">Spring-Cloud-kubernetes Github 说明</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">##controllers/ns_controller.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> controllers</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	rbacv1 <span class="string">&quot;k8s.io/api/rbac/v1&quot;</span></span><br><span class="line">	metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/apimachinery/pkg/types&quot;</span></span><br><span class="line">	ctrl <span class="string">&quot;sigs.k8s.io/controller-runtime&quot;</span></span><br><span class="line">	<span class="string">&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;</span></span><br><span class="line">	<span class="string">&quot;sigs.k8s.io/controller-runtime/pkg/event&quot;</span></span><br><span class="line">	<span class="string">&quot;sigs.k8s.io/controller-runtime/pkg/log&quot;</span></span><br><span class="line">	<span class="string">&quot;sigs.k8s.io/controller-runtime/pkg/predicate&quot;</span></span><br><span class="line"></span><br><span class="line">	corev1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	permissionSkipAnnotation = <span class="string">&quot;permission.k8s.shadow.io/skip&quot;</span></span><br><span class="line">	roleName                 = <span class="string">&quot;spring-cloud-kubernetes-role&quot;</span></span><br><span class="line">	roleBindingsName         = <span class="string">&quot;spring-cloud-kubernetes-role-bindings&quot;</span></span><br><span class="line">	rbacAPIGroup             = <span class="string">&quot;rbac.authorization.k8s.io&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> NamespaceReconciler <span class="keyword">struct</span> &#123;</span><br><span class="line">	client.Client</span><br><span class="line">	Scheme *runtime.Scheme</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//+kubebuilder:rbac:groups=&quot;&quot;,resources=namespaces,verbs=get;update;watch;list</span></span><br><span class="line"><span class="comment">//+kubebuilder:rbac:groups=&quot;rbac.authorization.k8s.io&quot;,resources=roles,verbs=create;bind;escalate</span></span><br><span class="line"><span class="comment">//+kubebuilder:rbac:groups=&quot;rbac.authorization.k8s.io&quot;,resources=rolebindings,verbs=create</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *NamespaceReconciler)</span> <span class="title">Reconcile</span><span class="params">(ctx context.Context, req ctrl.Request)</span> <span class="params">(ctrl.Result, error)</span></span> &#123;</span><br><span class="line">	logger := log.FromContext(ctx)</span><br><span class="line">	logger.Info(<span class="string">&quot;namespace permission reconcile start......&quot;</span>)</span><br><span class="line">	<span class="keyword">defer</span> logger.Info(<span class="string">&quot;namespace permission reconcile end!!!!!!&quot;</span>)</span><br><span class="line"></span><br><span class="line">	ns := &amp;corev1.Namespace&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> err := r.Get(ctx, req.NamespacedName, ns); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ctrl.Result&#123;&#125;, client.IgnoreNotFound(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//skip ns when it has been initialized</span></span><br><span class="line">	<span class="keyword">if</span> ns.GetAnnotations()[permissionSkipAnnotation] == <span class="string">&quot;true&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ctrl.Result&#123;&#125;, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//permission init</span></span><br><span class="line">	<span class="keyword">if</span> err := permissionInit(r, ctx, req.NamespacedName); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		logger.Error(err, <span class="string">&quot;permission init error&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//annotation record</span></span><br><span class="line">	<span class="keyword">if</span> ns.Annotations != <span class="literal">nil</span> &#123;</span><br><span class="line">		ns.Annotations[permissionSkipAnnotation] = <span class="string">&quot;true&quot;</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ns.Annotations = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">			permissionSkipAnnotation: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := r.Update(ctx, ns); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		logger.Error(err, <span class="string">&quot;namespace update error&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ctrl.Result&#123;&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetupWithManager sets up the controller with the Manager.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *NamespaceReconciler)</span> <span class="title">SetupWithManager</span><span class="params">(mgr ctrl.Manager)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> ctrl.NewControllerManagedBy(mgr).</span><br><span class="line">		For(&amp;corev1.Namespace&#123;&#125;).</span><br><span class="line">		WithEventFilter(predicate.Funcs&#123;</span><br><span class="line">			<span class="comment">// ignore DeleteEvent</span></span><br><span class="line">			DeleteFunc: <span class="function"><span class="keyword">func</span><span class="params">(event event.DeleteEvent)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="comment">// ignore GenericEvent</span></span><br><span class="line">			GenericFunc: <span class="function"><span class="keyword">func</span><span class="params">(event event.GenericEvent)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="comment">// ignore UpdateEvent</span></span><br><span class="line">			UpdateFunc: <span class="function"><span class="keyword">func</span><span class="params">(updateEvent event.UpdateEvent)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;).</span><br><span class="line">		Complete(r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">permissionInit</span><span class="params">(r *NamespaceReconciler, ctx context.Context, namespacedName types.NamespacedName)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	role := &amp;rbacv1.Role&#123;</span><br><span class="line">		ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">			Name:      roleName,</span><br><span class="line">			Namespace: namespacedName.Name,</span><br><span class="line">		&#125;,</span><br><span class="line">		Rules: []rbacv1.PolicyRule&#123;</span><br><span class="line">			&#123;</span><br><span class="line">				APIGroups: []<span class="keyword">string</span>&#123;<span class="string">&quot;&quot;</span>, <span class="string">&quot;extensions&quot;</span>, <span class="string">&quot;apps&quot;</span>&#125;,</span><br><span class="line">				Resources: []<span class="keyword">string</span>&#123;<span class="string">&quot;configmaps&quot;</span>, <span class="string">&quot;pods&quot;</span>, <span class="string">&quot;services&quot;</span>, <span class="string">&quot;endpoints&quot;</span>, <span class="string">&quot;secrets&quot;</span>&#125;,</span><br><span class="line">				Verbs:     []<span class="keyword">string</span>&#123;<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := r.Create(ctx, role); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	binding := &amp;rbacv1.RoleBinding&#123;</span><br><span class="line">		ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">			Name:      roleBindingsName,</span><br><span class="line">			Namespace: namespacedName.Name,</span><br><span class="line">		&#125;,</span><br><span class="line">		Subjects: []rbacv1.Subject&#123;</span><br><span class="line">			&#123;</span><br><span class="line">				Kind:     <span class="string">&quot;Group&quot;</span>,</span><br><span class="line">				Name:     <span class="string">&quot;system:serviceaccounts:&quot;</span> + namespacedName.Name,</span><br><span class="line">				APIGroup: rbacAPIGroup,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		RoleRef: rbacv1.RoleRef&#123;</span><br><span class="line">			Kind:     <span class="string">&quot;Role&quot;</span>,</span><br><span class="line">			Name:     roleName,</span><br><span class="line">			APIGroup: rbacAPIGroup,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := r.Create(ctx, binding); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## main.<span class="keyword">go</span> 中关于controller的注册部分</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err = (&amp;controllers.NamespaceReconciler&#123;</span><br><span class="line">    Client: mgr.GetClient(),</span><br><span class="line">    Scheme: mgr.GetScheme(),</span><br><span class="line">&#125;).SetupWithManager(mgr); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    setupLog.Error(err, <span class="string">&quot;unable to create controller&quot;</span>, <span class="string">&quot;controller&quot;</span>, <span class="string">&quot;permission&quot;</span>)</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>​    在项目目录中，直接执行make run，可以启动controller。看到输出日志。</p>
<p>​    在集群中创建一个新的ns，然后观察在该ns下是否有对应的role（spring-cloud-kubernetes-role）和rolebindings（spring-cloud-kubernetes-role-rolebindings）生成，而且已经生成的ns上会打上permission.k8s.shadow.io/skip=true的annotation。</p>
<p>​    <img src="operator-ns-validate.png" alt="operator-ns-validate"></p>
<h2 id="Webhook"><a href="#Webhook" class="headerlink" title="Webhook"></a>Webhook</h2><p>​    在Kubernetes中，有三种webhook：</p>
<p>​    1）admission webhook（变更或者是验证）</p>
<p>​    2）authorization webhook（权限认证）</p>
<p>​    3）CRD conversion webhook（自定义资源不同版本之间的转换）</p>
<p>​    这里重点关注admission的webhook。</p>
<p><img src="webhook-execute-sort.jpg" alt="webhook-execute-sort"></p>
<p>​        这里可以看出，admission controller的webhook是在Etcd落盘之前进行处理的。而Controller是在Etcd落盘之后，才进行工作的。</p>
<h3 id="为CRD创建Webhook"><a href="#为CRD创建Webhook" class="headerlink" title="为CRD创建Webhook"></a>为CRD创建Webhook</h3><p>​    使用Kubebuilder创建admission webhook</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubebuilder create webhook --group shadow --version v1 --kind Example --defaulting --programmatic-validation</span><br><span class="line"></span><br><span class="line"><span class="comment">##可以通过如下命令查看参数kubebuilder create webhook -h</span></span><br></pre></td></tr></table></figure>

<p><img src="kubebuilder-webhook-command.png" alt="kubebuilder-webhook-command"></p>
<p>​        <strong>kubebuilder不支持为核心类型，生成admission controller</strong></p>
<p>​    执行完上述命令后，工程中新增了文件：</p>
<p>​    1）api/v1/{example_webhook.go，webhook_suite_test.go}</p>
<p>​        可以看到example_webhook.go中实现了controller-runtime中admission包中的defaulter和validator接口。主要用以对pod进行变更和验证。</p>
<p>​    2）config/webhook目录，主要用以生成webhook的部署yaml</p>
<p>​    自动生成的代码中已经含有日志输出，可以用来进行简单的验证：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">##defaulter接口实现</span><br><span class="line"><span class="comment">// Default implements webhook.Defaulter so a webhooks will be registered for the type</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Example)</span> <span class="title">Default</span><span class="params">()</span></span> &#123;</span><br><span class="line">	examplelog.Info(<span class="string">&quot;default&quot;</span>, <span class="string">&quot;name&quot;</span>, r.Name)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO(user): fill in your defaulting logic.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##validator接口实现</span><br><span class="line"><span class="comment">// ValidateCreate implements webhook.Validator so a webhooks will be registered for the type</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Example)</span> <span class="title">ValidateCreate</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	examplelog.Info(<span class="string">&quot;validate create&quot;</span>, <span class="string">&quot;name&quot;</span>, r.Name)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO(user): fill in your validation logic upon object creation.</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ValidateUpdate implements webhook.Validator so a webhooks will be registered for the type</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Example)</span> <span class="title">ValidateUpdate</span><span class="params">(old runtime.Object)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	examplelog.Info(<span class="string">&quot;validate update&quot;</span>, <span class="string">&quot;name&quot;</span>, r.Name)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO(user): fill in your validation logic upon object update.</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ValidateDelete implements webhook.Validator so a webhooks will be registered for the type</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Example)</span> <span class="title">ValidateDelete</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	examplelog.Info(<span class="string">&quot;validate delete&quot;</span>, <span class="string">&quot;name&quot;</span>, r.Name)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO(user): fill in your validation logic upon object deletion.</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    Kubebuilder已经自动在入口文件中为我们注入了实现。如下图：</p>
<p><img src="kubebuilder-webhook-register.png" alt="kubebuilder-webhook-register"></p>
<h3 id="为核心资源生成Webhook"><a href="#为核心资源生成Webhook" class="headerlink" title="为核心资源生成Webhook"></a>为核心资源生成Webhook</h3><p>​    核心资源的webhook，需要自行编写文件实现controller-runtime中admission包中的webhook接口。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">##在项目根目录下创建webhook文件夹</span><br><span class="line">cd operator</span><br><span class="line">mkdir -p webhooks</span><br><span class="line"></span><br><span class="line">vim namespaces.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> webhooks</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	corev1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/apimachinery/pkg/util/json&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;</span></span><br><span class="line">	<span class="string">&quot;sigs.k8s.io/controller-runtime/pkg/webhook/admission&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> namespacesAnnotator <span class="keyword">struct</span> &#123;</span><br><span class="line">	Client  client.Client</span><br><span class="line">	decoder *admission.Decoder</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *namespacesAnnotator)</span> <span class="title">Handle</span><span class="params">(ctx context.Context, req admission.Request)</span> <span class="title">admission</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	ns := &amp;corev1.Namespace&#123;&#125;</span><br><span class="line">	err := a.decoder.Decode(req, ns)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> admission.Errored(http.StatusBadRequest, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// mutate the fields in namespace</span></span><br><span class="line">	<span class="keyword">if</span> annotations := ns.Annotations; annotations != <span class="literal">nil</span>&#123;</span><br><span class="line">		ns.Annotations[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;shadow&quot;</span></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		ns.Annotations = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">			<span class="string">&quot;name&quot;</span> : <span class="string">&quot;shadow&quot;</span>,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	marshaledNs, err := json.Marshal(ns)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> admission.Errored(http.StatusInternalServerError, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> admission.PatchResponseFromRaw(req.Object.Raw, marshaledNs)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *namespacesAnnotator)</span> <span class="title">InjectDecoder</span><span class="params">(d *admission.Decoder)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	a.decoder = d</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim setup.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> webhooks</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">ctrl <span class="string">&quot;sigs.k8s.io/controller-runtime&quot;</span></span><br><span class="line"><span class="string">&quot;sigs.k8s.io/controller-runtime/pkg/webhook&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//+kubebuilder:webhook:path=/annotate-v1-namespace,mutating=true,failurePolicy=fail,sideEffects=None,groups=&quot;&quot;,resources=namespaces,verbs=create;update,versions=v1,name=ns-annotate.admission.k8s.shadow.io,admissionReviewVersions=&#123;v1,v1beta1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetupWebhookWithManager</span><span class="params">(mgr ctrl.Manager)</span></span> &#123;</span><br><span class="line">	mgr.GetWebhookServer().Register(<span class="string">&quot;/annotate-v1-namespace&quot;</span>, &amp;webhook.Admission&#123;</span><br><span class="line">		Handler: &amp;namespacesAnnotator&#123;</span><br><span class="line">			Client: mgr.GetClient(),</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    在入口文件main.go中将webhook注册给manager</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//manual register webhooks for core resource</span></span><br><span class="line">webhooks.SetupWebhookWithManager(mgr)</span><br></pre></td></tr></table></figure>



<h3 id="部署验证"><a href="#部署验证" class="headerlink" title="部署验证"></a>部署验证</h3><p>​    需要准备一下用于测试的K8S集群，可以考虑使用Kind简单搭建一个，这里有现成的集群环境。就直接使用了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 首先检查一下虚拟机CentOS7.6中的Kubernetes连接是否正常，需要安装客户端工具+kubeconfig。这里不赘述。</span></span><br><span class="line">kubectl config current-context</span><br><span class="line">kubectl cluster-info</span><br><span class="line"></span><br><span class="line"><span class="comment">## 安装crd到集群中</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p><img src="make-install-cmd.png" alt="make-install-cmd"></p>
<p>​    从执行日志中可以看出，使用到了前面提供的controller-gen和kustomize两个脚手架工具，自动生成代码和yaml文件。</p>
<p>1）服务器部署</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 1.官方建议使cert-manager简化对证书的管理，然后执行make docker-build打包镜像，发布到K8S集群中。但是每次修改都要重新部署。</span></span><br><span class="line">kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.4.0/cert-manager.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## 2.如果因为网络问题执行测试用例报错，可以查看Makefile手动执行docker build，跳过测试的步骤</span></span><br><span class="line">make docker-build docker-push IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag  </span><br><span class="line">    <span class="comment">## 手动步骤</span></span><br><span class="line">    <span class="built_in">cd</span> operator</span><br><span class="line">    make generate manifests</span><br><span class="line">    <span class="comment">## 注意修改Dockerfile 将新增的webhooks目录在编译时也拷贝进builde容器，因为main.go中引用了这个package。</span></span><br><span class="line">    docker build -t &lt;some-registry&gt;/&lt;project-name&gt;:tag   </span><br><span class="line">    <span class="comment">## 如果无法下载go的依赖，可以在Dockerfile中添加这行 ENV GOPROXY=&quot;https://goproxy.cn,direct&quot;</span></span><br><span class="line">    <span class="comment">## FROM gcr.io/distroless/static:nonroot  修改为  FROM alpine:3.11</span></span><br><span class="line">docker push &lt;some-registry&gt;/&lt;project-name&gt;:tag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 3.将webhook的注释掉的配置，恢复</span></span><br><span class="line">vim config/default/kustomzation.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># Adds namespace to all resources.</span></span><br><span class="line">namespace: operator-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># Value of this field is prepended to the</span></span><br><span class="line"><span class="comment"># names of all resources, e.g. a deployment named</span></span><br><span class="line"><span class="comment"># &quot;wordpress&quot; becomes &quot;alices-wordpress&quot;.</span></span><br><span class="line"><span class="comment"># Note that it should also match with the prefix (text before &#x27;-&#x27;) of the namespace</span></span><br><span class="line"><span class="comment"># field above.</span></span><br><span class="line">namePrefix: operator-</span><br><span class="line"></span><br><span class="line"><span class="comment"># Labels to add to all resources and selectors.</span></span><br><span class="line"><span class="comment">#commonLabels:</span></span><br><span class="line"><span class="comment">#  someName: someValue</span></span><br><span class="line"></span><br><span class="line">bases:</span><br><span class="line">- ../crd</span><br><span class="line">- ../rbac</span><br><span class="line">- ../manager</span><br><span class="line"><span class="comment"># [WEBHOOK] To enable webhooks, uncomment all the sections with [WEBHOOK] prefix including the one in</span></span><br><span class="line"><span class="comment"># crd/kustomization.yaml</span></span><br><span class="line">- ../webhook</span><br><span class="line"><span class="comment"># [CERTMANAGER] To enable cert-manager, uncomment all sections with &#x27;CERTMANAGER&#x27;. &#x27;WEBHOOK&#x27; components are required.</span></span><br><span class="line">- ../certmanager</span><br><span class="line"><span class="comment"># [PROMETHEUS] To enable prometheus monitor, uncomment all sections with &#x27;PROMETHEUS&#x27;.</span></span><br><span class="line"><span class="comment">#- ../prometheus</span></span><br><span class="line"></span><br><span class="line">patchesStrategicMerge:</span><br><span class="line"><span class="comment"># Protect the /metrics endpoint by putting it behind auth.</span></span><br><span class="line"><span class="comment"># If you want your controller-manager to expose the /metrics</span></span><br><span class="line"><span class="comment"># endpoint w/o any authn/z, please comment the following line.</span></span><br><span class="line"><span class="comment">#- manager_auth_proxy_patch.yaml          ## 这个文件与manager_config_patch.yaml同时开启会有问题。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Mount the controller config file for loading manager configurations</span></span><br><span class="line"><span class="comment"># through a ComponentConfig type</span></span><br><span class="line">- manager_config_patch.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># [WEBHOOK] To enable webhooks, uncomment all the sections with [WEBHOOK] prefix including the one in</span></span><br><span class="line"><span class="comment"># crd/kustomization.yaml</span></span><br><span class="line">- manager_webhook_patch.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># [CERTMANAGER] To enable cert-manager, uncomment all sections with &#x27;CERTMANAGER&#x27;.</span></span><br><span class="line"><span class="comment"># Uncomment &#x27;CERTMANAGER&#x27; sections in crd/kustomization.yaml to enable the CA injection in the admission webhooks.</span></span><br><span class="line"><span class="comment"># &#x27;CERTMANAGER&#x27; needs to be enabled to use ca injection</span></span><br><span class="line">- webhookcainjection_patch.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># the following config is for teaching kustomize how to do var substitution</span></span><br><span class="line">vars:</span><br><span class="line"><span class="comment"># [CERTMANAGER] To enable cert-manager, uncomment all sections with &#x27;CERTMANAGER&#x27; prefix.</span></span><br><span class="line">- name: CERTIFICATE_NAMESPACE <span class="comment"># namespace of the certificate CR</span></span><br><span class="line">  objref:</span><br><span class="line">    kind: Certificate</span><br><span class="line">    group: cert-manager.io</span><br><span class="line">    version: v1</span><br><span class="line">    name: serving-cert <span class="comment"># this name should match the one in certificate.yaml</span></span><br><span class="line">  fieldref:</span><br><span class="line">    fieldpath: metadata.namespace</span><br><span class="line">- name: CERTIFICATE_NAME</span><br><span class="line">  objref:</span><br><span class="line">    kind: Certificate</span><br><span class="line">    group: cert-manager.io</span><br><span class="line">    version: v1</span><br><span class="line">    name: serving-cert <span class="comment"># this name should match the one in certificate.yaml</span></span><br><span class="line">- name: SERVICE_NAMESPACE <span class="comment"># namespace of the service</span></span><br><span class="line">  objref:</span><br><span class="line">    kind: Service</span><br><span class="line">    version: v1</span><br><span class="line">    name: webhooks-service</span><br><span class="line">  fieldref:</span><br><span class="line">    fieldpath: metadata.namespace</span><br><span class="line">- name: SERVICE_NAME</span><br><span class="line">  objref:</span><br><span class="line">    kind: Service</span><br><span class="line">    version: v1</span><br><span class="line">    name: webhooks-service</span><br><span class="line"></span><br><span class="line">vim config/crd/kustmozzation.yaml</span><br><span class="line"><span class="comment"># This kustomization.yaml is not intended to be run by itself,</span></span><br><span class="line"><span class="comment"># since it depends on service name and namespace that are out of this kustomize package.</span></span><br><span class="line"><span class="comment"># It should be run by config/default</span></span><br><span class="line">resources:</span><br><span class="line">- bases/shadow.shadow.io_examples.yaml</span><br><span class="line"><span class="comment">#+kubebuilder:scaffold:crdkustomizeresource</span></span><br><span class="line"></span><br><span class="line">patchesStrategicMerge:</span><br><span class="line"><span class="comment"># [WEBHOOK] To enable webhooks, uncomment all the sections with [WEBHOOK] prefix.</span></span><br><span class="line"><span class="comment"># patches here are for enabling the conversion webhooks for each CRD</span></span><br><span class="line">- patches/webhook_in_examples.yaml</span><br><span class="line"><span class="comment">#+kubebuilder:scaffold:crdkustomizewebhookpatch</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [CERTMANAGER] To enable webhooks, uncomment all the sections with [CERTMANAGER] prefix.</span></span><br><span class="line"><span class="comment"># patches here are for enabling the CA injection for each CRD</span></span><br><span class="line">- patches/cainjection_in_examples.yaml</span><br><span class="line"><span class="comment">#+kubebuilder:scaffold:crdkustomizecainjectionpatch</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># the following config is for teaching kustomize how to do kustomization for CRDs.</span></span><br><span class="line">configurations:</span><br><span class="line">- kustomizeconfig.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## 4.发布到集群</span></span><br><span class="line">make deploy IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag   <span class="comment">##需要熟悉kustomize的语法，主要解决kustomize执行遇到的问题</span></span><br></pre></td></tr></table></figure>

<p>​    执行日志：<img src="webhook-server-deploy.png" alt="webhook-server-deploy"></p>
<p>​    查看controller的运行状态和日志：</p>
<p><img src="operator-manager-log.png" alt="operator-manager-log"></p>
<p>​    创建一个ns，验证mutate是否生效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns shadow</span><br></pre></td></tr></table></figure>

<p><img src="core-resource-mutate-log.png" alt="core-resource-mutate-log"></p>
<p>​    对Example资源进行cud操作，验证是否生效：</p>
<p><img src="crd-example-cud.png" alt="crd-example-cud"></p>
<p><img src="crd-webhook-execute-log.png" alt="crd-webhook-execute-log"></p>
<p>​    可以看到admission webhook执行了创建和更新的日志输出，删除因为wehook的verb没有设置（如下标注，如果需要触发，需要增加delete的verb），所以没有触发。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;+kubebuilder:webhook:path&#x3D;&#x2F;validate-shadow-shadow-io-v1-example,mutating&#x3D;false,failurePolicy&#x3D;fail,sideEffects&#x3D;None,groups&#x3D;shadow.shadow.io,resources&#x3D;examples,verbs&#x3D;create;update,versions&#x3D;v1,name&#x3D;vexample.kb.io,admissionReviewVersions&#x3D;&#123;v1,v1beta1&#125;</span><br></pre></td></tr></table></figure>



<p>2）本地调试</p>
<p>​    本地调试可以参考<a target="_blank" rel="noopener" href="https://lailin.xyz/post/operator-08-kubebuilder-webhook.html">这里</a>。</p>
<p>​    <a target="_blank" rel="noopener" href="https://github.com/jetstack/cert-manager">cert-manager</a></p>
<blockquote>
<p>如果开发过程中，只调试controller不调试webhook，可以执行（make run ENABLE_WEBHOOKS=false）。</p>
</blockquote>
<h2 id="Code-Generator-1"><a href="#Code-Generator-1" class="headerlink" title="Code Generator"></a>Code Generator</h2><p>​    Client-go中提供了多种访问K8S资源的Client，这里我们重点研究，访问自定义的资源对象。目前已知有两种方式：Clientset和Dynamic Client。</p>
<p>​    Dynamic Client使用unstructured.Unstructured来描述资源的类型，有类型安全的问题，在序列化和反序列化的编码中，非常不友好，建议使用Clientset。</p>
<p>​    ClientSet依赖crd的资源定义和restclient，封装接口给上层应用使用。不同crd的Clientset存在大量的重复的模板式代码（Informer、Lister也是如此），使用codegen可以根据用户定义的crd自动生成符合k8s风格的代码。</p>
<h3 id="Clone"><a href="#Clone" class="headerlink" title="Clone"></a>Clone</h3><p>​    Code Generator 本质上是一系列代码生成器的shell脚本集合。要使用这些脚本，首先clone它们到operator项目中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> operator</span><br><span class="line">mkdir -p tools</span><br><span class="line"><span class="built_in">cd</span> tools</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/kubernetes/code-generator.git</span><br><span class="line"></span><br><span class="line"><span class="comment">## 一条命令生成clinetset、lister、informer</span></span><br><span class="line">tools/code-generator/generate-groups.sh all operator/pkg/generated/shadow operator/apis shadow:v1 --go-header-file ./hack/boilerplate.go.txt --output-base ../</span><br><span class="line"><span class="comment">### 参数说明见下图,这里有几点需要注意：</span></span><br><span class="line">（1）第一个参数all，可根据实际情况选择只生成具体需要的组件,具体查看<span class="built_in">help</span></span><br><span class="line">（2）第二、三个参数要包含module的名称，与工程的go.mod中保持一致，如果未包含module名称，代码无法生成</span><br><span class="line">（3）第四个参数为group:version。注意crd的定义必须放在这个目录下：第三个参数的路径/group/version/</span><br><span class="line">（4）后面可加-v number输出执行日志</span><br><span class="line">（5）开启kubuilder的multigroup功能，kubebuilder edit --multigroup=<span class="literal">true</span>。这样创建api会按照group/version的目录进行组织。未开启这个功能，kubebuilder创建api，crd定义在api下，开启之后，在apis下，并且按照group进行目录划分组织。</span><br><span class="line">（6）需要在crd定义的目录下，新增doc.go和register.go的文件</span><br><span class="line"></span><br><span class="line">vim api/shadow/v1/register.go</span><br><span class="line">package v1</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	<span class="string">&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// SchemeGroupVersion is group version used to register these objects</span><br><span class="line">var SchemeGroupVersion = GroupVersion</span><br><span class="line"></span><br><span class="line">// Resource takes an unqualified resource and returns a Group qualified GroupResource</span><br><span class="line">func Resource(resource string) schema.GroupResource &#123;</span><br><span class="line">	<span class="built_in">return</span> SchemeGroupVersion.WithResource(resource).GroupResource()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim api/shadow/v1/doc.go</span><br><span class="line">// +groupName=shadow.shadow.io                                          </span><br><span class="line"></span><br><span class="line">package v1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="code-generator-help.png" alt="code-generator-help"></p>
<p>​    根据参数二（operator/pkg/generated）和–output-base ../参数，生成的文件统一放在项目根目录下的pkg文件夹下：</p>
<p><img src="code-generator-result.png" alt="code-generator-result"></p>
<p>​    接下来，使用生成的client、informer、lister进行简单的测试验证。</p>
<h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><p>​    使用Example的crd，准备两个资源对象，并apply到集群环境中。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">shadow.shadow.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Example</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-sample-bar</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">shadow</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># Add fields here</span></span><br><span class="line">  <span class="attr">foo:</span> <span class="string">bar</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">shadow.shadow.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Example</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-sample-shadow</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">shadow</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># Add fields here</span></span><br><span class="line">  <span class="attr">foo:</span> <span class="string">shadow</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>​    使用code generator生成的client像使用核心资源那样去访问它的API</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/client-go/tools/clientcmd&quot;</span></span><br><span class="line">	example <span class="string">&quot;operator/pkg/generated/shadow/clientset/versioned&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	config, err := clientcmd.BuildConfigFromFlags(<span class="string">&quot;https://127.0.0.1:6443&quot;</span>, <span class="string">&quot;C:\\Users\\shadow\\.kube\\config&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	example, err := example.NewForConfig(config)</span><br><span class="line"></span><br><span class="line">	examples, err := example.ShadowV1().Examples(<span class="string">&quot;shadow&quot;</span>).List(context.TODO(),  metav1.ListOptions&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, ex := <span class="keyword">range</span> examples.Items&#123;</span><br><span class="line">		fmt.Println(ex.Spec.Foo)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>​    结果展示：</p>
<p><img src="example-client-usecase.png" alt="example-client-usecase"></p>
<h3 id="Informer-Lister"><a href="#Informer-Lister" class="headerlink" title="Informer/Lister"></a>Informer/Lister</h3><p>​    <a target="_blank" rel="noopener" href="https://github.com/kubernetes/sample-controller">sample-controller</a></p>
<p>​    参照上述代码，简单梳理了一下使用informer编写controller的流程</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">## 创建代码目录</span><br><span class="line">mkdir -p pkg/test</span><br><span class="line"></span><br><span class="line">vim controller.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	corev1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/apimachinery/pkg/api/errors&quot;</span></span><br><span class="line">	utilruntime <span class="string">&quot;k8s.io/apimachinery/pkg/util/runtime&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/apimachinery/pkg/util/wait&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/client-go/kubernetes&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/client-go/kubernetes/scheme&quot;</span></span><br><span class="line">	typedcorev1 <span class="string">&quot;k8s.io/client-go/kubernetes/typed/core/v1&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/client-go/tools/cache&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/client-go/tools/record&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/client-go/util/workqueue&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/klog/v2&quot;</span></span><br><span class="line">	exampleclient <span class="string">&quot;operator/pkg/generated/shadow/clientset/versioned&quot;</span></span><br><span class="line">	samplescheme <span class="string">&quot;operator/pkg/generated/shadow/clientset/versioned/scheme&quot;</span></span><br><span class="line">	exampleinformers <span class="string">&quot;operator/pkg/generated/shadow/informers/externalversions/shadow/v1&quot;</span></span><br><span class="line">	examplelisters <span class="string">&quot;operator/pkg/generated/shadow/listers/shadow/v1&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Controller <span class="keyword">struct</span> &#123;</span><br><span class="line">	kubeClientSet *kubernetes.Clientset</span><br><span class="line">	exampleClientSet *exampleclient.Clientset</span><br><span class="line"></span><br><span class="line">	exampleLister examplelisters.ExampleLister</span><br><span class="line">	exampleSynced cache.InformerSynced</span><br><span class="line"></span><br><span class="line">    workQueue workqueue.RateLimitingInterface</span><br><span class="line">	record record.EventRecorder</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span> <span class="title">enqueueFoo</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> key <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="keyword">if</span> key, err = cache.MetaNamespaceKeyFunc(obj); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utilruntime.HandleError(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	c.workQueue.Add(key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewController</span><span class="params">(kubeClientSet *kubernetes.Clientset, exampleClientSet *exampleclient.Clientset, exampleInformer exampleinformers.ExampleInformer)</span> *<span class="title">Controller</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//生成一个event记录器</span></span><br><span class="line">	utilruntime.Must(samplescheme.AddToScheme(scheme.Scheme))</span><br><span class="line">	klog.Info(<span class="string">&quot;Creating event broadcaster&quot;</span>)</span><br><span class="line">	eventBroadcaster := record.NewBroadcaster()</span><br><span class="line">	eventBroadcaster.StartStructuredLogging(<span class="number">0</span>)</span><br><span class="line">	eventBroadcaster.StartRecordingToSink(&amp;typedcorev1.EventSinkImpl&#123;Interface: kubeClientSet.CoreV1().Events(<span class="string">&quot;&quot;</span>)&#125;)</span><br><span class="line">	recorder := eventBroadcaster.NewRecorder(scheme.Scheme, corev1.EventSource&#123;Component: <span class="string">&quot;example-controller&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	controller := &amp;Controller&#123;</span><br><span class="line">		kubeClientSet:     kubeClientSet,</span><br><span class="line">		exampleClientSet:  exampleClientSet,</span><br><span class="line"></span><br><span class="line">		exampleLister: exampleInformer.Lister(),</span><br><span class="line">		exampleSynced: exampleInformer.Informer().HasSynced,</span><br><span class="line"></span><br><span class="line">		workQueue:         workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), <span class="string">&quot;Examples&quot;</span>),</span><br><span class="line">		record:            recorder,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	klog.Info(<span class="string">&quot;Setting up event handlers&quot;</span>)</span><br><span class="line">	exampleInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">		AddFunc: controller.enqueueFoo,</span><br><span class="line">		UpdateFunc: <span class="function"><span class="keyword">func</span><span class="params">(old, <span class="built_in">new</span> <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">			controller.enqueueFoo(<span class="built_in">new</span>)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> controller</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span> <span class="title">Run</span><span class="params">(threads <span class="keyword">int</span>, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">//execute when exit</span></span><br><span class="line">	<span class="keyword">defer</span> utilruntime.HandleCrash()</span><br><span class="line">	<span class="keyword">defer</span> c.workQueue.ShutDown()</span><br><span class="line"></span><br><span class="line">	klog.Info(<span class="string">&quot;Starting sample controller&quot;</span>)</span><br><span class="line"></span><br><span class="line">	klog.Info(<span class="string">&quot;Waiting for informer caches to sync&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> ok := cache.WaitForCacheSync(stopCh, c.exampleSynced); !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to wait for caches to sync&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	klog.Info(<span class="string">&quot;Starting workers&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i :=<span class="number">0</span>; i &lt; threads; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> wait.Until(c.runWorker, time.Second, stopCh)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	klog.Info(<span class="string">&quot;Started workers&quot;</span>)</span><br><span class="line"></span><br><span class="line">	&lt;-stopCh</span><br><span class="line"></span><br><span class="line">	klog.Info(<span class="string">&quot;Shutting down workers&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span> <span class="title">runWorker</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> c.processNextWorkItem()&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span> <span class="title">processNextWorkItem</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	item, shutdown := c.workQueue.Get()</span><br><span class="line">	<span class="keyword">if</span> shutdown &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//包装一下具体的处理方法，是为了使用defer处理queue.Done</span></span><br><span class="line">	<span class="comment">//如果一个元素，我们处理完成，或者想要抛弃，不想再次处理，需要调用queue.Forget</span></span><br><span class="line">	err := <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span>&#123;</span><br><span class="line">		<span class="keyword">defer</span> c.workQueue.Done(obj)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> key <span class="keyword">string</span></span><br><span class="line">		<span class="keyword">var</span> ok <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> key, ok = obj.(<span class="keyword">string</span>); !ok &#123;</span><br><span class="line">			<span class="comment">//不合法的数据，不处理，直接出队</span></span><br><span class="line">			c.workQueue.Forget(obj)</span><br><span class="line">			utilruntime.HandleError(fmt.Errorf(<span class="string">&quot;expected string in workqueue but got %#v&quot;</span>, obj))</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := c.syncHandler(key); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">//这个地方重新放回队列，重试~</span></span><br><span class="line">			c.workQueue.AddRateLimited(key)</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error syncing &#x27;%s&#x27;: %s, requeuing&quot;</span>, key, err.Error())</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//处理成功</span></span><br><span class="line">		c.workQueue.Forget(obj)</span><br><span class="line">		klog.Infof(<span class="string">&quot;Successfully synced &#x27;%s&#x27;&quot;</span>, key)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	&#125;(item)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utilruntime.HandleError(err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span> <span class="title">syncHandler</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	namespace, name, err := cache.SplitMetaNamespaceKey(key)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">		utilruntime.HandleError(fmt.Errorf(<span class="string">&quot;invalid resource key: %s&quot;</span>, key))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//这个地方用lister从缓存里取,这是期望的状态</span></span><br><span class="line">	example, err := c.exampleLister.Examples(namespace).Get(name)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> errors.IsNotFound(err) &#123;</span><br><span class="line">			utilruntime.HandleError(fmt.Errorf(<span class="string">&quot;foo &#x27;%s&#x27; in work queue no longer exists&quot;</span>, key))</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//这里是获取实际的状态，进行调谐，或者是更新自定义对象的状态。</span></span><br><span class="line">	klog.Infof(<span class="string">&quot;Reconcile/Update crd status if needed %v&quot;</span>, example)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 这里使用到了下文的单元测试，进行启动。没有放到入口文件main.<span class="keyword">go</span>中</span><br><span class="line"></span><br><span class="line">vim lister_infomer_test.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;testing&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;k8s.io/client-go/kubernetes&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/client-go/tools/clientcmd&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/klog/v2&quot;</span></span><br><span class="line"></span><br><span class="line">	exampleclient <span class="string">&quot;operator/pkg/generated/shadow/clientset/versioned&quot;</span></span><br><span class="line">	exampleinformer <span class="string">&quot;operator/pkg/generated/shadow/informers/externalversions&quot;</span></span><br><span class="line">	<span class="string">&quot;operator/pkg/signals&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestListerAndInformer</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set up signals so we handle the first shutdown signal gracefully</span></span><br><span class="line">	stopCh := signals.SetupSignalHandler()</span><br><span class="line"></span><br><span class="line">	config, err := clientcmd.BuildConfigFromFlags(<span class="string">&quot;https://127.0.0.1:6443&quot;</span>, <span class="string">&quot;C:\\Users\\shadow\\.kube\\config&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	exampleClient, err := exampleclient.NewForConfig(config)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Fatalf(<span class="string">&quot;Error building example client: %s&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	kubeClient, err := kubernetes.NewForConfig(config)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Fatalf(<span class="string">&quot;Error building kubernetes client: %s&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建共享Informer的工厂</span></span><br><span class="line">	exampleInformerFactory := exampleinformer.NewSharedInformerFactory(exampleClient, time.Second*<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">	controller := NewController(kubeClient, exampleClient, exampleInformerFactory.Shadow().V1().Examples())</span><br><span class="line"></span><br><span class="line">	exampleInformerFactory.Start(stopCh)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err = controller.Run(<span class="number">2</span>, stopCh); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Fatalf(<span class="string">&quot;Error running controller: %s&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>​    执行单元测试用例，输出日志如下：</p>
<p><img src="example-informer-usecase.png" alt="example-informer-usecase"></p>
<p>​    从日志可以看出，之前创建的两个资源对象，已经可以被处理。</p>
<blockquote>
<p>注意使用code generator的生成的代码。不要进行修改，即使进行了本地修改，下次重新生成的时候，也会被覆盖。</p>
</blockquote>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>​    controller测试比较麻烦，尽量使用单元测试。</p>
<h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><p>​    借助借助于testing和”github.com/stretchr/testify/assert”包，使用表格测试的方法，很容易写出单元测试的代码。同时也可以进行一些性能测试分析，和代码覆盖率报告的生成。</p>
<h3 id="集成测试"><a href="#集成测试" class="headerlink" title="集成测试"></a>集成测试</h3><p>​    Operator因为涉及到的组件比较复杂，能用单元测试尽量采用单元测试进行测试，下面是目前了解到的两种集成测试。</p>
<h4 id="Evntest"><a href="#Evntest" class="headerlink" title="Evntest"></a>Evntest</h4><p>​    <a target="_blank" rel="noopener" href="https://book.kubebuilder.io/reference/envtest.html">envtest</a></p>
<p>​    kubebuilder生成controller的时候，为我们使用envtest生成了测试的代码。</p>
<h4 id="End-to-end"><a href="#End-to-end" class="headerlink" title="End-to-end"></a>End-to-end</h4><p>​    什么是E2E测试：</p>
<blockquote>
<p>End-to-end testing is a technique that tests the entire software product from beginning to end to ensure the application flow behaves as expected. It defines the product’s system dependencies and ensures all integrated pieces work together as expected.</p>
<p>The main purpose of End-to-end (E2E) testing is to test from the end user’s experience by simulating the real user scenario and validating the system under test and its components for integration and data integrity</p>
</blockquote>
<p>​    </p>
<p>​    </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2021/03/11/Kubernetes-Containerd%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/11/Kubernetes-Containerd%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">Kubernetes-Containerd部署实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-11 00:00:00" itemprop="dateCreated datePublished" datetime="2021-03-11T00:00:00+08:00">2021-03-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​    K8S 1.20 版本发布后，即将废弃对Docker的支持。</p>
<h1 id="概念介绍"><a href="#概念介绍" class="headerlink" title="概念介绍"></a>概念介绍</h1><h2 id="cri（Container-runtime-interface）"><a href="#cri（Container-runtime-interface）" class="headerlink" title="cri（Container runtime interface）"></a>cri（Container runtime interface）</h2><blockquote>
<p>​       cri is a containerd plugin implementation of Kubernetes container runtime interface（CRI）.</p>
</blockquote>
<p>​       cri是Kubernetes的容器运行时接口的容器插件实现。</p>
<p><img src="cri.png" alt="cri"></p>
<h2 id="containerd"><a href="#containerd" class="headerlink" title="containerd"></a>containerd</h2><blockquote>
<p>​        containerd is an industry-standard（行业标准） container runtime with an emphasis（重点） on simplicity（简单性）,robustness（健壮性） and portability（可移植性）.</p>
</blockquote>
<p>​          containerd完全支持运行容器的CRI规范。</p>
<p>​          cri是containerd 1.1以上的版本的原生插件。它内置于containerd并默认启用。</p>
<p><img src="containerd.png" alt="containerd"></p>
<h2 id="oci（Open-Container-Initiative）"><a href="#oci（Open-Container-Initiative）" class="headerlink" title="oci（Open Container Initiative）"></a>oci（Open Container Initiative）</h2><p>​          <a target="_blank" rel="noopener" href="https://www.opencontainers.org/about/oci-scope-table">项目地址</a></p>
<p>​          oci是由多家公司成立的项目，并由linux基金会进行管理，致力于container runtime 的标准的制定和runc的开发等工作。</p>
<h2 id="cri-o"><a href="#cri-o" class="headerlink" title="cri-o"></a>cri-o</h2><p>​          OCI-based implementation of Kubernetes Container Runtime Interface.</p>
<p>​          Kubernetes 为了兼容cri和oci孵化了项目cri-o。为了架设在cri和oci之间的桥梁。因此cri-o即兼容cri插件实现又兼容oci的容器运行时标准。</p>
<h2 id="runc"><a href="#runc" class="headerlink" title="runc"></a>runc</h2><p>​          runc is a CLI tool for spawning and running containers according to the oci specification.</p>
<p>​          runc，是对oci标准的一个参考实现，是一个可以用于创建和运行容器的CLI（Command Line Interface）工具。</p>
<p><img src="kubelet.png" alt="kubelet"></p>
<p>​    <a target="_blank" rel="noopener" href="https://cuisongliu.github.io/2019/03/kubernetes/containerd/">参考资料</a></p>
<h3 id="kata"><a href="#kata" class="headerlink" title="kata"></a>kata</h3><p>​          kata containers是由OpenStack基金会管理，但独立于OpenStack项目之外的容器项目。它是一个可 以使用容器镜像以超轻量级虚机的形式创建容器的运行时工具。 kata containers整合了Intel的 Clear Containers 和 Hyper.sh 的 runV，能够支持不同平台的硬件 （x86-64，arm等），并符合OCI(Open Container Initiative)规范，同时还可以**兼容k8s的 CRI（Container Runtime Interface）接口规范。</p>
<h4 id="kata和传统容器对比"><a href="#kata和传统容器对比" class="headerlink" title="kata和传统容器对比"></a>kata和传统容器对比</h4><p><img src="kata-vs-container.jpg" alt="kata vs container"></p>
<h4 id="kata-and-docker"><a href="#kata-and-docker" class="headerlink" title="kata and docker"></a>kata and docker</h4><p><img src="kata-with-docker.png" alt="kata with docker"></p>
<h4 id="kata-in-kubernetes"><a href="#kata-in-kubernetes" class="headerlink" title="kata in kubernetes"></a>kata in kubernetes</h4><p><img src="kata-in-kubernetes.jpg" alt="kata in kubernetes"></p>
<h1 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h1><p>​    本例使用三台CentOS虚拟机进行部署，CentOS版本：CentOS Linux release 7.3.1611 (Core)，内核版本：3.10.0-514.el7.x86_64。</p>
<table>
<thead>
<tr>
<th align="center">主机名</th>
<th align="center">IP地址</th>
</tr>
</thead>
<tbody><tr>
<td align="center">K8S-194</td>
<td align="center">10.6.6.194</td>
</tr>
<tr>
<td align="center">K8S-195</td>
<td align="center">10.6.6.195</td>
</tr>
<tr>
<td align="center">K8S-196</td>
<td align="center">10.6.6.196</td>
</tr>
</tbody></table>
<h1 id="基础部署"><a href="#基础部署" class="headerlink" title="基础部署"></a>基础部署</h1><h2 id="SSH免密登陆"><a href="#SSH免密登陆" class="headerlink" title="SSH免密登陆"></a>SSH免密登陆</h2><p>​    这里简化一下免密登陆的设置步骤，统一使用相同的公钥、私钥。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen  &#x2F;&#x2F;生成公私钥对</span><br><span class="line">cat id_rsa.pub &gt;&gt; authorized_keys   &#x2F;&#x2F;将公钥写入authorized_keys</span><br></pre></td></tr></table></figure>

<p>​    然后将~/.ssh目录下id_rsa  id_rsa.pub分发给另外两台主机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp id_rsa id_rsa.pub authorized_keys root@10.6.6.195:~&#x2F;.ssh</span><br><span class="line">scp id_rsa id_rsa.pub authorized_keys root@10.6.6.196:~&#x2F;.ssh</span><br></pre></td></tr></table></figure>

<p>​    将hostname追加到三台机器的/etc/hosts中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.6.6.194 K8S-194</span><br><span class="line">10.6.6.195 K8S-195</span><br><span class="line">10.6.6.196 K8S-196</span><br></pre></td></tr></table></figure>

<p>​    至此，可实现三台机器互相的免密登陆。</p>
<h2 id="NTP对时"><a href="#NTP对时" class="headerlink" title="NTP对时"></a>NTP对时</h2><p>​    CentOS系统中，已经带有ntpd的服务，只需要修改配置文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;以10.6.6.194的时间为基准同步，在10.6.6.194上配置ntpd的配置文件</span><br><span class="line">vim &#x2F;etc&#x2F;ntp.conf</span><br><span class="line">server 127.127.1.0 iburst    &#x2F;&#x2F;在restrict ::1下去掉其它server增加这行</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;10.6.6.195、10.6.6.196的配置为</span><br><span class="line">vim &#x2F;etc&#x2F;ntp.conf</span><br><span class="line">server 10.6.6.194 iburst</span><br><span class="line">restrict 10.6.6.194 nomodify notrap noquery</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;所有节点上执行</span><br><span class="line">systemctl enable ntpd</span><br><span class="line">systemctl start ntpd</span><br><span class="line"></span><br><span class="line">ntpdate -u 10.6.6.194   &#x2F;&#x2F;进行手动同步</span><br></pre></td></tr></table></figure>

<h2 id="系统设置"><a href="#系统设置" class="headerlink" title="系统设置"></a>系统设置</h2><h3 id="关闭selinux"><a href="#关闭selinux" class="headerlink" title="关闭selinux"></a>关闭selinux</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;selinux&#x2F;config</span><br><span class="line">SELINUX&#x3D;disabled</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl disable firewalld.service</span><br></pre></td></tr></table></figure>

<h3 id="关闭swap"><a href="#关闭swap" class="headerlink" title="关闭swap"></a>关闭swap</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swappoff -a</span><br><span class="line">vim &#x2F;etc&#x2F;fstab</span><br><span class="line">注释掉swap分区所在的行</span><br></pre></td></tr></table></figure>



<h1 id="Sealos部署K8S"><a href="#Sealos部署K8S" class="headerlink" title="Sealos部署K8S"></a>Sealos部署K8S</h1><p>​    <a target="_blank" rel="noopener" href="https://github.com/fanux/sealos">Sealos Github</a></p>
<h2 id="官方安装步骤"><a href="#官方安装步骤" class="headerlink" title="官方安装步骤"></a>官方安装步骤</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget -c https:&#x2F;&#x2F;sealyun.oss-cn-beijing.aliyuncs.com&#x2F;latest&#x2F;sealos &amp;&amp; \</span><br><span class="line">    chmod +x sealos &amp;&amp; mv sealos &#x2F;usr&#x2F;bin</span><br><span class="line">    </span><br><span class="line">wget -c https:&#x2F;&#x2F;sealyun.oss-cn-beijing.aliyuncs.com&#x2F;2fb10b1396f8c6674355fcc14a8cda7c-v1.20.0&#x2F;kube1.20.0.tar.gz</span><br><span class="line"></span><br><span class="line">sealos init --passwd &#39;kubernetes&#39; --master 10.6.6.194  --master 10.6.6.195  --master 10.6.6.196 --pkg-url &#x2F;home&#x2F;sealos&#x2F;kube1.20.0.tar.gz --version v1.20.0</span><br></pre></td></tr></table></figure>



<blockquote>
<p>官方要求的注意事项。本次部署并没有严格遵守，实际使用应该严格遵守，而且Kubernetes 1.20.0的版本不建议上生产环境</p>
</blockquote>
<ul>
<li>必须同步所有服务器时间</li>
<li>所有服务器主机名不能重复</li>
<li>系统支持：centos7.6以上 ubuntu16.04以上</li>
<li>内核推荐4.14以上， 系统推荐：centos7.7</li>
</ul>
<h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img src="arch.png" alt="arch"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2021/03/10/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/10/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">Go语言基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-10 00:00:00" itemprop="dateCreated datePublished" datetime="2021-03-10T00:00:00+08:00">2021-03-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h1><h2 id="内建基本数据类型"><a href="#内建基本数据类型" class="headerlink" title="内建基本数据类型"></a>内建基本数据类型</h2><p>​    1、bool（相当于java中的boolean）、string。<br>​    2、（u）代表无符号，int，int8，int16、int32、int64、uintptr。<br>​    3、byte、rune（相当于java中的char，32位，占4个字节，为了应对多国语言，rune可以对字符重新编码，统一编码长度为4个字节，并重新存储）。<br>​    4、float32、float64，complex64、complex128（这个对应数学中的复数）。</p>
<h2 id="强制类型转换"><a href="#强制类型转换" class="headerlink" title="强制类型转换"></a>强制类型转换</h2><p>​    Go语言中需要进行显示的数据类型转换。</p>
<h2 id="函数是一等公民"><a href="#函数是一等公民" class="headerlink" title="函数是一等公民"></a>函数是一等公民</h2><p>​    1、Go语言 调用方法返回的变量必须接受，如果不需要使用返回的数据，可以使用 “_”。 </p>
<p>​    2、数组在方法中作为参数时，是作为值传递的也就说，是拷贝的。</p>
<h2 id="Slice"><a href="#Slice" class="headerlink" title="Slice"></a>Slice</h2><p>​    1、Slice本身是没有数据的，是对底层数据的视图。</p>
<p>​    2、[1]int [2]int是不同类型的数组。</p>
<p>​    3、Go语言一般不直接使用数组，而是使用切片。</p>
<p>​    4、Slice可以向后扩展，但不能超过cap。</p>
<p>​    5、数组遍历可以使用range</p>
<p><img src="Slice.png" alt="Slice"></p>
<h2 id="变量及函数的可见性"><a href="#变量及函数的可见性" class="headerlink" title="变量及函数的可见性"></a>变量及函数的可见性</h2><p>​    Go语言同一个目录下面只能有一个包名，函数及结构体变量的命名规范决定其可见性。统一使用驼峰式命名。</p>
<p>​    1、首字母大写代表是公共的。首字母小写代表是私有的。</p>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><h3 id="Duck-Typing"><a href="#Duck-Typing" class="headerlink" title="Duck Typing"></a>Duck Typing</h3><p>​    Go语言在面向对象时，仅支持接口和封装，不支持继承和多态。与Java中面向接口编程不同的是，Go采用的是一种duck typing的方式，由接口使用者来定义接口，实现者的代码只需要实现一个方法即可，不需要使用到使用者定义的任何类型。</p>
<p>​    接口可通过组合的方式进行扩展或者是更高层次的抽象设计。</p>
<h3 id="Type-Assertion"><a href="#Type-Assertion" class="headerlink" title="Type Assertion"></a>Type Assertion</h3><p>​    查看接口的实现，会发现Go语言的接口实现，是由一个类型Type，一个值Value（这个值可能是数值，也有可能是指针）。</p>
<p>​    取用接口实现对象通过：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> r Retriever</span><br><span class="line">r = &amp;mock.TestData&#123;Contents: <span class="string">&quot;shadow&quot;</span>&#125;</span><br><span class="line"><span class="comment">//查看接口的实现，发现一个类型Type，一个值Value(可能是值，也可能是指针)</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%T %v\n&quot;</span>, r, r)</span><br><span class="line"><span class="comment">//Type Assertion</span></span><br><span class="line">r2 := r.(*mock.TestData)</span><br></pre></td></tr></table></figure>



<h2 id="资源管理"><a href="#资源管理" class="headerlink" title="资源管理"></a>资源管理</h2><p>​    在一些I/O操作中，往往要对资源打开，然后要保证资源的关闭，及时释放资源，防止导致资源耗尽。Go语言中通过defer延迟执行，保证在任何情况下，defer后面的方法总会被执行。所以通常习惯上，在打开一个资源后，后面要及时跟上defer关闭相应的资源。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">file, err := os.OpenFile(<span class="string">&quot;fib.txt&quot;</span>, os.O_EXCL | os.O_CREATE, <span class="number">0666</span>)  <span class="comment">//存在文件会引起异常</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">//异常处理代码</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> file.Close()</span><br></pre></td></tr></table></figure>



<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>​    对于异常的处理，Go语言可以通过panic向上层抛出系统异常，也可以直接在函数的返回值中返回error的异常信息。</p>
<p>​    1、对于底层panic的异常，可以通过函数封装相应的函数调用，然后在外层函数体内，通过defer  recover对相应的相应的异常进行统一处理。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		err := <span class="built_in">recover</span>()</span><br><span class="line">		<span class="keyword">if</span> r, ok := err.(error); ok&#123;</span><br><span class="line">			fmt.Println(r)</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"><span class="comment">//函数调用</span></span><br></pre></td></tr></table></figure>

<p>​    2、对于返回值的异常，通过与零值（nil）对比，判断是否有异常，然后进行异常处理。</p>
<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p>​    Go语言的语法可以让我们更容易地去实践表格驱动测试，具备一下优点：</p>
<p>​    1、更容易分离测试数据和测试逻辑。</p>
<p>​    2、自定义出错信息。</p>
<p>​    3、允许部分失败。</p>
<p>​    Go语言测试文件编写规范：</p>
<p>​    1、测试用例文件与测试目标文件在同一目录下，测试文件命名为XXX_test.go</p>
<p>​    2、测试方法命名按照：Test[方法名称]（t *testing.T），性能测试要使用（b *testing.B）这样的参数。</p>
<p>​    3、使用2中的参数进行错误输出，例如：b.Errorf(“expected %d , but got %d”, length, actual)。</p>
<h3 id="测试覆盖率"><a href="#测试覆盖率" class="headerlink" title="测试覆盖率"></a>测试覆盖率</h3><p>​    1、进入目标测试代码目录执行go test。</p>
<p>​    2、执行go test -coverprofile=c.out 生成测试覆盖率文件。</p>
<p>​    3、go tool cover -html c.out 查看测试覆盖率文件</p>
<p><img src="TestCover.png" alt="TestCover"></p>
<h3 id="性能测试优化"><a href="#性能测试优化" class="headerlink" title="性能测试优化"></a>性能测试优化</h3><p>​    1、进行性能测试：go test -bench .</p>
<p>​    2、使用pprof进行性能调优：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> test -bench . -cpuprofile cpu.out</span><br><span class="line"><span class="keyword">go</span> tool pprof cpu.out <span class="comment">//进入控制台</span></span><br><span class="line">web  <span class="comment">//采用web的方式查看。 需要装插件显示svg。</span></span><br></pre></td></tr></table></figure>

<p><img src="performance.png" alt="performance">            </p>
<h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p>​    1、需要godoc（需要安装）、go doc来查看文档</p>
<p>​    2、使用go doc fmt.Println来查看具体接口文档</p>
<p>​    3、可以使用Example关键字放在方法的开头，作为实例代码，运行测试的时候会检查Example的结果是否正确   （//Output 来写预期结果）</p>
<h1 id="进阶知识"><a href="#进阶知识" class="headerlink" title="进阶知识"></a>进阶知识</h1><p>​    <a href="https://shadow802.gitee.io/2021/03/10/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/shadow.zip">代码样例</a></p>
<h2 id="并发编程"><a href="#并发编程" class="headerlink" title="并发编程"></a>并发编程</h2><h3 id="Goroutine"><a href="#Goroutine" class="headerlink" title="Goroutine"></a>Goroutine</h3><p>​    1、是一种协程 Coroutine。</p>
<p>​          轻量级的”线程”。</p>
<p>​          非抢占式多任务处理，由协程主动交出控制权。区别于线程，由操作系统调度、分时间片执行。</p>
<p>​          编译器、解释器、虚拟机层面的多任务。</p>
<p>​          多个协程可以在一个或者是多个线程上执行。</p>
<p>​    2 、子程序是协程的一个特例。调度器来决定协程是否放在同一个线程中。</p>
<p><img src="Goroutine.png" alt="Goroutine"></p>
<p>​    </p>
<p>​    3、Gorotine的代码实现很简单，任何函数只要加上 go就能送给调度器进行调度：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//do something</span></span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<p>​           不需要在定义时区分是否是异步函数。</p>
<p>​           调度器在合适的点进行切换，可能切换的点：</p>
<p>​                I/O、select、channel、等待锁、函数调用、runtime.Gosched()。仅作为参考。</p>
<p>​    4、可以使用go run -race xxxx.go 检测数据冲突</p>
<p><img src="race.png" alt="race"></p>
<h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><p>​    1、Channel作为GoRoutine之间推荐的通信方式</p>
<p><img src="channel.png" alt="channel"></p>
<p>​    2、Communication Sequential Process（CSP）</p>
<p><img src="csp.png" alt="csp"></p>
<p>​    3、等待任务完成可以使用WaitGroup</p>
<h3 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h3><p>​    1、for  select可以让我们同时做很多事情，满足条件就做。</p>
<p>​    2、在select case中，如果channel是nil会阻塞住，当满足条件了之后，会进行，可以利用这个机制，控制case是否执行。</p>
<p>​    </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2021/02/03/01%E7%9B%91%E6%8E%A7%E6%8A%80%E6%9C%AF-K8s+Prometheus+Grafana%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/03/01%E7%9B%91%E6%8E%A7%E6%8A%80%E6%9C%AF-K8s+Prometheus+Grafana%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">监控技术-K8s + Promethues + Grafana方案实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-03 00:00:00" itemprop="dateCreated datePublished" datetime="2021-02-03T00:00:00+08:00">2021-02-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="K8s监控"><a href="#K8s监控" class="headerlink" title="K8s监控"></a>K8s监控</h1><p>​    提到监控，Prometheus已经是事实上的标准。我们将应用部署到K8s中后，需要借助于Prometheus对K8s集群，容器（数据库、中间件、应用），机器的硬件等进行监控，配置一定的告警规则。</p>
<p>​    Promethues官方对K8s的监控进行了一定适配，首先了解一下K8s的基础概念。</p>
<h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><p>（1）CRD（Custom Resource Definition）</p>
<p>​    K8s采用的是一种声明式的编程方式，其基本的设计思想是，在K8s中一切都是资源，我们通过yaml/json的文件描述我们所需要的资源的预期的状态，然后通过一个资源控制器（Controller）在集群中采取各种措施（重启、杀掉重建、调度），不断趋向这种用户的预期状态，最终使实际情况达到用户预期。并时刻守护。</p>
<p>​    K8s提供了一些资源的实现，例如Pod、ConfigMap等。但这些资源描述还不能满足我们所有的需求，因此需要提供一种类似于插件扩展的机制，让用户自己定义并实现资源的描述。</p>
<p>（2）Operator</p>
<p>​    对于无状态的应用，我们可以通过Deployment这种控制器很容易地实现扩缩实例数量。但是对于一些有状态的服务，例如mysql、redis这样的有状态服务，实例的扩缩，往往需要进行状态的同步、数据的迁移，而这样的步骤是跟随着组件的不同需要定制化采取不同的步骤，常规的K8s控制器无法一一适配，所幸业界对于许多状态的服务进行了封装和开源，提供出来，供我们在K8s中使用。以本案的Promethues为例。</p>
<p><img src="prometheus-operator.png" alt="prometheus-operator"></p>
<p>​    （3） Promethues-Operator  VS Kube-Prometheus</p>
<p>​    对于K8s的监控，Promethues-Operator只能监控到部分数据，完整的监控能力要使用kube-prometheuses。</p>
<h2 id="Kube-Prometheus"><a href="#Kube-Prometheus" class="headerlink" title="Kube-Prometheus"></a>Kube-Prometheus</h2><p>​    <a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/kube-prometheus">Github地址</a></p>
<h3 id="基础介绍"><a href="#基础介绍" class="headerlink" title="基础介绍"></a>基础介绍</h3><p>​    Kube-Prometheus是Prometheus Operator对K8S监控的升级改装。</p>
<p>​    CRD资源介绍：</p>
<p>​    （1）Prometheus，定义了Prometheus的部署。</p>
<p>​    （2）AlertManager，定义了AlertManager的部署。</p>
<p>​    （3）ServiceMonitor，指定K8S中被监控的Service对象。Operator根据Service关联的endpoint中关联的Pod对象，自动生成Prometheus的scrape配置。</p>
<p>​    （4）PodMonitor，指定Pod对象，也会自动生成Prometheus的scrape配置。</p>
<p>​    （5）PrometheusRule，指定Prometheus的alert/record规则，Operator会自动将其转换为文件，提供给Promethues使用。</p>
<p>​    部署后通过下面命令查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get crd |grep coreos.com</span><br></pre></td></tr></table></figure>

<p><img src="kube-prometheus-crd.jpg" alt="kube-prometheus-crd"></p>
<h3 id="部署实践"><a href="#部署实践" class="headerlink" title="部署实践"></a>部署实践</h3><p>​    kube-prometheus是一个K8S prometheus的监控包或者是库，是使用 <a target="_blank" rel="noopener" href="http://jsonnet.org/">jsonnet</a>编写的。里面预置了一些对K8S组件的监控规则设定和一些dashboard、alert的规则，这些东西有很多是来自 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-monitoring/kubernetes-mixin">kubernetes-mixin project</a>这个项目。</p>
<p>​    用户可以通过修改代码库中的 <a target="_blank" rel="noopener" href="http://jsonnet.org/">jsonnet</a> 文件，来定制化Kube-Prometheus。然后通过./build.sh example.jsonnet重新生成manifests下的yaml文件。</p>
<p>​    这里我们直接使用release的版本。</p>
<p>（1）本例的实验环境是Kubernetes 1.17的版本，所以只能选用release-0.4的版本</p>
<p><img src="kube-prometheus-version.jpg" alt="kube-prometheus-version"></p>
<p>（2）Github下载release包，执行如下两条命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f manifests&#x2F;setup&#x2F;</span><br><span class="line">kubectl apply -f manifests&#x2F;</span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>（3）修改prometheus、grafana、altermanager将对应的Service修改为NodePort，以便在集群外访问。</p>
<p>​    </p>
<p>（4）卸载命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete --ignore-not-found&#x3D;true -f manifests&#x2F; -f manifests&#x2F;setup</span><br></pre></td></tr></table></figure>





<h1 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h1><p>​    </p>
<p>​    通过梳理Kube Prometheus在K8S中通过CRD对Prometheus的实现，来实现几个常用的监控部署。</p>
<h2 id="基本组件"><a href="#基本组件" class="headerlink" title="基本组件"></a>基本组件</h2><p>​    Kube-Prometheus部署完成后，通过K8S的Pod查询命令来看一下一共有哪些Pod，各自承担的职责。</p>
<p><img src="kube-prometheus-pod.jpg" alt="kube-prometheus-pod"></p>
<p>​        从Github的官方文档得知，Kube-Prometheus主要包括一下组件：</p>
<p>​        （1）高可用的Prometheus，对应图中prometheus-k8s-0/1</p>
<p>​        （2）高可用的AlertManager，对应图中alertmanager-main-0/1/2</p>
<p>​        （3）Prometheus Operator，负责Prometheus的扩缩容的控制器，对应图中prometheus-operator-xxxx</p>
<p>​        （4）Prometheus node-exporter，负责收集主机信息，对应图中node-exporter-xxxxx</p>
<p>​        （5）<a target="_blank" rel="noopener" href="https://github.com/DirectXMan12/k8s-prometheus-adapter">Prometheus Adapter for Kubernetes Metrics APIs</a>，</p>
<p>​        从字面意思上可以看出是Kubernetes Metric APIs为了适配Promethues这类数据源所使用的适配器，详细内容我们在HPA一节中详解。</p>
<p>​        （6）Grafana，UI展示工具，可对接多种数据源，自行配置展示图表。</p>
<p>​        （7）<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kube-state-metrics">Kube-state-metrics</a>，也是K8S聚合API的一种实现，与Heapster、Metrics Server类似。</p>
<p>​                                                                        <img src="k8s-hpa-ms.png" alt="k8s-hpa-ms"></p>
<p>​     </p>
<h2 id="配置实践"><a href="#配置实践" class="headerlink" title="配置实践"></a>配置实践</h2><h3 id="监控K8S的存储ETCD"><a href="#监控K8S的存储ETCD" class="headerlink" title="监控K8S的存储ETCD"></a>监控K8S的存储ETCD</h3><p>（1）查看ETCD的证书存放位置（/etc/kubernetes/pki/etcd），并将证书信息保存在K8S集群中，供后续Prometheus使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe  pod etcd-edu3.5-ha-1 -n kube-system</span><br><span class="line">kubectl -n monitoring create secret generic etcd-certs --from-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;healthcheck-client.crt --from-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;healthcheck-client.key --from-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.crt</span><br></pre></td></tr></table></figure>

<p><img src="etcd-ca.jpg" alt="etcd-ca"></p>
<p>​    </p>
<p>（2）为Promethues设置ETCD的访问证书，增加如下两行，wq保存，并检查是否已经挂载进Prometheus中去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit prometheus k8s -n monitoring</span><br></pre></td></tr></table></figure>

<p><img src="prometheus-etcd-secret.jpg" alt="prometheus-etcd-secret"></p>
<p><img src="prometheus-etcd-secret-mount.jpg" alt="prometheus-etcd-secret-mount"></p>
<p>​    </p>
<p>（3）查看集群中ETCD的Service对象内容，根据label值创建ServiceMonitor对象，指向ETCD的Service。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc etcd -n kube-system --show-labels</span><br><span class="line">kubectl describe svc etcd -n kube-system</span><br></pre></td></tr></table></figure>

<p><img src="etcd-service-info.jpg" alt="etcd-service-info"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceMonitor</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">etcd</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="string">metrics</span>            <span class="comment"># 对应service的端口名</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">tlsConfig:</span></span><br><span class="line">      <span class="attr">caFile:</span> <span class="string">/etc/prometheus/secrets/etcd-certs/ca.crt</span></span><br><span class="line">      <span class="attr">certFile:</span> <span class="string">/etc/prometheus/secrets/etcd-certs/healthcheck-client.crt</span></span><br><span class="line">      <span class="attr">keyFile:</span> <span class="string">/etc/prometheus/secrets/etcd-certs/healthcheck-client.key</span></span><br><span class="line">      <span class="attr">insecureSkipVerify:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>​        endpoints 属性下面可以配置很多抓取的参数，比如 relabel、proxyUrl，tlsConfig 表示用于配置抓取监控数据端点的 tls 认证，由于证书 serverName 和 etcd 中签发的可能不匹配，所以加上了 insecureSkipVerify=true</p>
<p>​        <img src="serviceMonitor-endpoints-config.png" alt="serviceMonitor-endpoints-config"></p>
<p>（4）查看Prometheus UI中的Target监控对象</p>
<p><img src="prometheus-target-etcd.jpg" alt="prometheus-target-etcd"></p>
<p>​    <a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/prometheus-operator-monitor-etcd/">Prometheus Operator 监控 etcd 集群</a></p>
<h3 id="监控Spring-Boot应用"><a href="#监控Spring-Boot应用" class="headerlink" title="监控Spring Boot应用"></a>监控Spring Boot应用</h3><p>​    应用启动在K8S中，Kube-Prometheus监控了Pod的资源情况，应用程序中的GVM、QPS等，需要应用内部通过端点暴露给Prometheus来抓取收集。在Spring Boot的技术栈中，Actuator实现了对应用内部数据的暴露。但是暴露出来的数据格式并不符合Prometheus的数据格式，我们需要借助于micrometer-registry-prometheus进行转换。</p>
<p>​    下面是Github上对于micrometer的说明：</p>
<blockquote>
<p>​    An application metrics facade for the most popular monitoring tools. Instrument your code with dimensional metrics with a vendor neutral interface and decide on the monitoring backend at the last minute.</p>
</blockquote>
<p>​    <a target="_blank" rel="noopener" href="https://github.com/micrometer-metrics/micrometer">micrometer github</a></p>
<p>​    <a target="_blank" rel="noopener" href="https://github.com/micrometer-metrics/micrometer-docs">micrometer doc github</a></p>
<p>（1）使用micrometer转换actuator的监控数据</p>
<p>​    需要引入如下依赖，并在应用的配置文件暴露监控端点</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.micrometer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>



<p>（2）使用micrometer自定义监控数据</p>
<p>​        实验代码清单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicrometerCustom</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MeterRegistry meterRegistry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Counter lightOrderCounter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Counter aleOrderCounter;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MicrometerCustom</span><span class="params">(MeterRegistry meterRegistry)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        initOrderCounters();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initOrderCounters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1 - create a counter</span></span><br><span class="line">        lightOrderCounter = <span class="keyword">this</span>.meterRegistry.counter(<span class="string">&quot;beer.orders&quot;</span>, <span class="string">&quot;type&quot;</span>, <span class="string">&quot;light&quot;</span>);</span><br><span class="line">        <span class="comment">// 2 - create a counter using the fluent API</span></span><br><span class="line">        aleOrderCounter = Counter.builder(<span class="string">&quot;beer.orders&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;ale&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;The number of orders ever placed for Ale beers&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">orderBeer</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 3 - increment the counter</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;light&quot;</span>.equals(order.getType())) &#123;</span><br><span class="line">            lightOrderCounter.increment(<span class="number">1.0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;ale&quot;</span>.equals(order.getType())) &#123;</span><br><span class="line">            aleOrderCounter.increment();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener(ApplicationReadyEvent.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">orderBeers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Flux.interval(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">                .map(MicrometerCustom::toOrder)</span><br><span class="line">                .doOnEach(o -&gt;<span class="keyword">this</span>.orderBeer(o.get()))</span><br><span class="line">                .subscribe();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Order <span class="title">toOrder</span><span class="params">(Long l)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> amount = l % <span class="number">5</span>;</span><br><span class="line">        String type = l % <span class="number">2</span> == <span class="number">0</span> ? <span class="string">&quot;ale&quot;</span> : <span class="string">&quot;light&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Order(amount, type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        </p>
<p>​    启动服务后，访问/actuator/prometheus，搜索关键字beer_orders_total，如下图</p>
<p><img src="micrometer-custom.jpg" alt="micrometer-custom"></p>
<p>​    其他类型指标编写方式，参考micrometer API或者是网上资料，这里仅仅是示意。</p>
<p>（3）配置Prometheus 的scrape任务</p>
<p>​    将上述应用打包部署到K8S中，定义ServiceMonitor对象，配置Prometheus的scrape任务。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ServiceMonitor清单文件</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">edu</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">gateway</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">localtime</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/etc/localtime</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">        <span class="attr">image:</span> <span class="number">10.6</span><span class="number">.6</span><span class="number">.197</span><span class="string">:5000/library/gateway-service:v3</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">800Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">800Mi</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">18080</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">localtime</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">edu</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">18080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">18080</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">18080</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">gateway</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>​    查看Prometheus UI中的监控对象</p>
<p><img src="prometheus-springboot.jpg" alt="prometheus-springboot"></p>
<p>​    查看自定义监控指标</p>
<p><img src="prometheus-micrometer-custom.jpg" alt="prometheus-micrometer-custom"></p>
<h3 id="监控集群外部服务"><a href="#监控集群外部服务" class="headerlink" title="监控集群外部服务"></a>监控集群外部服务</h3><p>​    假设我们在另一台服务器上有一个外部服务，在18080端口暴露了一些监控数据，我们可以通过<a target="_blank" rel="noopener" href="http://10.6.6.207:18080/metrics%E6%8B%BF%E5%88%B0%E8%BF%99%E4%BA%9B%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E3%80%82">http://10.6.6.207:18080/metrics拿到这些监控数据。</a></p>
<p>（1）为外部服务创建endpoints和service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">external</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.6</span><span class="number">.6</span><span class="number">.207</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">18080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">external</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">external-metrics</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">18080</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">18080</span>      </span><br></pre></td></tr></table></figure>

<p>​    查看是否创建成功</p>
<p>​    创建ServiceMonitor资源对象</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceMonitor</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">external</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">external</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">external-metrics</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="string">metrics</span>             <span class="comment"># 对应service的端口名</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&#x27;/metrics&#x27;</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">honorLabels:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>然后查看Prometheus UI页面</p>
<p><img src="prometheus-external-service.jpg" alt="prometheus-external-service"></p>
<p>查看（<a target="_blank" rel="noopener" href="http://10.6.6.207:18080/metrics%EF%BC%89%E5%85%B6%E4%B8%AD%E7%9A%84%E6%8C%87%E6%A0%87%EF%BC%8C%E5%8F%91%E7%8E%B0%E5%B7%B2%E7%BB%8F%E6%94%B6%E9%9B%86%E4%B8%8A%E6%9D%A5%E4%BA%86%E3%80%82">http://10.6.6.207:18080/metrics）其中的指标，发现已经收集上来了。</a></p>
<p><img src="prometheus-external-metrics.jpg" alt="prometheus-external-metrics"></p>
<p>​    </p>
<h3 id="告警规则配置"><a href="#告警规则配置" class="headerlink" title="告警规则配置"></a>告警规则配置</h3><h1 id="AlertManager"><a href="#AlertManager" class="headerlink" title="AlertManager"></a>AlertManager</h1><h2 id="基础介绍-1"><a href="#基础介绍-1" class="headerlink" title="基础介绍"></a>基础介绍</h2><h2 id="配置实践-1"><a href="#配置实践-1" class="headerlink" title="配置实践"></a>配置实践</h2><h1 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h1><p>​    Grafana支持自定义仪表盘，或者从官网下载开源的仪表搭配方案，直接上载。</p>
<h2 id="总体介绍"><a href="#总体介绍" class="headerlink" title="总体介绍"></a>总体介绍</h2><h2 id="配置实践-2"><a href="#配置实践-2" class="headerlink" title="配置实践"></a>配置实践</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2021/02/03/Kubernetes-HPA%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/03/Kubernetes-HPA%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">Kubernetes-HPA方案实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-03 00:00:00" itemprop="dateCreated datePublished" datetime="2021-02-03T00:00:00+08:00">2021-02-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HPA基础"><a href="#HPA基础" class="headerlink" title="HPA基础"></a>HPA基础</h1><h2 id="Pod-水平自动扩缩的工作机制"><a href="#Pod-水平自动扩缩的工作机制" class="headerlink" title="Pod 水平自动扩缩的工作机制"></a>Pod 水平自动扩缩的工作机制</h2><p><img src="hpa-scale.png" alt="hpa-scale"></p>
<p>​    </p>
<p>​    Pod扩缩特性，由K8S的API资源和控制器实现，资源决定了控制器的行为，控制器会周期型地调整副本控制器中副本的数量，以使Pod的资源使用情况，符合用户设定的目标值，Pod自动扩缩不适用于无法扩缩的对象，例如DaemonSet。</p>
<p>​    K8S聚合API的功能，提供了一种API的注册机制，使得API Server可以代理自定义指标的访问，将实际请求转发给对应的Service，然后Service的后端指向指标服务器，这其中包括了Metrics Server、我们自定义的Prometheus adapter。这里是通过下面命令查看对应的Service：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">apiservices.apiregistration.k8s.io</span></span><br></pre></td></tr></table></figure>

<p>​    这里以Metrics Server中的v1beta1.metrics.k8s.io API资源为例，查看情况：</p>
<p><img src="apiservice-metrics.jpg" alt="apiservice-metrics"></p>
<p>​    这是部署kube prometheus之前apiservice的指向情况，部署之后的指向情况如下：</p>
<p><img src="apiservice-metrics-adapter.jpg" alt="apiservice-metrics-adapter"></p>
<p>​    这里可以看出，部署了kube prometheus后，聚合api的代理统一通过adapter来实现。我们在部署的yaml清单中也能发现相关文件：</p>
<p><img src="kube-prometheus-yaml.jpg" alt="kube-prometheus-yaml"></p>
<p>​    </p>
<h2 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h2><p><img src="k8s-hpa.png" alt="k8s-hpa"></p>
<p>​    了解了HPA的工作的工作机制后，下面来梳理一下HPA + Kube Prometheus的大概工作流程：</p>
<p>​        （1）首先prometheus通过定义的serviceMonitor收集了K8s中绝大部分的指标。</p>
<p><img src="kube-prometheus-serviceMonitor.jpg" alt="kube-prometheus-serviceMonitor"></p>
<p>​        （2）prometheus adapter对prometheus中的指标进行了K8s API的适配，将其指标通过K8s apiservice的方式暴露出来。</p>
<p>​        （3）HPA的控制器（HorizontalPodAutoscaler）会从一系列的api中获取度量值，在启用了API聚合层的情况下：</p>
<p>​                    对于资源指标，使用metrics.k8s.io API，一般由metric service提供。</p>
<p>​                    对于自定义指标，使用custom.metrics.k8s.io API，一般由其他厂商提供adapter的API服务器提供。</p>
<p>​                    对于外部指标。使用external.metrics.k8s.io API，可能由上面的自定义指标适配器提供。</p>
<p>​        （4）HPA 度量指标类型：</p>
<p>​                    Resource：指的是当前伸缩对象下的pod的cpu和memory指标，只支持Utilization和AverageValue类型的目标值.</p>
<p>​                                        <strong>只要metrics.k8s.io API存在，他们就是可用的。</strong></p>
<p>​                    Object：指的是指定k8s内部对象的指标，数据需要第三方adapter提供，只支持Value和AverageValue类型的目标值。</p>
<p>​                    Pods：指的是<code>伸缩对象Pods的指标</code>，数据需要第三方的adapter提供，只允许AverageValue类型的目标值。</p>
<p>​                                    <strong>Object、Pods被认为是custom.metrics.k8s.io API</strong></p>
<p>​                    External：指的是k8s外部的指标，数据同样需要第三方的adapter提供，只支持Value和AverageValue类型的目标值。            </p>
<h1 id="HPA-应用实践"><a href="#HPA-应用实践" class="headerlink" title="HPA 应用实践"></a>HPA 应用实践</h1><p>​    这里依然采用kube-prometheus进行实验。</p>
<h2 id="基于CPU、内存"><a href="#基于CPU、内存" class="headerlink" title="基于CPU、内存"></a>基于CPU、内存</h2><p>​    （1）使用内存、CPU创建HorizontalPodAutoscaler对象</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hpa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">edu</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">      <span class="attr">targetAverageUtilization:</span> <span class="number">60</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">targetAverageUtilization:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f  hpa.yml</span><br></pre></td></tr></table></figure>

<p>​    （2）增加scaleTargetRef对象的负载，观察效果，最终的扩容结果，会以同时满足两个指标情况为最终扩容结果。</p>
<p>​    <strong>使用HPA进行扩缩容管理时，如果手动对Deployment进行scale，会出现缩容失败的情况，同时官方也指出，绑定了HPA的滚动升级，HPA不能工作。</strong></p>
<p>​        <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-multiple-metrics">中文官方文档</a></p>
<h2 id="基于自定义指标"><a href="#基于自定义指标" class="headerlink" title="基于自定义指标"></a>基于自定义指标</h2><p>​    （1）首先需要在应用中自定义指标，并收集到prometheus中，在监控一节已经详细说明，可参照。</p>
<p>​    （2）本例选用 actuator 中的http_server_requests_seconds_count作为示例指标。通过NodePort暴露应用的监控信息如下：</p>
<p><img src="actuator-prometheus.jpg" alt="actuator-prometheus"></p>
<p>​    （3）将指标收集到prometheus后，可以在UI界面查询到应用的对象，和该指标情况：</p>
<p><img src="metric-demo.jpg" alt="metric-demo"></p>
<p>​        （4）通过定义adapter的configMap，将该指标通过K8s API暴露出来。configMap定义：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config.yaml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">seriesQuery:</span> <span class="string">&#x27;http_server_requests_seconds_count&#x27;</span></span><br><span class="line">      <span class="attr">seriesFilters:</span> []</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">overrides:</span></span><br><span class="line">          <span class="attr">namespace:</span></span><br><span class="line">            <span class="attr">resource:</span> <span class="string">namespace</span></span><br><span class="line">          <span class="attr">pod:</span></span><br><span class="line">            <span class="attr">resource:</span> <span class="string">pod</span></span><br><span class="line">      <span class="attr">name:</span></span><br><span class="line">        <span class="attr">matches:</span> <span class="string">&quot;^(.*)_seconds_count&quot;</span></span><br><span class="line">        <span class="attr">as:</span> <span class="string">&quot;$&#123;1&#125;_per_second&quot;</span></span><br><span class="line">      <span class="attr">metricsQuery:</span> <span class="string">(sum(rate(&lt;&lt;.Series&gt;&gt;&#123;&lt;&lt;.LabelMatchers&gt;&gt;&#125;[1m]))</span> <span class="string">by</span> <span class="string">(&lt;&lt;.GroupBy&gt;&gt;))</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">adapter-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>​    这是一个带参数的 Prometheus 查询，其中：</p>
<ul>
<li><code>seriesQuery</code>：查询 Prometheus 的语句，通过这个查询语句查询到的所有指标都可以用于 HPA</li>
<li><code>seriesFilters</code>：查询到的指标可能会存在不需要的，可以通过它过滤掉。</li>
<li><code>resources</code>：通过 <code>seriesQuery</code> 查询到的只是指标，如果需要查询某个 Pod 的指标，肯定要将它的名称和所在的命名空间作为指标的标签进行查询，<code>resources</code> 就是将指标的标签和 k8s 的资源类型关联起来，最常用的就是 pod 和 namespace。有两种添加标签的方式，一种是 <code>overrides</code>，另一种是 <code>template</code>。<ul>
<li><code>overrides</code>：它会将指标中的标签和 k8s 资源关联起来。上面示例中就是<code>将指标中的 pod 和 namespace 标签和 k8s 中的 pod 和 namespace 资源关联起来（相当于从指标中拿到了label，就可以kubectl get pods -n xxx pod_name 来查询？）</code>，因为 pod 和 namespace 都属于核心 api 组，所以不需要指定 api 组。当我们查询某个 pod 的指标时，它会自动将 pod 的名称和名称空间作为标签加入到查询条件中。比如 <code>nginx: &#123;group: &quot;apps&quot;, resource: &quot;deployment&quot;&#125;</code> 这么写表示的就是将指标中 nginx 这个标签和 apps 这个 api 组中的 <code>deployment</code> 资源关联起来；</li>
<li><code>template</code>：通过 go 模板的形式。比如<code>template: &quot;kube_&lt;&lt;.Group&gt;&gt;_&lt;&lt;.Resource&gt;&gt;&quot;</code> 这么写表示，假如 <code>&lt;&lt;.Group&gt;&gt;</code> 为 apps，<code>&lt;&lt;.Resource&gt;&gt;</code> 为 deployment，那么它就是将指标中 <code>kube_apps_deployment</code> 标签和 deployment 资源关联起来。</li>
</ul>
</li>
<li><code>name</code>：用来给指标重命名的，之所以要给指标重命名是因为有些指标是只增的，比如以 total 结尾的指标。这些指标拿来做 HPA 是没有意义的，我们一般计算它的速率，以速率作为值，那么此时的名称就不能以 total 结尾了，所以要进行重命名。<ul>
<li><code>matches</code>：通过正则表达式来匹配指标名，可以进行分组</li>
<li><code>as</code>：默认值为 <code>$1</code>，也就是第一个分组。<code>as</code> 为空就是使用默认值的意思。</li>
</ul>
</li>
<li><code>metricsQuery</code>：这就是 Prometheus 的查询语句了，前面的 <code>seriesQuery</code> 查询是获得 HPA 指标。当我们要查某个指标的值时就要通过它指定的查询语句进行了。可以看到查询语句使用了速率和分组，这就是解决上面提到的只增指标的问题。<ul>
<li><code>Series</code>：表示指标名称</li>
<li><code>LabelMatchers</code>：附加的标签，目前只有 <code>pod</code> 和 <code>namespace</code> 两种，因此我们要在之前使用 <code>resources</code> 进行关联</li>
<li><code>GroupBy</code>：就是 pod 名称，同样需要使用 <code>resources</code> 进行关联。</li>
</ul>
</li>
</ul>
<p>在K8s集群中，应用上述configMap，通过API查看自定义指标是否生效。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get --raw &quot;&#x2F;apis&#x2F;custom.metrics.k8s.io&#x2F;v1beta1&#x2F;namespaces&#x2F;&#123;namespace&#125;&#x2F;pod&#x2F;*&#x2F;http_server_requests_per_second&quot; | jq</span><br></pre></td></tr></table></figure>



<p><img src="metric-query.jpg" alt="metric-query"></p>
<p>​    （5）在cpu、内存的基础上追加自定义指标，根据实际情况设定指标值</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hpa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">edu</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">      <span class="attr">targetAverageUtilization:</span> <span class="number">60</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">targetAverageUtilization:</span> <span class="number">60</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Pods</span></span><br><span class="line">    <span class="attr">pods:</span></span><br><span class="line">      <span class="attr">metricName:</span> <span class="string">&#x27;http_server_requests_per_second&#x27;</span></span><br><span class="line">      <span class="attr">targetAverageValue:</span> <span class="string">100m</span></span><br></pre></td></tr></table></figure>

<p>​    （6）观察Pod扩缩容情况。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2020/12/04/06%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF-K8s%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90%E8%AF%84%E6%B5%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/04/06%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF-K8s%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90%E8%AF%84%E6%B5%8B/" class="post-title-link" itemprop="url">微服务技术-K8s容器资源评测</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-04 00:00:00" itemprop="dateCreated datePublished" datetime="2020-12-04T00:00:00+08:00">2020-12-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​    本文讨论的问题，服务共享平台需要大量动态发布Rest Server，目前首先考虑采用熟悉的技术栈Spring Boot 配合容器在K8s部署实现。在不考虑服务本身访问产生数据流量的情况下（抗流量，想通过副本扩展来应对），测试CPU、内存的消耗情况。        </p>
<p>​    主要分为两部分：</p>
<p>​        （1）基于《网关集成实践》中的设计，数据服务的Rest Server的职责，主要是承载数据访问的实际流量，启动后需要将自己上报给注册中心。</p>
<p>​        （2）Kubernetes部署最低配置</p>
<h1 id="Java-容器"><a href="#Java-容器" class="headerlink" title="Java 容器"></a>Java 容器</h1><p>​    主要通过限定容器的资源，同时在容器内限定jvm的资源，在保证正常启动，提供简单Rest服务的情况下，测试CPU、内存的临界值。</p>
<h2 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a>Spring Boot</h2><p>​    demo工程采用的是Spring Boot 2.3.2.RELEASE，集成了Oauth2的Resource Server + Spring Security、Nacos客户端。K8s中部署所使用的yaml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo-limit-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">demo-limit</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">demo-limit</span></span><br><span class="line">        <span class="attr">image:</span> <span class="number">10.6</span><span class="number">.1</span><span class="number">.56</span><span class="string">:5000/shadow/demo:8-jre-alpine-v4</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;-XX:InitialRAMPercentage=50.0 -XX:MaxRAMPercentage=80.0 -XX:+PrintFlagsFinal&quot;</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">18888</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">18888</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">800m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">800m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">18888</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo-limit</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-limit</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">18888</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">18888</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-limit</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    制作镜像的Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> docker.io/openjdk:<span class="number">8</span>-jre-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./demo-application.jar /usr/app/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /usr/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sh -c <span class="string">&#x27;touch demo-application.jar&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> java <span class="variable">$JAVA_OPTS</span> -jar demo-application.jar</span></span><br></pre></td></tr></table></figure>



<p>​    jvm的默认堆最大内存会根据主机内存的情况，设置为大约主机内存的1/4。Java8u131+及以后追加了对容器内存cgroup的感知。本文使用的Java版本如下：<img src="container-java-version.jpg" alt="container-java-version"></p>
<p>​    在开启了UseContainerSupport后，可以通过参数根据容器的资源情况进一步限定内存的占比。</p>
<p>​    在上述情况下，建议将最小CPU设为600m，将内存设为200Mi，如果CPU过低，会导致java进程无法在指定时间内提供服务，被restart，如果内存设置过低，例如设置为100M以后，会导致容器被OOMKilled</p>
<p><img src="container-OOMKilled.jpg" alt="container-OOMKilled"></p>
<p>​    实际运行起来，查看容器资源消耗</p>
<p><img src="container-spring-limit.jpg" alt="container-spring-limit"></p>
<h2 id="Java-Servlet"><a href="#Java-Servlet" class="headerlink" title="Java Servlet"></a>Java Servlet</h2><p>​    因为数据服务的Rest Server功能相对单一，主要是从后端存储中获取数据，然后以Rest接口的形式提供服务，Spring占用大量内存，因此考虑是用servlet测试服务本身的资源情况，以期降低消耗。</p>
<p>​    K8s部署中使用的yaml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">servlet-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">servlet</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">servlet</span></span><br><span class="line">        <span class="attr">image:</span> <span class="number">10.6</span><span class="number">.1</span><span class="number">.56</span><span class="string">:5000/shadow/servlet-demo:v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;-XX:InitialRAMPercentage=50.0 -XX:MaxRAMPercentage=80.0 -XX:+PrintFlagsFinal&quot;</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/servlet-demo/my</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/servlet-demo/my</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">300m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">300m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">servlet</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">servlet</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">18080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">servlet</span></span><br></pre></td></tr></table></figure>

<p>​    制作镜像的Dockerfile，在tomcat上为jvm设置参数</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> docker.io/tomcat:<span class="number">8</span>-jdk8</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./servlet-demo.war /usr/<span class="built_in">local</span>/tomcat/webapps/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;/usr/local/tomcat/bin/catalina.sh&quot;</span>, <span class="string">&quot;run&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>​    可在容器中，执行jinfo Pid查询JVM的参数是否生效</p>
<p><img src="container-tomcat-jvm.jpg" alt="container-tomcat-jvm"></p>
<p>​    在上述情况下，建议将最小cpu设为300m，最小内存设为100Mi，只相当于Spring版本的一半。</p>
<p>​    查看容器资源消耗</p>
<p><img src="container-servlet-limit.jpg" alt="container-servlet-limit"></p>
<h2 id="其它语言"><a href="#其它语言" class="headerlink" title="其它语言"></a>其它语言</h2><p>​    go语言等可能较Java具有更小的资源消耗，和更高的并发支持。因受限于技术栈情况，会增加额外的开发维护成本，暂不考虑go等其它语言实现。</p>
<h1 id="K8s-部署"><a href="#K8s-部署" class="headerlink" title="K8s 部署"></a>K8s 部署</h1><p>​    K8s 部署方式可以分为：高可用部署、单master集群部署、单节点部署。</p>
<p>​    高可用部署和单master部署，需要三台及以上节点。K8s自身的服务并不需要太高的资源（根据在虚拟机上的部署经验，通常1核2G就可以运行得很好）。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2020/11/25/05%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF-%E7%BD%91%E5%85%B3%E9%9B%86%E6%88%90%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/25/05%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF-%E7%BD%91%E5%85%B3%E9%9B%86%E6%88%90%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">微服务技术-网关集成实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-25 00:00:00" itemprop="dateCreated datePublished" datetime="2020-11-25T00:00:00+08:00">2020-11-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​    根据系统架构设计图，需要对服务网关进行集成，满足动态路由配置、认证鉴权、容错限流规则动态加载、负载均衡等要求，如图红色部分。</p>
<p><img src="Data-Service-Gateway.jpg" alt="Data-Service-Gateway"></p>
<p>​    现基于Spring-Cloud-Gateway进行相关功能的集成、技术验证</p>
<h1 id="动态配置"><a href="#动态配置" class="headerlink" title="动态配置"></a>动态配置</h1><p>​    根据上述架构图，数据服务发布后，需要通过Rest API在Nacos上修改配置，及时生效的功能主要有：</p>
<p>​        （1）网关的路由配置文件，在网关上追加到服务的路由配置</p>
<p>​        （2）容错限流Sentinel的阈值设定，后期运维可能需要动态调整</p>
<h2 id="Nacos-Rest-API"><a href="#Nacos-Rest-API" class="headerlink" title="Nacos Rest API"></a>Nacos Rest API</h2><p>​    </p>
<p>​    <a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/open-api.html">官方API说明</a></p>
<h3 id="配置文件创建-修改"><a href="#配置文件创建-修改" class="headerlink" title="配置文件创建/修改"></a>配置文件创建/修改</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.6.6.208:8848/nacos/v1/cs/configs</span><br></pre></td></tr></table></figure>

<p><img src="config-create.jpg" alt="config-create" style="zoom:50%;" />                               <img src="config-create-result.jpg" alt="config-create-result" style="zoom:50%;" /> </p>
<h3 id="配置文件查询"><a href="#配置文件查询" class="headerlink" title="配置文件查询"></a>配置文件查询</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.6.6.208:8848/nacos/v1/cs/configs?dataId=gateway-routes.yml&amp;group=DEFAULT_GROUP</span><br></pre></td></tr></table></figure>

<img src="config-query.jpg" alt="config-query"  />



<h2 id="Gateway-动态刷新"><a href="#Gateway-动态刷新" class="headerlink" title="Gateway 动态刷新"></a>Gateway 动态刷新</h2><p>​    Spring Cloud Gateway + Actuator可以暴露网关中配置的路由规则，需要搭配的配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">management.endpoints.web.exposure.include&#x3D;gateway</span><br><span class="line">management.endpoint.gateway.enabled&#x3D;true</span><br><span class="line"></span><br><span class="line">通过如下地址可以查看</span><br><span class="line">http:&#x2F;&#x2F;10.6.3.39:18080&#x2F;actuator&#x2F;gateway&#x2F;routes</span><br></pre></td></tr></table></figure>

<img src="gateway-route-query.jpg" alt="gateway-route-query"  />



<p>​    配合1.1.1中配置文件的Rest API可以实现动态路由。例如下图配置了使用负载均衡并使用path的断言：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">path_route1</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://demo-http-service:8888</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/demo</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">path_route2</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://demo-http-service:8888</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/home</span>  </span><br></pre></td></tr></table></figure>



<p>​    只需要对这样一段字符串进行增删改的维护，应用就可以自行读取动态配置，如果使用JSON的配置文件格式，虽然更易于维护，但是因为应用只能使用properties或者是yml的配置文件，需要自己集成网关中的路由的增删改处理，Spring Cloud Gateway已也有相关支持的接口类。</p>
<h2 id="Sentinel客户端使用Nacos-Datasource"><a href="#Sentinel客户端使用Nacos-Datasource" class="headerlink" title="Sentinel客户端使用Nacos Datasource"></a>Sentinel客户端使用Nacos Datasource</h2><p>​    <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81">Gateway整合Sentinel文档</a></p>
<p>​    <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/tree/master/sentinel-demo/sentinel-demo-nacos-datasource">Nacos Datasource Demo</a></p>
<p>​    要实现数据服务的动态容错限流，根据Sentinel官方的描述，推荐使用的方式是，将容错限流的规则推送到Nacos（可使用1.1中的Nacos Rest API），然后在Sentinel的客户端，集成Nacos的数据源，动态在内存中更新并使用这些规则。</p>
<h3 id="推送JSON格式的规则"><a href="#推送JSON格式的规则" class="headerlink" title="推送JSON格式的规则"></a>推送JSON格式的规则</h3><p>​    使用Postman推送JSON格式的Sentinel限流规则，这里仅仅设置了限流为1，使用Gateway中配置的route_id作为resource，更加复杂的规则设定可以通过抓取Sentinel dashboard的数据格式或者参照官网进行：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;<span class="attr">&quot;resource&quot;</span>: <span class="string">&quot;path_route1&quot;</span>,<span class="attr">&quot;controlBehavior&quot;</span>: <span class="number">0</span>,<span class="attr">&quot;count&quot;</span>: <span class="number">1</span>,<span class="attr">&quot;grade&quot;</span>: <span class="number">1</span>,<span class="attr">&quot;limitApp&quot;</span>: <span class="string">&quot;default&quot;</span>,<span class="attr">&quot;strategy&quot;</span>: <span class="number">0</span>&#125;]</span><br></pre></td></tr></table></figure>

<img src="sentinel-rule-nacos.jpg" alt="sentinel-rule-nacos" style="zoom: 80%;" />



<h3 id="网关使用Nacos-Datasource"><a href="#网关使用Nacos-Datasource" class="headerlink" title="网关使用Nacos Datasource"></a>网关使用Nacos Datasource</h3><p>​    在网关上需要设置Sentinel的filter，并为Sentinel注册Nacos的规则数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initNacosDatasource</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String remoteAddress = <span class="string">&quot;10.6.6.208&quot;</span>;</span><br><span class="line">    String groupId = <span class="string">&quot;DEFAULT_GROUP&quot;</span>;</span><br><span class="line">    String dataId = <span class="string">&quot;gateway_sentinel_rule&quot;</span>;</span><br><span class="line">    <span class="comment">/** 效果一样</span></span><br><span class="line"><span class="comment">    ReadableDataSource&lt;String, List&lt;FlowRule&gt;&gt; flowRuleDataSource = new NacosDataSource&lt;&gt;(remoteAddress, groupId, dataId,</span></span><br><span class="line"><span class="comment">    	source -&gt; JSON.parseObject(source, new TypeReference&lt;List&lt;FlowRule&gt;&gt;() &#123;</span></span><br><span class="line"><span class="comment">    &#125;));</span></span><br><span class="line"><span class="comment">    FlowRuleManager.register2Property(flowRuleDataSource.getProperty());</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    ReadableDataSource&lt;String, Set&lt;GatewayFlowRule&gt;&gt; flowRuleDataSource = <span class="keyword">new</span> NacosDataSource&lt;&gt;(remoteAddress, groupId, dataId,</span><br><span class="line">    	source -&gt; JSON.parseObject(source, <span class="keyword">new</span> TypeReference&lt;Set&lt;GatewayFlowRule&gt;&gt;() &#123;</span><br><span class="line">    &#125;));</span><br><span class="line">    GatewayRuleManager.register2Property(flowRuleDataSource.getProperty());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    启动服务之后，使用Postman推送规则，发现对应的服务被容错限流保护，修改限流数量为10，服务被放过部分后，继续熔断。</p>
<p><img src="service-block.jpg" alt="service-block">                        <img src="sentinel-rule-modify.jpg" alt="sentinel-rule-modify" style="zoom:50%;" /></p>
<p>​    <strong>（1）这里有一点跟之前理解的不一样，将Sentinel的规则数据源换成Nacos后，dashboard失效。</strong></p>
<p>​    <strong>（2）可以在 GatewayCallbackManager 注册回调进行定制</strong></p>
<p>​                <strong>setBlockHandler：注册函数用于实现自定义的逻辑处理被限流的请求，对应接口为 BlockRequestHandler</strong></p>
<p>​                <strong>默认实现为 DefaultBlockRequestHandler，当被限流时会返回类似于下面的错误信息：Blocked by Sentinel: FlowException</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GatewayCallbackManager.setBlockHandler(<span class="keyword">new</span> BlockRequestHandler() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">handleRequest</span><span class="params">(ServerWebExchange serverWebExchange, Throwable throwable)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h1 id="认证鉴权"><a href="#认证鉴权" class="headerlink" title="认证鉴权"></a>认证鉴权</h1><p>​    通常情况下，需要在网关上进行统一认证，而选在在网关上或者是子服务中鉴权，这里我们将鉴权交给子服务。</p>
<p><img src="oauth-security-jwt.jpg" alt="oauth-security-jwt"></p>
<p>​    按照上述架构图设计，需要在各服务中集成oauth2 + Spring Security + JWT，主要分成三个部分：</p>
<h2 id="认证服务"><a href="#认证服务" class="headerlink" title="认证服务"></a>认证服务</h2><p>​    认证服务器，负责获取用户信息（包括基本信息、角色、功能权限等），生成JWT token。认证服务器支持四种模式：</p>
<h3 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h3><p>​    （1）首先客户端使用客户端凭证、用户名密码到授权服务器上换取token</p>
<img src="oauth-security-jwt/oauth-password-token.jpg" alt="oauth-security-jwt-password" style="zoom: 50%;" />

<p>​    （2）使用换取的token到网关上访问具体的资源服务</p>
<img src="oauth-security-jwt/oauth-password-visit.jpg" alt="oauth-security-jwt-password-visit" style="zoom: 80%;" />

<h3 id="授权码模式"><a href="#授权码模式" class="headerlink" title="授权码模式"></a>授权码模式</h3><p>​    （1）首先访问认证服务器，如果是第一次，会要求输入用户名密码。认证通过后，需要选择是否授权（如果在认证服务器设置.autoApprove(true)可跳过手动授权这步）。</p>
<p><img src="oauth-security-jwt/oauth-code-approval.jpg" alt="oauth-code-approval"></p>
<p>​    （2）授权码模式需要在授权服务器上配置一个回调地址（资源服务的地址），授权通过后，授权码通过这个地址回传。</p>
<p><img src="oauth-security-jwt/oauth-code-redirect.jpg" alt="oauth-code-redirect"></p>
<p>​    （3）网关需要使用这个授权码到认证服务上换取jwt token，并且缓存这个token。</p>
<p><img src="oauth-security-jwt/oauth-code-token-1.jpg" alt="oauth-code-token-1" style="zoom: 25%;" />                            <img src="oauth-security-jwt/oauth-code-token-2.jpg" alt="oauth-code-token-2" style="zoom: 33%;" /></p>
<p>​    （4）客户端使用code访问网关，网关找出对应的jwt token，认证并使用其中的信息进行鉴权，决定是否可以访问对应的资源。</p>
<h3 id="客户端模式"><a href="#客户端模式" class="headerlink" title="客户端模式"></a>客户端模式</h3><p>​    （1）客户端使用客户端凭证到认证服务器上获取token</p>
<p><img src="oauth-security-jwt/oauth-client-token.jpg" alt="oauth-client-token"></p>
<p>​    （2）使用上述获得的token，可以正常访问网关服务提供的资源。</p>
<h3 id="简易模式"><a href="#简易模式" class="headerlink" title="简易模式"></a>简易模式</h3><p>​    （1）相较于授权码模式，省去返回授权码的步骤，如果第一次登录需要输入用户名密码，并且选择是否授权（如果在认证服务器设置.autoApprove(true)可跳过手动授权这步），如果选择授权，直接返回token</p>
<img src="oauth-security-jwt/oauth-implicit-approval.jpg" alt="oauth-implicit-approval"  />

<img src="oauth-security-jwt/oauth-implicit-token.jpg" alt="oauth-implicit-token"  />



<p>​    （2）使用上述获得的token，可以正常访问网关服务提供的资源。</p>
<h2 id="网关服务"><a href="#网关服务" class="headerlink" title="网关服务"></a>网关服务</h2><p>​    网关作为一种特殊的资源服务，本身虽然不提供资源，但是作为资源的统一访问转发服务，需要在其上集成认证（用户认证+接口认证）。</p>
<h3 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h3><p>​    使用授权码模式，并设定.autoApprove(true)跳过手动授权。</p>
<h3 id="接口认证"><a href="#接口认证" class="headerlink" title="接口认证"></a>接口认证</h3><p>​    使用客户端模式，认证服务后端接jdbc存储，动态生成客户端模式的客户凭证。可以通过代理获取token，将token返回给用户，用户使用token来访问具体的服务。</p>
<h2 id="资源服务"><a href="#资源服务" class="headerlink" title="资源服务"></a>资源服务</h2><p>​    各子服务，负责自身的鉴权（用户鉴权+接口鉴权）。</p>
<h3 id="用户鉴权"><a href="#用户鉴权" class="headerlink" title="用户鉴权"></a>用户鉴权</h3><p>​    系统的功能菜单、url权限存放在数据库中，子服务获取http header中的用户权限，比对即可进行相应的权限控制。</p>
<h3 id="接口鉴权"><a href="#接口鉴权" class="headerlink" title="接口鉴权"></a>接口鉴权</h3><p>​    子服务的url权限，存放在数据库中，用户可以通过UI动态调整url的权限信息，http header中存有客户端凭证信息，可据此进行权限控制。</p>
<h3 id="数据权限"><a href="#数据权限" class="headerlink" title="数据权限"></a>数据权限</h3><p>​    需要在子服务中根据组织机构、数据属主进行数据权限的过滤。</p>
<h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><h3 id="认证服务-1"><a href="#认证服务-1" class="headerlink" title="认证服务"></a>认证服务</h3><p>​    （1）Oauth2 Server</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2ServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PasswordEncoder passwordEncoder;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SecurityUserService userDetailsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenEnhancer jwtTokenEnhancer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//可配合接后端存储 可以自动授权</span></span><br><span class="line">        clients.inMemory()</span><br><span class="line">                .withClient(<span class="string">&quot;client-app&quot;</span>)</span><br><span class="line">                .secret(passwordEncoder.encode(<span class="string">&quot;123456&quot;</span>))</span><br><span class="line">                .scopes(<span class="string">&quot;all&quot;</span>)</span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>, <span class="string">&quot;client_credentials&quot;</span>, <span class="string">&quot;authorization_code&quot;</span>, <span class="string">&quot;implicit&quot;</span>)</span><br><span class="line">                .accessTokenValiditySeconds(<span class="number">3600</span>)</span><br><span class="line">                .refreshTokenValiditySeconds(<span class="number">86400</span>)</span><br><span class="line">            	<span class="comment">//授权模式的回调地址	</span></span><br><span class="line">                .redirectUris(<span class="string">&quot;http://10.6.3.39:18080/callback&quot;</span>)</span><br><span class="line">                <span class="comment">//自动授权</span></span><br><span class="line">                .autoApprove(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        TokenEnhancerChain enhancerChain = <span class="keyword">new</span> TokenEnhancerChain();</span><br><span class="line">        List&lt;TokenEnhancer&gt; delegates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        delegates.add(jwtTokenEnhancer);</span><br><span class="line">        delegates.add(accessTokenConverter());</span><br><span class="line">        enhancerChain.setTokenEnhancers(delegates); <span class="comment">//配置JWT的内容增强器</span></span><br><span class="line">        endpoints.authenticationManager(authenticationManager)</span><br><span class="line">                .userDetailsService(userDetailsService) <span class="comment">//配置加载用户信息的服务</span></span><br><span class="line">                .accessTokenConverter(accessTokenConverter())</span><br><span class="line">                .tokenEnhancer(enhancerChain);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//开启/oauth/token_key验证端口认证权限访问</span></span><br><span class="line">        <span class="comment">//开启/oauth/check_token验证端口认证权限访问</span></span><br><span class="line">        <span class="comment">//允许表单认证</span></span><br><span class="line">        security.tokenKeyAccess(<span class="string">&quot;isAuthenticated()&quot;</span>).checkTokenAccess(<span class="string">&quot;isAuthenticated()&quot;</span>).allowFormAuthenticationForClients();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">accessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter jwtAccessTokenConverter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        jwtAccessTokenConverter.setKeyPair(keyPair());</span><br><span class="line">        <span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyPair <span class="title">keyPair</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//从classpath下的证书中获取秘钥对</span></span><br><span class="line">        KeyStoreKeyFactory keyStoreKeyFactory = <span class="keyword">new</span> KeyStoreKeyFactory(<span class="keyword">new</span> ClassPathResource(<span class="string">&quot;jwt.jks&quot;</span>), <span class="string">&quot;123456&quot;</span>.toCharArray());</span><br><span class="line">        <span class="keyword">return</span> keyStoreKeyFactory.getKeyPair(<span class="string">&quot;jwt&quot;</span>, <span class="string">&quot;123456&quot;</span>.toCharArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>秘钥对生成：keytool -genkey -alias jwt -keyalg RSA -keypass 123456 -keystore jwt.jks -storepass 123456</strong></p>
<p><strong>-genkey 生成密钥 -alias 别名 -keyalg 密钥算法 -keypass 密钥口令 -keystore 生成密钥库的存储路径和名称 -storepass 密钥库口令</strong></p>
<p>​    （2）Spring Security</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfiguration</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用内存的方式，可以换成其他方式，例如数据存储</span></span><br><span class="line">        auth.inMemoryAuthentication()</span><br><span class="line">                .passwordEncoder(passwordEncoder())</span><br><span class="line">                .withUser(<span class="string">&quot;shadow&quot;</span>).password(passwordEncoder().encode(<span class="string">&quot;123456&quot;</span>)).authorities(<span class="string">&quot;USER&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .withUser(<span class="string">&quot;sugon&quot;</span>).password(passwordEncoder().encode(<span class="string">&quot;123456&quot;</span>)).authorities(<span class="string">&quot;USER&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// @formatter:off</span></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .requestMatchers(EndpointRequest.toAnyEndpoint()).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/rsa/publicKey&quot;</span>, <span class="string">&quot;/oauth/**&quot;</span>, <span class="string">&quot;/actuator/**&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .httpBasic() <span class="comment">//  Basic登录  （授权码）</span></span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable(); <span class="comment">//关跨域保护;</span></span><br><span class="line">        <span class="comment">// @formatter:on</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="服务网关"><a href="#服务网关" class="headerlink" title="服务网关"></a>服务网关</h3><p>​    （1）Spring Security</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebFluxSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayResourceServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthorizationManager authorizationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityWebFilterChain <span class="title">securityWebFilterChain</span><span class="params">(ServerHttpSecurity http)</span> </span>&#123;</span><br><span class="line">        http.oauth2ResourceServer().jwt().jwtAuthenticationConverter(jwtAuthenticationConverter());</span><br><span class="line">        <span class="comment">// 自定义处理JWT请求头过期或签名错误的结果</span></span><br><span class="line">        <span class="comment">//http.oauth2ResourceServer().authenticationEntryPoint(customServerAuthenticationEntryPoint);</span></span><br><span class="line"></span><br><span class="line">        http.authorizeExchange()</span><br><span class="line">                <span class="comment">//.pathMatchers(ArrayUtil.toArray(whiteListConfig.getUrls(),String.class)).permitAll()</span></span><br><span class="line">                .pathMatchers(<span class="string">&quot;/actuator/**&quot;</span>).permitAll()</span><br><span class="line">                .anyExchange().access(authorizationManager)</span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()</span><br><span class="line">                <span class="comment">//.accessDeniedHandler(customServerAccessDeniedHandler) // 处理未授权</span></span><br><span class="line">                <span class="comment">//.authenticationEntryPoint(customServerAuthenticationEntryPoint) //处理未认证</span></span><br><span class="line">                .and().csrf().disable();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@linkhttps</span>://blog.csdn.net/qq_24230139/article/details/105091273</span></span><br><span class="line"><span class="comment">     * ServerHttpSecurity没有将jwt中authorities的负载部分当做Authentication</span></span><br><span class="line"><span class="comment">     * 需要把jwt的Claim中的authorities加入</span></span><br><span class="line"><span class="comment">     * 方案：重新定义ReactiveAuthenticationManager权限管理器，默认转换器JwtGrantedAuthoritiesConverter</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;Jwt, ? extends Mono&lt;? extends AbstractAuthenticationToken&gt;&gt; jwtAuthenticationConverter() &#123;</span><br><span class="line">        JwtGrantedAuthoritiesConverter jwtGrantedAuthoritiesConverter = <span class="keyword">new</span> JwtGrantedAuthoritiesConverter();</span><br><span class="line">        jwtGrantedAuthoritiesConverter.setAuthorityPrefix(AuthConstant.AUTHORITY_PREFIX);</span><br><span class="line">        jwtGrantedAuthoritiesConverter.setAuthoritiesClaimName(AuthConstant.AUTHORITY_CLAIM_NAME);</span><br><span class="line"></span><br><span class="line">        JwtAuthenticationConverter jwtAuthenticationConverter = <span class="keyword">new</span> JwtAuthenticationConverter();</span><br><span class="line">        jwtAuthenticationConverter.setJwtGrantedAuthoritiesConverter(jwtGrantedAuthoritiesConverter);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReactiveJwtAuthenticationConverterAdapter(jwtAuthenticationConverter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    （2）鉴权实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationManager</span> <span class="keyword">implements</span> <span class="title">ReactiveAuthorizationManager</span>&lt;<span class="title">AuthorizationContext</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;AuthorizationDecision&gt; <span class="title">check</span><span class="params">(Mono&lt;Authentication&gt; mono, AuthorizationContext authorizationContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        URI uri = authorizationContext.getExchange().getRequest().getURI();</span><br><span class="line">        System.out.printf(<span class="string">&quot;uri: &quot;</span> + uri.toString());</span><br><span class="line">        <span class="comment">//这里可以从数据库或其他存储设备中加载当前url对应的权限，然后进行鉴权，目前我们在网关中不鉴权</span></span><br><span class="line">        List&lt;String&gt; authorities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        authorities.add(AuthConstant.AUTHORITY_PREFIX + <span class="string">&quot;USER&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//认证通过且角色匹配的用户可访问当前路径</span></span><br><span class="line">        <span class="comment">/** 客户端模式没有角色</span></span><br><span class="line"><span class="comment">        return mono.filter(Authentication::isAuthenticated)</span></span><br><span class="line"><span class="comment">                .flatMapIterable(Authentication::getAuthorities)</span></span><br><span class="line"><span class="comment">                .map(GrantedAuthority::getAuthority)</span></span><br><span class="line"><span class="comment">                .any(authorities::contains)</span></span><br><span class="line"><span class="comment">                .map(AuthorizationDecision::new)</span></span><br><span class="line"><span class="comment">                .defaultIfEmpty(new AuthorizationDecision(false));*/</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mono.just(<span class="keyword">new</span> AuthorizationDecision(<span class="keyword">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="资源服务-1"><a href="#资源服务-1" class="headerlink" title="资源服务"></a>资源服务</h3><p>​    （1）使用普通的filter，比对请求中用户权限信息和缓存中url的权限数据即可。</p>
<p>​    （2）作为资源服务，接入oauth2认证服务器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfiguration</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthorizationManager authorizationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// @formatter:off</span></span><br><span class="line">        http</span><br><span class="line">            <span class="comment">// Since we want the protected resources to be accessible in the UI as well we need</span></span><br><span class="line">            <span class="comment">// session creation to be allowed (it&#x27;s disabled by default in 2.0.6)</span></span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class="line">            .and()</span><br><span class="line">            .requestMatchers().anyRequest()</span><br><span class="line">            .and()</span><br><span class="line">            .anonymous()</span><br><span class="line">            .and()</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                    <span class="comment">//.antMatchers(&quot;/product/**&quot;).access(&quot;#oauth2.hasScope(&#x27;select&#x27;) and hasRole(&#x27;ROLE_USER&#x27;)&quot;)</span></span><br><span class="line">            .antMatchers(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .authenticated() ;  <span class="comment">//配置resource访问控制，必须认证过后才可以访问</span></span><br><span class="line">        <span class="comment">// @formatter:on</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        resources.tokenStore(tokenStore());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">tokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtTokenStore(accessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">accessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter jwtAccessTokenConverter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        jwtAccessTokenConverter.setKeyPair(keyPair());</span><br><span class="line">        <span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyPair <span class="title">keyPair</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//从classpath下的证书中获取秘钥对</span></span><br><span class="line">        KeyStoreKeyFactory keyStoreKeyFactory = <span class="keyword">new</span> KeyStoreKeyFactory(<span class="keyword">new</span> ClassPathResource(<span class="string">&quot;jwt.jks&quot;</span>), <span class="string">&quot;123456&quot;</span>.toCharArray());</span><br><span class="line">        <span class="keyword">return</span> keyStoreKeyFactory.getKeyPair(<span class="string">&quot;jwt&quot;</span>, <span class="string">&quot;123456&quot;</span>.toCharArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    （3）如果需要使用注解进行权限控制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">GlobalMethodSecurityConfiguration</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/demo&quot;)</span></span><br><span class="line">@PreAuthorize(&quot;hasAuthority(&#x27;USER&#x27;)&quot;)                               #更复杂的语法，具体使用查阅</span><br><span class="line"><span class="function">String <span class="title">demo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;demo success @ &quot;</span> + LoginUserHolder.getCurrentUser();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    <strong>Spring Security默认是禁用注解的，要想开启注解，需要在继承WebSecurityConfigurerAdapter的类上加@EnableGlobalMethodSecurity注解，来判断用户对某个控制层的方法是否具有访问权限</strong></p>
<p>​    （4）如果需要动态修改权限的数据</p>
<p>​    <a target="_blank" rel="noopener" href="https://blog.csdn.net/caplike/article/details/107497640">参考链接</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2020/11/07/03%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/07/03%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/" class="post-title-link" itemprop="url">微服务技术-配置中心</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-07 00:00:00" itemprop="dateCreated datePublished" datetime="2020-11-07T00:00:00+08:00">2020-11-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​    在微服务架构中，服务往往是多实例，尤其是在K8s的部署模式下，不可能将配置放在应用的本地，因此需要一个统一的配置中心，同时在everything is code的思想下，配置应该有一个版本管理，当需要调整的时候，应用可以自动加载生效（热更新）。</p>
<h1 id="技术要求"><a href="#技术要求" class="headerlink" title="技术要求"></a>技术要求</h1><h2 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h2><p>​    开发/运维修改了应用的配置之后，无需重启应用，应用可以及时更新最新的配置并生效。</p>
<h2 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h2><p>​    配置中心作为应用配置的来源，不能出现单点故障，否则会引发系统性的灾难。</p>
<h2 id="版本管理"><a href="#版本管理" class="headerlink" title="版本管理"></a>版本管理</h2><p>​    everything is code，需要追溯配置修改的版本，便于排错和及时回滚错误的配置版本。</p>
<h2 id="友好性"><a href="#友好性" class="headerlink" title="友好性"></a>友好性</h2><p>​    （1）配置中心应该提供良好的UI界面，便于运维人员直观的查询修改；最好有开发性api便于二次开发集成。</p>
<p>​    （2）配置中心应该具备易于集成客户端，以便在应用中快速集成。</p>
<h1 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h1><p>​    因为Spring Cloud Config在热更新方面集成比较复杂，予以排除，目前主要考虑的两个配置中心：</p>
<h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><p>​    Nacos是Spring Cloud Alibaba架构下的组件，一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。截止2020-11-07，github star 14.8K。</p>
<p>​    <a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos">Nacos Github</a></p>
<p>​    <a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/index.html">Nacos 官网</a></p>
<h2 id="Apollo"><a href="#Apollo" class="headerlink" title="Apollo"></a>Apollo</h2><p>​    Apollo是携程开源的一款配置中心，适用于微服务架构下的不同环境的配置管理。对Spring/Spring Cloud有很好的支持。截止2020-1107，github star 22.8。</p>
<p>​    <a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo">Apollo Github</a></p>
<h2 id="Nacos-vs-Apollo"><a href="#Nacos-vs-Apollo" class="headerlink" title="Nacos vs Apollo"></a>Nacos vs Apollo</h2><p>​    两款注册中心都比较优秀，均满足上述技术要求，从github的星数可见一斑。下面仅从自己的角度，对一些细微的地方做一些说明：</p>
<p>（1）Nacos作为配置中心的同时，同时提供了服务注册、发现的功能。</p>
<p>（2）Apollo、Nacos在高可用方面，应用会在自己的本地存储缓存一份配置文件，这样一旦发生配置中心整个不可用，应用也可以使用自己的本地配置文件。</p>
<p>​          在UI上，apollo可以将配置先保存，不直接发布，apollo的UI感觉更舒服。    </p>
<p>​    鉴于Nacos的服务注册、发现功能，建议选用Nacos，毕竟可以在开发环境少集成一个组件，节约成本。</p>
<h1 id="拓展思考"><a href="#拓展思考" class="headerlink" title="拓展思考"></a>拓展思考</h1><p>​    在为微服务架构选型的时候，经常在想K8s提供了哪些功能，这些功能跟微服务组件提供的功能很类似，如果应用最终是要上K8s部署，能不能借用K8s现有的功能，减少微服务组件的引用，如下表格：</p>
<table>
<thead>
<tr>
<th></th>
<th>Kubernetes</th>
<th>微服务</th>
</tr>
</thead>
<tbody><tr>
<td>服务注册、发现</td>
<td>Service</td>
<td>Eureka、Nacos等</td>
</tr>
<tr>
<td>配置管理</td>
<td>ConfigMap</td>
<td>Apollo、Nacos等</td>
</tr>
<tr>
<td>负载均衡</td>
<td>Service</td>
<td>Ribbon</td>
</tr>
<tr>
<td>服务网关</td>
<td>Ingress</td>
<td>Gateway、Zuul、Traefik等</td>
</tr>
</tbody></table>
<p>​    但是目前看来，目前K8s的功能对于完全实现一个微服务系统来说，相对较弱，而且我们要基于这些功能做一些应用、业务上的扩展的时候，会比较麻烦，或者根本无法扩展。</p>
<p>​    所以K8s对微服务来说，还是应该充分发挥它在运维上的能力，系统开发应该交给更专业的这些微服务组件。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2020/11/07/02%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/07/02%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" class="post-title-link" itemprop="url">微服务技术-分布式事务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-07 00:00:00" itemprop="dateCreated datePublished" datetime="2020-11-07T00:00:00+08:00">2020-11-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​    分布式事务，是微服务架构下的一个重要话题，许多场景中，我们都追求业务的一致性，业务的一致性，其实本质上是数据的一致性。</p>
<h1 id="微服务事务"><a href="#微服务事务" class="headerlink" title="微服务事务"></a>微服务事务</h1><p>​    传统的单体架构下，我们借助于数据库本地事务，来解决同一数据库下，不同表数据操作的一致性。微服务架构下，我们将服务拆分成了多个服务实例，将数据库分库分表，这导致我们在一次业务流程中，可能会涉及到多个数据库的数据修改，我们需要借助分布式事务来达到业务一致性这个目的。</p>
<h2 id="XA"><a href="#XA" class="headerlink" title="XA"></a>XA</h2><p>​    两阶段提交，顾名思义整个分布式事务分为两个阶段：</p>
<p>​        第一阶段：分布式事务发起者，需要分别与分布式事务的参与者协商，是否可以进行分布式事务中的数据修改。分布式事务的参与者首先完成本地资源的锁定，同时记录undo、redo日志，然后根据执行情况，返回对应的信息给分布式事务发起者。</p>
<p>​        第二阶段：分布式事务发起者收集返回信息，决定分布式事务Commit or Rollback。    </p>
<p>​    2PC要求，在第一阶段，分布式参与者，如果回复yes，那么在第二阶段必须要能Commit。</p>
<p>​    可以看出XA在执行事务的过程中，需要对使用到的所有资源进行锁定，直到事务执行结束，适合于并发量小的，短分布式事务。</p>
<h2 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h2><p>​    TCC将分布式事务的一致性交由业务（分布式事务发起者）来处理，通过调用分布式事务参与者提供的Try、Confirm、Cancel三个接口，来实现数据一致性。</p>
<p>​        Try：完成业务检查，预留数据资源；                 #这一阶段，可以认为已经在数据库将数据进行了修改并提交，将资源划给了业务。</p>
<p>​        Confirm：执行业务逻辑，直接使用Try预留的资源；</p>
<p>​        Cancel：释放Try阶段预留的资源。</p>
<p>​    TCC属于柔性事务，通过预留资源的方式，不需要对资源加锁。但是对业务的侵入性较大，改造成本高。</p>
<h2 id="SAGA"><a href="#SAGA" class="headerlink" title="SAGA"></a>SAGA</h2><p>​    Saga，使用的是异步补偿机制，业务在提供资源的同时，必须提供幂等的补偿方法，属于柔性事务。适合追求最终一致性的高并发长分布式事务。</p>
<h1 id="Seata解决方案"><a href="#Seata解决方案" class="headerlink" title="Seata解决方案"></a>Seata解决方案</h1><p>​    seata提供了四种分布式事务的解决方案：AT、TCC、SAGA、XA。主要包括三个主要组件：</p>
<p>​        TM（Transaction Manager）：全局事务管理器，控制全局事务的边界，负责全局事务开启，全局事务提交/回滚。</p>
<p>​        RM（Resource Manager）：资源管理器，控制分支事务，分支注册，状态汇报，并接受事务协调器的指令，驱动本地事务的提交/回滚。</p>
<p>​        TC（Transaction Coordinate）：事务协调器，维护全局事务的状态，负责协调并驱动全局事务的提交/回滚。</p>
<p>​    <img src="seata-architecture.jpg" alt="seata-architecture"></p>
<p>​    因为TCC、SAGA本身都对开发代码有侵入性，本次方案暂不考虑，下面主要分析AT、XA两种模式。</p>
<h2 id="AT"><a href="#AT" class="headerlink" title="AT"></a>AT</h2><p>​    AT模式是一种无侵入的分布式事务解决方案。</p>
<p>（1）第一阶段：</p>
<p>​        通过设置对JDBC数据源的代理，用户定义的SQL，全部在这层代理中执行，在这层代理中，seata可以控制sql的回滚提交，并且可以利用本地数据库ACID特性，将业务sql和数据镜像（beforeImage和afterImage）组成回滚日志，统一提交和回滚，保证了任何业务的更新，一定会有对应的本地回滚日志。（RM）</p>
<p>​        在本地事务提交之前，RM会向TC注册本地分支，同时以数据的resourceId-tableName-rowPK作为锁的key申请数据的写锁。如果拿不到写锁，RM以重试+超时重复该过程。</p>
<p>​        完成本地事务后，RM会向TC汇报本地事务的执行情况（RM不向TM汇报执行情况，是因为存在TM可以在某个RM执行失败的情况下，强制发起提交）。并完成业务的RPC调用过程。</p>
<p>​        <img src="seata-at-1.jpg" alt="seata-at-1"></p>
<p>（2）第二阶段：</p>
<p>​        如果是全局提交，分支事务已经完成提交，立即释放全局事务申请的所有写锁，异步调用RM清理本地数据库的回滚日志。</p>
<p>​        <img src="seata-at-2-commit.jpg" alt="seata-at-2-commit"></p>
<p>​        如果是全局回滚，RM收到全局协调器发来的回滚请求，通过XID和BranchID找到对应的回滚日志，生成反向更新的sql，完成对数据的回滚，然后通知TC回滚完成。这时候TC才释放该分支事务相关的锁。</p>
<p>​        <img src="seata-at-2-rollback.jpg" alt="seata-at-2-rollback"></p>
<p>​        回滚失败的情况：如果分布式事务和本地事务同时对外开发接口，那么在分布式事务回滚之前，本地事务的接口，如果不验证在TC注册的锁，那么分布式事务回滚时就可能遇到数据不一致，无法通过回滚日志恢复，会抛出异常。</p>
<p>​        <strong>经测试发现：分布式事务未提交之前，已提交的本地事务的分支，如果此时分支系统提供了本地修改接口，如果通过本地修改接口修改了数据，会导致分布式事务回滚失败。需要在Service上追加@GlobalLock的注解，这样在本地修改接口修改数据时，会去探测分布式事务的锁，如果存在，本地修改抛出异常，修改失败。</strong></p>
<p>​        <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/87097525">参考链接</a></p>
<h2 id="XA-1"><a href="#XA-1" class="headerlink" title="XA"></a>XA</h2><p>​    XA模式利用事务资源（数据库）对XA协议的支持，以XA协议的机制来管理分支事务的一种事务模式。从编程模型上，XA模式和AT模式保持完全一致。</p>
<p>​    <img src="seata-datasource-proxy.png" alt="seata-dataspurce-proxy"></p>
<p>​    使用XA模式仅需要替换对应的dataSourceProxy，XA不需要undo_log的回滚日志记录表。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(&quot;dataSourceProxy&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">(DruidDataSource druidDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// DataSourceProxy for AT mode</span></span><br><span class="line">        <span class="comment">// return new DataSourceProxy(druidDataSource);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// DataSourceProxyXA for XA mode</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProxyXA(druidDataSource);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="AT-vs-XA"><a href="#AT-vs-XA" class="headerlink" title="AT vs XA"></a>AT vs XA</h2><p>​    本文使用seata-sample中的demo进行测试，<a target="_blank" rel="noopener" href="https://github.com/seata/seata-samples">传送门</a>，对比AT、XA两种模式在实际开发中的使用情况，建议采用AT模式。原因如下：</p>
<p>（1）XA模式，通过数据库本地XA协议实现，对性能影响严重，同时，目前的版本，会影响到本地接口方法的执行，报 failed to register xa branch null since GlobalTransactionNotExist:Response[ TransactionException[Could not found global transaction xid = null, may be has finished.] 的异常。</p>
<p>（2）AT模式，通过Seata-Server一端的数据存储，实现数据的行锁，不会有严重的性能损失，同时，如果应用需要同时提供本地接口方法和分布式接口方法，可以通过@GlobalLock，去侦测Seata-Server的行锁，达到数据修改统一互斥的目的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Shadow802</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">60</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shadow802</span>
</div>

<div class="powered-by">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <i class="fa fa-user-md"></i>
    <span id="busuanzi_container_site_uv">
        本站访客数:<span id="busuanzi_value_site_uv"></span>
    </span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_pv">
        本站访问量<span id="busuanzi_value_site_pv"></span>
    </span>
</div>
        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
