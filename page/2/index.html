<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shadow802.gitee.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Shadow802">
<meta property="og:url" content="https://shadow802.gitee.io/page/2/index.html">
<meta property="og:site_name" content="Shadow802">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Shadow802">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://shadow802.gitee.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Shadow802</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Shadow802</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2022/06/21/Linux%E8%BF%90%E7%BB%B4%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/21/Linux%E8%BF%90%E7%BB%B4%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">Linux运维常用命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-21 00:00:00" itemprop="dateCreated datePublished" datetime="2022-06-21T00:00:00+08:00">2022-06-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/" itemprop="url" rel="index"><span itemprop="name">运维实践</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>    在Linux运维过程中，经常需要排查服务器的异常情况，当服务器因某些不明原因down机或者不响应，或者监控告警系统提示服务器某些指标出现异常，往往需要登录到这些服务器上进行异常原因排查，这时就需要一些常规的命令快速定位问题的所在，因此熟悉这些命令的使用，快速读懂它们的输出就非常重要。</p>
<h1 id="常用方式"><a href="#常用方式" class="headerlink" title="常用方式"></a>常用方式</h1><p>    服务器一般有几个核心的指标比较重要，下面根据具体的指标，展开分析如何进行排查分析。</p>
<h2 id="实时查看"><a href="#实时查看" class="headerlink" title="实时查看"></a>实时查看</h2><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">top</span><br><span class="line"><span class="meta">#</span><span class="bash"> 按数字1可以展开每个cpu的情况</span></span><br><span class="line">vmstat</span><br></pre></td></tr></table></figure>

<h3 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -lh</span><br></pre></td></tr></table></figure>

<h3 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h3><h4 id="流量情况"><a href="#流量情况" class="headerlink" title="流量情况"></a>流量情况</h4><ol>
<li><p>iftop</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">man iftop</span><br><span class="line">iftop -n -i enp0s3</span><br></pre></td></tr></table></figure>

<p><img src="iftop-remark.png"></p>
</li>
<li><p>ifconfig</p>
</li>
<li><p>netlog</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt install nethogs</span><br><span class="line">man nethogs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以在主机上查看哪些进程占用带宽较多</span></span><br><span class="line">nethogs </span><br></pre></td></tr></table></figure>

<h4 id="Socket情况"><a href="#Socket情况" class="headerlink" title="Socket情况"></a>Socket情况</h4><p>    netstat/ss</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">man ss</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看TCP的连接数量</span></span><br><span class="line">ss  -tan|awk &#x27;NR&gt;1&#123;++S[$1]&#125;END&#123;for (a in S) print a,S[a]&#125;&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有TCP Socket，不加-a不显示listenning的TCP socket</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -l可以只显示listenning的socket</span></span><br><span class="line">ss -t -a</span><br><span class="line"><span class="meta">#</span><span class="bash"> 过滤某状态的TCP连接</span></span><br><span class="line">ss -tn -o state established</span><br></pre></td></tr></table></figure>

<h4 id="容器情况"><a href="#容器情况" class="headerlink" title="容器情况"></a>容器情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stat</span><br></pre></td></tr></table></figure>

<p><img src="docker-stats-introduction.png"></p>
<h3 id="Disk-I-O"><a href="#Disk-I-O" class="headerlink" title="Disk I/O"></a>Disk I/O</h3><ol>
<li> iotop</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> iotop 默认按照Tid显示，可加参数-P按照Pid显示</span></span><br><span class="line">iotop -P</span><br></pre></td></tr></table></figure>

<p><img src="iotop-introduction.png"></p>
<ol start="2">
<li>raid</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 软raid的查看方式</span></span></span><br><span class="line">fdisk -l</span><br><span class="line">cat /proc/scsi/scsi</span><br><span class="line">或</span><br><span class="line">cat /proc/mdstat</span><br><span class="line">cat /etc/mdadm.conf</span><br></pre></td></tr></table></figure>

<h3 id="File-System"><a href="#File-System" class="headerlink" title="File System"></a>File System</h3><h4 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h4><h5 id="系统级别"><a href="#系统级别" class="headerlink" title="系统级别"></a>系统级别</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sysctl -h</span><br><span class="line"><span class="meta">#</span><span class="bash"> 统计每个进程打开文件数，第二行是Pid，第一行是数量</span></span><br><span class="line">lsof -n|awk &#x27;&#123;print $2&#125;&#x27;|sort|uniq -c|sort -nr|more</span><br></pre></td></tr></table></figure>

<p><img src="system-file-limit.png"></p>
<blockquote>
<p>这里用官方文档解释一下file-nr、open-nr、file-max分别代表的意思</p>
</blockquote>
<p><img src="file-introduction.png"></p>
<p>    <a target="_blank" rel="noopener" href="https://docs.kernel.org/admin-guide/sysctl/fs.html">官方说明</a></p>
<h5 id="用户级别"><a href="#用户级别" class="headerlink" title="用户级别"></a>用户级别</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ulimit -h</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询单个用户进程打开文件数，后面加上数字可临时修改，对当前shell有效</span></span><br><span class="line">ulimit -n</span><br><span class="line"><span class="meta">#</span><span class="bash"> 永久设置，设置的格式内容可以参照/etc/security/limits.conf前面的描述</span>            </span><br><span class="line">vim /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br></pre></td></tr></table></figure>

<h4 id="inode"><a href="#inode" class="headerlink" title="inode"></a>inode</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> inode在文件系统初始化的时候通过-N 指定数量</span></span><br><span class="line">df -i /</span><br></pre></td></tr></table></figure>

<h4 id="磁盘分区及挂载、用量"><a href="#磁盘分区及挂载、用量" class="headerlink" title="磁盘分区及挂载、用量"></a>磁盘分区及挂载、用量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看磁盘情况</span></span><br><span class="line">fdisk -l</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看分区、挂载</span></span><br><span class="line">df</span><br><span class="line">lsblk</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看文件夹下用量，进入该文件夹</span></span><br><span class="line">du -sh .</span><br></pre></td></tr></table></figure>

<h3 id="Process-Thread"><a href="#Process-Thread" class="headerlink" title="Process/Thread"></a>Process/Thread</h3><ol>
<li>Pid</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 系统对Pid限制</span></span><br><span class="line">sysctl -a | grep</span><br><span class="line">ulimit -u</span><br><span class="line">vim /etc/security/limits.con </span><br><span class="line">*        hard    nproc           5000</span><br><span class="line">*        soft    nproc           5000</span><br></pre></td></tr></table></figure>

<p><img src="pid-limit.png"></p>
<blockquote>
<p> 在Linux操作系统中，线程和进程的数据结构是一样的，只不过线程是通过clone的方式创建的共享父进程的内存，而进程是通过fork产生的，拥有自己独立的内存。</p>
<p>pid_max代表的是独立内存的进程的最大数量</p>
<p>thread_max是代表的是共享内存的进程的最大数量</p>
</blockquote>
<ol start="2">
<li>进程数/线程数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看进程</span></span><br><span class="line">ps -ef</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看线程  -T     Show threads, possibly with SPID column.</span></span><br><span class="line">ps -eT</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>僵尸进程</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看zombie</span></span><br><span class="line">top</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者查看状态为Z的</span></span><br><span class="line">ps -ef | grep defunct</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如何处理僵尸进程</p>
<p>可以kill僵尸进程的父进程，这样僵尸进程就成为孤儿进程，会托管给init进程，init进程会清理僵尸进程</p>
</blockquote>
<h2 id="历史记录"><a href="#历史记录" class="headerlink" title="历史记录"></a>历史记录</h2><h3 id="sysstat"><a href="#sysstat" class="headerlink" title="sysstat"></a>sysstat</h3><p>    sysstat服务启动以后，每十分钟收集一次系统系统状态信息（定时任务：cat /etc/cron.d/sysstat），数据记录在/var/log/sa目录下。配置文件在/etc/sysconfig/sysstat。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">man sar</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看/var/<span class="built_in">log</span>/sa下的历史某天记录</span></span><br><span class="line">cd /var/log/sa</span><br><span class="line">ll -al</span><br><span class="line"><span class="meta">#</span><span class="bash"> sadd是二进制文件，可通过如下命令查看；sardd是文本文件，可以直接查看</span></span><br><span class="line">sar -f sa   </span><br></pre></td></tr></table></figure>

<h3 id="系统日志"><a href="#系统日志" class="headerlink" title="系统日志"></a>系统日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">man journalctl</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内核日志</span></span><br><span class="line">journalctl -k</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看上一次的启动日志</span></span><br><span class="line">journalctl -b -1</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2022/06/19/K8s%E9%9B%86%E7%BE%A4%E8%BF%90%E7%BB%B4%E6%9D%82%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/19/K8s%E9%9B%86%E7%BE%A4%E8%BF%90%E7%BB%B4%E6%9D%82%E8%AE%B0/" class="post-title-link" itemprop="url">K8s集群运维杂记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-19 00:00:00" itemprop="dateCreated datePublished" datetime="2022-06-19T00:00:00+08:00">2022-06-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/" itemprop="url" rel="index"><span itemprop="name">运维实践</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>    最近在进行K8s运维时，遇到一些问题，特此记录，以备忘。</p>
<h1 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h1><h2 id="负载均衡选择"><a href="#负载均衡选择" class="headerlink" title="负载均衡选择"></a>负载均衡选择</h2><p>    我们在原生集群中，集成了Nginx Ingress Controller，并使用了公有云上的CLB进行转发。从CLB到K8s集群中的Nginx Controller实例，目前主流上如下三种连接方式：</p>
<h3 id="HostNetwork"><a href="#HostNetwork" class="headerlink" title="HostNetwork"></a>HostNetwork</h3><p>    让Nginx Controller直接使用节点的网络。</p>
<p>    这种方式的好处是效率高，CLB直接转发给节点，进协议栈，然后交给Nginx实例。</p>
<p>    缺点是需要固定集群中的一些节点最为CLB的后端，一旦需要扩缩容，则需要手动维护CLB的后端服务器列表。而且如果无法在单个节点上部署多套Nginx Controller，会有端口冲突的问题（不建议在命令行修改Nginx Controller默认的端口号，不利于维护）。</p>
<h3 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h3><p>    主流厂商的LoadBalancer Service都是通过NodePort的方式实现的。优点是厂商一般都提供了LoadBalancer Service自动创建（绑定已创建）CLB的方式，CLB的后端无需手工维护，可以自动配置。</p>
<p>    缺点是，首先通过NodePort这种方式会导致网络通信链路变长，CLB转发给NodePort后需要在协议栈中再次进行转发，或是转发给同节点的Pod网络命名空间，或是跨节点转发给Nginx Controller实例。如果需要保留客户端IP需要设置externalTrafficPolicy=local，这样虽然保留住了客户端IP。但是如果在没有Nginx Controller的节点上访问CLB，会访问不通。究其原因，是因为LoadBalancer Service的ExternalName会写上CLB的IP，然后IPVS会在本机设置到CLB这个IP的转发地址，而Service的externalTrafficPolicy=local允许转发给本机的Nginx Controller。这些问题导致该方案无法使用。</p>
<h3 id="ENI"><a href="#ENI" class="headerlink" title="ENI"></a>ENI</h3><p>    这种方式对Pod的网络模型有要求，Pod的CIDR必须使用VPC中的子网。节点上会为Pod单独绑定弹性网卡，设置IP。</p>
<p>    Pod相当于与集群中的节点是对等的关系，在一个扁平网络里。这种方式SLB可以想转发给VPC中节点一样，直接将数据转发给Pod。</p>
<p>    这种方式Pod的IP从VPC的子网中直接分配，可能会有IP不足的问题。不同公有云厂商也有一些其他限制（例如必须使用公有云提供的操作系统内核）。具体情况需要参照公有云厂商的文档，这里不再详述。</p>
<h2 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h2><p>    最近搭建了一个海外的K8s集群，集群中部署了Prometheus，公司内网这边需要读取集群中的监控数据，海外集群和公司内网目前通过IPSec进行连接，延迟大约在200+ms。我们的proxy prometheus连接了许多prometheus，应用查询时需要遍历所有的prometheus，因此不能将高延迟的promethues放到proxy上，否则会拖慢所有相关查询的速度。</p>
<h3 id="Remote-Storage"><a href="#Remote-Storage" class="headerlink" title="Remote Storage"></a>Remote Storage</h3><p>    为了解决Prometheus历史数据持久化的问题，Prometheus定义了两个标准的接口remote write/remote read，用户可以基于这两个接口将数据保存到任意第三方的存储服务中，这种方式被称为Remote Storage。</p>
<h4 id="Remote-Write"><a href="#Remote-Write" class="headerlink" title="Remote Write"></a>Remote Write</h4><p>    Prometheus内置了Remote Write的实现，只要在服务端的Prometheus启动命令行加入如下参数，即可开启。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--web.enable-remote-write-receiver    # 默认的写入端点是：&#x2F;api&#x2F;v1&#x2F;write</span><br></pre></td></tr></table></figure>

<p>    然后在客户端的Prometheus的配置文件中，加入写入的端点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">remote_write:</span><br><span class="line">- url: http:&#x2F;&#x2F;xx.xxx.xx.xxx:9090&#x2F;api&#x2F;v1&#x2F;write</span><br><span class="line">  remote_timeout: 30s</span><br></pre></td></tr></table></figure>

<p>    客户端的Prometheus会启动一个队列，从wal中读取样本数据，然后写入内存中分片所属的队列，然后请求远程写入端点，发送数据。</p>
<p>  </p>
<blockquote>
<p>不影响客户端Prometheus本地数据的保存，会在远程端点额外保存一份。</p>
</blockquote>
<h4 id="Remote-Read"><a href="#Remote-Read" class="headerlink" title="Remote Read"></a>Remote Read</h4><p>    支持从第三方存储中读取Promethues数据（通过一个adapter服务将第三方存储的数据协议转换为Prometheus的标准数据协议，可自定义），当然也可以从另一个Prometheus中读取数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">remote_read:</span><br><span class="line">  - read_recent: true</span><br><span class="line">    remote_timeout: 30s</span><br><span class="line">    url: http:&#x2F;&#x2F;xx.xx.xx.xx:9090&#x2F;api&#x2F;v1&#x2F;read</span><br></pre></td></tr></table></figure>

<p>    远程读取会从远端服务中获取原始样本数据，然后在本地进行计算。</p>
<h2 id="Node-Maintain"><a href="#Node-Maintain" class="headerlink" title="Node Maintain"></a>Node Maintain</h2><p>    最近接到需求，需要对生产集群部分节点进行下线处理，首先根据资源的情况，确定的部分节点，接下来要对节点上的业务负载进行处理，并退订该部分节点。</p>
<h3 id="Cordon"><a href="#Cordon" class="headerlink" title="Cordon"></a>Cordon</h3><p>    对节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cordon kind-worker      # 使用kubectl uncordon kind-worker解除</span><br></pre></td></tr></table></figure>

<p>    查看Node，发现在taints中增加了一行，标明不再接受新调度的Pod。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Taints:             node.kubernetes.io&#x2F;unschedulable:NoSchedule</span><br></pre></td></tr></table></figure>

<h3 id="Drain"><a href="#Drain" class="headerlink" title="Drain"></a>Drain</h3><p>    使用drain命令，会对当前节点上的Pod进行Evicted。无法驱逐使用了local-path的Pod和Daemonset（可使用–ignore-daemonsets忽略）。</p>
<p>    drain并不能保证应用的可用性，如果需要保证服务不中断，服务质量不受影响，需要结合PodDisruptionBudget。</p>
<h3 id="PodDisruptionBudget"><a href="#PodDisruptionBudget" class="headerlink" title="PodDisruptionBudget"></a>PodDisruptionBudget</h3><p>    PDB可以设置最大不可用副本数和最小可用副本数，一旦drain操作进行时，被驱逐的工作负载的副本，违反PDB中设置的规则，drain将会报错，无法进行下去，直到满足PDB。</p>
<h3 id="实践验证"><a href="#实践验证" class="headerlink" title="实践验证"></a>实践验证</h3><p>    受限于电脑资源，使用kind创建了一个两个节点的K8s集群，并去除调了Master节点不能调度Pod的taints。</p>
<p>    部署一个httpbin的deployment，设置副本数为1。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: httpbin</span><br><span class="line">      version: v1</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: httpbin</span><br><span class="line">        version: v1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: httpbin</span><br><span class="line">        image: xxx.xxx.xxx&#x2F;release&#x2F;httpbin</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 80</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: http</span><br><span class="line">          protocol: TCP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: httpbin</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: http</span><br><span class="line">  selector:</span><br><span class="line">    app: httpbin</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure>

<p>    查看集群Pod的状态，并通过curl验证Pod访问正常。</p>
<p><img src="curl-httpbin.png" alt="curl-httpbin.png"></p>
<p>    执行kubectl drain kind-control-pane：</p>
<p><img src="drain-node.png" alt="drain-node.png"></p>
<p>    在drain执行的过程中，curl httpbin服务。发现中间出现了服务中断：</p>
<p><img src="curl-httpbin-error.png" alt="curl-httpbin-error.png"></p>
<p>    watch Pod的日志，发现新创建的Pod尚未Ready，就已经被停止。</p>
<p><img src="drain-httpbin-log.png" alt="drain-httpbin-log.png"></p>
<p>   这与我们的要求相违背，加上PDB再次进行实验：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: policy&#x2F;v1</span><br><span class="line">kind: PodDisruptionBudget</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  minAvailable: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: httpbin</span><br></pre></td></tr></table></figure>

<p>    发现PDB阻止了drain对Pod进行Evicted。也就是说PDB可以防止drain进行误操作，破坏业务为应用副本制定的规则，从而保障了节点维护时，不会影响服务质量，发生服务中断这样的生产问题。</p>
<p><img src="pdb-drain.png" alt="pdb-drain.png"></p>
<p>    因此，为了能Evicted要维护节点上的Pod，可以修改Deployment的副本数，扩大到2，让其他节点上有httpbin的Ready实例，drain就能顺利执行。</p>
<h2 id="Zookeeper启动异常"><a href="#Zookeeper启动异常" class="headerlink" title="Zookeeper启动异常"></a>Zookeeper启动异常</h2><p>    K8s集群Pod间网络不通，strimzi-kafka-operator启动zookeeper时，日志报NullPointerExecption。从日志上一点也看不出来是网路不通的原因。</p>
<h2 id="Iptables"><a href="#Iptables" class="headerlink" title="Iptables"></a>Iptables</h2><p>    部署Drone的plugins/docker时，在镜像中通过如下命令连接宿主机sock时，会报Iptables命令无法设置，或者是不存在iptables，提示通过insmod安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dockerd --data-root &#x2F;var&#x2F;lib&#x2F;docker --host&#x3D;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock</span><br></pre></td></tr></table></figure>

<p>    后经多番尝试可通过添加–iptables=false测试启动成功。查看宿主机和镜像中的iptables版本iptables v1.8.4 (nf_tables)和iptables v1.8.3 (legacy)。</p>
<p>    目前Linux的iptables有了nf-tables这种全新的实现，改进了原来的内核api，无法与原先的版本兼容。后通过在主机中加载ip_tables模块得以解决。目前宿主机中同时存在nf_tables和legacy的iptables，目前尚未发现问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modprobe ip_tables</span><br></pre></td></tr></table></figure>

<h2 id="负载均衡内网回环"><a href="#负载均衡内网回环" class="headerlink" title="负载均衡内网回环"></a>负载均衡内网回环</h2><p>    使用公有云CLB+集群Nginx Ingress进行负载均衡时，会遇到内网负载均衡网络回环的问题，分一下几种情况：</p>
<p>    （1）公网CLB，CLB指向的后端服务节点以及其上面的Pod访问公网负载均衡地址，不会出现回环问题，因为从服务节点出去的流量会nat成公网的地址，再转发给CLB时，CLB转发给后端服务节点，后端服务节点无法识别到自己的公网地址，所以通信正常。</p>
<p>    （2）内网CLB，CLB指向的后端服务节点以及器上面的Pod访问内网负载均衡地址，源IP为该服务器的地址，如果CLB只有这一个后端，转发给服务节点后，服务节点会发现源IP和目的IP是一样的，因此会在服务器内部回环。如果存在多个后端，那么如果转发给其他服务节点，通信正常，如果转发给这个服务节点，会失败，七层CLB会重试，就会出现延迟比较高的情况。</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/457/61737#.E4.B8.BA.E4.BB.80.E4.B9.88.E5.85.AC.E7.BD.91-clb-.E4.B8.8D.E5.AD.98.E5.9C.A8.E5.9B.9E.E7.8E.AF.E9.97.AE.E9.A2.98.EF.BC.9F">容器服务 CLB 回环问题 - 故障处理 - 文档中心 - 腾讯云</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2022/04/05/tcpdump%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/05/tcpdump%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">tcpdump抓包分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-05 00:00:00" itemprop="dateCreated datePublished" datetime="2022-04-05T00:00:00+08:00">2022-04-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/" itemprop="url" rel="index"><span itemprop="name">运维实践</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>    在实际生产网络问题排查时，经常因为搞不清楚网络拓扑结构，而不清楚网络不通的原因，tcpdump是一个很好的抓包工具，配合Wireshark进行转包分析，但因为生产服务器的安全性管控，下载tcpdump抓取的.pcap文件不是很方便，因此需要简单看懂tcpdump的抓包输出。</p>
<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><p>    在Linux环境下，可以通过man tcpdump查看使用命令以及过滤参数，下面是一段使用tcpdump抓取的curl访问记录。</p>
<p>    curl命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl httpbin.xxx.net:31012&#x2F;get</span><br></pre></td></tr></table></figure>

<p>    tcpdump抓取如下：</p>
<p><img src="curl-tcpdump.png" alt="curl-tcpdump.png"></p>
<p>    再次进行相同的抓取使用-w 抓取到pcap文件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i enp0s3 host xx.xxx.xxx.xx and port 31012 -w curl.pcap</span><br></pre></td></tr></table></figure>

<p>    使用Wireshark打开记录如下：</p>
<p><img src="curl-tcpdump-wireshark.png" alt="curl-tcpdump-wireshark.png"></p>
<p>    可以比照上下两幅图的记录，根据Wireshark的解析，理解tcpdump的输出记录。</p>
<h2 id="FLags标记"><a href="#FLags标记" class="headerlink" title="FLags标记"></a>FLags标记</h2><p>    在上图中，可以看到抓到的几条数据的Flags字段各不相同，标识含义：</p>
<ul>
<li>[S]：SYN同步标识，TCP三次握手连接建立的发起方。</li>
<li>[.]：表示ACK确认标识。</li>
<li>[S.]：SYN同步标识+确认[S]的ACK。</li>
<li>[P.]：PSH，push推送，数据传输。</li>
<li>[R.]：RST，连接重置。</li>
<li>[F.]：FIN结束连接。</li>
<li>[DF]：Don’t Fragment（不分片）。当DF=0，表示允许分片，一般-v时才有这个标识。</li>
<li>[FP.]：标记FIN、PUSH、ACK组合，这样做是为了提升网络效率，减少数据来回确认。</li>
</ul>
<h2 id="SYN-ACK-SEQ"><a href="#SYN-ACK-SEQ" class="headerlink" title="SYN ACK SEQ"></a>SYN ACK SEQ</h2><p>    ACK=SYN SEQ + 1</p>
<h1 id="典型案例"><a href="#典型案例" class="headerlink" title="典型案例"></a>典型案例</h1><h2 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h2><p>    开发人员在K8s集群某个Pod中连接外部服务，发现网络不通。重新启动一个Pod访问，又是可以通信的。</p>
<h2 id="问题处理"><a href="#问题处理" class="headerlink" title="问题处理"></a>问题处理</h2><p>    我们知道，Pod的网络通过veth pair对，会经由宿主机网络然后往外出访问，首先测试了Pod所在的节点到外部服务的连通性，发现是通的。检查veth pair对的虚拟网卡，也没有发现任何异常，Pod与主机通信并无异常。</p>
<h3 id="抓包分析"><a href="#抓包分析" class="headerlink" title="抓包分析"></a>抓包分析</h3><p>    通过在Pod中抓取发往服务器端的包，发现所有的SYN都没有ACK回应，也就是说服务器端没有给会ACK。为什么服务器端没有给回ACK呢，通过Google搜索，发现有提到net.ipv4.tcp_timestamps和net.ipv4.tcp_tw_recycle同时启用的问题。</p>
<ol>
<li><p>开启net.ipv4.tcp_tw_recycle的问题</p>
<p>当网络中客户端存在SNAT的时候，开启net.ipv4.tcp_tw_recycle和net.ipv4.tcp_timestamps，客户端的SYN报文可能会被drop调。因为客户端进行了SNAT后，对服务器而言，多个客户端是通过同一个IP来连接服务器端的（看不到实际客户端的IP）。这个时候timestamp较小的SYN报文就会被服务器drop，因为服务器认为同一个IP的服务器发送的报文是的单调递增的，不可能收到比之前报文时间戳还小的报文。</p>
</li>
<li><p>为什么要开启net.ipv4.tcp_tw_recycle</p>
<p>开启net.ipv4.tcp_tw_recycle为了减少TIME_WAIT状态的socket连接，从而减少内存、cpu使用。</p>
<p>在没有开启net.ipv4.tcp_tw_recycle的时候，如果服务器先关闭连接，socket会停留来TIME_WAIT的状态，直到1个TCP_PAWS_MSL的时间，在此期间，客户端不能使用刚刚使用过的源端口号，否则服务器会直接RST。</p>
</li>
</ol>
<blockquote>
<p>可以通过netstat -s 查看服务端对于包处理的统计，可以看到大量被drop的package</p>
</blockquote>
<h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><p>    可以看到，在比较低版本的内核说明（man tcp）中，是不建议开启net.ipv4.tcp_tw_recycle的。</p>
<p><img src="man-tcp.png" alt="man-tcp.png"></p>
<p>    而比较新的内核版本已经去除了该参数的配置说明。因此关闭该内核参数后，服务访问正常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.ipv4.tcp_tw_recycle&#x3D;0  # 立即生效</span><br><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;sysctl.conf  # 修改该参数值，永久生效。</span><br></pre></td></tr></table></figure>

<p> </p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://ieevee.com/tech/2017/07/19/tcp-tw-recycle.html">不要开启tcp_tw_recycle</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2022/03/12/BPF-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/12/BPF-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">eBPF-基础知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-12 00:00:00" itemprop="dateCreated datePublished" datetime="2022-03-12T00:00:00+08:00">2022-03-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/eBPF/" itemprop="url" rel="index"><span itemprop="name">eBPF</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><pre><code>eBPF已经成为时下最为火热的技术之一，在保证安全的情况下，通过在内核中嵌入用户自定义代码，干涉内核的行为，使内核变为可编程，在安全、网络、跟踪&amp;性能分析、观测&amp;监控等场景中发挥着巨大的作用。
本文属于新手入门eBPF编程，通过一些基础概念和Demo演示，从初学者角度理解eBPF的实现原理和使用方式。
</code></pre>
<h1 id="新手上路"><a href="#新手上路" class="headerlink" title="新手上路"></a>新手上路</h1><h2 id="eBPF"><a href="#eBPF" class="headerlink" title="eBPF"></a>eBPF</h2><p><img src="c-libbpf-ebpf.png" alt="c-libbpf-ebpf"></p>
<pre><code>上图是[eBPF官网使用](https://ebpf.io/what-is-ebpf)C语言，借助libbpf进行eBPF的工作流程，其中的C/C++ libbpf library也可换成BCC、Go library等，这些只是用户侧编程借助的工具不同，不影响整体流程。

下面就其中的一些基础概念，名字术语加以说明。
</code></pre>
<h3 id="名词术语"><a href="#名词术语" class="headerlink" title="名词术语"></a>名词术语</h3><h4 id="LLVM-Clang"><a href="#LLVM-Clang" class="headerlink" title="LLVM/Clang"></a>LLVM/Clang</h4><pre><code>LLVM是&quot;Low Level Virtual Machine&quot;的简称。这个库提供了与编译器相关的支持，能够进行程序语言的编译期优化、链接优化、在线编译优化、代码生成。可以作为多种语言编译器的后台来使用。

Clang是一个C++编写的基于LLVM、发布于LLVM BSD许可证下的C／C++／Object-C／Object-C++ 编译器。

Clang是Apple公司用以取代GCC对C/C++/Object-C的编译的。
</code></pre>
<h4 id="Bytecode"><a href="#Bytecode" class="headerlink" title="Bytecode"></a>Bytecode</h4><pre><code>eBPF内核态程序需要通过clang/llvm编译成该类型文件，然后通过系统调用加载进内核虚拟机中执行。注意传统的GCC不支持生成eBPF的bytecode。
</code></pre>
<h4 id="Verifier"><a href="#Verifier" class="headerlink" title="Verifier"></a>Verifier</h4><pre><code>对eBPF的bytecode进行安全检查，防止出现危及内核的程序操作。因此编写eBPF程序也有一些限制，例如循环限制等。
</code></pre>
<h4 id="JIT（Just-In-Time）"><a href="#JIT（Just-In-Time）" class="headerlink" title="JIT（Just In Time）"></a>JIT（Just In Time）</h4><pre><code>即时编译器，在内核的虚拟机中解析执行eBPF的bytecode。

大部分的操作系统架构都内置了eBPF的JIT，可通过如下方式打开：
</code></pre>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/core/bpf_jit_enable</span><br></pre></td></tr></table></figure>

<h3 id="编程基础"><a href="#编程基础" class="headerlink" title="编程基础"></a>编程基础</h3><h4 id="SEC"><a href="#SEC" class="headerlink" title="SEC"></a>SEC</h4><pre><code>一个简单的BPF程序，包括如下几个部分：
</code></pre>
<ol>
<li><p>程序附着的hook点，一般包括：程序类型/具体附着的函数（例如：tracepoint/syscalls/sys_enter_execve）。</p>
</li>
<li><p>可能需要保存状态（多次BPF调用、用户态程序通过文件描述符）的数据结构。</p>
</li>
<li><p>内核允许的License，否则内核会拒绝加载。</p>
<p> 这三部分都是通过关键字SEC在程序中声明的。</p>
</li>
</ol>
<h5 id="程序类型"><a href="#程序类型" class="headerlink" title="程序类型"></a>程序类型</h5><pre><code>比较常见的重要的类型如下：

（1）Kprobe，通过注册Kprobe的方式，将程序插入到指定内核函数的前后。

（2）Tracepoint，attach到内核预定义好的tracepoint上。

（3）Socket Filter，attach到Socket上，可以定制化被Socket处理的数据包的网络流量处理逻辑。

（4）XDP，在网络数据包刚刚到达内核时，进行处理。

还有一些其它的类型，在ubuntu，可通过查看/usr/src/linux-headers-5.13.0-30-generic/include/uapi/linux/bpf.h，查找关键字 bpf_prog_type：
</code></pre>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Note that tracing related programs such as</span></span><br><span class="line"><span class="comment"> * BPF_PROG_TYPE_&#123;KPROBE,TRACEPOINT,PERF_EVENT,RAW_TRACEPOINT&#125;</span></span><br><span class="line"><span class="comment"> * are not subject to a stable API since kernel internal data</span></span><br><span class="line"><span class="comment"> * structures can change from release to release and may</span></span><br><span class="line"><span class="comment"> * therefore break existing tracing BPF programs. Tracing BPF</span></span><br><span class="line"><span class="comment"> * programs correspond to /a/ specific kernel which is to be</span></span><br><span class="line"><span class="comment"> * analyzed, and not /a/ specific kernel /and/ all future ones.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_prog_type</span> &#123;</span></span><br><span class="line">        BPF_PROG_TYPE_UNSPEC,</span><br><span class="line">        BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">        BPF_PROG_TYPE_KPROBE,</span><br><span class="line">        BPF_PROG_TYPE_SCHED_CLS,</span><br><span class="line">        BPF_PROG_TYPE_SCHED_ACT,</span><br><span class="line">        BPF_PROG_TYPE_TRACEPOINT,</span><br><span class="line">        BPF_PROG_TYPE_XDP,</span><br><span class="line">        BPF_PROG_TYPE_PERF_EVENT,</span><br><span class="line">        BPF_PROG_TYPE_CGROUP_SKB,</span><br><span class="line">        BPF_PROG_TYPE_CGROUP_SOCK,</span><br><span class="line">        BPF_PROG_TYPE_LWT_IN,</span><br><span class="line">        BPF_PROG_TYPE_LWT_OUT,</span><br><span class="line">        BPF_PROG_TYPE_LWT_XMIT,</span><br><span class="line">        BPF_PROG_TYPE_SOCK_OPS,</span><br><span class="line">        BPF_PROG_TYPE_SK_SKB,</span><br><span class="line">        BPF_PROG_TYPE_CGROUP_DEVICE,</span><br><span class="line">        BPF_PROG_TYPE_SK_MSG,</span><br><span class="line">        BPF_PROG_TYPE_RAW_TRACEPOINT,</span><br><span class="line">        BPF_PROG_TYPE_CGROUP_SOCK_ADDR,</span><br><span class="line">        BPF_PROG_TYPE_LWT_SEG6LOCAL,</span><br><span class="line">        BPF_PROG_TYPE_LIRC_MODE2,</span><br><span class="line">        BPF_PROG_TYPE_SK_REUSEPORT,</span><br><span class="line">        BPF_PROG_TYPE_FLOW_DISSECTOR,</span><br><span class="line">        BPF_PROG_TYPE_CGROUP_SYSCTL,</span><br><span class="line">        BPF_PROG_TYPE_RAW_TRACEPOINT_WRITABLE,</span><br><span class="line">        BPF_PROG_TYPE_CGROUP_SOCKOPT,</span><br><span class="line">        BPF_PROG_TYPE_TRACING,</span><br><span class="line">        BPF_PROG_TYPE_STRUCT_OPS,</span><br><span class="line">        BPF_PROG_TYPE_EXT,</span><br><span class="line">        BPF_PROG_TYPE_LSM,</span><br><span class="line">        BPF_PROG_TYPE_SK_LOOKUP,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="映射类型"><a href="#映射类型" class="headerlink" title="映射类型"></a>映射类型</h5><pre><code>单个BPF程序最多可直接访问64个不同map。map的实现由核心内核提供，有per-CPU、non-per=CPU的通用map，可以使用一组通用的BPF赋值函数来进行维护操作。也有非通用map，针对特定的问题，需要在各次BPF程序调用之间保持额外的状态（非数据）。

在ubuntu，可通过查看/usr/src/linux-headers-5.13.0-30-generic/include/uapi/linux/bpf.h，查找关键字 bpf_map_type：
</code></pre>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_map_type</span> &#123;</span></span><br><span class="line">        BPF_MAP_TYPE_UNSPEC,</span><br><span class="line">        BPF_MAP_TYPE_HASH,</span><br><span class="line">        BPF_MAP_TYPE_ARRAY,</span><br><span class="line">        BPF_MAP_TYPE_PROG_ARRAY,</span><br><span class="line">        BPF_MAP_TYPE_PERF_EVENT_ARRAY,</span><br><span class="line">        BPF_MAP_TYPE_PERCPU_HASH,</span><br><span class="line">        BPF_MAP_TYPE_PERCPU_ARRAY,</span><br><span class="line">        BPF_MAP_TYPE_STACK_TRACE,</span><br><span class="line">        BPF_MAP_TYPE_CGROUP_ARRAY,</span><br><span class="line">        BPF_MAP_TYPE_LRU_HASH,</span><br><span class="line">        BPF_MAP_TYPE_LRU_PERCPU_HASH,</span><br><span class="line">        BPF_MAP_TYPE_LPM_TRIE,</span><br><span class="line">        BPF_MAP_TYPE_ARRAY_OF_MAPS,</span><br><span class="line">        BPF_MAP_TYPE_HASH_OF_MAPS,</span><br><span class="line">        BPF_MAP_TYPE_DEVMAP,</span><br><span class="line">        BPF_MAP_TYPE_SOCKMAP,</span><br><span class="line">        BPF_MAP_TYPE_CPUMAP,</span><br><span class="line">        BPF_MAP_TYPE_XSKMAP,</span><br><span class="line">        BPF_MAP_TYPE_SOCKHASH,</span><br><span class="line">        BPF_MAP_TYPE_CGROUP_STORAGE,</span><br><span class="line">        BPF_MAP_TYPE_REUSEPORT_SOCKARRAY,</span><br><span class="line">        BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE,</span><br><span class="line">        BPF_MAP_TYPE_QUEUE,</span><br><span class="line">        BPF_MAP_TYPE_STACK,</span><br><span class="line">        BPF_MAP_TYPE_SK_STORAGE,</span><br><span class="line">        BPF_MAP_TYPE_DEVMAP_HASH,</span><br><span class="line">        BPF_MAP_TYPE_STRUCT_OPS,</span><br><span class="line">        BPF_MAP_TYPE_RINGBUF,</span><br><span class="line">        BPF_MAP_TYPE_INODE_STORAGE,</span><br><span class="line">        BPF_MAP_TYPE_TASK_STORAGE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="license"><a href="#license" class="headerlink" title="license"></a>license</h5><pre><code>由于Linux内核是根据GPL许可的，因此它也只能加载以GPL许可的程序。
</code></pre>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> _license[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;GPL&quot;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="Helper-Functions"><a href="#Helper-Functions" class="headerlink" title="Helper Functions"></a>Helper Functions</h4><pre><code>辅助函数是内核提供的，能够让BPF程序从内核中查询数据，或者将数据推送到内核。不同BPF程序能够使用的辅助函数可能是不同的。

编写程序时，通过[bpf_helpers.h](https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md#program-types)引入辅助函数。
</code></pre>
<h4 id="Object-Pinning"><a href="#Object-Pinning" class="headerlink" title="Object Pinning"></a>Object Pinning</h4><pre><code>BPF map和程序作为内核资源只能通过文件描述符访问，其背后是内核匿名的inode。然而，文件描述符受限于进程的生命周期，使得map共享之类的操作非常笨重。

为了解决这个问题，内核实现了一个最小内核空间BPF文件系统。BPF map和BPF程序都可以钉到这个文件系统内。
</code></pre>
<p><img src="epbf-fs-pin.png" alt="epbf-fs-pin"></p>
<h4 id="Tail-Calls"><a href="#Tail-Calls" class="headerlink" title="Tail Calls"></a>Tail Calls</h4><pre><code>尾调用，一个BPF程序可以调用另一个BPF程序，并且调用完成后不用返回原来的程序（**bpf_tail_call()**）。

类型相同的BPF程序才可以进行尾调用。
</code></pre>
<h4 id="BPF-to-BPF-Calls"><a href="#BPF-to-BPF-Calls" class="headerlink" title="BPF to BPF Calls"></a>BPF to BPF Calls</h4><blockquote>
<p>以上主要参考<a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/bpf/">Cilium官网说明</a></p>
<p>受限于英语水平，可参考<a target="_blank" rel="noopener" href="https://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/">翻译版(版本1.10)</a></p>
</blockquote>
<h3 id="编程工具"><a href="#编程工具" class="headerlink" title="编程工具"></a>编程工具</h3><pre><code>利用eBPF编写生产可用的程序，一般包含三部分：

（1）eBPF程序，编译成bytecode的字节码。

（2）loader程序，负责通过bpf()的系统调用，将bytecode加载至内核中具体的hook点。

（3）用户空间程序，负责与eBPF的某些数据结构（Maps、Global）交互，读写数据。

此外，因为一些eBPF会读取内核中的数据结构（task_struct、skb等）来获取数据信息，因此需要依赖Linux内核的一些header定义。而不同Linux内核版本的header会发生改变，因此会导致编译好的eBPF程序只能在当前编译的宿主机上的内核版本下正常运行，缺乏对其他内核版本的兼容性，严重影响eBPF程序的分发部署。开发者也不可能为每次内核变动都编译相应的版本。

因此，需要一些开发者工具库，简化eBPF的开发过程，将所有程序打包成一个ELF文件，同时兼容多个Linux内核版本，支持CO-RE（Compile Once, Run Everywhere）。
</code></pre>
<blockquote>
<p>很多前端工具，例如 bcc、perf、iproute2，都可以将 BPF 程序加载到内核。</p>
</blockquote>
<h4 id="BCC"><a href="#BCC" class="headerlink" title="BCC"></a>BCC</h4><p><img src="bcc-bpf-tools.webp" alt="bcc-bpf-tools"></p>
<pre><code>BCC全称&quot;BPF Compiler Collection&quot;，为了便于eBPF的开发和使用，libbcc库中集成了clang/llvm编译器，让编译和运行处在同一节点上，但这样也带来了一些问题：

（1）运行BCC工具的节点上，必须安装内核头文件，以便于编译内核态eBPF代码。

（2）内置clang/llvm不仅占用磁盘，而且运行程序需要编译，启动时间长，会占用节点上的CPU和内存，这在生产环境中几乎是不可忍受的。
</code></pre>
<h4 id="Libbpf"><a href="#Libbpf" class="headerlink" title="Libbpf"></a>Libbpf</h4><pre><code>用户态BPF loader库。
</code></pre>
<h4 id="CO-RE"><a href="#CO-RE" class="headerlink" title="CO-RE"></a>CO-RE</h4><h5 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h5><pre><code>CO-RE是&quot;Compile Once - Run Everywhere&quot;的缩写。是用来解决eBPF程序适配多内核版本所遇到的问题的。

使用CO-RE编译出来的eBPF程序，可以在不同内核上运行。在Linux内核和eBPF程序之间，会通过BTF（BPF Type Format）来协调不同内核版本数据结构的变量偏移或者变量长度优化等问题。

eBPF程序include的一个vmlinux.h文件，这其中包含了所有的内核数据结构，它是由内核文件vmlinux（/sys/kernel/btf/vmlinux）的BTF信息转化而来。同时通过使用bpftool这个工具可以将eBPF编译成的.o文件重新生成一个C语言的头文件.skel.h，这个文件中定义了加载eBPF程序的函数，eBPF的bytecode也直接写在了这个文件中。用户态程序可以通过引用这个文件，调用里面自动生成eBPF加载函数。
</code></pre>
<h5 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h5><pre><code>首先检查eBPF的编译环境和运行环境的Linux内核必须支持并开启BTF的功能。
</code></pre>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /boot/config-5.13.0-30-generic | grep CONFIG_DEBUG_INFO_BTF</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 结果</span></span></span><br><span class="line">CONFIG_DEBUG_INFO_BTF=y</span><br><span class="line">CONFIG_DEBUG_INFO_BTF_MODULES=y</span><br></pre></td></tr></table></figure>

<pre><code>这里我们直接使用[libbpf-bootstrap](https://github.com/libbpf/libbpf-bootstrap) 这样项目进行实验，按照如下步骤：
</code></pre>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/libbpf/libbpf-bootstrap</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 安装对应内核版本的bpftool</span></span></span><br><span class="line">bpftool version</span><br><span class="line"><span class="meta">#</span><span class="bash"> 结果</span></span><br><span class="line">/usr/lib/linux-tools/5.13.0-30-generic/bpftool v5.13.19</span><br><span class="line">features:</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 生成vmlinux.h文件</span></span></span><br><span class="line">cd libbpf-bootstrap/vmlinux</span><br><span class="line">bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 编译bootstrap程序，先生成bootstrap.bpf.o文件, 再编译。可通过添加V=1查看make的详细步骤</span></span></span><br><span class="line">cd libbpf-bootstrap/examples/c</span><br><span class="line">clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I.output -I../../libbpf/include/uapi -I../../vmlinux/ -idirafter /usr/lib/llvm-15/lib/clang/15.0.0/include -idirafter /usr/local/include -idirafter /usr/include/x86_64-linux-gnu -idirafter /usr/include -c bootstrap.bpf.c -o .output/bootstrap.bpf.o</span><br><span class="line"></span><br><span class="line">make bootstrap</span><br></pre></td></tr></table></figure>

<pre><code>执行.bootstrap，远程登录系统，可以看到程序生效，输出一些内容，示意如下：
</code></pre>
<p><img src="bootstrap-ssh-login.png" alt="bootstrap-ssh-login"></p>
<blockquote>
<p>程序的具体内容，可通过查看源代码了解，这里不详作说明。</p>
</blockquote>
<h2 id="内核功能"><a href="#内核功能" class="headerlink" title="内核功能"></a>内核功能</h2><pre><code>eBPF程序需要附着在内核的hook点上执行相应的逻辑，内核通过各种各样的方式提供了许多hook附着点，下面就一些常用的主要的加以说明。了解Linux内核的这些功能，清楚它们常见的适用场景。
</code></pre>
<h3 id="功能说明"><a href="#功能说明" class="headerlink" title="功能说明"></a>功能说明</h3><h4 id="XDP"><a href="#XDP" class="headerlink" title="XDP"></a>XDP</h4><pre><code>XDP，是&quot;eXpress Data Path&quot;的缩写，主要有三种操作模式：
</code></pre>
<p>（1）原生XDP</p>
<pre><code>这是默认模式。在这种模式下，XDP BPF程序直接在**驱动**的接收路径上运行。使用此模式时，检查驱动程序是否支持它很重要。
</code></pre>
<p>（2）Offloaded XDP</p>
<pre><code>在这种模式下，允许将整个 BPF/XDP 程序 offload 到硬件，因此程序在网卡收到包时就直接在网卡进行处理，而不是在主机CPU上执行。通过将执行移出CPU，与本地XDP相比，此模式具有高性能的特点。
</code></pre>
<p>（3）通用XDP</p>
<pre><code>这是一种测试模式，用于给那些还没有原生支持 XDP 的驱动进行试验性测试，很少在生产上使用。

位于内核协议栈的主接收路径（main receive path）上，接受的是`skb` 格式的包，但由于这些 hook 位于 ingress 路径的很后面，因此与 native XDP 相比性能有明显下降。

iproute2同时支持以上三种模式。Cilium就是面向iproute2加载器实现的。
</code></pre>
<h4 id="Traffic-Control"><a href="#Traffic-Control" class="headerlink" title="Traffic Control"></a>Traffic Control</h4><pre><code>TC主要包括三个要素：队列规则（qdisc， Queue Disciplines）、类（Class）和过滤器（filter）。其中一个应用场景是模拟弱网环境。

TC在网卡设备的入口（ingress）流量的管控一般称为policing（流量策略），是可以进行丢弃，重定向的。这里一般是无法控制发送方的流量到达的。而在网卡设备的出口（egress）方向，则可以进行很多流量管控的措施，例如限制速率，按照优先级发送。一般的流量管控是指egress的方向，这里的流量管控称为shaping（流量整形）。

网卡发送数据包的排队规则（Queue Disciplines）：
</code></pre>
<ol>
<li><p>简单、不分类排队规则（Simple、classless qdisc）</p>
<ul>
<li><p>先入先出队列（pfifo_fast）</p>
<p>无法通过tc命令添加qdisc。依据数据包的TOS字段，内置了三个优先级队列。高优先级的队列数据发送完了，才发送低优先级的队列数据。</p>
<p><img src="tc-fifo.png" alt="tc-fifo">                               <img src="tc-fifio-fast.png" alt="tc-fifio-fast"></p>
</li>
<li><p>令牌桶过滤器（TBF，Token Bucket Filter）</p>
<p>基于令牌的速率限制。</p>
<p><img src="tc-tbf.png" alt="tc-tbf"></p>
</li>
<li><p>随机公平排队（SFQ，Stochastic Fairness Queueing）</p>
<p>可以保证不同的tcp session或者是udp的flow分配到不同的队列，不会发生独占的情况。</p>
<p><img src="tc-sfq.png" alt="tc-sfq"></p>
</li>
</ul>
</li>
<li><p>分类别的排队规则（Classful qdisc）</p>
<ul>
<li>优先级排队规则（PRIO qdisc）</li>
<li>基于类的排队规则（CBO qdisc， Class Base Queueing）</li>
<li>层级令牌桶（HTB， Hierarchical Token Bucket）</li>
</ul>
</li>
</ol>
<blockquote>
<p>参考资料</p>
<p><a target="_blank" rel="noopener" href="https://github.com/liucimin/Learning/blob/master/linux%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3/Linux-TC%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3.md"><strong>Linux-TC框架详解</strong></a></p>
<p><a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/lartc-qdisc-zh/#95-classful-qdisc%E5%88%86%E7%B1%BB%E5%88%AB%E6%8E%92%E9%98%9F%E8%A7%84%E5%88%99">[译] 《Linux 高级路由与流量控制手册（2012）》第九章：用 tc qdisc 管理 Linux 网络带宽</a></p>
</blockquote>
<h4 id="Trace-System"><a href="#Trace-System" class="headerlink" title="Trace System"></a>Trace System</h4><p><img src="trace-system-layers.webp" alt="trace-system-layers"></p>
<h5 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h5><h6 id="Tracepoint"><a href="#Tracepoint" class="headerlink" title="Tracepoint"></a>Tracepoint</h6><pre><code>Tracepoint是在内核固定的hook点上，并不是所有的函数中都有tracepoint。
</code></pre>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 使用perf list  查看所有的tracepoint</span></span></span><br><span class="line">perf list | grep Tracepoint</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 使用perf stat查看内核函数发生的频率</span></span></span><br><span class="line">perf stat -a -e syscalls:sys_enter_fsopen -- sleep 10</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 在ftrace中从tracefs文件系统中，查看tracepoint</span></span></span><br><span class="line">find /sys/kernel/debug/tracing/events -type d | sort</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 在ftrace中查看调用的信息</span></span></span><br><span class="line">cd /sys/kernel/debug/tracing</span><br><span class="line">echo 1 &gt; events/syscalls/sys_enter_chdir/enable</span><br><span class="line">cat trace</span><br></pre></td></tr></table></figure>

<p><img src="ftrace-enable.png" alt="1646962969090.png"></p>
<pre><code>Tracepoint在内核中的实现：是通过在代码中需要被trace的地方显式的加上hook点（内核源代码中预先写好），然后再把自己的probe函数注册上去，那么在代码执行的时候，就可以执行probe函数。
</code></pre>
<h6 id="Kprobe"><a href="#Kprobe" class="headerlink" title="Kprobe"></a>Kprobe</h6><pre><code>Kprobe可以动态地在把所有的内核函数（除inline函数）上挂载probe函数。
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">## 通过perf probe注册未实现tracepoint的函数</span><br><span class="line">perf probe --add do_filp_open</span><br><span class="line"></span><br><span class="line">## 通过perf stat统计该函数的调用次数</span><br><span class="line">perf stat -a -e probe:do_filp_open -- sleep 10</span><br><span class="line"></span><br><span class="line">## 通过ftrace定义kprobe event</span><br><span class="line">echo &#39;p:kprobes&#x2F;myprobe do_filp_open dfd&#x3D;+0(%di):u32 pathname&#x3D;+0(+0(%si)):string&#39; &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;kprobe_event</span><br><span class="line"></span><br><span class="line">## enable kprobe event 并查看结果</span><br><span class="line">echo 1 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;events&#x2F;kprobes&#x2F;myprobe&#x2F;enable</span><br><span class="line">cat &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;trace</span><br></pre></td></tr></table></figure>

<pre><code>Kprobe在内核中的实现：把目标指令替换，替换成的指令可以使程序跑到一个特定的handler里去执行probe函数。
</code></pre>
<h6 id="Uprobe"><a href="#Uprobe" class="headerlink" title="Uprobe"></a>Uprobe</h6><h5 id="调试工具"><a href="#调试工具" class="headerlink" title="调试工具"></a>调试工具</h5><h6 id="perf"><a href="#perf" class="headerlink" title="perf"></a>perf</h6><pre><code>perf是基于事件的，可以通过perf list查看事件类型。主要分为：

（1）hardware event，主要来自处理的PMU（Performance Monitoring Unit），是底层处理器的行为。

（2）software event，主要是内核代码中的几个特定事件，比如上下文切换，缺页中断（page faults）。

（3）tracepoints event，与software event类似，也是在内核代码中注册了事件。

perf stat统计数量，perf record采样，后面可指定参数。

常用的性能分析方式是：perf record采样， FlameGraph生成火焰图，查看耗时较长的函数。
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## 在容器中使用perf的限制</span><br><span class="line"></span><br><span class="line">1. perf版本要与宿主机内核版本一致，可通过源代码编译出静态perf。</span><br><span class="line"></span><br><span class="line">2.  seccomp对系统调用和内核对SYS_ADMIN capability的限制。</span><br></pre></td></tr></table></figure>

<h6 id="ftrace"><a href="#ftrace" class="headerlink" title="ftrace"></a>ftrace</h6><pre><code>ftrace，全称&quot;function tracer&quot;，从名字可以看出，这个工具是专门为了追踪内核函数的。
</code></pre>
<p><img src="ftrace.webp" alt="1646964149741.png"></p>
<pre><code>ftrace的操作基本上都可以在tracefs这个文件子系统中完成，例如ubuntu下在/sys/kernel/debug/tracing。
</code></pre>
<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><pre><code>根据之前libbpf-bootstrap的工程目录，现在进行Hello World的编写。在example/c目录下添加：
</code></pre>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim hello.bpf.c</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEC(NAME) __attribute__((section(NAME), used))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*bpf_trace_printk)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, <span class="keyword">int</span> fmt_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                               ...)</span> </span>= (<span class="keyword">void</span> *)BPF_FUNC_trace_printk;</span><br><span class="line"></span><br><span class="line">SEC(<span class="string">&quot;tracepoint/syscalls/sys_enter_execve&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bpf_prog</span><span class="params">(<span class="keyword">void</span> *ctx)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> msg[] = <span class="string">&quot;Hello, BPF World!&quot;</span>;</span><br><span class="line">  bpf_trace_printk(msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> _license[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;GPL&quot;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">vim hello.c</span><br><span class="line"></span><br><span class="line"><span class="comment">// SPDX-License-Identifier: (LGPL-2.1 OR BSD-2-Clause)</span></span><br><span class="line"><span class="comment">/* Copyright (c) 2020 Facebook */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bpf/libbpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;hello.skel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">libbpf_print_fn</span><span class="params">(<span class="keyword">enum</span> libbpf_print_level level, <span class="keyword">const</span> <span class="keyword">char</span> *format, va_list args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, format, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bump_memlock_rlimit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rlim_new</span> =</span> &#123;</span><br><span class="line">                .rlim_cur       = RLIM_INFINITY,</span><br><span class="line">                .rlim_max       = RLIM_INFINITY,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (setrlimit(RLIMIT_MEMLOCK, &amp;rlim_new)) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to increase RLIMIT_MEMLOCK limit!\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hello_bpf</span> *<span class="title">skel</span>;</span></span><br><span class="line">        <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Set up libbpf errors and debug info callback */</span></span><br><span class="line">        libbpf_set_print(libbpf_print_fn);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Bump RLIMIT_MEMLOCK to allow BPF sub-system to do anything */</span></span><br><span class="line">        bump_memlock_rlimit();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Open BPF application */</span></span><br><span class="line">        skel = hello_bpf__open();</span><br><span class="line">        <span class="keyword">if</span> (!skel) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to open BPF skeleton\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Load &amp; verify BPF programs */</span></span><br><span class="line">        err = hello_bpf__load(skel);</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to load and verify BPF skeleton\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Attach tracepoint handler */</span></span><br><span class="line">        err = hello_bpf__attach(skel);</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to attach BPF skeleton\n&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &quot;</span></span><br><span class="line">               <span class="string">&quot;to see output of the BPF programs.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="comment">/* trigger our BPF program */</span></span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">                sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line">        hello_bpf__destroy(skel);</span><br><span class="line">        <span class="keyword">return</span> -err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>在Makefile中添加编译的的app hello。
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">APPS &#x3D; hello minimal bootstrap uprobe kprobe fentry</span><br><span class="line"></span><br><span class="line">## 编译</span><br><span class="line">make hello</span><br><span class="line"></span><br><span class="line">## 执行,通过cat &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;trace_pipe查看结果</span><br><span class="line">.&#x2F;hello</span><br></pre></td></tr></table></figure>

<p><img src="hello-world.png" alt="hello-world"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2022/02/12/ServiceMesh-Istio%20Sidecar%E6%B5%81%E9%87%8F%E5%8A%AB%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/12/ServiceMesh-Istio%20Sidecar%E6%B5%81%E9%87%8F%E5%8A%AB%E6%8C%81/" class="post-title-link" itemprop="url">ServiceMesh-Istio Sidecar流量劫持</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-12 00:00:00" itemprop="dateCreated datePublished" datetime="2022-02-12T00:00:00+08:00">2022-02-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ServiceMesh/" itemprop="url" rel="index"><span itemprop="name">ServiceMesh</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>​    Istio使用Sidecar的方式劫持应用的流量，从而为应用透明地提供一些服务治理、监控的功能。在Kubernetes集群中，Pod可以通过定义Service，借由Kube-Proxy的四层负载均衡，实现Pod之间的通信。这两种方式都是通过定义Iptables规则，对流量进行劫持转发实现的，在学习Istio的过程中，经常会对两种方式的通信方式产生疑惑和混淆，本文通过案例分析Istio Sidecar的流量劫持方式，深入理解Istio的流量通信机制。</p>
<h1 id="流量劫持"><a href="#流量劫持" class="headerlink" title="流量劫持"></a>流量劫持</h1><h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><p>​    （1）本文的实验环境</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>Kubernetes</td>
<td>v1.20.11</td>
</tr>
<tr>
<td>Istio operator</td>
<td>1.12.1</td>
</tr>
<tr>
<td>httpbin</td>
<td>latest</td>
</tr>
</tbody></table>
<p>​    （2）部署情况说明</p>
<p>​    通过如下命令，在sidecar分区开启了sidecar的注入，然后分别部署了sleep服务（curl工具）和httpbin的服务，从curl工具的pod中通过service的域名访问httpbin服务来分析网格中不同Pod之间的流量通信方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 开启sidecar的注入</span><br><span class="line">kubectl label namespace sidecar istio-injection&#x3D;enabled</span><br><span class="line"></span><br><span class="line"># curl测试httpbin服务</span><br><span class="line">curl httpbin&#x2F;get</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;args&quot;: &#123;&#125;,</span><br><span class="line">  &quot;headers&quot;: &#123;</span><br><span class="line">    &quot;Accept&quot;: &quot;*&#x2F;*&quot;,</span><br><span class="line">    &quot;Host&quot;: &quot;httpbin&quot;,</span><br><span class="line">    &quot;User-Agent&quot;: &quot;curl&#x2F;7.81.0-DEV&quot;,</span><br><span class="line">    &quot;X-B3-Parentspanid&quot;: &quot;7401b316a7be3d2d&quot;,</span><br><span class="line">    &quot;X-B3-Sampled&quot;: &quot;0&quot;,</span><br><span class="line">    &quot;X-B3-Spanid&quot;: &quot;ac54e1bea35a534e&quot;,</span><br><span class="line">    &quot;X-B3-Traceid&quot;: &quot;92c6639fb8a764707401b316a7be3d2d&quot;,</span><br><span class="line">    &quot;X-Envoy-Attempt-Count&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;X-Forwarded-Client-Cert&quot;: &quot;By&#x3D;spiffe:&#x2F;&#x2F;cluster.local&#x2F;ns&#x2F;shadow&#x2F;sa&#x2F;default;Hash&#x3D;d6ad76288ec25532207928f784f8f99abdd9f74f97330feb60de9290fa35cf98;Subject&#x3D;\&quot;\&quot;;URI&#x3D;spiffe:&#x2F;&#x2F;cluster.local&#x2F;n</span><br><span class="line">s&#x2F;shadow&#x2F;sa&#x2F;sleep&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;origin&quot;: &quot;127.0.0.6&quot;,</span><br><span class="line">  &quot;url&quot;: &quot;http:&#x2F;&#x2F;httpbin&#x2F;get&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="过程分析"><a href="#过程分析" class="headerlink" title="过程分析"></a>过程分析</h2><p>​    <img src="envoy-sidecar-traffic-interception.png" alt="envoy-sidecar-traffic-interception"></p>
<p>​                                                                                                                          <a target="_blank" rel="noopener" href="https://jimmysong.io/blog/sidecar-injection-iptables-and-traffic-routing/">图片出处及原文链接</a></p>
<p>​    对照上述图片，当使用curl工具访问httpbin服务时，实际数据包的流向过程如下：</p>
<h3 id="客户端数据包发出"><a href="#客户端数据包发出" class="headerlink" title="客户端数据包发出"></a>客户端数据包发出</h3><p>​    sleep服务Pod中实际的Iptables规则如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">nsenter -t 2156522 -n iptables-save -t nat</span><br><span class="line"># Generated by iptables-save v1.8.4 on Fri Jan 28 15:05:19 2022</span><br><span class="line">*nat</span><br><span class="line">:PREROUTING ACCEPT [143:8580]</span><br><span class="line">:INPUT ACCEPT [143:8580]</span><br><span class="line">:OUTPUT ACCEPT [294:32758]</span><br><span class="line">:POSTROUTING ACCEPT [294:32758]</span><br><span class="line">:ISTIO_INBOUND - [0:0]</span><br><span class="line">:ISTIO_IN_REDIRECT - [0:0]</span><br><span class="line">:ISTIO_OUTPUT - [0:0]</span><br><span class="line">:ISTIO_REDIRECT - [0:0]</span><br><span class="line">-A PREROUTING -p tcp -j ISTIO_INBOUND</span><br><span class="line">-A OUTPUT -p tcp -j ISTIO_OUTPUT</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15008 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 22 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15090 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15021 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15020 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006</span><br><span class="line">-A ISTIO_OUTPUT -s 127.0.0.6&#x2F;32 -o lo -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT ! -d 127.0.0.1&#x2F;32 -o lo -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT ! -d 127.0.0.1&#x2F;32 -o lo -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -d 127.0.0.1&#x2F;32 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -j ISTIO_REDIRECT</span><br><span class="line">-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001</span><br><span class="line">COMMIT</span><br><span class="line"># Completed on Fri Jan 28 15:05:19 2022</span><br></pre></td></tr></table></figure>

<p>（1）DNS解析获取Cluster IP</p>
<p>​    在sleep的Pod中，首先通过DNS服务，查找httpbin的域名所指向的IP。获取到获取到服务的cluster ip后，然后向这个地址的80端口发送请求数据。</p>
<p>（2）出口流量拦截</p>
<p>​    数据包进入内核网络协议栈，如图⑨进入OUTPUT - ⑩ -&gt; ISTIO_OUTPUT - ⑪ -&gt; ISTIO_REDIRECT - ⑫ -&gt; 进入sidecar的15001端口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl.exe pc listeners -n sidecar sleep-557747455f-mgh4d --port&#x3D;15001</span><br><span class="line">ADDRESS PORT  MATCH         DESTINATION</span><br><span class="line">0.0.0.0 15001 ALL           PassthroughCluster</span><br><span class="line">0.0.0.0 15001 Addr: *:15001 Non-HTTP&#x2F;Non-TCP</span><br></pre></td></tr></table></figure>

<p>（3）Outbound Handler</p>
<p>​    Envoy从15001接收数据包后，数据包的访问域名是httpbin，端口是80。查找name=80的路由信息，通过比对域名和端口，找到对应的VirtualHost，匹配路由，找到需要转发到的Cluster：outbound|80||httpbin.sidecar.svc.cluster.local。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">istioctl.exe pc routes -n sidecar sleep-557747455f-mgh4d --name&#x3D;80 -ojson</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;name&quot;: &quot;httpbin.sidecar.svc.cluster.local:80&quot;,</span><br><span class="line">	&quot;domains&quot;: [</span><br><span class="line">		&quot;httpbin.sidecar.svc.cluster.local&quot;,</span><br><span class="line">		&quot;httpbin.sidecar.svc.cluster.local:80&quot;,</span><br><span class="line">		&quot;httpbin&quot;,</span><br><span class="line">		&quot;httpbin:80&quot;,</span><br><span class="line">		&quot;httpbin.sidecar.svc&quot;,</span><br><span class="line">		&quot;httpbin.sidecar.svc:80&quot;,</span><br><span class="line">		&quot;httpbin.sidecar&quot;,</span><br><span class="line">		&quot;httpbin.sidecar:80&quot;,</span><br><span class="line">		&quot;172.16.250.35&quot;,</span><br><span class="line">		&quot;172.16.250.35:80&quot;</span><br><span class="line">	],</span><br><span class="line">	&quot;routes&quot;: [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;name&quot;: &quot;default&quot;,</span><br><span class="line">			&quot;match&quot;: &#123;</span><br><span class="line">				&quot;prefix&quot;: &quot;&#x2F;&quot;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;route&quot;: &#123;</span><br><span class="line">				&quot;cluster&quot;: &quot;outbound|80||httpbin.sidecar.svc.cluster.local&quot;,</span><br><span class="line">				&quot;timeout&quot;: &quot;0s&quot;,</span><br><span class="line">				&quot;retryPolicy&quot;: &#123;</span><br><span class="line">					&quot;retryOn&quot;: &quot;connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes&quot;,</span><br><span class="line">					&quot;numRetries&quot;: 2,</span><br><span class="line">					&quot;retryHostPredicate&quot;: [</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;name&quot;: &quot;envoy.retry_host_predicates.previous_hosts&quot;</span><br><span class="line">						&#125;</span><br><span class="line">					],</span><br><span class="line">					&quot;hostSelectionRetryMaxAttempts&quot;: &quot;5&quot;,</span><br><span class="line">					&quot;retriableStatusCodes&quot;: [</span><br><span class="line">						503</span><br><span class="line">					]</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;maxStreamDuration&quot;: &#123;</span><br><span class="line">					&quot;maxStreamDuration&quot;: &quot;0s&quot;,</span><br><span class="line">					&quot;grpcTimeoutHeaderMax&quot;: &quot;0s&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;decorator&quot;: &#123;</span><br><span class="line">				&quot;operation&quot;: &quot;httpbin.sidecar.svc.cluster.local:80&#x2F;*&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	&quot;includeRequestAttemptCount&quot;: true</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>​    查看Cluster关联的Endpoints信息，发现最终定位到的IP为httpbin的Pod IP：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl.exe pc endpoints -n sidecar sleep-557747455f-mgh4d --cluster&#x3D;&quot;outbound|80||httpbin.sidecar.svc.cluster.local&quot;</span><br><span class="line">ENDPOINT            STATUS      OUTLIER CHECK     CLUSTER</span><br><span class="line">172.16.0.218:80     HEALTHY     OK                outbound|80||httpbin.sidecar.svc.cluster.local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ kubectl get pod -n sidecar -o wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   IP             NODE                     NOMINATED NODE   READINESS GATES</span><br><span class="line">httpbin-5bc89f56dd-8n5cx   2&#x2F;2     Running   0          34m   172.16.0.218   kube-node-xx-xx-xx-xx   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">sleep-557747455f-mgh4d     2&#x2F;2     Running   0          34m   172.16.0.219   kube-node-xx-xx-xx-xx   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>



<p>​    经过Outbound Handler处理过后的数据包，找到了httpbin的Pod IP。然后进入内核协议栈，经由</p>
<p>​        ⑬ -&gt;OUTPUT - ⑭ -&gt; ISTIO_OUTPUT - ⑯ -&gt; POSTTOUTING - ⑰ -&gt; 从sleep的pod发出。    </p>
<h3 id="Pod间通信"><a href="#Pod间通信" class="headerlink" title="Pod间通信"></a>Pod间通信</h3><p> （4）数据包在K8S集群中，通过网络插件，实现Pod之间通过IP进行通信，这个过程这里不详细分析。</p>
<h3 id="服务端数据包接收"><a href="#服务端数据包接收" class="headerlink" title="服务端数据包接收"></a>服务端数据包接收</h3><p>​    httpbin服务Pod中的Iptables规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> nsenter -t 2154864 -n iptables-save -t nat</span><br><span class="line"># Generated by iptables-save v1.8.4 on Fri Jan 28 15:47:02 2022</span><br><span class="line">*nat</span><br><span class="line">:PREROUTING ACCEPT [1403:84180]</span><br><span class="line">:INPUT ACCEPT [1403:84180]</span><br><span class="line">:OUTPUT ACCEPT [5404:647880]</span><br><span class="line">:POSTROUTING ACCEPT [5404:647880]</span><br><span class="line">:ISTIO_INBOUND - [0:0]</span><br><span class="line">:ISTIO_IN_REDIRECT - [0:0]</span><br><span class="line">:ISTIO_OUTPUT - [0:0]</span><br><span class="line">:ISTIO_REDIRECT - [0:0]</span><br><span class="line">-A PREROUTING -p tcp -j ISTIO_INBOUND</span><br><span class="line">-A OUTPUT -p tcp -j ISTIO_OUTPUT</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15008 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 22 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15090 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15021 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15020 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006</span><br><span class="line">-A ISTIO_OUTPUT -s 127.0.0.6&#x2F;32 -o lo -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT ! -d 127.0.0.1&#x2F;32 -o lo -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT ! -d 127.0.0.1&#x2F;32 -o lo -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -d 127.0.0.1&#x2F;32 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -j ISTIO_REDIRECT</span><br><span class="line">-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001</span><br><span class="line">COMMIT</span><br><span class="line"># Completed on Fri Jan 28 15:47:02 2022</span><br></pre></td></tr></table></figure>

<p>（5）入口流量拦截</p>
<p>​    数据包使用Pod IP + Port由①进入目标Pod。然后进入到内核协议栈，经由</p>
<p>​        PREROUTING - ② -&gt; ISTIO_INBOUND - ③ -&gt; ISTIO_IN_REDIRECT 进入sidecat的15006端口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl.exe pc listeners -n sidecar httpbin-5bc89f56dd-8n5cx --port&#x3D;15006</span><br></pre></td></tr></table></figure>

<p><img src="server-listener-15006.png" alt="server-listener-15006"></p>
<p>（6）Inbound Handler</p>
<p>​        Envoy从15006接收到数据包后，会交由inbound_0.0.0.0_80监听器处理 -&gt; inbound|80|| route处理 -&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">istioctl.exe pc route -n sidecar httpbin-5bc89f56dd-hntgz --name&#x3D;80 -o json </span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;name&quot;: &quot;httpbin.sidecar.svc.cluster.local:80&quot;,</span><br><span class="line">	&quot;domains&quot;: [</span><br><span class="line">		&quot;httpbin.sidecar.svc.cluster.local&quot;,</span><br><span class="line">		&quot;httpbin.sidecar.svc.cluster.local:80&quot;,</span><br><span class="line">		&quot;httpbin&quot;,</span><br><span class="line">		&quot;httpbin:80&quot;,</span><br><span class="line">		&quot;httpbin.sidecar.svc&quot;,</span><br><span class="line">		&quot;httpbin.sidecar.svc:80&quot;,</span><br><span class="line">		&quot;httpbin.sidecar&quot;,</span><br><span class="line">		&quot;httpbin.sidecar:80&quot;,</span><br><span class="line">		&quot;172.16.250.35&quot;,</span><br><span class="line">		&quot;172.16.250.35:80&quot;</span><br><span class="line">	],</span><br><span class="line">	&quot;routes&quot;: [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;name&quot;: &quot;default&quot;,</span><br><span class="line">			&quot;match&quot;: &#123;</span><br><span class="line">				&quot;prefix&quot;: &quot;&#x2F;&quot;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;route&quot;: &#123;</span><br><span class="line">				&quot;cluster&quot;: &quot;outbound|80||httpbin.sidecar.svc.cluster.local&quot;,</span><br><span class="line">				&quot;timeout&quot;: &quot;0s&quot;,</span><br><span class="line">				&quot;retryPolicy&quot;: &#123;</span><br><span class="line">					&quot;retryOn&quot;: &quot;connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes&quot;,</span><br><span class="line">					&quot;numRetries&quot;: 2,</span><br><span class="line">					&quot;retryHostPredicate&quot;: [</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;name&quot;: &quot;envoy.retry_host_predicates.previous_hosts&quot;</span><br><span class="line">						&#125;</span><br><span class="line">					],</span><br><span class="line">					&quot;hostSelectionRetryMaxAttempts&quot;: &quot;5&quot;,</span><br><span class="line">					&quot;retriableStatusCodes&quot;: [</span><br><span class="line">						503</span><br><span class="line">					]</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;maxStreamDuration&quot;: &#123;</span><br><span class="line">					&quot;maxStreamDuration&quot;: &quot;0s&quot;,</span><br><span class="line">					&quot;grpcTimeoutHeaderMax&quot;: &quot;0s&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;decorator&quot;: &#123;</span><br><span class="line">				&quot;operation&quot;: &quot;httpbin.sidecar.svc.cluster.local:80&#x2F;*&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	&quot;includeRequestAttemptCount&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    Inbound Handler最终也会将数据包转发给cluster：outbound|80||httpbin.sidecar.svc.cluster.local。最后找到httpbin服务的Pod IP，发现是自己的IP，然后将目标地址转化为127.0.0.1。然后以这个地址向外发出数据包。进入内核协议栈后：</p>
<p>​        ⑤ -&gt; OUTPUT - ⑥ -&gt; ISTIO_OUTPUT - ⑦ -&gt; POSTROUTING - ⑧ -&gt; 发往本地应用容器。   </p>
<h1 id="总结拓展"><a href="#总结拓展" class="headerlink" title="总结拓展"></a>总结拓展</h1><p>​    目前Istio在生产环境下主要有以下几点需要着重考虑的点：</p>
<ol>
<li>从上述数据包的流转不难看出，客户端与服务端的单向通信，需要经过两次Sidecar的拦截，数据包频繁地出入内核协议栈，在用户空间和内核空间之间拷贝，效率必然会有所下降。</li>
<li>默认情况下，每个Sidecar的代理都包含了整个集群的配置，配置文件非常庞大，而在集群中，代理的数量又是伴随着业务容器的增长而不断增加，不但增加了内存资源的消耗，同时也增加了维护的成本。</li>
<li>应用之间所有的通信都托管给了sidecar，重度依赖sidecar，因此需要考虑sidecar与应用容器之间的启停顺序。</li>
<li>Sidecar作为中间件，是需要维护升级的，而业务又是不允许中断的，如何对Sidecar进行热升级。</li>
</ol>
<h2 id="eBPF技术"><a href="#eBPF技术" class="headerlink" title="eBPF技术"></a>eBPF技术</h2><p>​    使用eBPF技术可以优化Istio的数据转发路径，加速数据转发：</p>
<p>​    （1）使用SocketMap可以减少应用容器与Sidecar之间的数据路径，加快数据包的流转。</p>
<p>​    （2）使用XDP可以在网络协议栈之前，在网卡上就处理掉协议包的转发。</p>
<p>​    （3）使用Traffic Control可以进行流量控制。</p>
<p>​    目前比较火的Cilium就是这样的一站式K8S网络解决方案。</p>
<p><img src="istio-netfilter.png" alt="istio-netfilter"></p>
<p><img src="Istio-cilium.png" alt="Istio-cilium"></p>
<h2 id="代理瘦身"><a href="#代理瘦身" class="headerlink" title="代理瘦身"></a>代理瘦身</h2><h3 id="服务按需暴露"><a href="#服务按需暴露" class="headerlink" title="服务按需暴露"></a>服务按需暴露</h3><p>​    Istio提供了exportTo限定服务对Sidecar的可见性，来控制服务的可见性，从而减小Envoy的配置大小。</p>
<h3 id="节点统一代理"><a href="#节点统一代理" class="headerlink" title="节点统一代理"></a>节点统一代理</h3><p>​    目前也有sidecar per node的一些方案，但同时也有一些问题，但同时也会带来一些例如单点的问题。</p>
<h2 id="热升级"><a href="#热升级" class="headerlink" title="热升级"></a>热升级</h2><p>​    阿里的OpenKruise 通过引入Empty容器，实现热升级。</p>
<p>​    <a target="_blank" rel="noopener" href="https://github.com/openkruise/kruise/blob/master/README-zh_CN.md">OpenKruise</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2022/01/27/ServiceMesh-Istio%20Ingress%20Gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/27/ServiceMesh-Istio%20Ingress%20Gateway/" class="post-title-link" itemprop="url">ServiceMesh-Istio Ingress Gateway</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-27 00:00:00" itemprop="dateCreated datePublished" datetime="2022-01-27T00:00:00+08:00">2022-01-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ServiceMesh/" itemprop="url" rel="index"><span itemprop="name">ServiceMesh</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="网关方案"><a href="#网关方案" class="headerlink" title="网关方案"></a>网关方案</h1><p>​    Kubernetes集群的南北向流量打通，需要一个边缘网关，在实际生产中，该网关往往也常常作为API 网关被使用，提供一些服务治理的功能。</p>
<h2 id="选型考量"><a href="#选型考量" class="headerlink" title="选型考量"></a>选型考量</h2><p>​    目前集群中使用nginx ingress作为边缘网关，主要充当七层负载均衡，通过annotations进行一些功能的定制，非常不友好，而且对于服务治理能力支持较弱，K8S SIG小组提出了API Gateway的标准，有一些项目（<a target="_blank" rel="noopener" href="https://gateway-api.sigs.k8s.io/implementations/">Kubernetes Gateway API</a>）做了实现，但是都尚处于孵化阶段，功能也不是很完善，无法应用于生产环境。</p>
<p>​    之前计划使用APISIX作为Kubernetes新的负载均衡实现，但是因为目前的APISIX暂无法满足内外网隔离配置（ingressClass）的需求，而被否定。</p>
<p>​    考虑到ServiceMesh的技术是主流的方向，而且已经日趋成熟，Envoy作为Istio的数据面，除了充当Sidecar以外，也被使用在Istio的网关当中。而且Envoy的成熟度是经过生产验证的，而且使用Istio Ingress Gateway作为边缘网关，可以复用Istio大部分的服务治理能力。</p>
<p>​    本文将尝试使用Istio Ingress Gateway作为边缘网关，在网关上使用Istio的流量治理能力（生产集群实际未开启Sidecar注入能力）。</p>
<h2 id="Envoy简介"><a href="#Envoy简介" class="headerlink" title="Envoy简介"></a>Envoy简介</h2><p>Envoy是由C++编写的一个代理，首次提出并实现了API可配置网关，使用xDS协议通过API管理服务实现对代理服务的动态配置。</p>
<p>​    通过Envoy的配置文件，可以看出xDS的几个重要组成：</p>
<ol>
<li><p>LDS                 对应Istio的Gateway对象，每一个Listener，Envoy都会为其起一个监听端口。</p>
<p>|——&gt; RDS   主要对应路由规则以及一些路由相关的配置。</p>
</li>
<li><p>CDS                Cluster对应一组服务，在不考虑Subset的情况下，可以认为是对应K8S的一个Service。</p>
<p>|——&gt; EDS    Endpoint最终转发到的上游服务。</p>
</li>
</ol>
<p>​    RDS会通过route.cluster指向CDS。从而实现数据转发到最终的上游服务。</p>
<p>​    在Istio中，可通过如下命令查看Envoy的相关配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">istioctl dashboard envoy -n &lt;namespace&gt; &lt;pod name&gt;</span><br><span class="line"></span><br><span class="line">istioctl proxy-config listeners&#x2F;clusters -n [namespace] [pod name]</span><br></pre></td></tr></table></figure>

<p><img src="Istio-Gateway-config-dump.png" alt="Istio-Gateway-config-dump"></p>
<h2 id="功能梳理"><a href="#功能梳理" class="headerlink" title="功能梳理"></a>功能梳理</h2><p><img src="Istio-Gateway.png" alt="Istio-Gateway"></p>
<p>​    如上是根据当前系统的功能需求，梳理的Istio Ingress Gateway对用的功能图表。</p>
<h1 id="功能实践"><a href="#功能实践" class="headerlink" title="功能实践"></a>功能实践</h1><p>​    <a target="_blank" rel="noopener" href="https://istio.io/latest/docs/examples/">Istio Bookinfo Example</a></p>
<p>​    常规的功能在Istio官网的Bookinfo的实例中，已有很好的演示，本文不再赘述。本文重点侧重于通过EnvoyFilter对Envoy进行定制化的配置和扩展。</p>
<h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><table>
<thead>
<tr>
<th>组件</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>Kubernetes</td>
<td>v1.20.11</td>
</tr>
<tr>
<td>Istio operator</td>
<td>1.12.1</td>
</tr>
<tr>
<td>httpbin</td>
<td>latest</td>
</tr>
</tbody></table>
<p>​    通过NodePort暴露了Istio Ingress Gateway的监听端口8080和8443，部署httpbin相关的Istio CRD对象如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">httpbin-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">httpbin.xxx.xx</span></span><br><span class="line">    <span class="attr">port:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">httpbin.xxx.xx</span></span><br><span class="line">    <span class="attr">port:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">8443</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTPS</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">credentialName:</span> <span class="string">xxxxxxx</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">SIMPLE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">httpbin-gateway</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">httpbin.xxx.xx</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">exact:</span> <span class="string">/get</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">exact:</span> <span class="string">/headers</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">httpbin</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">httpbin</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>



<h2 id="WebAssembly"><a href="#WebAssembly" class="headerlink" title="WebAssembly"></a>WebAssembly</h2><h3 id="基础介绍"><a href="#基础介绍" class="headerlink" title="基础介绍"></a>基础介绍</h3><p>​    WebAssembly可使用多种语言进行编写，最终编译成wasm二进制文件，通过沙箱技术运行，在Istio中，可以自定义扩展EnvoyFilter资源对象对代理进行扩展。Proxy-Wasm目前已经取代了Mixer成为了Istio的主要扩展机制。</p>
<p>​    Proxy-Wasm sdk目前比较成熟的是C++、Rust、WebAssembly Script。目前TinyGo（Go语言的一个子集）尚处于Experimental阶段。因为技术栈原因，本文使用TinyGo进行实践。Istio官方文档对于wasm与数据平面Envoy代理之间的关系如下：</p>
<p><img src="istio-wasm-proxy.svg" alt="istio-wasm-proxy"></p>
<h3 id="Demo实践"><a href="#Demo实践" class="headerlink" title="Demo实践"></a>Demo实践</h3><h4 id="TinyGo安装"><a href="#TinyGo安装" class="headerlink" title="TinyGo安装"></a>TinyGo安装</h4><p>​    根据官网要求安装TinyGo。</p>
<p>​    <a target="_blank" rel="noopener" href="https://tinygo.org/getting-started/install/">TinyGo Install</a></p>
<h4 id="编译wasm"><a href="#编译wasm" class="headerlink" title="编译wasm"></a>编译wasm</h4><p>​    <a target="_blank" rel="noopener" href="https://github.com/tetratelabs/proxy-wasm-go-sdk/tree/main/examples">tetratelabs/proxy-wasm-go-sdk</a></p>
<p>​    从上面的案例库中选取其中一个example：http_headers，可以看到这个程序在请求的header中增加了一个键值对，作为我们验证是否生效的点。</p>
<blockquote>
<p>这里是自定义逻辑实现的点，可以实现各种filter满足自身业务需要，需要遵循proxy-wasm sdk的SPI。</p>
<p>TinyGo是Go语言的一个子集，使用TinyGO编写Wasm存在一些限制，例如不能使用goroutine、recover等。</p>
<p>详细可参考文档说明<a target="_blank" rel="noopener" href="https://github.com/tetratelabs/proxy-wasm-go-sdk/blob/main/doc/OVERVIEW.md">https://github.com/tetratelabs/proxy-wasm-go-sdk/blob/main/doc/OVERVIEW.md</a></p>
</blockquote>
<p>​    编译wasm二进制文件。可以参考Makefile中的命令。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tinygo build -o http_headers.wasm -scheduler=none -target=wasi http_headers.go</span><br></pre></td></tr></table></figure>

<h4 id="EnvoyFilter"><a href="#EnvoyFilter" class="headerlink" title="EnvoyFilter"></a>EnvoyFilter</h4><p>​    EnvoyFilter的资源定义文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EnvoyFilter</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wasm-filter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">configPatches:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">applyTo:</span> <span class="string">CLUSTER</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">GATEWAY</span></span><br><span class="line">    <span class="attr">patch:</span></span><br><span class="line">      <span class="attr">operation:</span> <span class="string">ADD</span></span><br><span class="line">      <span class="attr">value:</span> <span class="comment"># cluster specification</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">&quot;wasm-cluster&quot;</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">STRICT_DNS</span></span><br><span class="line">        <span class="attr">connect_timeout:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">lb_policy:</span> <span class="string">ROUND_ROBIN</span></span><br><span class="line">        <span class="attr">load_assignment:</span></span><br><span class="line">          <span class="attr">cluster_name:</span> <span class="string">wasm-cluster</span></span><br><span class="line">          <span class="attr">endpoints:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">lb_endpoints:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">endpoint:</span></span><br><span class="line">                <span class="attr">address:</span></span><br><span class="line">                  <span class="attr">socket_address:</span></span><br><span class="line">                    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">                    <span class="attr">address:</span> <span class="string">&quot;xx.xxx.xx.xxx&quot;</span></span><br><span class="line">                    <span class="attr">port_value:</span> <span class="number">8081</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">applyTo:</span> <span class="string">HTTP_FILTER</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">GATEWAY</span></span><br><span class="line">      <span class="attr">listener:</span></span><br><span class="line">        <span class="attr">portNumber:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">filterChain:</span></span><br><span class="line">          <span class="attr">filter:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">envoy.filters.network.http_connection_manager</span></span><br><span class="line">            <span class="attr">subFilter:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">envoy.filters.http.router</span></span><br><span class="line">    <span class="attr">patch:</span></span><br><span class="line">      <span class="attr">operation:</span> <span class="string">INSERT_BEFORE</span></span><br><span class="line">      <span class="attr">value:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">envoy.filters.http.wasm</span></span><br><span class="line">        <span class="attr">typed_config:</span></span><br><span class="line">          <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm</span></span><br><span class="line">          <span class="attr">config:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">wasm-filter</span></span><br><span class="line">            <span class="attr">root_id:</span> <span class="string">wasm-root-id</span></span><br><span class="line">            <span class="attr">vm_config:</span></span><br><span class="line">              <span class="attr">vm_id:</span> <span class="string">wasm-vm-id</span></span><br><span class="line">              <span class="attr">runtime:</span> <span class="string">envoy.wasm.runtime.v8</span></span><br><span class="line">              <span class="attr">code:</span></span><br><span class="line">                <span class="attr">remote:</span></span><br><span class="line">                  <span class="attr">sha256:</span> <span class="string">4333211c41afe75903b4eaf3093fd18a7f9435b159a97fa3088bbc585f4930c1</span></span><br><span class="line">                  <span class="attr">http_uri:</span></span><br><span class="line">                    <span class="attr">cluster:</span> <span class="string">wasm-cluster</span></span><br><span class="line">                    <span class="attr">uri:</span> <span class="string">http://xx.xxx.xx.xxx:8081/http_headers.wasm</span>   <span class="comment"># 这里使用nginx搭建了文件下载服务器</span></span><br><span class="line">                    <span class="attr">timeout:</span> <span class="string">&quot;3s&quot;</span></span><br></pre></td></tr></table></figure>

<p>​    这里有几个地方需要注意：</p>
<ol>
<li>远程代码访问的地址，必须定义在Envoy的Cluster内，否则会报错。<ul>
<li>ConfigMap的方式对文件大小有限制。</li>
<li>也可以使用宿主机挂载的方式，可维护性较差。</li>
</ul>
</li>
<li>EnvoyFilter需要定义在Ingress Gateway的命名空间下，否则无法生效。</li>
<li>envoy.filters.http.wasm 暂不支持按照domain和route进行配置：<ul>
<li>使用typed_per_filter_config：Envoy目前不支持wasm的http filter类型。</li>
<li>使用Composite：Istio目前不支持Matching API下发。</li>
</ul>
</li>
</ol>
<h4 id="结果验证"><a href="#结果验证" class="headerlink" title="结果验证"></a>结果验证</h4><p>​    在集群中创建该对象后，通过istioctl dashboard envoy -n  [namespace] [pod name] 查看配置是否生效，如下图：</p>
<p><img src="envoyfilter-wasm.png" alt="envoyfilter-wasm"></p>
<p>​    访问httpbin服务，查看header中是否添加了对应的key。第一次访问是EnvoyFilter未提交或者是删除的情况下。</p>
<p><img src="wasm-headers.png" alt="wasm-headers"></p>
<h2 id="Rate-Limits"><a href="#Rate-Limits" class="headerlink" title="Rate Limits"></a>Rate Limits</h2><p>​    根据Istio文档的描述，Rate Limits分为：</p>
<ul>
<li><p>Global Rate Limit   </p>
</li>
<li><p>Local Rate Limit</p>
<p> 全局的Rate Limits依赖外部服务，增加了复杂度，并且没有办法根据路径进行限流，直接舍弃。因此，这里仅测试Envoy自身支持的局部限流。</p>
</li>
</ul>
<h3 id="Local-Rate-Limits"><a href="#Local-Rate-Limits" class="headerlink" title="Local Rate Limits"></a>Local Rate Limits</h3><p>​    前面在环境说明中已经部署了httpbin的VirtualService，这里为了实现根据路径限流的要求，稍作修改，为每个路由规则增加名称：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">httpbin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">httpbin-gateway</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">httpbin.xxx.xx</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">get</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">exact:</span> <span class="string">/get</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">headers</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">exact:</span> <span class="string">/headers</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">slash</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpbin-match</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">httpbin</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>

<p>​    查看网关的配置，发现Envoy根据VirtualService的配置为每条路由都生成了一个名称，如下图所示：</p>
<p><img src="rate-limits-route-name.png" alt="rate-limits-route-name"></p>
<p>​    接下来，根据这个名称，为/get路由请求配置Local Rate Limits</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EnvoyFilter</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filter-local-ratelimit-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">istio-ingressgateway</span></span><br><span class="line">  <span class="attr">configPatches:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">applyTo:</span> <span class="string">HTTP_FILTER</span></span><br><span class="line">      <span class="attr">match:</span></span><br><span class="line">        <span class="attr">context:</span> <span class="string">GATEWAY</span></span><br><span class="line">        <span class="attr">listener:</span></span><br><span class="line">          <span class="attr">filterChain:</span></span><br><span class="line">            <span class="attr">filter:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">&quot;envoy.filters.network.http_connection_manager&quot;</span></span><br><span class="line">      <span class="attr">patch:</span></span><br><span class="line">        <span class="attr">operation:</span> <span class="string">INSERT_BEFORE</span></span><br><span class="line">        <span class="attr">value:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">envoy.filters.http.local_ratelimit</span></span><br><span class="line">          <span class="attr">typed_config:</span></span><br><span class="line">            <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/udpa.type.v1.TypedStruct</span></span><br><span class="line">            <span class="attr">type_url:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit</span></span><br><span class="line">            <span class="attr">value:</span></span><br><span class="line">              <span class="attr">stat_prefix:</span> <span class="string">http_local_rate_limiter</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">applyTo:</span> <span class="string">HTTP_ROUTE</span></span><br><span class="line">      <span class="attr">match:</span></span><br><span class="line">        <span class="attr">context:</span> <span class="string">GATEWAY</span></span><br><span class="line">        <span class="attr">routeConfiguration:</span></span><br><span class="line">          <span class="attr">vhost:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">&quot;httpbin.xxx.xx:8443&quot;</span></span><br><span class="line">            <span class="attr">route:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">&quot;httpbin-match.get&quot;</span></span><br><span class="line">              <span class="attr">action:</span> <span class="string">ANY</span></span><br><span class="line">      <span class="attr">patch:</span></span><br><span class="line">        <span class="attr">operation:</span> <span class="string">MERGE</span></span><br><span class="line">        <span class="attr">value:</span></span><br><span class="line">          <span class="attr">typed_per_filter_config:</span></span><br><span class="line">            <span class="attr">envoy.filters.http.local_ratelimit:</span></span><br><span class="line">              <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/udpa.type.v1.TypedStruct</span></span><br><span class="line">              <span class="attr">type_url:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit</span></span><br><span class="line">              <span class="attr">value:</span></span><br><span class="line">                <span class="attr">stat_prefix:</span> <span class="string">http_local_rate_limiter</span></span><br><span class="line">                <span class="attr">token_bucket:</span></span><br><span class="line">                  <span class="attr">max_tokens:</span> <span class="number">1</span></span><br><span class="line">                  <span class="attr">tokens_per_fill:</span> <span class="number">1</span></span><br><span class="line">                  <span class="attr">fill_interval:</span> <span class="string">60s</span></span><br><span class="line">                <span class="attr">filter_enabled:</span></span><br><span class="line">                  <span class="attr">runtime_key:</span> <span class="string">local_rate_limit_enabled</span></span><br><span class="line">                  <span class="attr">default_value:</span></span><br><span class="line">                    <span class="attr">numerator:</span> <span class="number">100</span></span><br><span class="line">                    <span class="attr">denominator:</span> <span class="string">HUNDRED</span></span><br><span class="line">                <span class="attr">filter_enforced:</span></span><br><span class="line">                  <span class="attr">runtime_key:</span> <span class="string">local_rate_limit_enforced</span></span><br><span class="line">                  <span class="attr">default_value:</span></span><br><span class="line">                    <span class="attr">numerator:</span> <span class="number">100</span></span><br><span class="line">                    <span class="attr">denominator:</span> <span class="string">HUNDRED</span></span><br><span class="line">                <span class="attr">response_headers_to_add:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">append:</span> <span class="literal">false</span></span><br><span class="line">                    <span class="attr">header:</span></span><br><span class="line">                      <span class="attr">key:</span> <span class="string">x-local-rate-limit</span></span><br><span class="line">                      <span class="attr">value:</span> <span class="string">&#x27;true&#x27;</span></span><br></pre></td></tr></table></figure>

<p>​    kubectl apply -f 上述对象后，再次检查配置文件看配置是否生效，并测试结果。</p>
<p><img src="rate-limits-route-config.png" alt="rate-limits-route-config"></p>
<p><img src="rate-limits-evaluate.png" alt="rate-limits-evaluate"></p>
<h2 id="Lua"><a href="#Lua" class="headerlink" title="Lua"></a>Lua</h2><p>​    Wasm的插件目前不支持按照route path进行启用：</p>
<p>​    （1）Envoy的typed_per_filter_config暂不支持envoy.filters.http.wasm的类型，但可以支持envoy.filters.http.lua。</p>
<p>​    （2）Istio的xDS目前不支持Envoy的composite的http filter的下发。</p>
<p>​    下面采用lua扩展，支持按照路由路径配置插件的启用。因为对lua脚本并不熟悉，示例插件实现较为简单，仅以在header追加内容为例。比较复杂的插件可以通过lua封装成组件库，然后在lua中引用，具体可参照Envoy的<a target="_blank" rel="noopener" href="https://github.com/envoyproxy/envoy/tree/b29f4deb5e89bfdf07abd3684179072d789f6673/examples/lua">官方示例</a></p>
<p>​    使用如下yaml文件，为httpbin服务的http监听器的/get路径启用插件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EnvoyFilter</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lua-filter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">configPatches:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">applyTo:</span> <span class="string">HTTP_ROUTE</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">      <span class="attr">routeConfiguration:</span></span><br><span class="line">        <span class="attr">vhost:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">httpbin.xxx.xx:8080</span>                           <span class="comment">## 指定vhost</span></span><br><span class="line">          <span class="attr">route:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">&quot;httpbin-match.get&quot;</span>                         <span class="comment">## 指定路由名称，这里沿用Rate Limits的VirtualService中使用的名称</span></span><br><span class="line">    <span class="attr">patch:</span></span><br><span class="line">      <span class="attr">operation:</span> <span class="string">MERGE</span></span><br><span class="line">      <span class="attr">value:</span></span><br><span class="line">        <span class="attr">typed_per_filter_config:</span></span><br><span class="line">          <span class="attr">envoy.filters.http.lua:</span></span><br><span class="line">            <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.lua.v3.LuaPerRoute</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">shadow.lua</span>                                   <span class="comment">## 引用在HTTP_FILTER定义的lua脚本</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">applyTo:</span> <span class="string">HTTP_FILTER</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">GATEWAY</span></span><br><span class="line">      <span class="attr">listener:</span></span><br><span class="line">        <span class="attr">portNumber:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">filterChain:</span></span><br><span class="line">          <span class="attr">filter:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">envoy.filters.network.http_connection_manager</span></span><br><span class="line">            <span class="attr">subFilter:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">envoy.filters.http.router</span></span><br><span class="line">    <span class="attr">patch:</span></span><br><span class="line">      <span class="attr">operation:</span> <span class="string">INSERT_BEFORE</span></span><br><span class="line">      <span class="attr">value:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">envoy.filters.http.lua</span></span><br><span class="line">        <span class="attr">typed_config:</span></span><br><span class="line">          <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua</span></span><br><span class="line">          <span class="attr">inline_code:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">function</span> <span class="string">envoy_on_request(request_handle)</span></span><br><span class="line">              <span class="string">--</span> <span class="string">do</span> <span class="string">something</span></span><br><span class="line">            <span class="string">end</span></span><br><span class="line">          <span class="attr">source_codes:</span></span><br><span class="line">            <span class="attr">shadow.lua:</span>                                    <span class="comment">## 申明脚本内容</span></span><br><span class="line">              <span class="attr">inline_string:</span> <span class="string">|</span></span><br><span class="line">                <span class="string">function</span> <span class="string">envoy_on_request(request_handle)</span></span><br><span class="line">                  <span class="string">request_handle:headers():add(&quot;foo&quot;,</span> <span class="string">&quot;shadow&quot;</span><span class="string">)</span></span><br><span class="line">                <span class="string">end</span></span><br></pre></td></tr></table></figure>

<p>​    将上述对象在集群中执行，验证结果，当访问/get时，lua插件为请求添加了Foo=shadow的header，而插件并未处理/header的请求：</p>
<p><img src="lua-extension.png" alt="lua-extension"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2021/10/16/Kubernetes-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90kube-controller-manager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/16/Kubernetes-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90kube-controller-manager/" class="post-title-link" itemprop="url">Kubernetes-源码分析kube-controller-manager</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-16 00:00:00" itemprop="dateCreated datePublished" datetime="2021-10-16T00:00:00+08:00">2021-10-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​    理解Kubernetes的Informer机制，对于基于Kubernetes作二次开发，编写一些符合业务场景的controller至关重要。本文通过梳理Kubernetes的controller-manager的实现，对于深入理解使用Informer给予一些启发。</p>
<h1 id="组件介绍"><a href="#组件介绍" class="headerlink" title="组件介绍"></a>组件介绍</h1><p>​    kube-controller-manager是Kubernetes中controller模式的实现者，承载了许多工作负载的关键逻辑实现。在实际使用的集群中，kube-controller-manager以多副本选主的方式，保证高可用。通过ListWatch api-server对应资源的API。触发事件回调，执行相应的调谐逻辑保证工作负载的状态与用户期望的状态达到最终一致性。</p>
<p>​    kube-controller-manager作为Kubernetes的关键组件之一，代码相对简单，整体结构基本与自定义controller的实现并无二致。</p>
<p>​    参照《Kubernetes源码剖析》一书中的这幅图，详细展示了组件之间的关系，笔者在图上作了序号的标记，结合源码在下文中来详细解释。</p>
<p><img src="code-architecture.png" alt="code-architecture"></p>
<p>​    </p>
<p>​    其中包括多个工作组件，之前在《Kubernetes-Operator》中结合具体的场景分析过，本文将从Kubernetes源码的角度，分析官方提供的工作负载（以Deployment为例）各个组件是如何协同工作，数据是如何传递，保存的，事件是如何注册、触发的。</p>
<blockquote>
<p><strong>特别说明</strong></p>
<p>​    本次源码分析，主要为了理清Kubernetes核心组件的整体实现思路，会着重分析一些看源码时候比较迷惑的点， 但并不会局限于全部的实现细节，也不局限于某个版本，因此代码的原本是直接使用下面命令clone的github上最新代码</p>
<p>​    git clone –depth=1 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes.git%E3%80%82">https://github.com/kubernetes/kubernetes.git。</a></p>
<p>​    笔者认为，也许代码的实现细节会随着版本的更迭，有所更新，但核心的实现思路并不会有太大变化，只要理清了这些核心的实现，在工作学习中，结合具体场景具体问题再做具体分析，再返回头来深究一些细节，也是会事半功倍的。</p>
<p>​    源码分析不是一蹉而就的，需要反复阅读，反复考究。温故而知新。</p>
</blockquote>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>​    Kubernetes中自带了许多controller，controller-manager负责启动这些controller，具体的调谐逻辑存放在controller中。下面是源码中controller名称和启动方法的对应map。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewControllerInitializers</span><span class="params">(loopMode ControllerLoopMode)</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">InitFunc</span></span> &#123;</span><br><span class="line">	controllers := <span class="keyword">map</span>[<span class="keyword">string</span>]InitFunc&#123;&#125;</span><br><span class="line">	controllers[<span class="string">&quot;endpoint&quot;</span>] = startEndpointController</span><br><span class="line">	controllers[<span class="string">&quot;endpointslice&quot;</span>] = startEndpointSliceController</span><br><span class="line">	controllers[<span class="string">&quot;endpointslicemirroring&quot;</span>] = startEndpointSliceMirroringController</span><br><span class="line">	controllers[<span class="string">&quot;replicationcontroller&quot;</span>] = startReplicationController</span><br><span class="line">	controllers[<span class="string">&quot;podgc&quot;</span>] = startPodGCController</span><br><span class="line">	controllers[<span class="string">&quot;resourcequota&quot;</span>] = startResourceQuotaController</span><br><span class="line">	controllers[<span class="string">&quot;namespace&quot;</span>] = startNamespaceController</span><br><span class="line">	controllers[<span class="string">&quot;serviceaccount&quot;</span>] = startServiceAccountController</span><br><span class="line">	controllers[<span class="string">&quot;garbagecollector&quot;</span>] = startGarbageCollectorController</span><br><span class="line">	controllers[<span class="string">&quot;daemonset&quot;</span>] = startDaemonSetController</span><br><span class="line">	controllers[<span class="string">&quot;job&quot;</span>] = startJobController</span><br><span class="line">	controllers[<span class="string">&quot;deployment&quot;</span>] = startDeploymentController</span><br><span class="line">	controllers[<span class="string">&quot;replicaset&quot;</span>] = startReplicaSetController</span><br><span class="line">	controllers[<span class="string">&quot;horizontalpodautoscaling&quot;</span>] = startHPAController</span><br><span class="line">	controllers[<span class="string">&quot;disruption&quot;</span>] = startDisruptionController</span><br><span class="line">	controllers[<span class="string">&quot;statefulset&quot;</span>] = startStatefulSetController</span><br><span class="line">	controllers[<span class="string">&quot;cronjob&quot;</span>] = startCronJobController</span><br><span class="line">	controllers[<span class="string">&quot;csrsigning&quot;</span>] = startCSRSigningController</span><br><span class="line">	controllers[<span class="string">&quot;csrapproving&quot;</span>] = startCSRApprovingController</span><br><span class="line">	controllers[<span class="string">&quot;csrcleaner&quot;</span>] = startCSRCleanerController</span><br><span class="line">	controllers[<span class="string">&quot;ttl&quot;</span>] = startTTLController</span><br><span class="line">	controllers[<span class="string">&quot;bootstrapsigner&quot;</span>] = startBootstrapSignerController</span><br><span class="line">	controllers[<span class="string">&quot;tokencleaner&quot;</span>] = startTokenCleanerController</span><br><span class="line">	controllers[<span class="string">&quot;nodeipam&quot;</span>] = startNodeIpamController</span><br><span class="line">	controllers[<span class="string">&quot;nodelifecycle&quot;</span>] = startNodeLifecycleController</span><br><span class="line">	<span class="keyword">if</span> loopMode == IncludeCloudLoops &#123;</span><br><span class="line">		controllers[<span class="string">&quot;service&quot;</span>] = startServiceController</span><br><span class="line">		controllers[<span class="string">&quot;route&quot;</span>] = startRouteController</span><br><span class="line">		controllers[<span class="string">&quot;cloud-node-lifecycle&quot;</span>] = startCloudNodeLifecycleController</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> volume controller into the IncludeCloudLoops only set.</span></span><br><span class="line">	&#125;</span><br><span class="line">	controllers[<span class="string">&quot;persistentvolume-binder&quot;</span>] = startPersistentVolumeBinderController</span><br><span class="line">	controllers[<span class="string">&quot;attachdetach&quot;</span>] = startAttachDetachController</span><br><span class="line">	controllers[<span class="string">&quot;persistentvolume-expander&quot;</span>] = startVolumeExpandController</span><br><span class="line">	controllers[<span class="string">&quot;clusterrole-aggregation&quot;</span>] = startClusterRoleAggregrationController</span><br><span class="line">	controllers[<span class="string">&quot;pvc-protection&quot;</span>] = startPVCProtectionController</span><br><span class="line">	controllers[<span class="string">&quot;pv-protection&quot;</span>] = startPVProtectionController</span><br><span class="line">	controllers[<span class="string">&quot;ttl-after-finished&quot;</span>] = startTTLAfterFinishedController</span><br><span class="line">	controllers[<span class="string">&quot;root-ca-cert-publisher&quot;</span>] = startRootCACertPublisher</span><br><span class="line">	controllers[<span class="string">&quot;ephemeral-volume&quot;</span>] = startEphemeralVolumeController</span><br><span class="line">	<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(genericfeatures.APIServerIdentity) &amp;&amp;</span><br><span class="line">		utilfeature.DefaultFeatureGate.Enabled(genericfeatures.StorageVersionAPI) &#123;</span><br><span class="line">		controllers[<span class="string">&quot;storage-version-gc&quot;</span>] = startStorageVersionGCController</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> controllers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="主线脉络"><a href="#主线脉络" class="headerlink" title="主线脉络"></a>主线脉络</h2><p>​    以DeploymentController为例，代码的主线脉络如下图：</p>
<p><img src="Kube-Controller-Manager.png" alt="Kube-Controller-Manager"></p>
<h2 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h2><p>​    这部分主要就阅读过程中一些关键的部分进行分析。</p>
<h3 id="SharedInformers"><a href="#SharedInformers" class="headerlink" title="SharedInformers"></a>SharedInformers</h3><p>​    从上图的主线脉络中可以看出，Controller Manager管理了许多的Controller。不用的Controller负责处理不同工作负载的调谐逻辑，但是他们所使用到的Informer具有共性，同一种资源可能被多个Controller所关注，所以源码中将Infromer的初始化，放在了Controller的实现之外，通过factory中的map数据结构进行去重，然后在Controller Manager的主逻辑中，将Informer启动起来，并且在每个Controller正式执行调谐之前，就需要等待与之关联的infromer资源的数据同步完成。从而保证与Etcd中数据的一致性。</p>
<p>​    sharedInformer的数据结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> sharedIndexInformer <span class="keyword">struct</span> &#123;</span><br><span class="line">	indexer    Indexer</span><br><span class="line">	controller Controller</span><br><span class="line"></span><br><span class="line">	processor             *sharedProcessor</span><br><span class="line">	cacheMutationDetector MutationDetector</span><br><span class="line"></span><br><span class="line">	listerWatcher ListerWatcher</span><br><span class="line"></span><br><span class="line">	...省略...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    其中indexer是本地缓存，processor是用户事件注册、触发的实现。</p>
<h3 id="关键流程"><a href="#关键流程" class="headerlink" title="关键流程"></a>关键流程</h3><h4 id="ListWatch"><a href="#ListWatch" class="headerlink" title="ListWatch"></a>ListWatch</h4><p>​    先来看一下Delta FIFO的数据结构</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DeltaFIFO <span class="keyword">struct</span> &#123;</span><br><span class="line">	...省略...</span><br><span class="line"></span><br><span class="line">	<span class="comment">// `items` maps a key to a Deltas.</span></span><br><span class="line">	<span class="comment">// Each such Deltas has at least one Delta.</span></span><br><span class="line">	items <span class="keyword">map</span>[<span class="keyword">string</span>]Deltas</span><br><span class="line"></span><br><span class="line">	<span class="comment">// `queue` maintains FIFO order of keys for consumption in Pop().</span></span><br><span class="line">	<span class="comment">// There are no duplicates in `queue`.</span></span><br><span class="line">	<span class="comment">// A key is in `queue` if and only if it is in `items`.</span></span><br><span class="line">	queue []<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// populated is true if the first batch of items inserted by Replace() has been populated</span></span><br><span class="line">	<span class="comment">// or Delete/Add/Update/AddIfNotPresent was called first.</span></span><br><span class="line">	populated <span class="keyword">bool</span></span><br><span class="line">	<span class="comment">// initialPopulationCount is the number of items inserted by the first call of Replace()</span></span><br><span class="line">	initialPopulationCount <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// keyFunc is used to make the key used for queued item</span></span><br><span class="line">	<span class="comment">// insertion and retrieval, and should be deterministic.</span></span><br><span class="line">	keyFunc KeyFunc</span><br><span class="line"></span><br><span class="line">	<span class="comment">// knownObjects list keys that are &quot;known&quot; --- affecting Delete(),</span></span><br><span class="line">	<span class="comment">// Replace(), and Resync()</span></span><br><span class="line">	knownObjects KeyListerGetter</span><br><span class="line"></span><br><span class="line">	...省略...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    其中knownObjects对应的就是indexer的数据结构。</p>
<p>​    根据上图中的数据流程，先来看一下Informer是如何将数据放入Delta FiFO中的，也即是图中序号①所标注的流程。</p>
<p>​    在2.1主线脉络中，从controllerContext.InformerFactory.Start()开始循环执行注册的SharedInformer的Run方法。 通过Reflector首先进行数据的全量同步，然后根据最新的版本号watch资源的变化，监听到数据变化的事件后，将数据放到Delta FIFO中。</p>
<p>​    在Reflector的数据处理中，还有一步Rsync的操作，主要负责将indexer中的数据重新同步会Delta FIFO中，重新触发处理事件。</p>
<p>​    Reflector的数据结构如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Reflector <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// name identifies this reflector. By default it will be a file:line if possible.</span></span><br><span class="line">	name <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    ...省略...</span><br><span class="line">    </span><br><span class="line">	store Store</span><br><span class="line">	<span class="comment">// listerWatcher is used to perform lists and watches.</span></span><br><span class="line">	listerWatcher ListerWatcher</span><br><span class="line"></span><br><span class="line">	resyncPeriod time.Duration</span><br><span class="line">	<span class="comment">// ShouldResync is invoked periodically and whenever it returns `true` the Store&#x27;s Resync operation is invoked</span></span><br><span class="line">	</span><br><span class="line">    ...省略...</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// lastSyncResourceVersion is the resource version token last</span></span><br><span class="line">	<span class="comment">// observed when doing a sync with the underlying store</span></span><br><span class="line">	<span class="comment">// it is thread safe, but not synchronized with the underlying store</span></span><br><span class="line">	lastSyncResourceVersion <span class="keyword">string</span></span><br><span class="line">	</span><br><span class="line">    ...省略...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    其中store对应的就是Delta FIFO的数据结构。</p>
<h4 id="本地缓存数据更新"><a href="#本地缓存数据更新" class="headerlink" title="本地缓存数据更新"></a>本地缓存数据更新</h4><p>​    图中序号②本地缓存更新，发生在controller实际从Delta FIFO中pop数据的时候，pop出来的数据首先触发SharedInformer的HandleDeltas，根据事件的类型对indexer进行同步更新，然后通过processor.distribute触发注册的用户自定义的增删改事件，对应图中序号③的方法。</p>
<h4 id="用户事件注册"><a href="#用户事件注册" class="headerlink" title="用户事件注册"></a>用户事件注册</h4><p>​    在往SharedInformerFactory中注册完SharedInformer后，通过AddEventHandler往SharedInformer中的processor中注册用户回调事件。同时启动对应的run和pop处理方法，负责接收notification触发对应的处理过程。而notification的正是由processor.distribute方法在处理Delta FIFO数据的时候，根据不同的事件类型产生的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> sharedProcessor <span class="keyword">struct</span> &#123;</span><br><span class="line">	listenersStarted <span class="keyword">bool</span></span><br><span class="line">	listenersLock    sync.RWMutex</span><br><span class="line">	listeners        []*processorListener</span><br><span class="line">	syncingListeners []*processorListener</span><br><span class="line">	clock            clock.Clock</span><br><span class="line">	wg               wait.Group</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="indexer例子"><a href="#indexer例子" class="headerlink" title="indexer例子"></a>indexer例子</h3><p>​    通过源码分析，知道indexer最终是由一个threadSafeMap来实现的，其数据结构如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> threadSafeMap <span class="keyword">struct</span> &#123;</span><br><span class="line">	lock  sync.RWMutex</span><br><span class="line">	items <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// indexers maps a name to an IndexFunc</span></span><br><span class="line">	indexers Indexers</span><br><span class="line">	<span class="comment">// indices maps a name to an Index</span></span><br><span class="line">	indices Indices</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    可以看到除了一个用于存放数据的map，还有两个属性用于协助快速的读取数据。那么这两个属性是如何工作的呢，通过一个例子是用来看一下内部的数据组成：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   v1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">   metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">   <span class="string">&quot;k8s.io/client-go/tools/cache&quot;</span></span><br><span class="line">   <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UsersIndexFunc</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">([]<span class="keyword">string</span>, error)</span></span>&#123;</span><br><span class="line">   pod := obj.(*v1.Pod)</span><br><span class="line">   usersString := pod.Annotations[<span class="string">&quot;users&quot;</span>]</span><br><span class="line">   <span class="keyword">return</span> strings.Split(usersString, <span class="string">&quot;,&quot;</span>), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">   index := cache.NewIndexer(cache.MetaNamespaceKeyFunc, cache.Indexers&#123;</span><br><span class="line">      <span class="string">&quot;byUser&quot;</span>: UsersIndexFunc,</span><br><span class="line">   &#125;)</span><br><span class="line"></span><br><span class="line">   pod1 := &amp;v1.Pod&#123;</span><br><span class="line">      ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">         Name: <span class="string">&quot;pod1&quot;</span>,</span><br><span class="line">         Annotations: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">            <span class="string">&quot;users&quot;</span>: <span class="string">&quot;ernie,bert&quot;</span>,</span><br><span class="line">         &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   pod2:= &amp;v1.Pod&#123;</span><br><span class="line">      ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">         Name: <span class="string">&quot;pod2&quot;</span>,</span><br><span class="line">         Annotations: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">            <span class="string">&quot;users&quot;</span>: <span class="string">&quot;bert,oscar&quot;</span>,</span><br><span class="line">         &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   pod3 := &amp;v1.Pod&#123;</span><br><span class="line">      ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">         Name: <span class="string">&quot;pod3&quot;</span>,</span><br><span class="line">         Annotations: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">            <span class="string">&quot;users&quot;</span>: <span class="string">&quot;ernie,elmo&quot;</span>,</span><br><span class="line">         &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   index.Add(pod1)</span><br><span class="line">   index.Add(pod2)</span><br><span class="line">   index.Add(pod3)</span><br><span class="line"></span><br><span class="line">   pods, err := index.ByIndex(<span class="string">&quot;byUser&quot;</span>, <span class="string">&quot;ernie&quot;</span>)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="built_in">panic</span>(err)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> _, v := <span class="keyword">range</span> pods &#123;</span><br><span class="line">      fmt.Println(v.(*v1.Pod).Name)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    通过分析上述代码，发现</p>
<p>​    1）Items是本地缓存的map[string]interface{}。</p>
<p>​    2）indexers注册的是索引器名称和对应的方法（方法parse对象返回查询时候使用的键值列表）。</p>
<p>​    3）indices是根据注册的索引器，重新组织缓存数据：</p>
<p>​          第一层使用索引器名称，第二层使用用查询的键值作为key，缓存的数据组装成slice作为value。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2021/10/16/Kubernetes-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90kube-scheduler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/16/Kubernetes-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90kube-scheduler/" class="post-title-link" itemprop="url">Kubernetes-源码分析kube-scheduler</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-16 00:00:00" itemprop="dateCreated datePublished" datetime="2021-10-16T00:00:00+08:00">2021-10-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​    Kube-Scheduler负责Pod的节点分配，通过预选和优选两个过程，为Pod选择一个合适的节点，预选和优选过程中包含很多内置的调度算法，在实际的场景中，也可能根据具体的业务场景基于原有的调度器进行扩展，或者完全重新编写一个新的调度器，Kubernetes是如何进行节点调度的，又是如何支持调度器扩展的。</p>
<h1 id="组件介绍"><a href="#组件介绍" class="headerlink" title="组件介绍"></a>组件介绍</h1><p>​    Kube-Scheduler依托第二代调度框架，提供了灵活的配置方式和扩展方法，可以作用在调度过程中各个环境，乃至最后的绑定过程。用户可以根据自己的业务场景灵活搭配。</p>
<p>​    Kube-scheduler的调度框架，因为要支持用户自定义的配置和扩展，具有一定的抽象度，阅读起来有些晦涩，本文侧重于整体的调度流程实现以及与用户自定义扩展的契合。就一些迷惑点，进行分析。</p>
<blockquote>
<p><strong>特别说明</strong></p>
<p>​    本次源码分析，主要为了理清Kubernetes核心组件的整体实现思路，会着重分析一些看源码时候比较迷惑的点， 但并不会局限于全部的实现细节，也不局限于某个版本，因此代码的原本是直接使用下面命令clone的Github上最新代码</p>
<p>​    git clone –depth=1 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes.git%E3%80%82">https://github.com/kubernetes/kubernetes.git。</a></p>
<p>​    笔者认为，也许代码的实现细节会随着版本的更迭，有所更新，但核心的实现思路并不会有太大变化，只要理清了这些核心的实现，在工作学习中，结合具体场景具体问题再做具体分析，再返回头来深究一些细节，也是会事半功倍的。</p>
<p>​    源码分析不是一蹉而就的，需要反复阅读，反复考究。温故而知新。</p>
</blockquote>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>​    下图使用知乎大神的帖子，清晰展示了整个调度过程涉及到的点，有助于理解整个调度框架的整体过程。</p>
<p><img src="schedule-framework.jpg" alt="schedule-framework"></p>
<h2 id="主线脉络"><a href="#主线脉络" class="headerlink" title="主线脉络"></a>主线脉络</h2><p>​    下图是根据代码整理的调度器的方法调用主干过程，其中黄色标签的三个点，因为篇幅原因，未能在本图上继续展开，将在2.2中予以说明。</p>
<p>​    <img src="Kube-Scheduler.png" alt="Kube-Scheduler"></p>
<p>​    上述代码的主干调用关系，很难看出调度器工作过程中涉及到的主要组件和它们之间的关系，在《Kubernetes源码剖析》书中，有一副图片，整体上展示了整个调度过程，各组件之间的关系。这里直接引用过来供参考。</p>
<p><img src="schedule-architecture.png" alt="schedule-architecture"></p>
<p>​    </p>
<p>​    下面将详细解释笔者阅读源码时一些比较困惑的点，结合这些细节的点，来理解整个调度过程和各组件之间的协作。</p>
<h2 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h2><h3 id="调度算法（插件）"><a href="#调度算法（插件）" class="headerlink" title="调度算法（插件）"></a>调度算法（插件）</h3><p>​    调度器会默认提供一些调度算法，并通过配置的方式供用户扩展，最后这些调度算法会应用在调度框架中。</p>
<h4 id="默认配置"><a href="#默认配置" class="headerlink" title="默认配置"></a>默认配置</h4><p>​    调度器通过KubeSchedulerConfiguration提供配置选项，用户可以在调度器的命令行中使用–config指定对应的资源清单。</p>
<p>​    下面是在Kubernetes v1.21.5使用–write-config-to默认导出的一份配置资源文件，这里不涉及任何用户自定义的部分，先来看一下有个直观的认识。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">clientConnection:</span></span><br><span class="line">  <span class="attr">acceptContentTypes:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">burst:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">contentType:</span> <span class="string">application/vnd.kubernetes.protobuf</span></span><br><span class="line">  <span class="attr">kubeconfig:</span> <span class="string">/etc/kubernetes/scheduler.conf</span></span><br><span class="line">  <span class="attr">qps:</span> <span class="number">50</span></span><br><span class="line"><span class="attr">enableContentionProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enableProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:10251</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeSchedulerConfiguration</span></span><br><span class="line"><span class="attr">leaderElection:</span></span><br><span class="line">  <span class="attr">leaderElect:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">leaseDuration:</span> <span class="string">15s</span></span><br><span class="line">  <span class="attr">renewDeadline:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">resourceLock:</span> <span class="string">leases</span></span><br><span class="line">  <span class="attr">resourceName:</span> <span class="string">kube-scheduler</span></span><br><span class="line">  <span class="attr">resourceNamespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">retryPeriod:</span> <span class="string">2s</span></span><br><span class="line"><span class="attr">metricsBindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:10251</span></span><br><span class="line"><span class="attr">parallelism:</span> <span class="number">16</span></span><br><span class="line"><span class="attr">percentageOfNodesToScore:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">podInitialBackoffSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">podMaxBackoffSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">profiles:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">pluginConfig:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">DefaultPreemptionArgs</span></span><br><span class="line">      <span class="attr">minCandidateNodesAbsolute:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">minCandidateNodesPercentage:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">DefaultPreemption</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line">      <span class="attr">hardPodAffinityWeight:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">InterPodAffinityArgs</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">InterPodAffinity</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">NodeAffinityArgs</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">NodeAffinity</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">NodeResourcesFitArgs</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">NodeResourcesFit</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">NodeResourcesLeastAllocatedArgs</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">NodeResourcesLeastAllocated</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line">      <span class="attr">defaultingType:</span> <span class="string">System</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">PodTopologySpreadArgs</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">PodTopologySpread</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line">      <span class="attr">bindTimeoutSeconds:</span> <span class="number">600</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">VolumeBindingArgs</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">VolumeBinding</span></span><br><span class="line">  <span class="attr">plugins:</span></span><br><span class="line">    <span class="attr">bind:</span></span><br><span class="line">      <span class="attr">enabled:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DefaultBinder</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">filter:</span></span><br><span class="line">      <span class="attr">enabled:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeUnschedulable</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeName</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TaintToleration</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeAffinity</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodePorts</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeResourcesFit</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">VolumeRestrictions</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EBSLimits</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GCEPDLimits</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeVolumeLimits</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AzureDiskLimits</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">VolumeBinding</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">VolumeZone</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PodTopologySpread</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">InterPodAffinity</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">permit:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">postBind:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">postFilter:</span></span><br><span class="line">      <span class="attr">enabled:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DefaultPreemption</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">preBind:</span></span><br><span class="line">      <span class="attr">enabled:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">VolumeBinding</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">preFilter:</span></span><br><span class="line">      <span class="attr">enabled:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeResourcesFit</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodePorts</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PodTopologySpread</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">InterPodAffinity</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">VolumeBinding</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeAffinity</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">preScore:</span></span><br><span class="line">      <span class="attr">enabled:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">InterPodAffinity</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PodTopologySpread</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TaintToleration</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeAffinity</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">queueSort:</span></span><br><span class="line">      <span class="attr">enabled:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PrioritySort</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">reserve:</span></span><br><span class="line">      <span class="attr">enabled:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">VolumeBinding</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">score:</span></span><br><span class="line">      <span class="attr">enabled:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeResourcesBalancedAllocation</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ImageLocality</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">InterPodAffinity</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeResourcesLeastAllocated</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeAffinity</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodePreferAvoidPods</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">10000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PodTopologySpread</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TaintToleration</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br></pre></td></tr></table></figure>



<p>​    在这个实际的集群中，看一下kube-scheduler的启动参数</p>
<p><img src="kube-shceduler-start-cmd.png" alt="kube-shceduler-start-cmd"></p>
<p>​    实际指定的配置内容如下：</p>
<p><img src="kube-scheduler-config.png" alt="kube-scheduler-config"></p>
<p>​    </p>
<blockquote>
<p><strong>重点放在profiles这个字段上，这是一个数组，用户可以定义多个profile然后在pod中指定调度器的名称来选择使用对用的调度器对其进行调度，如果不指定，默认使用default-scheduler这一默认调度器。但一般情况下，如果集群中存在多个调度器，需要考虑相互之间的资源隔离问题。</strong></p>
</blockquote>
<p>​    最终生成的使用配置对象与启动时指定的对象相比，多了许多内容，这里重点关注profiles中调度算法如何填充进去的，通过源码来看一下。</p>
<p><img src="scheduler-plugins.png" alt="scheduler-plugins"></p>
<p>​    最后将不同类型配置对应的初始化方法注册在defaulterFuncs这个变量中，而调度器初始化的代码中，①的黄色标签最后的代码正是从这个变量中，根据类型获取到初始化方法然后执行的。</p>
<blockquote>
<p><strong>这里用户自定义配置与默认配置merge的过程，略过不计。</strong></p>
</blockquote>
<h4 id="注册调度框架"><a href="#注册调度框架" class="headerlink" title="注册调度框架"></a>注册调度框架</h4><p>​    在2.1调度器代码的主线脉络的图中，实际的调度过程，大量从frameworkImpl对象中获取实例化的调度算法对象，然后执行相应的过滤，从frameworkImpl这个对象的定义中，找到了关于各个调度点的调度器集合的定义（如下），那么这些实例化的调度算法对象，是如何将自己注册给调度框架的呢？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> frameworkImpl <span class="keyword">struct</span> &#123;</span><br><span class="line">    ...省略...</span><br><span class="line">    </span><br><span class="line">	queueSortPlugins     []framework.QueueSortPlugin</span><br><span class="line">	preFilterPlugins     []framework.PreFilterPlugin</span><br><span class="line">	filterPlugins        []framework.FilterPlugin</span><br><span class="line">	postFilterPlugins    []framework.PostFilterPlugin</span><br><span class="line">	preScorePlugins      []framework.PreScorePlugin</span><br><span class="line">	scorePlugins         []framework.ScorePlugin</span><br><span class="line">	reservePlugins       []framework.ReservePlugin</span><br><span class="line">	preBindPlugins       []framework.PreBindPlugin</span><br><span class="line">	bindPlugins          []framework.BindPlugin</span><br><span class="line">	postBindPlugins      []framework.PostBindPlugin</span><br><span class="line">	permitPlugins        []framework.PermitPlugin</span><br><span class="line">    </span><br><span class="line">	...省略...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    在2.2.1.1中生成了调度器的配置文件，最终放到了内置的资源对象KubeSchedulerConfiguration中，这里重点关注Profiles和Extenders两个slice，这都是调度器的扩展方式。</p>
<blockquote>
<p>Extenders的扩展，类似于webhook的方式，是发送请求到另一个服务，代码不在调度器的主逻辑中，松耦合，但是因为不是本地方法调用，性能要差一些。</p>
</blockquote>
<p>​    基于以上，看一下调度算法实例在调度框架的注册。</p>
<p><img src="schduler-plugins-instance.png" alt="schduler-plugins-instance"></p>
<h3 id="调度队列、缓存"><a href="#调度队列、缓存" class="headerlink" title="调度队列、缓存"></a>调度队列、缓存</h3><p>​    先来看一下调度器的数据结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">type Scheduler struct &#123;</span><br><span class="line">	&#x2F;&#x2F; It is expected that changes made via SchedulerCache will be observed</span><br><span class="line">	&#x2F;&#x2F; by NodeLister and Algorithm.</span><br><span class="line">	SchedulerCache internalcache.Cache</span><br><span class="line"></span><br><span class="line">	Algorithm ScheduleAlgorithm</span><br><span class="line"></span><br><span class="line">	Extenders []framework.Extender</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; NextPod should be a function that blocks until the next pod</span><br><span class="line">	&#x2F;&#x2F; is available. We don&#39;t use a channel for this, because scheduling</span><br><span class="line">	&#x2F;&#x2F; a pod may take some amount of time and we don&#39;t want pods to get</span><br><span class="line">	&#x2F;&#x2F; stale while they sit in a channel.</span><br><span class="line">	NextPod func() *framework.QueuedPodInfo</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Error is called if there is an error. It is passed the pod in</span><br><span class="line">	&#x2F;&#x2F; question, and the error</span><br><span class="line">	Error func(*framework.QueuedPodInfo, error)</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Close this to shut down the scheduler.</span><br><span class="line">	StopEverything &lt;-chan struct&#123;&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; SchedulingQueue holds pods to be scheduled</span><br><span class="line">	SchedulingQueue internalqueue.SchedulingQueue</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Profiles are the scheduling profiles.</span><br><span class="line">	Profiles profile.Map</span><br><span class="line"></span><br><span class="line">	client clientset.Interface</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    在这里面重点关注调度队列SchedulingQueue和调度缓存SchedulerCache。</p>
<pre><code> SchedulingQueue是PriorityQueue的实例化对象，其中有三个队列：
</code></pre>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PriorityQueue <span class="keyword">struct</span> &#123;</span><br><span class="line">   ...省略...  </span><br><span class="line"></span><br><span class="line">   <span class="comment">// activeQ is heap structure that scheduler actively looks at to find pods to</span></span><br><span class="line">   <span class="comment">// schedule. Head of heap is the highest priority pod.</span></span><br><span class="line">   activeQ *heap.Heap</span><br><span class="line">   <span class="comment">// podBackoffQ is a heap ordered by backoff expiry. Pods which have completed backoff</span></span><br><span class="line">   <span class="comment">// are popped from this heap before the scheduler looks at activeQ</span></span><br><span class="line">   podBackoffQ *heap.Heap</span><br><span class="line">   <span class="comment">// unschedulableQ holds pods that have been tried and determined unschedulable.</span></span><br><span class="line">   unschedulableQ *UnschedulablePodsMap</span><br><span class="line">   </span><br><span class="line">   ...省略...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    SchedulerCache的数据结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">type schedulerCache struct &#123;</span><br><span class="line">   stop   &lt;-chan struct&#123;&#125;</span><br><span class="line">   ttl    time.Duration</span><br><span class="line">   period time.Duration</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; This mutex guards all fields within this cache struct.</span><br><span class="line">   mu sync.RWMutex</span><br><span class="line">   &#x2F;&#x2F; a set of assumed pod keys.</span><br><span class="line">   &#x2F;&#x2F; The key could further be used to get an entry in podStates.</span><br><span class="line">   assumedPods sets.String</span><br><span class="line">   &#x2F;&#x2F; a map from pod key to podState.</span><br><span class="line">   podStates map[string]*podState</span><br><span class="line">   nodes     map[string]*nodeInfoListItem</span><br><span class="line">   &#x2F;&#x2F; headNode points to the most recently updated NodeInfo in &quot;nodes&quot;. It is the</span><br><span class="line">   &#x2F;&#x2F; head of the linked list.</span><br><span class="line">   headNode *nodeInfoListItem</span><br><span class="line">   nodeTree *nodeTree</span><br><span class="line">   &#x2F;&#x2F; A map from image name to its imageState.</span><br><span class="line">   imageStates map[string]*imageState</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    在调度的主逻辑中，通过podInfo := sched.NextPod() 从调度队列中拿到了下一个待调度的Pod，然后执行调度过程，从调度缓存中拿到节点的snapshot，然后执行对应的调度算法，下面来看一下调度队列，调度缓存的数据是如何维护的。</p>
<p><img src="scheduler-cache-queue.png" alt="scheduler-cache-queue"></p>
<p>​    当监听到Node/Pod的事件后，需要更新缓存数据和调度队列。这其中需要注意一些点：</p>
<p>​    1）如果事件可能会让新的节点调度起来（例如新增Node/Pod调度到新的节点亲和性发生变化）那么需要从unschedulableQ/backoffQ队列新加入到调度队列activeQ中。</p>
<p>​    2）SchedulerCache中维护了一个node的双向链表，每次会将最新更新的Node移动到链表的头部。</p>
<p>​    3）资源事件的回调处理。</p>
<h1 id="知识扩展"><a href="#知识扩展" class="headerlink" title="知识扩展"></a>知识扩展</h1><p>​    在阅读调度器的源码过程中，重点关注了调度框架的实现，以及调度框架如何让用户更容易地扩展，目前了解到的一些关于调度框架的扩展的场景，包括：</p>
<p>​    1）腾讯开源的GaiaGPU中的GPU Scheduler组件。</p>
<p>​           <a target="_blank" rel="noopener" href="https://pokerfacesad.github.io/2020/02/07/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E3%80%8AGaiaGPU%20Sharing%20GPUs%20in%20Container%20Clouds%E3%80%8B/">论文笔记《GaiaGPU：Sharing GPUs in Container Clouds》</a>。</p>
<p>​    2）大数据的一些跑批任务，使用Kubernetes进行资源调度，需要考虑按Group调度和资源的碎片化问题。这里面也涉及到了Serveless的一些技术，使用Virtual Kubelet在Serverless平台进行弹性伸缩。</p>
<p>​    目前了解到的调度器扩展主要有：</p>
<p>​    1）通过配置文件改变默认的default-scheduler的参数。</p>
<p>​    2）自定义自己的调度器。</p>
<p>​    3）使用extender或者是plugins对调度器进行扩展。extender类似于webhook的方式，是通过远程调用第三方服务来执行调度判定，性能较差，未来可能会被废弃。而plugins的方式，使用本地方法调用，性能上有优势，但是因为需要重新编译调度器，耦合调度器的代码，在Kubernetes版本升级兼容可能存在问题。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2021/10/03/Kubernetes-Watch%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/03/Kubernetes-Watch%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Kubernetes-Watch使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-03 00:00:00" itemprop="dateCreated datePublished" datetime="2021-10-03T00:00:00+08:00">2021-10-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h1><p>​    在基于Kubernetes的业务方案中，经常需要将Kubernetes中的资源对象，与实际的业务相结合，做一些业务的逻辑。一般业务的数据存放在业务系统的关系型数据库（例如mysql），而Kubernetes的资源对象存放在etcd中，虽然kubernetes的资源对象提供了类似annotation、labels这样的简单的保存/查询业务数据的字段，但是不可能将系统所有相关的业务数据都放到etcd中，这样会加重etcd的负担，降低Kubenetes的性能。</p>
<p>​    所以，传统的做法，一般是采用定时任务，将Kubernetes与业务相关的数据同步会业务数据库中，这种定时同步任务是比较稳妥的方式，但是在时效性方面不尽如人意，对于一些对实时性有要求的业务操作影响较大。</p>
<p>​    本文通过调研Kubernetes的Watch API。采用List Watch机制，将数据异步同步到业务的数据库中，提高数据同步的实时性。</p>
<h1 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h1><h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><p><img src="design.png" alt="design"></p>
<p>​    本文主要使用Golang编写实现，根据上图，主要包含三个主要组件：</p>
<p>​    1）watcher</p>
<p>​          负责Watch K8S中的API 资源对象。将收到的数据，放到queue中。</p>
<p>​    2）worker</p>
<p>​          负责消费queue中的数据，将数据同步到业务数据库中。</p>
<p>​    3）queue</p>
<p>​           负责解耦watcher和worker。</p>
<h3 id="关键点"><a href="#关键点" class="headerlink" title="关键点"></a>关键点</h3><h3 id="高可用（选主）"><a href="#高可用（选主）" class="headerlink" title="高可用（选主）"></a>高可用（选主）</h3><p>​    参考kubernetes的controller-manager组件设计，使用k8s.io/client-go/tools/leaderelection在多实例的情况下，进行选主，保证同一时刻最多只有一个实例在正常工作。其它实例stand by。一旦主实例失败，其它实例通过竞争锁，成为新的leader。</p>
<p>​    核心代码如下，锁也可以使用endpoint、configMap。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">lock := &amp;resourcelock.LeaseLock&#123;</span><br><span class="line">    LeaseMeta: metav1.ObjectMeta&#123;</span><br><span class="line">        Name: leaseLockName,</span><br><span class="line">        Namespace: leaseLockNamespace,</span><br><span class="line">    &#125;,</span><br><span class="line">    Client: client.CoordinationV1(),</span><br><span class="line">    LockConfig: resourcelock.ResourceLockConfig&#123;</span><br><span class="line">        Identity: id,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">leaderelection.RunOrDie(ctx, leaderelection.LeaderElectionConfig&#123;</span><br><span class="line">    Lock: lock,</span><br><span class="line">    ReleaseOnCancel: <span class="literal">true</span>,</span><br><span class="line">    LeaseDuration: <span class="number">15</span> * time.Second,</span><br><span class="line">    RenewDeadline: <span class="number">10</span> * time.Second,</span><br><span class="line">    RetryPeriod: <span class="number">2</span> * time.Second,</span><br><span class="line">    Callbacks: leaderelection.LeaderCallbacks&#123;</span><br><span class="line">        OnStartedLeading: <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">            Run(ctx)</span><br><span class="line">        &#125;,</span><br><span class="line">        OnStoppedLeading: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            cancel()</span><br><span class="line">            klog.Infof(<span class="string">&quot;leader lost: %s&quot;</span>, id)</span><br><span class="line">            os.Exit(<span class="number">0</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        OnNewLeader: <span class="function"><span class="keyword">func</span><span class="params">(identity <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">            <span class="comment">// we&#x27;re notified when new leader elected</span></span><br><span class="line">            <span class="keyword">if</span> identity == id &#123;</span><br><span class="line">                <span class="comment">// I just got the lock</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            klog.Infof(<span class="string">&quot;new leader elected: %s&quot;</span>, identity)</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h3><p>​    根据controller-manager中的实现。Kubernetes的List Watch机制，需要配合全量数据同步，和增量的依据resourceVersion进行Watch。</p>
<h4 id="全量同步"><a href="#全量同步" class="headerlink" title="全量同步"></a>全量同步</h4><p>​    这里需要通过List方法，首先将集群中对象全部查询出来，做全量同步。具体业务场景中，可以全量取出最新的数据，对已存的历史数据进行增量的对比修正，而不要采取全量删除重建的方式，减小对正在进行的业务的影响。</p>
<p>​    全量数据同步后，需要记录资源的最新resourceVersion，以备传入Watch中，利用resoureVersion单调递增的特性，将全量同步之后的新增数据操作，全部交由Watch来处理。保证不丢数据操作，保持数据一致性。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">resourceVersion, err := fullSync()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">workQueue := workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), clusterInfo.Name + <span class="string">&quot;@namespace&quot;</span>)</span><br><span class="line"></span><br><span class="line">startWatcher(ctx, clusterInfo.Config, resourceVersion, &amp;workQueue)</span><br><span class="line"></span><br><span class="line"><span class="comment">//multi workers</span></span><br><span class="line"><span class="keyword">for</span> i:=<span class="number">1</span>; i&lt;= clusterInfo.WorkerNum; i++ &#123;</span><br><span class="line">    startWorker(ctx, <span class="string">&quot;workers-&quot;</span> + strconv.Itoa(i) + <span class="string">&quot;@&quot;</span> + clusterInfo.Name, &amp;workQueue)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="失败重建"><a href="#失败重建" class="headerlink" title="失败重建"></a>失败重建</h4><p>​    Watch是不稳定的，正常的长时间Watch或者发生异常，会导致Watch关闭，需要保证Watch操作的自动重建，可以通过简单粗暴的死循环的方式，然而在k8s.io/client-go/tools/watch包中提供关于Watch失败重建的封装，在里面实现了记录最后一次Watch到数据的resourceVersion，在重建的时候，传入以保证不丢失数据。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">rw, err := toolswatch.NewRetryWatcher(initialResourceVersion, &amp;cache.ListWatch&#123;</span><br><span class="line">    WatchFunc: <span class="function"><span class="keyword">func</span><span class="params">(options metav1.ListOptions)</span> <span class="params">(watch.Interface, error)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> client.CoreV1().Namespaces().Watch(ctx, metav1.ListOptions&#123;&#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    klog.Errorf(<span class="string">&quot;watch namespace error: %s&quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> rw.Stop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>&#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> event, ok := &lt;-rw.ResultChan():</span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            klog.Info(<span class="string">&quot;result chan has been closed&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        (*workQueue).Add(event)</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">        <span class="comment">//grace shutdown</span></span><br><span class="line">        klog.Info(<span class="string">&quot;gracefully shutdown&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">case</span> &lt;-rw.Done():</span><br><span class="line">        klog.Info(<span class="string">&quot;retry watcher has been stopped&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;, <span class="number">200</span>*time.Millisecond, ctx.Done())</span><br></pre></td></tr></table></figure>

<p>​    这里使用了一个工作队列来解耦负责数据库操作的worker和负责Watch数据的Watcher。因为二者处理速度的不匹配，可以通过开启多个Worker来加快处理进度。</p>
<h3 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h3><h4 id="幂等性"><a href="#幂等性" class="headerlink" title="幂等性"></a>幂等性</h4><p>​    Watch本身是基于事件来进行通知的。对象的任何操作都会触发event，需要自行进行甄别。如下图所示，通过简单的创建然后删除namespace，打印收到的事件情况：</p>
<p><img src="namespace-create-event.png" alt="namespace-create-event"></p>
<p><img src="namespace-delete-event.png" alt="namespace-delete-event"></p>
<p>​    可以看到在创建namespace的时候，收到了1个创建事件，4个修改事件。在删除namespace的时候，收到了三个修改事件，1个删除事件。通过多个worker处理这些事件的时候，需要考虑幂等性。同一个资源的两个事件被两个worker同时处理的情况是可能发生的，需要我们在worker根据自己的场景，采取相应的措施进行数据处理。</p>
<p>​    本文只是同步namespace，所以只需要关注新增和删除事件。相对比较简单。</p>
<h3 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h3><h4 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h4><p>​    这个由队列自身来保证，Kubernetes的DeploymentController也是使用的这样的队列。具体可以参照源码实现，了解其实现细节。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workQueue := workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), clusterInfo.Name + <span class="string">&quot;@namespace&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="代码测试"><a href="#代码测试" class="headerlink" title="代码测试"></a>代码测试</h2><h3 id="完整示意代码"><a href="#完整示意代码" class="headerlink" title="完整示意代码"></a>完整示意代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;context&quot;</span><br><span class="line">	&quot;flag&quot;</span><br><span class="line">	&quot;os&quot;</span><br><span class="line">	&quot;os&#x2F;signal&quot;</span><br><span class="line">	&quot;strconv&quot;</span><br><span class="line">	&quot;strings&quot;</span><br><span class="line">	&quot;syscall&quot;</span><br><span class="line">	&quot;time&quot;</span><br><span class="line"></span><br><span class="line">	v1 &quot;k8s.io&#x2F;api&#x2F;core&#x2F;v1&quot;</span><br><span class="line">	metav1 &quot;k8s.io&#x2F;apimachinery&#x2F;pkg&#x2F;apis&#x2F;meta&#x2F;v1&quot;</span><br><span class="line">	&quot;k8s.io&#x2F;apimachinery&#x2F;pkg&#x2F;util&#x2F;uuid&quot;</span><br><span class="line">	&quot;k8s.io&#x2F;apimachinery&#x2F;pkg&#x2F;util&#x2F;wait&quot;</span><br><span class="line">	&quot;k8s.io&#x2F;apimachinery&#x2F;pkg&#x2F;watch&quot;</span><br><span class="line">	&quot;k8s.io&#x2F;client-go&#x2F;kubernetes&quot;</span><br><span class="line">	&quot;k8s.io&#x2F;client-go&#x2F;tools&#x2F;cache&quot;</span><br><span class="line">	&quot;k8s.io&#x2F;client-go&#x2F;tools&#x2F;clientcmd&quot;</span><br><span class="line">	&quot;k8s.io&#x2F;client-go&#x2F;tools&#x2F;leaderelection&quot;</span><br><span class="line">	&quot;k8s.io&#x2F;client-go&#x2F;tools&#x2F;leaderelection&#x2F;resourcelock&quot;</span><br><span class="line">	toolswatch &quot;k8s.io&#x2F;client-go&#x2F;tools&#x2F;watch&quot;</span><br><span class="line">	&quot;k8s.io&#x2F;client-go&#x2F;util&#x2F;workqueue&quot;</span><br><span class="line">	&quot;k8s.io&#x2F;klog&#x2F;v2&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">const maxRetries &#x3D; 15</span><br><span class="line"></span><br><span class="line">type ClusterInfo struct &#123;</span><br><span class="line">	Name string</span><br><span class="line">	WorkerNum int</span><br><span class="line">	Config string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;测试一下选主API+ListWatch</span><br><span class="line">&#x2F;&#x2F;启动命令：go run leader_election.go -name&#x3D;election -namespace&#x3D;shadow -v&#x3D;4 -config&#x3D;C:&#x2F;Users&#x2F;shadow&#x2F;.kube&#x2F;config -id&#x3D;1</span><br><span class="line">func main()&#123;</span><br><span class="line">	klog.InitFlags(nil)</span><br><span class="line"></span><br><span class="line">	var config, leaseLockName, leaseLockNamespace, id string</span><br><span class="line">	flag.StringVar(&amp;config, &quot;config&quot;, &quot;&quot;, &quot;absolute path to the config path&quot;)</span><br><span class="line">	flag.StringVar(&amp;leaseLockName, &quot;name&quot;, &quot;&quot;, &quot;the lease lock resource name&quot;)</span><br><span class="line">	flag.StringVar(&amp;leaseLockNamespace, &quot;namespace&quot;, &quot;&quot;, &quot;the lease lock resource namespace&quot;)</span><br><span class="line">	flag.StringVar(&amp;id, &quot;id&quot;, string(uuid.NewUUID()), &quot;the holder identity name&quot;)</span><br><span class="line"></span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	if leaseLockName &#x3D;&#x3D; &quot;&quot; &#123;</span><br><span class="line">		klog.Fatal(&quot;unable to get lease lock resource name&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if leaseLockNamespace &#x3D;&#x3D; &quot;&quot; &#123;</span><br><span class="line">		klog.Fatal(&quot;unable to get lease lock resource namespace&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cfg, err :&#x3D;clientcmd.BuildConfigFromFlags(&quot;&quot;, config)</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		klog.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	client :&#x3D; kubernetes.NewForConfigOrDie(cfg)</span><br><span class="line"></span><br><span class="line">	ctx, cancel :&#x3D; context.WithCancel(context.Background())</span><br><span class="line">	defer cancel()</span><br><span class="line"></span><br><span class="line">	ch :&#x3D; make(chan os.Signal, 1)</span><br><span class="line">	signal.Notify(ch, os.Interrupt, syscall.SIGTERM)</span><br><span class="line">	go func() &#123;</span><br><span class="line">		&lt;-ch</span><br><span class="line">		klog.Info(&quot;Received termination, signaling shutdown&quot;)</span><br><span class="line">		cancel()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	lock :&#x3D; &amp;resourcelock.LeaseLock&#123;</span><br><span class="line">		LeaseMeta: metav1.ObjectMeta&#123;</span><br><span class="line">			Name: leaseLockName,</span><br><span class="line">			Namespace: leaseLockNamespace,</span><br><span class="line">		&#125;,</span><br><span class="line">		Client: client.CoordinationV1(),</span><br><span class="line">		LockConfig: resourcelock.ResourceLockConfig&#123;</span><br><span class="line">			Identity: id,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	leaderelection.RunOrDie(ctx, leaderelection.LeaderElectionConfig&#123;</span><br><span class="line">		Lock: lock,</span><br><span class="line">		ReleaseOnCancel: true,</span><br><span class="line">		LeaseDuration: 15 * time.Second,</span><br><span class="line">		RenewDeadline: 10 * time.Second,</span><br><span class="line">		RetryPeriod: 2 * time.Second,</span><br><span class="line">		Callbacks: leaderelection.LeaderCallbacks&#123;</span><br><span class="line">			OnStartedLeading: func(ctx context.Context) &#123;</span><br><span class="line">				Run(ctx)</span><br><span class="line">			&#125;,</span><br><span class="line">			OnStoppedLeading: func() &#123;</span><br><span class="line">				cancel()</span><br><span class="line">				klog.Infof(&quot;leader lost: %s&quot;, id)</span><br><span class="line">				os.Exit(0)</span><br><span class="line">			&#125;,</span><br><span class="line">			OnNewLeader: func(identity string) &#123;</span><br><span class="line">				&#x2F;&#x2F; we&#39;re notified when new leader elected</span><br><span class="line">				if identity &#x3D;&#x3D; id &#123;</span><br><span class="line">					&#x2F;&#x2F; I just got the lock</span><br><span class="line">					return</span><br><span class="line">				&#125;</span><br><span class="line">				klog.Infof(&quot;new leader elected: %s&quot;, identity)</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	panic(&quot;Unreachable&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func Run (ctx context.Context)&#123;</span><br><span class="line">	klog.Infof(&quot;leader run starting......&quot;)</span><br><span class="line"></span><br><span class="line">	for _, clusterInfo :&#x3D; range gerClusterInfos()&#123;</span><br><span class="line"></span><br><span class="line">		resourceVersion, err :&#x3D; fullSync()</span><br><span class="line">		if err !&#x3D; nil &#123;</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		workQueue :&#x3D; workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), clusterInfo.Name + &quot;@namespace&quot;)</span><br><span class="line"></span><br><span class="line">		startWatcher(ctx, clusterInfo.Config, resourceVersion, &amp;workQueue)</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F;multi workers</span><br><span class="line">		for i:&#x3D;1; i&lt;&#x3D; clusterInfo.WorkerNum; i++ &#123;</span><br><span class="line">			startWorker(ctx, &quot;workers-&quot; + strconv.Itoa(i) + &quot;@&quot; + clusterInfo.Name, &amp;workQueue)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	klog.Infof(&quot;leader run successfully exit~&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func getClient(content string) (*kubernetes.Clientset, error) &#123;</span><br><span class="line">	config, err :&#x3D; clientcmd.RESTConfigFromKubeConfig([]byte(content))</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		return nil, err</span><br><span class="line">	&#125;</span><br><span class="line">	return kubernetes.NewForConfig(config)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func gerClusterInfos() []ClusterInfo&#123;</span><br><span class="line">	&#x2F;&#x2F;TODO get all cluster information</span><br><span class="line">	return []ClusterInfo&#123;</span><br><span class="line">		&#123;</span><br><span class="line">			Name: &quot;cluster&quot;,</span><br><span class="line">			Config: &quot;这里是连接集群的kubeconfig文件的内容&quot;,</span><br><span class="line">			WorkerNum: 2,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func startWatcher(ctx context.Context, config, initialResourceVersion string, workQueue *workqueue.RateLimitingInterface)&#123;</span><br><span class="line">	go wait.Until(func() &#123;</span><br><span class="line">		defer (*workQueue).ShutDown()</span><br><span class="line"></span><br><span class="line">		client, err :&#x3D; getClient(config)</span><br><span class="line">		if err !&#x3D; nil &#123;</span><br><span class="line">			klog.Errorf(&quot;get client from kube config error: %v&quot;, err)</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		rw, err :&#x3D; toolswatch.NewRetryWatcher(initialResourceVersion, &amp;cache.ListWatch&#123;</span><br><span class="line">			WatchFunc: func(options metav1.ListOptions) (watch.Interface, error)&#123;</span><br><span class="line">				return client.CoreV1().Namespaces().Watch(ctx, metav1.ListOptions&#123;&#125;)</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;)</span><br><span class="line"></span><br><span class="line">		if err !&#x3D; nil &#123;</span><br><span class="line">			klog.Errorf(&quot;watch namespace error: %s&quot;, err)</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line">		defer rw.Stop()</span><br><span class="line"></span><br><span class="line">		for&#123;</span><br><span class="line">			select &#123;</span><br><span class="line">			case event, ok :&#x3D; &lt;-rw.ResultChan():</span><br><span class="line">				if !ok &#123;</span><br><span class="line">					klog.Info(&quot;result chan has been closed&quot;)</span><br><span class="line">					return</span><br><span class="line">				&#125;</span><br><span class="line">				(*workQueue).Add(event)</span><br><span class="line">			case &lt;-ctx.Done():</span><br><span class="line">				&#x2F;&#x2F;grace shutdown</span><br><span class="line">				klog.Info(&quot;gracefully shutdown&quot;)</span><br><span class="line">				return</span><br><span class="line">			case &lt;-rw.Done():</span><br><span class="line">				klog.Info(&quot;retry watcher has been stopped&quot;)</span><br><span class="line">				return</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;, 200*time.Millisecond, ctx.Done())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func startWorker(ctx context.Context, identify string, workQueue *workqueue.RateLimitingInterface)&#123;</span><br><span class="line">	go wait.Until(func()&#123;</span><br><span class="line">		for &#123;</span><br><span class="line">			item, shutdown :&#x3D; (*workQueue).Get()</span><br><span class="line">			if shutdown &#123;</span><br><span class="line">				return</span><br><span class="line">			&#125;</span><br><span class="line">			func()&#123;</span><br><span class="line">				defer (*workQueue).Done(item)</span><br><span class="line"></span><br><span class="line">				event :&#x3D; item.(watch.Event)</span><br><span class="line">				namespace :&#x3D; event.Object.(*v1.Namespace)</span><br><span class="line"></span><br><span class="line">				&#x2F;&#x2F;persistent to cmdb idempotence</span><br><span class="line">				klog.Infof(&quot;%s -&gt; cluster:%s, operation:%s, namespace:%s, tenant:%s &quot;, identify, strings.Split(identify, &quot;@&quot;)[1], event.Type, namespace.Name, namespace.Labels[&quot;k8s.shadow.io&#x2F;tenant&quot;])</span><br><span class="line"></span><br><span class="line">				var err error</span><br><span class="line">				if err !&#x3D; nil &amp;&amp; (*workQueue).NumRequeues(item) &lt; maxRetries &#123;</span><br><span class="line">					(*workQueue).AddRateLimited(item)</span><br><span class="line">					klog.Errorf(&quot;cmdb syncing %s error:%s, re-queuing&quot;, namespace.Name, err.Error())</span><br><span class="line">					return</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				(*workQueue).Forget(item)</span><br><span class="line">			&#125;()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;, 200*time.Millisecond, ctx.Done())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func fullSync() (string, error) &#123;</span><br><span class="line">	resourceVersion :&#x3D; &quot;1&quot;</span><br><span class="line">	&#x2F;&#x2F;TODO full data compare and sync</span><br><span class="line">	klog.Info(&quot;full data sync&quot;)</span><br><span class="line">	return resourceVersion, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>示意代码中，关于数据库的操作只使用了打印日志来代替</p>
<p>多集群的获取，暂时写死在配置中，可以通过更灵活的获取方式，考虑集群添加如何动态识别</p>
</blockquote>
<h3 id="测试方式"><a href="#测试方式" class="headerlink" title="测试方式"></a>测试方式</h3><p>​    创建选主所需要的锁资源，这里使用的是lease资源。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;<span class="string">EOF </span></span><br><span class="line"><span class="string">apiVersion: coordination.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Lease</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: shadow</span></span><br><span class="line"><span class="string">  namespace: shadow</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>​    切换到代码所在目录，通过如下命令启动集群，如要启动多个实例，更改一下id的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run leader_election.go -name&#x3D;election -namespace&#x3D;shadow -v&#x3D;4 -config&#x3D;C:&#x2F;Users&#x2F;shadow&#x2F;.kube&#x2F;config -id&#x3D;1</span><br></pre></td></tr></table></figure>

<p>​    关闭被选为主的id进程，观察选主情况。</p>
<p>​    创建资源观察Watcher及Worker的处理情况。</p>
<p>​    放置一段时间，观察Watch重建情况。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shadow802.gitee.io/2021/08/10/Kubernetes-NetworkPolicy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Shadow802">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow802">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/10/Kubernetes-NetworkPolicy/" class="post-title-link" itemprop="url">Kubernetes-NetworkPolicy</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-10 00:00:00" itemprop="dateCreated datePublished" datetime="2021-08-10T00:00:00+08:00">2021-08-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​    Kubernetes的CNI网络插件，打通了各节点上Pod的网络通信，但在某项情况下（多租户的情况），需要进行网络隔离，阻止不同逻辑归属的Pod之间的相互通信，Kubernetes提供了Network Policy这样的资源，底层需要CNI网络插件的支持。</p>
<h1 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h1><p>​    先来了解一下Network Policy的底层实现，这里参考网上帖子<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg5NDYxNTYyMw==&mid=2247487293&idx=1&sn=c62f306edc742e500265ad0533862b45&source=41#wechat_redirect">Kubernetes NetworkPolicy 工作原理浅析</a>，以Calico为例。</p>
<p><img src="calico-networkpolicy.webp" alt="calico-networkpolicy"></p>
<p>​    基本步骤：</p>
<p>​    1）通过K8S的客户端，将Network Policy 对象发送给API Server。</p>
<p>​    2）Calico的policy-controller监听Network Policy资源，获取后，写入calico的etcd数据库。</p>
<p>​    3）Node上的calico-felix从etcd中获取policy资源，调用iptables做相应的配置。</p>
<h1 id="实践测试"><a href="#实践测试" class="headerlink" title="实践测试"></a>实践测试</h1><p>​    本文主要为了测试在kubernetes中，使用Network Policy对不同namespace下的Pod进行网络隔离，侧重于ingress方向。</p>
<h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2><table>
<thead>
<tr>
<th>组件</th>
<th>版本</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Kubernetes</td>
<td>v1.20.9</td>
<td></td>
</tr>
<tr>
<td>Canal</td>
<td>v3.19.1</td>
<td>网络插件要支持Network Policy。</td>
</tr>
<tr>
<td>Istio</td>
<td>1.10.3</td>
<td>这是环境附带的组件，引发了一个问题，详见《意外收获》3.1。</td>
</tr>
<tr>
<td>nginx</td>
<td>1.21</td>
<td></td>
</tr>
<tr>
<td>sleep</td>
<td></td>
<td>一个curl工具镜像，这里直接使用的istio官网范例的yaml文件</td>
</tr>
</tbody></table>
<h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><p>​    在default和shadow的命名空间下，分别部署了nginx deployment和sleep应用。然后创建Network Policy，测试它们之间的http的连通性。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## nginx deployment and service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">xxxxxxx/shadow/nginx:1.21</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## sleep deployment and service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sleep</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sleep</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sleep</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">sleep</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sleep</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sleep</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">sleep</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">sleep</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">sleep</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sleep</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">curlimages/curl</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;3650d&quot;</span>]</span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/sleep/tls</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">sleep-secret</span></span><br><span class="line">          <span class="attr">optional:</span> <span class="literal">true</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<p>​    使用如下命令部署：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f xxxx.yaml</span><br><span class="line">kubectl apply -f xxxx.yaml -n shadow</span><br></pre></td></tr></table></figure>

<p>​    将curl工具注册为环境变量，便于后续使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># shadow namespace</span></span></span><br><span class="line">export SHADOW=$(kubectl get pod -l app=sleep -n shadow -o jsonpath=&#123;.items..metadata.name&#125;)</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># default namespace</span></span></span><br><span class="line">export DEFAULT=$(kubectl get pod -l app=sleep -o jsonpath=&#123;.items..metadata.name&#125;)</span><br></pre></td></tr></table></figure>



<h2 id="实例测试"><a href="#实例测试" class="headerlink" title="实例测试"></a>实例测试</h2><h3 id="拒绝所有入站流量策略"><a href="#拒绝所有入站流量策略" class="headerlink" title="拒绝所有入站流量策略"></a>拒绝所有入站流量策略</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 指定policyTypes为入站方向，不为spec.ingress设定规则。不选定生效范围，默认为当前命名空间下所有pod。</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">network-policy-deny-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br></pre></td></tr></table></figure>

<p>使用如下命令部署Network Policy,并在default和shadow的命名空间中分别尝试连接到shadow命名空间下的nginx：</p>
<p>访问不通：</p>
<p>​    1）不同命名空间下访问，返回了503 Service Unavailable。</p>
<p>​    2）相同命名空间下访问，返回time out。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it $DEFAULT -c sleep -- curl -i http:&#x2F;&#x2F;nginx.shadow.svc.cluster.local</span><br><span class="line">kubectl exec -it -n shadow $SHADOW -c sleep -- curl -i http:&#x2F;&#x2F;nginx.shadow.svc.cluster.local</span><br></pre></td></tr></table></figure>

<p><img src="ingress-deny-all-curl.png" alt="deny-all-curl"></p>
<h3 id="拒绝所有出站流量策略"><a href="#拒绝所有出站流量策略" class="headerlink" title="拒绝所有出站流量策略"></a>拒绝所有出站流量策略</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 指定policyTypes为出站方向（默认为Ingress，要设置Egress一定要显示指定policyTypes），不为spec.egress设定规则。不选定生效范围，默认为当前命名空间下所有pod。</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">network-policy-deny-egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br></pre></td></tr></table></figure>



<p>重新部署后，从shadow命名空间分别向本命名空间和default命名空间发送http请求：</p>
<p>访问不通：</p>
<p>​    可以发现，连域名解析的流量也被拦截，Pod无法通过Kubernetes的DNS域名解析服务，解析出Service的Cluster IP。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">-n</span> <span class="string">shadow</span> <span class="string">$SHADOW</span> <span class="string">-c</span> <span class="string">sleep</span> <span class="string">--</span> <span class="string">curl</span> <span class="string">-i</span> <span class="string">http://nginx.default.svc.cluster.local</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">-n</span> <span class="string">shadow</span> <span class="string">$SHADOW</span> <span class="string">-c</span> <span class="string">sleep</span> <span class="string">--</span> <span class="string">curl</span> <span class="string">-i</span> <span class="string">http://nginx.shadow.svc.cluster.local</span></span><br></pre></td></tr></table></figure>



<p><img src="egress-deny-all-curl.png" alt="egress-deny-all-curl"></p>
<h3 id="允许所有入站-出站流量"><a href="#允许所有入站-出站流量" class="headerlink" title="允许所有入站/出站流量"></a>允许所有入站/出站流量</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 这种配置跟默认的不创建Network Policy是一样的。</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">network-policy-allow-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br></pre></td></tr></table></figure>



<p>重新部署后，分别从出口和入口两个方向，测试http连通性：</p>
<p>均返回200，访问成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 出口方向</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it -n shadow <span class="variable">$SHADOW</span> -c sleep -- curl -i http://nginx.shadow.svc.cluster.local</span><br><span class="line">kubectl <span class="built_in">exec</span> -it -n shadow <span class="variable">$SHADOW</span> -c sleep -- curl -i http://nginx.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 入口方向</span></span><br><span class="line"> kubectl <span class="built_in">exec</span> -it <span class="variable">$DEFAULT</span> -c sleep -- curl -i http://nginx.shadow.svc.cluster.local</span><br></pre></td></tr></table></figure>

<p><img src="allow-all-curl.png" alt="allow-all-curl"></p>
<h3 id="选择器"><a href="#选择器" class="headerlink" title="选择器"></a>选择器</h3><p>​    在Network Policy的定义中，分为两类选择器：</p>
<p>​    1）在spec层面，通过podSelector定义了网络策略生效的对象，可以通过matchExpressions和matchLabels进行筛选，两者是and的关系。</p>
<p>​    2）在网络策略规则（spec.ingress/spec.egress）层面。通过ipBlock、namespaceSelector、podSelector的组合和Ports来定义规则生效的对象。</p>
<h4 id="网络策略对象选择"><a href="#网络策略对象选择" class="headerlink" title="网络策略对象选择"></a>网络策略对象选择</h4><h5 id="PodSelector"><a href="#PodSelector" class="headerlink" title="PodSelector"></a>PodSelector</h5><p>​    （1）matchExpressions</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">network-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">from:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">network-policy.shadow.io/namespace</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">shadow</span></span><br></pre></td></tr></table></figure>

<p>​    （2）matchLabels</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">network-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">from:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">          <span class="attr">matchLabels:</span></span><br><span class="line">            <span class="attr">network-policy.shadow.io/namespace:</span> <span class="string">shadow</span></span><br></pre></td></tr></table></figure>



<h4 id="网络规则对象选择"><a href="#网络规则对象选择" class="headerlink" title="网络规则对象选择"></a>网络规则对象选择</h4><h5 id="Selector"><a href="#Selector" class="headerlink" title="Selector"></a>Selector</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## podSelector从自身所在的命名空间挑选Pod + 从namespaceSelector中挑选Pod</span></span><br><span class="line"><span class="comment">## namespaceSelector定义可以访问的namespace</span></span><br><span class="line"><span class="comment">## Ports如不定义，默认访问所有，可定义多个ingress.from。只要满足一条，访问就会被放过。</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">network-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">from:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">network-policy.shadow.io/namespace</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">          <span class="attr">matchLabels:</span></span><br><span class="line">            <span class="attr">app:</span> <span class="string">sleep</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>执行如下命令测试连通性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 返回200</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$DEFAULT</span> -c sleep -- curl -i http://nginx.shadow.svc.cluster.local</span><br><span class="line">kubectl <span class="built_in">exec</span> -it -n shadow <span class="variable">$SHADOW</span> -c sleep -- curl -i http://nginx.shadow.svc.cluster.local</span><br></pre></td></tr></table></figure>



<h5 id="IpBlock"><a href="#IpBlock" class="headerlink" title="IpBlock"></a>IpBlock</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## ipBlock与namespaceSelector + podSelector组合，二者是或的关系。</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">shadow</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span>              <span class="comment">## 这个是kubernetes集群中Pod的cidr，就是集群内所有pod均可访问</span></span><br><span class="line">        <span class="attr">except:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.187</span><span class="string">/32</span>                <span class="comment">## 这里排除了另一个命名空间的一个pod的ip</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">        <span class="attr">matchExpressions:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">network-policy.shadow.io/namespace</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">          <span class="attr">values:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br></pre></td></tr></table></figure>



<p>重新部署后执行测试，结果如下图：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 被排除的Pod无法访问</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">-n</span> <span class="string">networkpolicy</span> <span class="string">$NETWORK</span> <span class="string">-c</span> <span class="string">sleep</span> <span class="string">--</span> <span class="string">curl</span> <span class="string">-i</span> <span class="string">http://nginx.shadow.svc.cluster.local</span></span><br><span class="line"><span class="comment">## 因为没有定义PodSelector，所有本命名空间内的也不能访问。但是符合ipBlock cidr中的Pod。</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">-n</span> <span class="string">shadow</span> <span class="string">$SHADOW</span> <span class="string">-c</span> <span class="string">sleep</span> <span class="string">--</span> <span class="string">curl</span> <span class="string">-i</span> <span class="string">http://nginx.shadow.svc.cluster.local。</span></span><br></pre></td></tr></table></figure>



<p><img src="ipBlock-ingress.png" alt="ipBlock-ingress"></p>
<h1 id="意外收获"><a href="#意外收获" class="headerlink" title="意外收获"></a>意外收获</h1><h2 id="Istio"><a href="#Istio" class="headerlink" title="Istio"></a>Istio</h2><p>​    <a target="_blank" rel="noopener" href="https://istio.io/latest/zh/blog/2017/0.1-using-network-policy/">Istio use network policy</a></p>
<p>​    参阅如上材料，Istio主要处理5-7层网络，而networkpolicy负责处理3-4层网络。在本实验中，遇到一个问题，进行复盘：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Network Policy 部署到shadow命名空间下</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">network-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">from:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">network-policy.shadow.io/namespace</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">          <span class="attr">matchLabels:</span></span><br><span class="line">            <span class="attr">app:</span> <span class="string">sleep</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it $DEFAULT -c sleep -- curl -i http:&#x2F;&#x2F;nginx.shadow.svc.cluster.local</span><br></pre></td></tr></table></figure>

<p>发现不通，这与network policy中定义的预期不符。</p>
<p>后经排查，意外发现，default的命名空间开启了istio的自动注入，sleep的程序默认部署了sidecar。如下图：</p>
<p><img src="istio-network-policy-pod.png" alt="istio-network-policy-pod"></p>
<p>可以看到开启了istio自动注入的命名空间的pod，多了一个sidecar的容器。而定义network policy的shadow命名空间并没有开启自动注入。</p>
<p>经反复实验发现：<strong>去掉default上的istio自动注入或者给shadow加上istio的自动注入（istio-injection: enabled），结果均符合预期。</strong></p>
<p>由此可以得出，istio + network policy同时作用在服务的发起方和调用发，<strong>必须两者同时开启或者关闭istio</strong>。</p>
<blockquote>
<p>Istio是在Pod的命名空间内，通过设置iptables接管Pod的流量，而Network Policy是在Node上设置Iptables规则。</p>
<p>Istio + Network Policy之后，<strong>目前猜测</strong>如果请求发起方经由Enovy代理后，服务方如果在ingress方向使用了Network Policy。</p>
<p>请求流量无法匹配Node上的iptables规则，也无法使用Istio为Pod设置的Iptables规则（服务方未部署Enovy）。</p>
<p><strong>进一步佐证，需要分析Pod和Node上的Iptables规则。</strong></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Shadow802</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">60</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shadow802</span>
</div>

<div class="powered-by">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <i class="fa fa-user-md"></i>
    <span id="busuanzi_container_site_uv">
        本站访客数:<span id="busuanzi_value_site_uv"></span>
    </span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_pv">
        本站访问量<span id="busuanzi_value_site_pv"></span>
    </span>
</div>
        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
